# ChemParser - Chemistry to LaTeX Conversion System

## Project Overview
ChemParser is a comprehensive chemistry visualization and conversion system that converts chemical structures (SMILES, nomenclature, drawings) to ChemFig LaTeX code and various rendering formats (SVG, PDF). The system includes a Chrome extension, multiple backend servers, and web interfaces for interactive molecule rendering.

## Quick Start

### Start Everything
```bash
# Windows
1-start-all.bat

# Linux/Mac
# Start servers individually (see Server Architecture below)
```

### Access Main Interface
**Unified Interface:** http://localhost:5000/unified-interface.html
**Mol2ChemFig Complete:** http://localhost:5000/mol2chemfig-full-interface.html

## System Architecture

### 1. Backend Servers (3 Microservices)

**IMPORTANT:** All interfaces and extension now use port 5001 (Flask wrapper) which proxies to port 8000 (Docker) when needed. This provides better error handling when Docker is not running.

#### MoleculeViewer Server (Port 5000) - PRIMARY
**Technology:** Node.js + RDKit
**Purpose:** Main SVG generation, serves static files
**No Docker Required** ✅

**Key Files:**
- `MoleculeViewer/server.js` - Express server
- `MoleculeViewer/generate_svg.py` - Python RDKit backend
- `MoleculeViewer/cache/moleculeviewer/` - SVG cache

**Endpoints:**
- `GET /img/smiles?smiles=CCO` - Generate SVG from SMILES
- `GET /img/nomenclature?nomenclature=ethanol` - Generate from name
- `GET /health` - Health check
- `GET /cache-info` - Cache statistics
- Serves all static HTML interfaces

#### Mol2ChemFig Server (Port 5001)
**Technology:** Flask (Python)
**Purpose:** ChemFig LaTeX conversion, OPSIN 3D SMILES
**Docker Required for Full Features** ⚠️

**Key Files:**
- `mol2chemfig_server.py` - Flask server (575 lines)
- `m2cf_docker_full.py` - Main mol2chemfig backend
- `m2cf_processor_docker.py` - Processing logic
- `m2cf_options_docker.py` - ChemFig options handler
- `cache/mol2chemfig/` - Persistent cache

**Endpoints:**
- `POST /convert` - Convert SMILES/MOL to ChemFig
- `POST /opsin/name-to-smiles` - OPSIN 3D SMILES generation (WORKS)
- `POST /apply-options` - Apply ChemFig options to molecule
- `GET /health` - Health check

**Important Fix (Line 575):**
```python
# Fixed to return both 'smiles' and 'smiles_3d' for compatibility
return jsonify({
    "success": True,
    "name": name,
    "smiles": result.get('smiles'),
    "smiles_3d": result.get('smiles'),  # Added for frontend compatibility
    "source": "OPSIN"
})
```

#### PubChem Server (Port 5002)
**Technology:** Node.js
**Purpose:** 3D molecule viewer, compound search
**No Docker Required** ✅

**Key Files:**
- `pubchem_server.py` - PubChem API integration
- `pubchem-cache/` - PubChem data cache

**Endpoints:**
- `GET /search?q=aspirin` - Search PubChem by name
- `GET /3d-viewer?cid=12345` - 3D molecule visualization

### 2. Frontend Interfaces

#### Unified Interface (`unified-interface.html`)
**Purpose:** Hub for all tools with tabbed interface
**FIXED:** Mol2ChemFig tab now embeds the full interface with ALL 8 options
**Features:**
- Quick access to all tools
- Tab navigation between different services
- Links to test files
- **Full ChemFig interface with all 8 options** (embedded via iframe)

**Tabs:**
- Mol2ChemFig - Full interface embedded
- MoleculeViewer - Simple SMILES/SVG rendering
- PubChem - Compound search
- 3D SMILES - OPSIN name-to-SMILES conversion
- Tests - All test files

#### Mol2ChemFig Complete Interface (`mol2chemfig-full-interface.html`)
**Purpose:** Full-featured ChemFig conversion with ALL 8 options
**Source:** Copied from `test_m2cf_full.html`
**FIXED:** Now points to port 5001 (Flask wrapper) instead of port 8000 (Docker direct)

**Features:**
✅ **All 8 ChemFig Options:**
1. **Aromatic** (`-o`) - Circles in benzene rings instead of double bonds
2. **Fancy Bonds** (`-f`) - Prettier double/triple bonds
3. **Compact View** (`-z`) - More compact chemfig format
4. **Show Carbon** (`-c`) - Display C atoms as elements
5. **Show Methyl** (`-m`) - Display CH₃ groups as elements
6. **Flip** (`-p`) - Mirror horizontally
7. **Flop** (`-q`) - Mirror vertically
8. **Atom Numbers** (`-n`) - Number all atoms

✅ **Advanced Controls:**
- Rotation Angle: -360° to +360°
- Indentation: 0-20 spaces
- H₂ Treatment: Keep / Add / Delete

✅ **Input Methods:**
- Kekule.js chemical drawing tool
- PubChem compound search
- Direct SMILES input
- Reaction scheme drawing

✅ **Export Formats:**
- SVG (scalable vector graphics)
- Layered SVG (separate bond layers)
- PDF (embedded document)

✅ **Extras:**
- Options persistence (localStorage)
- Live preview modes
- Reaction scheme support

### 3. Chrome Extension (`chem-extension/`)

**Purpose:** Detect and render `chem:molecule_name` or `chem:SMILES` syntax on any webpage

**Key Files:**
- `content.js` - Main rendering logic (2500+ lines)
- `popup.html` + `popup.js` - Settings UI
- `manifest.json` - Extension configuration

**API Endpoints Used:**
- `http://localhost:5000` - MoleculeViewer (primary)
- `http://localhost:5001` - Mol2ChemFig Flask wrapper (FIXED - was incorrectly pointing to 8000)
- `http://localhost:5002` - PubChem (optional)

**Features:**
- Auto-detect chemistry syntax on web pages
- Size controls with up/down arrows
- Dark mode support
- Settings persistence
- Multiple rendering backends

## Batch File Commands (Windows)

### Main Commands
| File | Purpose | Use When |
|------|---------|----------|
| `1-start-all.bat` | Start all 3 servers + open browser | Starting the system |
| `util-stop-all.bat` | Kill all Node.js and Python processes | Shutting down |
| `util-status.bat` | Check which ports are listening | Debugging |

### Development Commands
| File | Purpose | Port |
|------|---------|------|
| `dev-start-moleculeviewer.bat` | MoleculeViewer only | 5000 |
| `dev-start-mol2chemfig.bat` | Mol2ChemFig only | 5001 |
| `dev-start-pubchem.bat` | PubChem only | 5002 |

## Docker Information

### Current Status
**Docker is NOT required for basic operation** ✅

The system works fully without Docker using:
- MoleculeViewer (Port 5000) for SVG rendering
- OPSIN API for 3D SMILES generation
- Kekule.js for chemical drawing

### What Docker Enables (Optional)
- Advanced Mol2ChemFig backend rendering
- PDF generation via mol2chemfig
- Layered SVG export from mol2chemfig

### Docker Setup (If Needed)
```bash
# Install Docker Desktop
# https://www.docker.com/products/docker-desktop

# Start mol2chemfig container
docker-compose up -d

# Verify running on port 8000
curl http://localhost:8000/health

# View logs
docker-compose logs -f backend

# Restart after code changes
docker-compose restart backend

# Stop
docker-compose down
```

**Docker Configuration:**
- `docker-compose.yml` - Container configuration
- `MOL2CHEMFIG_BACKEND = "http://localhost:8000"` (in mol2chemfig_server.py)
- Mounts `m2cf_fixed.py` into container

## Repository Structure (Lightweight)

### Included (3-5 MB)
✅ All Python backend files (.py)
✅ All HTML/CSS/JS interfaces
✅ Batch scripts for server management
✅ Configuration files
✅ Documentation (118+ markdown files)
✅ Source code folders:
  - `mol2chemfig/` - Mol2ChemFig source
  - `backend_source_mol2chemfig/` - Backend processing
  - `backend_source_chemistry/` - Chemistry utilities
  - `chemistry/` - Chemistry core
  - `frontend_source/` - Frontend source files
  - `chem-extension/` - Chrome extension

### Excluded via .gitignore (150+ MB)
❌ `MoleculeViewer/` - 159 MB library (run `npm install` locally)
❌ `ChemDoodleWeb-11.0.0/` - 16 MB library (download separately)
❌ `node_modules/` - 2.5 MB (run `npm install`)
❌ `cache/` - Runtime SVG cache
❌ `pubchem-cache/` - PubChem data cache
❌ `backend_data/` - Runtime backend storage
❌ `mol2chemfig_storage/` - Processing temp files
❌ `__pycache__/` - Python bytecode
❌ Log files (*.log)

### Setup After Clone
```bash
# 1. Install Node dependencies
npm install

# 2. Install Python dependencies
pip install -r requirements_server.txt
pip install -r requirements_pubchem.txt

# 3. Download MoleculeViewer (if needed)
# Place in MoleculeViewer/ folder or clone from source

# 4. Download ChemDoodleWeb (if needed)
# https://web.chemdoodle.com/
# Extract to ChemDoodleWeb-11.0.0/

# 5. Start servers
1-start-all.bat  # Windows
# Or start individually on Linux/Mac
```

## Caching System

### Separate Cache Folders
Each server has dedicated cache to prevent conflicts:
- `MoleculeViewer/cache/moleculeviewer/` - RDKit SVG cache
- `cache/mol2chemfig/` - ChemFig conversion cache
- `pubchem-cache/` - PubChem API response cache

### Cache Management
```bash
# Clear individual caches
curl -X DELETE http://localhost:5000/clear-cache  # MoleculeViewer
curl -X POST http://localhost:5001/api/cache/clear  # Mol2ChemFig

# Manual clear
rm -rf MoleculeViewer/cache/moleculeviewer/*
rm -rf cache/mol2chemfig/*
rm -rf pubchem-cache/*
```

### Cache Deduplication
**Script:** `deduplicate_cache.py`
**Purpose:** Use canonical SMILES to merge duplicates
**Example:** "ethanol" + "CCO" + "C-C-O" → single cached SVG

```bash
python deduplicate_cache.py
```

## Testing

### Test Files
The project includes extensive test HTML files:
- `test_m2cf_full.html` - Full Mol2ChemFig interface (source of unified interface)
- `test_extension_integration.py` - Extension API testing
- `test_cache_deduplication.py` - Cache system tests
- `test_cache_separation.py` - Cache folder separation tests
- `test_3d_smiles.html` - OPSIN 3D SMILES testing
- `test_opsin_3d.html` - OPSIN integration
- `test_pubchem.html` - PubChem API testing
- `test_pubchem_3d.html` - PubChem 3D viewer
- `test_all_features_demo.html` - Complete feature showcase

### Test Endpoints
```bash
# MoleculeViewer health
curl http://localhost:5000/health

# Generate SVG from SMILES
curl "http://localhost:5000/img/smiles?smiles=CCO"

# Generate from nomenclature
curl "http://localhost:5000/img/nomenclature?nomenclature=ethanol"

# Mol2ChemFig health
curl http://localhost:5001/health

# OPSIN 3D SMILES (FIXED)
curl -X POST http://localhost:5001/opsin/name-to-smiles \
  -H "Content-Type: application/json" \
  -d '{"name":"caffeine"}'

# PubChem search
curl "http://localhost:5002/search?q=aspirin"
```

## Common Development Tasks

### Extension Development
1. Edit files in `chem-extension/`
2. Go to `chrome://extensions`
3. Click "Reload" on ChemParser extension
4. Test on any webpage with `chem:` syntax

### Backend Changes

**MoleculeViewer:**
1. Edit files in `MoleculeViewer/`
2. Kill Node server (Ctrl+C)
3. Restart: `node server.js`
4. Test with curl or browser

**Mol2ChemFig (Docker):**
1. Edit `m2cf_fixed.py` or related files
2. Restart container: `docker-compose restart backend`
3. Test with curl or interface

**Mol2ChemFig (Flask):**
1. Edit `mol2chemfig_server.py`
2. Restart Flask server (Ctrl+C, then restart)
3. Test with curl or interface

**PubChem:**
1. Edit `pubchem_server.py`
2. Restart server
3. Test with curl or interface

### Interface Changes
1. Edit HTML files in root directory
2. Clear browser cache (Ctrl+Shift+R)
3. Reload page
4. Test features

## Key Features & Recent Fixes (November 2025)

### ✅ Extension API Fixed
**Fixed:** `chem-extension/content.js` line 12
**Issue:** Extension was calling port 8000 (Docker) directly instead of port 5001 (Flask wrapper)
**Solution:** Changed `MOL2CHEMFIG_API` from `http://localhost:8000` to `http://localhost:5001`
**Impact:** Extension now works even when Docker is not running (will show proper error messages)

### ✅ Unified Interface Enhanced
**Fixed:** `unified-interface.html` Mol2ChemFig tab
**Issue:** Missing all 8 ChemFig options - had only basic controls
**Solution:** Replaced with iframe embedding `mol2chemfig-full-interface.html`
**Impact:** All 8 ChemFig options now accessible from unified interface

### ✅ Mol2ChemFig Interfaces Updated
**Fixed:** `mol2chemfig-full-interface.html` and `test_m2cf_full.html`
**Issue:** Both called port 8000 (Docker) directly, failing when Docker not running
**Solution:** Changed `API_BASE` from `http://localhost:8000/m2cf` to `http://localhost:5001/m2cf`
**Impact:** Interfaces now use Flask wrapper with better error handling

### ✅ Flask Server Proxy Routes Added
**Fixed:** `mol2chemfig_server.py` (added routes at line 726-801)
**Issue:** Flask server had /api/* endpoints but interfaces needed /m2cf/* endpoints
**Solution:** Added proxy routes that forward /m2cf/* requests to Docker backend
**Impact:** Backwards compatibility - interfaces work with Flask wrapper seamlessly

### ✅ All 8 ChemFig Options Available
Achieved by embedding full interface in unified interface and updating API endpoints

### ✅ OPSIN 3D SMILES Generation
**Fixed:** `mol2chemfig_server.py` line 581
**Issue:** API returned `smiles` but frontend expected `smiles_3d`
**Solution:** Return both fields for compatibility

### ✅ Options Persistence
ChemFig options saved in browser localStorage across sessions

### ✅ Multiple Preview Modes
- SVG (vector graphics, scalable)
- Layered SVG (separate bond layers for editing)
- PDF (embedded document for LaTeX)

### ✅ Chemical Drawing
Kekule.js integration for drawing molecules directly in browser

### ✅ Reaction Schemes
Full support for drawing and converting reaction schemes

### ⚠️ Mol2ChemFig Docker Dependency
**Limitation:** Advanced mol2chemfig rendering requires Docker
**Workaround:** Use MoleculeViewer (Port 5000) for most use cases
**Error Message:** `Failed to establish connection to localhost:8000`

## Important Notes for AI Assistants

### When Making Changes

**Before editing any server file:**
1. Read the file first to understand current implementation
2. Check which server it belongs to (port 5000/5001/5002)
3. Understand dependencies and related files

**After editing:**
- MoleculeViewer: Restart Node server
- Mol2ChemFig (Docker): `docker-compose restart backend`
- Mol2ChemFig (Flask): Restart Flask server
- Extension: Reload at `chrome://extensions`

### Testing Protocol
1. Check server health endpoints first
2. Test with curl before testing in browser
3. Clear cache if seeing stale results
4. Check browser console for errors
5. Verify correct port is being accessed

### Common Issues

**Port Already in Use:**
```bash
util-stop-all.bat  # Kill all processes
# Wait 2 seconds
1-start-all.bat    # Restart
```

**Docker Connection Error:**
- Expected if Docker not installed
- Use MoleculeViewer as alternative
- Only needed for advanced mol2chemfig features

**Extension Not Working:**
1. Check all servers running: `util-status.bat`
2. Reload extension: `chrome://extensions`
3. Check browser console for errors
4. Verify API URLs in `content.js`

**Changes Not Appearing:**
- Clear browser cache (Ctrl+Shift+R)
- Restart appropriate server
- Check if editing correct file (not cached version)

## Documentation Reference

### Main Docs (Root Level)
- `00_START_HERE.md` - Quick start guide
- `README_LIGHTWEIGHT.md` - Repository structure
- `FIXES_SUMMARY.md` - What was fixed and how
- `BATCH_FILES_GUIDE.md` - Batch file reference
- `INTERFACES_GUIDE.md` - Interface comparison

### Extended Docs (docs/ folder - 118+ files)
- `docs/ARCHITECTURE.md` - System architecture
- `docs/API_ENDPOINTS.md` - API reference
- `docs/CACHE_SYSTEM_DOCUMENTATION.md` - Cache details
- `docs/AUTONOMOUS_TESTING_GUIDE.md` - Testing guide
- `docs/AGENT_GUIDE.md` - Multi-agent development

### Component Docs
- `chem-extension/USAGE.md` - Extension usage
- `chem-extension/CHEMFIG_SUPPORT.md` - ChemFig features
- `MoleculeViewer/README.md` - MoleculeViewer setup
- `MoleculeViewer/docs/` - MoleculeViewer extended docs

## Current Status

### Working Features ✅
- MoleculeViewer SVG rendering (no Docker)
- OPSIN 3D SMILES generation
- PubChem 3D viewer and search
- All 8 ChemFig options in UI
- Chemical drawing with Kekule.js
- Reaction scheme support
- Options persistence
- Multiple export formats
- Cache system with deduplication
- Chrome extension
- Unified interface
- Batch file automation

### Requires Docker ⚠️
- Advanced Mol2ChemFig rendering
- PDF generation via mol2chemfig
- Layered SVG export from mol2chemfig

### Port Allocation
- **5000** - MoleculeViewer (Node.js) - PRIMARY
- **5001** - Mol2ChemFig (Flask/Python)
- **5002** - PubChem (Node.js/Python)
- **8000** - Mol2ChemFig Docker Backend (optional)

## Quick Workflows

### Draw and Convert a Molecule
1. Start system: `1-start-all.bat`
2. Open: http://localhost:5000/mol2chemfig-full-interface.html
3. Click "Molecule" tab
4. Use Kekule.js drawing tool
5. Click "Convert to Chemfig"
6. Select options (aromatic, fancy bonds, etc.)
7. Click "Apply Options"
8. View as SVG or PDF

### Search PubChem
1. Open unified interface
2. Click "PubChem" tab
3. Type compound name (e.g., "caffeine")
4. Click search
5. View 3D structure or export

### Convert SMILES
1. Open MoleculeViewer or Mol2ChemFig interface
2. Paste SMILES string
3. Apply options
4. Export to desired format

### Test Extension
1. Load extension from `chem-extension/`
2. Navigate to any webpage
3. Add text: `chem:aspirin` or `chem:CCO`
4. Extension auto-renders molecule images

## Version Information
- **Last Updated:** November 2025
- **System Status:** 3/3 Servers Operational
- **Docker Status:** Optional (not required for basic use)
- **Extension Status:** Fully functional
- **ChemFig Options:** All 8 available

## Resources
- ChemFig Documentation: https://www.ctan.org/pkg/chemfig
- RDKit: https://www.rdkit.org/
- OPSIN API: https://opsin.ch.cam.ac.uk/
- PubChem API: https://pubchem.ncbi.nlm.nih.gov/
- Kekule.js: http://partridgejiang.github.io/Kekule.js/
