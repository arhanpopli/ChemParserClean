name: xTB Orbital Calculation

on:
  workflow_dispatch:
    inputs:
      smiles:
        description: 'SMILES string of molecule'
        required: true
        default: 'O'
        type: string
      orbital:
        description: 'Orbital to visualize (homo, lumo, homo-1, etc.)'
        required: false
        default: 'homo'
        type: string
      gfn:
        description: 'GFN method (0, 1, 2)'
        required: false
        default: '2'
        type: string
      charge:
        description: 'Molecular charge'
        required: false
        default: '0'
        type: string
      multiplicity:
        description: 'Spin multiplicity (2S+1)'
        required: false
        default: '1'
        type: string
      solvent:
        description: 'ALPB solvent (none, water, methanol, ... )'
        required: false
        default: 'none'
        type: string

jobs:
  calculate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install xTB
        run: |
          sudo apt-get update
          sudo apt-get install -y xtb
      
      - name: Install Open Babel (for SMILES to XYZ)
        run: |
          sudo apt-get install -y openbabel
      
      - name: Convert SMILES to XYZ
        run: |
          echo "Converting SMILES: '${{ github.event.inputs.smiles }}'"
          echo '${{ github.event.inputs.smiles }}' | obabel -ismi -oxyz --gen3d -O molecule.xyz
          
          if [ ! -f "molecule.xyz" ]; then
            echo "Error: molecule.xyz was not generated!"
            exit 1
          fi
          
          echo "=== Generated XYZ file ==="
          cat molecule.xyz

      - name: Run xTB calculation
        run: |
          echo "=== Running xTB GFN2 calculation with ALL properties ==="
          echo "GFN method: ${{ github.event.inputs.gfn }}"
          echo "Charge: ${{ github.event.inputs.charge }}"
          echo "Multiplicity: ${{ github.event.inputs.multiplicity }}"
          echo "Solvent: ${{ github.event.inputs.solvent }}"

          GFN_METHOD="${{ github.event.inputs.gfn }}"
          CHARGE="${{ github.event.inputs.charge }}"
          MULTIPLICITY="${{ github.event.inputs.multiplicity }}"
          SOLVENT="${{ github.event.inputs.solvent }}"

          if [ -z "$GFN_METHOD" ]; then GFN_METHOD="2"; fi
          if [ -z "$CHARGE" ]; then CHARGE="0"; fi
          if [ -z "$MULTIPLICITY" ]; then MULTIPLICITY="1"; fi
          if [ -z "$SOLVENT" ]; then SOLVENT="none"; fi

          UHF=$((MULTIPLICITY - 1))

          XTB_OPTS="--gfn $GFN_METHOD --sp --molden --wbo --charges --dipole --fod --etemp 300 --json --chrg $CHARGE"

          if [ "$MULTIPLICITY" -gt 1 ]; then
            XTB_OPTS="$XTB_OPTS --uhf $UHF"
          fi

          if [ "$SOLVENT" != "none" ]; then
            XTB_OPTS="$XTB_OPTS --alpb $SOLVENT"
          fi
          
          # Run with all output options
          # --molden: Molecular orbitals in molden format
          # --wbo: Wiberg Bond Orders (bond strength analysis)
          # --charges: Mulliken atomic partial charges
          # --dipole: Dipole moment
          # --fod: Fractional Occupation Density (FOD) analysis
          # --etemp: Electronic temperature
          # --json: Comprehensive JSON output
          xtb molecule.xyz $XTB_OPTS
          
          echo "=== Calculation Complete ==="
          echo ""
          echo "=== Generated Files ==="
          ls -lh
          
          echo ""
          echo "=== Checking for additional cube files ==="
          # xTB may generate density cubes with certain flags
          if [ -f "density.cub" ]; then
            echo "âœ“ density.cub found (electron density)"
          fi
          if [ -f "spindens.cub" ]; then
            echo "âœ“ spindens.cub found (spin density)"
          fi
          if [ -f "fod.cub" ]; then
            echo "âœ“ fod.cub found (fractional occupation density)"
          fi
      
      - name: Display Molden output
        run: |
          echo "=== Molden File (first 200 lines) ==="
          head -200 molden.input
          
          echo ""
          echo "=== Molden File Size ==="
          ls -lh molden.input
      
      - name: Parse and display all properties
        run: |
          echo "=== ORBITAL ENERGIES ==="
          grep -A1 "Ene=" molden.input | head -50
          
          echo ""
          echo "Total molecular orbitals:"
          grep -c "Ene=" molden.input || echo "0"
          
          echo ""
          echo "=== ATOMIC CHARGES ==="
          if [ -f "charges" ]; then
            cat charges
          else
            echo "No charges file generated"
          fi
          
          echo ""
          echo "=== WIBERG BOND ORDERS ==="
          if [ -f "wbo" ]; then
            head -50 wbo
          else
            echo "No wbo file generated"
          fi
          
          echo ""
          echo "=== DIPOLE MOMENT ==="
          # Dipole is usually in xtbout.json or stdout
          if [ -f "xtbout.json" ]; then
            echo "JSON output available (contains dipole, energy, gap, etc.)"
            cat xtbout.json | head -100
          fi
          
          echo ""
          echo "=== FOD ANALYSIS ==="
          if [ -f "fod" ]; then
            cat fod
          else
            echo "No FOD file generated"
          fi
      
      - name: Upload ALL results
        uses: actions/upload-artifact@v4
        with:
          name: xtb-results-${{ github.run_id }}
          path: |
            molecule.xyz
            molden.input
            charges
            wbo
            xtbout.json
            fod
            xtb.out
            density.cub
            spindens.cub
            fod.cub
          retention-days: 7
      
      - name: Summary
        run: |
          echo "## xTB Calculation Complete! ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Molecule:** ${{ github.event.inputs.smiles }}" >> $GITHUB_STEP_SUMMARY
          echo "**Orbital requested:** ${{ github.event.inputs.orbital }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results uploaded as artifact. Download to view orbital coefficients." >> $GITHUB_STEP_SUMMARY
