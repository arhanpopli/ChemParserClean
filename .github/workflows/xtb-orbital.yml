name: xTB Orbital Calculation

on:
  workflow_dispatch:
    inputs:
      smiles:
        description: 'SMILES string of molecule'
        required: true
        default: 'O'
        type: string
      orbital:
        description: 'Orbital to visualize (homo, lumo, homo-1, etc.)'
        required: false
        default: 'homo'
        type: string

jobs:
  calculate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: xtb-env
          create-args: >-
            xtb
            openbabel
            -c conda-forge

      - name: Convert SMILES to XYZ
        shell: bash -l {0}
        run: |
          echo "Converting SMILES: '${{ github.event.inputs.smiles }}'"
          echo '${{ github.event.inputs.smiles }}' | obabel -ismi -oxyz --gen3d -O molecule.xyz
          
          if [ ! -f "molecule.xyz" ]; then
            echo "Error: molecule.xyz was not generated!"
            exit 1
          fi

      - name: Run xTB calculation
        shell: bash -l {0}
        run: |
          echo "=== Running xTB GFN2 calculation ==="
          xtb molecule.xyz --gfn 2 --sp --molden --json
          echo "=== Calculation Complete ==="
          ls -l
          
          # Show orbital energies
          if [ -f "xtbout.json" ]; then
            echo "=== Orbital Info from JSON ==="
            cat xtbout.json | head -100
          fi
      
      - name: Display Molden output
        run: |
          echo "=== Molden File (first 200 lines) ==="
          head -200 molden.input
          
          echo ""
          echo "=== Molden File Size ==="
          ls -lh molden.input
      
      - name: Parse orbital information
        run: |
          # Find HOMO (highest occupied)
          echo "=== Parsing Orbital Energies ==="
          grep -A1 "Ene=" molden.input | head -50
          
          # Count orbitals
          echo ""
          echo "Total molecular orbitals:"
          grep -c "Ene=" molden.input || echo "0"
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: xtb-results-${{ github.run_id }}
          path: |
            molecule.xyz
            molden.input
            xtbout.json
            charges
            wbo
          retention-days: 7
      
      - name: Summary
        run: |
          echo "## xTB Calculation Complete! ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Molecule:** ${{ github.event.inputs.smiles }}" >> $GITHUB_STEP_SUMMARY
          echo "**Orbital requested:** ${{ github.event.inputs.orbital }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results uploaded as artifact. Download to view orbital coefficients." >> $GITHUB_STEP_SUMMARY
