
/* Firefox CSP Bypass - Routes fetch through background script */
(function(){
  const _originalFetch = window.fetch;
  const CHEMSERVER = 'server-chemistryrenderer.vercel.app';
  
  window.fetch = async function(url, opts) {
    const urlStr = typeof url === 'string' ? url : url.toString();
    
    // Only intercept requests to our server
    if (urlStr.includes(CHEMSERVER)) {
      console.log('[Firefox CSP Bypass] Routing through background:', urlStr);
      
      return new Promise((resolve, reject) => {
        if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
          chrome.runtime.sendMessage(
            { type: 'FETCH_TEXT', url: urlStr, options: opts || {} },
            (response) => {
              if (chrome.runtime.lastError) {
                console.error('[Firefox CSP Bypass] Background error:', chrome.runtime.lastError.message);
                // Try original fetch as fallback
                _originalFetch(url, opts).then(resolve).catch(reject);
                return;
              }
              
              if (response && response.success) {
                // Create a fake Response object
                const headers = new Headers();
                headers.set('content-type', 'image/svg+xml');
                
                resolve(new Response(response.data, {
                  status: 200,
                  statusText: 'OK',
                  headers: headers
                }));
              } else {
                reject(new Error(response?.error || 'Background fetch failed'));
              }
            }
          );
        } else {
          // No chrome.runtime, try original
          _originalFetch(url, opts).then(resolve).catch(reject);
        }
      });
    }
    
    // Pass through for all other URLs
    return _originalFetch(url, opts);
  };
  
  console.log('[ChemistryLaTeX] Firefox CSP bypass installed');
})();

const CHEMISTRYLATEX_SERVER_URL="https://server-chemistryrenderer.vercel.app",CHEMISTRYLATEX_CACHE_VERSION="v6";let cacheBustTimestamp="";function buildServerSvgUrl(e,t,o={}){const r=["mol","smiles","iupac"].includes(e.toLowerCase());let l=t;if(r){const d=[];o.showCarbons&&d.push("c"),o.aromaticCircles&&d.push("o"),o.showMethyls&&d.push("m"),o.atomNumbers&&d.push("n"),o.showHydrogens&&d.push("h"),o.showImplicitH&&d.push("i"),o.gradientColors&&d.push("g"),o.useStereochemistry&&d.push("s"),o.compactDrawing&&d.push("k"),o.flipHorizontal&&d.push("p"),o.flipVertical&&d.push("q"),d.sort(),d.length>0&&(l=`${t}+${d.join("+")}`)}const a=new URLSearchParams;a.set("_v","v6"),cacheBustTimestamp&&a.set("_t",cacheBustTimestamp);const m={rdkit:"/rdkit",kekule:"/kekule"}[o.renderingEngine]||"",c=a.toString();return`${CHEMISTRYLATEX_SERVER_URL}${m}/${e}=${encodeURIComponent(l)}.svg${c?"?"+c:""}`}async function fetchFromChemistryLaTeXServer(e,t){const o=`${CHEMISTRYLATEX_SERVER_URL}/${e}=${encodeURIComponent(t)}.json`,i=await fetch(o);if(!i.ok)throw new Error(`Server returned ${i.status}`);return i.json()}const ELEMENT_MARKERS={C:"#101010",H:"#181818",N:"#202020",O:"#282828",S:"#303030",P:"#383838",F:"#404040",CL:"#484848",BR:"#505050",I:"#585858",B:"#606060",SI:"#686868",ATOM_NUMBER:"#707070"},THEME_COLORS={light:{C:"#222222",H:"#666666",N:"#3498db",O:"#e74c3c",S:"#f1c40f",P:"#d35400",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",B:"#e67e22",SI:"#e67e22",ATOM_NUMBER:"#2196F3"},dark:{C:"#ffffff",H:"#aaaaaa",N:"#4dabf7",O:"#ff6b6b",S:"#fcc419",P:"#fd7e14",F:"#51cf66",CL:"#20c997",BR:"#fd7e14",I:"#be4bdb",B:"#f59f00",SI:"#f59f00",ATOM_NUMBER:"#ffd700"},classic_black:{C:"#000000",H:"#000000",N:"#000000",O:"#000000",S:"#000000",P:"#000000",F:"#000000",CL:"#000000",BR:"#000000",I:"#000000",B:"#000000",SI:"#000000",ATOM_NUMBER:"#000000"},classic_white:{C:"#ffffff",H:"#ffffff",N:"#ffffff",O:"#ffffff",S:"#ffffff",P:"#ffffff",F:"#ffffff",CL:"#ffffff",BR:"#ffffff",I:"#ffffff",B:"#ffffff",SI:"#ffffff",ATOM_NUMBER:"#ffffff"},warm_paper:{C:"#586e75",H:"#657b83",N:"#268bd2",O:"#dc322f",S:"#b58900",P:"#d33682",F:"#859900",CL:"#16a085",BR:"#cb4b16",I:"#6c71c4",B:"#2aa198",SI:"#2aa198",ATOM_NUMBER:"#2196F3"},terminal_green:{C:"#00FF41",H:"#008F11",N:"#003B00",O:"#0D0208",S:"#00FF41",P:"#00FF41",F:"#00FF41",CL:"#00FF41",BR:"#00FF41",I:"#00FF41",B:"#00FF41",SI:"#00FF41",ATOM_NUMBER:"#00FF41"},modern_dark:{C:"#c9d1d9",H:"#8b949e",N:"#58a6ff",O:"#f85149",S:"#d29922",P:"#db6d28",F:"#3fb950",CL:"#3fb950",BR:"#db6d28",I:"#a371f7",B:"#db6d28",SI:"#db6d28",ATOM_NUMBER:"#58a6ff"},carbon:{C:"#f4f4f4",H:"#a8a8a8",N:"#4589ff",O:"#fa4d56",S:"#f1c21b",P:"#ff832b",F:"#42be65",CL:"#42be65",BR:"#ff832b",I:"#a56eff",B:"#ff832b",SI:"#ff832b",ATOM_NUMBER:"#4589ff"}};function applyThemeColors(e,t){const o=THEME_COLORS[t]||THEME_COLORS.light;let i=e;for(const[r,l]of Object.entries(ELEMENT_MARKERS)){const a=o[r]||l,n=new RegExp(l,"gi");i=i.replace(n,a)}return i}window.addEventListener("error",function(e){if(e.filename&&e.filename.includes("chrome-extension://"))return e.preventDefault(),!0}),window.addEventListener("unhandledrejection",function(e){const t=e.reason;if(t&&t.stack&&t.stack.includes("ChemRenderer")||t&&t.message&&t.message.includes("Extension context invalidated"))return e.preventDefault(),!0});const LOG_PREFIX="[ChemRenderer]",log={info:(e,t)=>{},success:(e,t)=>{},warn:(e,t)=>{},error:(e,t)=>{},debug:(e,t)=>{},inject:(e,t)=>{}};let logHistory=[],extensionContextInvalid=!1;const renderedImageCache=new Map,MAX_IMAGE_CACHE_SIZE=100;function generateImageCacheKey(e,t={}){const o=[t.showCarbons?"c1":"c0",t.showMethyls?"m1":"m0",t.aromaticCircles?"a1":"a0",t.showHydrogens?"h1":"h0",t.atomNumbers?"n1":"n0",t.theme||"light",t.width||300,t.height||240].join("_");return`${e}__${o}`}const SMILES_CACHE_KEY="chemistrylatex_smiles_cache",SMILES_CACHE_MAX_SIZE=500;let smilesCache={},smilesCacheLoaded=!1;async function loadSmilesCache(){if(smilesCacheLoaded)return smilesCache;try{smilesCache=(await chrome.storage.local.get(SMILES_CACHE_KEY))[SMILES_CACHE_KEY]||{},smilesCacheLoaded=!0,log.info(`\u{1F4E6} Loaded SMILES cache: ${Object.keys(smilesCache).length} entries`)}catch(e){log.warn("Failed to load SMILES cache:",e),smilesCache={}}return smilesCache}async function saveSmilesCache(){try{const e=Object.keys(smilesCache);if(e.length>SMILES_CACHE_MAX_SIZE){const t=e.length-SMILES_CACHE_MAX_SIZE;e.slice(0,t).forEach(o=>delete smilesCache[o])}await chrome.storage.local.set({[SMILES_CACHE_KEY]:smilesCache})}catch(e){log.warn("Failed to save SMILES cache:",e)}}async function getCachedSmiles(e){await loadSmilesCache();const t=e.toLowerCase().trim(),o=smilesCache[t];return o?(log.debug(`\u{1F3AF} SMILES cache HIT: ${e}`),o.smiles&&!o.canonicalSmiles&&!o.isomericSmiles&&(log.debug(`\u{1F504} Migrating old cache format for: ${e}`),o.isomericSmiles=o.smiles,o.canonicalSmiles=stripStereochemistry(o.smiles),delete o.smiles,smilesCache[t]=o,clearTimeout(setCachedSmiles._saveTimeout),setCachedSmiles._saveTimeout=setTimeout(()=>saveSmilesCache(),1e3)),o):null}async function setCachedSmiles(e,t){await loadSmilesCache();const o=e.toLowerCase().trim();smilesCache[o]={...t,cachedAt:Date.now()},clearTimeout(setCachedSmiles._saveTimeout),setCachedSmiles._saveTimeout=setTimeout(()=>saveSmilesCache(),1e3);const i=t.isomericSmiles||t.canonicalSmiles||"N/A";log.debug(`\u{1F4E6} Cached SMILES: ${e} \u2192 canonical: ${t.canonicalSmiles?.substring(0,25)||"N/A"}, isomeric: ${t.isomericSmiles?.substring(0,25)||"N/A"}`)}const pendingSearches=new Map,MAX_PENDING_SEARCHES=50;async function getOrCreatePendingSearch(e,t){const o=e.toLowerCase().trim();if(pendingSearches.has(o))return log.debug(`\u{1F504} Reusing pending search for: ${e}`),pendingSearches.get(o);pendingSearches.size>=MAX_PENDING_SEARCHES&&(log.warn(`\u26A0\uFE0F Too many pending searches (${pendingSearches.size}), clearing old ones...`),Array.from(pendingSearches.keys()).slice(0,Math.floor(MAX_PENDING_SEARCHES/2)).forEach(l=>pendingSearches.delete(l)));const i=t().finally(()=>{pendingSearches.delete(o)});return pendingSearches.set(o,i),log.debug(`\u{1F195} Started new search for: ${e}`),i}function clearAllCaches(){renderedImageCache.clear(),smilesCache={},smilesCacheLoaded=!1,pendingSearches.clear(),chrome.storage.local.remove(SMILES_CACHE_KEY),cacheBustTimestamp=Date.now().toString(),log.info(`\u{1F5D1}\uFE0F Cache cleared! New cache bust timestamp: ${cacheBustTimestamp}`)}function stripStereochemistry(e){return e&&e.replace(/@@|@|\/|\\/g,"")}const renderedMolecules=new Map;function getAffectedImageTypes(e){const t=new Set,o=["sdShowCarbons","sdAromaticRings","sdShowMethyls","sdAtomNumbers","sdShowExplicitHydrogens","sdShowImplicitHydrogens","sdFlipHorizontal","sdFlipVertical","sdTheme","sdAutoAdapt","sdRotate","sdBondThickness","sdGradientColors","sdScaleByWeight","m2cfShowCarbons","m2cfAromaticCircles","m2cfShowMethyls","m2cfAtomNumbers","m2cfAddH2","m2cfShowImplicitH","m2cfFlipHorizontal","m2cfFlipVertical"],i=["molviewRepresentation","compoundMolviewBgColor","molviewEngine"],r=["proteinRemoveWhiteBg","viewer3DStyle","viewer3DAutoRotate","viewer3DBgColor","viewer3DSize","molviewChainType","molviewChainBonds","molviewChainColor","proteinMolviewBgColor","molviewBioAssembly"],l=["mineralRepresentation","mineralMolviewBgColor","mineralCrystallography"],a=["performanceMode","enableAIFlagControl"],n=Object.keys(e);for(const m of n)(o.includes(m)||i.includes(m))&&t.add("compound"),r.includes(m)&&t.add("biomolecule"),l.includes(m)&&t.add("mineral"),a.includes(m)&&(t.add("compound"),t.add("biomolecule"),t.add("mineral"));return t.size===0&&(t.add("compound"),t.add("biomolecule"),t.add("mineral")),t}async function reRenderAllMolecules(e){return log.info("\u{1F504} Re-rendering all molecules with lazy loading..."),lazyReRenderMolecules(e)}let pendingReRenderSettings=null,pendingUpdateIndicator=null,isUpdatingImages=!1;function addLoadingIndicator(e){if(e.dataset.hasLoadingIndicator==="true")return;const t=document.createElement("div");t.className="chemistrylatex-image-loading-indicator",t.setAttribute("aria-label","Updating image"),t.style.cssText=`
    position: absolute;
    top: 50%;
    left: 10px;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid rgba(255, 71, 87, 0.25);
    border-top-color: #ff4757;
    z-index: 10;
    animation: chemtex-spin 0.9s linear infinite;
    pointer-events: none;
  `;const o=e.parentElement;if(o&&(window.getComputedStyle(o).position==="static"&&(o.style.position="relative"),o.appendChild(t)),!document.getElementById("chemtex-loading-indicator-style")){const i=document.createElement("style");i.id="chemtex-loading-indicator-style",i.textContent=`
      @keyframes chemtex-spin {
        from { transform: translateY(-50%) rotate(0deg); }
        to { transform: translateY(-50%) rotate(360deg); }
      }
      @keyframes chemtex-fade-in {
        from { opacity: 0.65; }
        to { opacity: 1; }
      }
    `,document.head.appendChild(i)}e.dataset.hasLoadingIndicator="true",e.dataset.loadingIndicatorElement="true"}function removeLoadingIndicator(e){if(e.dataset.hasLoadingIndicator!=="true")return;const t=e.parentElement;if(t){const o=t.querySelector(".chemistrylatex-image-loading-indicator");o&&o.remove()}delete e.dataset.hasLoadingIndicator,delete e.dataset.loadingIndicatorElement}function applyAverageSizeScaling(e){const t=e/100,o=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let i=0;o.forEach(r=>{if(r.closest(".molecule-3d-viewer")||r.closest(".molecule-viewer-container")||r.closest(".biomolecule-viewer")||(r.dataset.compoundType||"")==="biomolecule")return;const a=r.src||"";if(!(a.includes("data:image/svg")||a.endsWith(".svg")))return;const m=r.closest(".molecule-container, .chem-image-container");if(m){const c=r.naturalWidth||parseInt(r.style.width)||r.offsetWidth||300,f=r.naturalHeight||parseInt(r.style.height)||r.offsetHeight||240,d=Math.round(c*t),S=Math.round(f*t);m.style.width=d+"px",m.style.height=S+"px",r.style.width="100%",r.style.height="100%",r.style.transform=""}else{const c=r.naturalWidth||parseInt(r.style.width)||r.offsetWidth||300,f=r.naturalHeight||parseInt(r.style.height)||r.offsetHeight||240;r.style.width=Math.round(c*t)+"px",r.style.height=Math.round(f*t)+"px"}i++})}async function lazyReRenderMolecules(e){if(isUpdatingImages=!0,Object.assign(settings,e),e.sdShowCarbons!==void 0&&(settings.m2cfShowCarbons=e.sdShowCarbons),e.sdAromaticRings!==void 0&&(settings.m2cfAromaticCircles=e.sdAromaticRings),e.sdShowMethyls!==void 0&&(settings.m2cfShowMethyls=e.sdShowMethyls),e.sdAtomNumbers!==void 0&&(settings.m2cfAtomNumbers=e.sdAtomNumbers),e.sdShowExplicitHydrogens!==void 0&&(settings.m2cfAddH2=e.sdShowExplicitHydrogens),e.sdShowImplicitHydrogens!==void 0&&(settings.m2cfShowImplicitH=e.sdShowImplicitHydrogens),e.sdCompactDrawing!==void 0&&(settings.m2cfCompactDrawing=e.sdCompactDrawing),e.sdFlipHorizontal!==void 0&&(settings.m2cfFlipHorizontal=e.sdFlipHorizontal),e.sdFlipVertical!==void 0&&(settings.m2cfFlipVertical=e.sdFlipVertical),e.sdGradientColors!==void 0&&(settings.sdGradientColors=e.sdGradientColors),e.sdTheme!==void 0&&(settings.sdTheme=e.sdTheme),e.sdAutoAdapt!==void 0&&(settings.sdAutoAdapt=e.sdAutoAdapt),e.sdBondThickness!==void 0&&(settings.sdBondThickness=e.sdBondThickness),e.sdRotate!==void 0&&(settings.m2cfRotate=e.sdRotate),e.useStereochemistry!==void 0&&(settings.m2cfUse3DSmiles=e.useStereochemistry),e.sdAverageSize!==void 0){settings.sdAverageSize=e.sdAverageSize,applyAverageSizeScaling(e.sdAverageSize),isUpdatingImages=!1;return}e.compound3DSize!==void 0&&(settings.compound3DSize=e.compound3DSize),e.mineral3DSize!==void 0&&(settings.mineral3DSize=e.mineral3DSize);const t=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");if(t.length===0){isUpdatingImages=!1;return}let o=0;for(const r of t)try{const l=r.dataset.smiles||"",a=r.dataset.originalNomenclature,n=r.dataset.nomenclature,m=E=>!(!E||E==="molecule"||E.includes("Error loading")||E.includes("Server returned")||E.includes("Failed to"));let c=a||n||"";if(!m(c))continue;const f=r.dataset.compoundType||"compound";if(!c||c==="molecule")continue;let d={},S=null;if(r.dataset.moleculeViewer)try{const E=JSON.parse(atob(r.dataset.moleculeViewer));d=E.flags||{},S=E.smiles||null}catch{}let b;if(f==="compound"){const E=S||l||null;b={nomenclature:c,smiles:E,type:E?"smiles":"nomenclature",options:{width:parseInt(r.dataset.renderWidth)||300,height:parseInt(r.dataset.renderHeight)||240,aromaticCircles:settings.m2cfAromaticCircles,showCarbons:settings.m2cfShowCarbons,showMethyls:settings.m2cfShowMethyls,atomNumbers:settings.m2cfAtomNumbers,addH2:settings.m2cfAddH2,showImplicitH:settings.m2cfShowImplicitH,flipHorizontal:settings.m2cfFlipHorizontal,flipVertical:settings.m2cfFlipVertical,scale:1,rotation:parseInt(r.dataset.rotation)||0},isMoleculeViewer:!0,flags:{...d,useDefaults:!1,compoundType:"compound",isDirectSmiles:d.isDirectSmiles||!1,isIUPAC:d.isIUPAC||!1,smilesValue:d.smilesValue||E,iupacValue:d.iupacValue||null}}}else if(f==="biomolecule")b={nomenclature:c,type:"nomenclature",options:{width:parseInt(r.dataset.renderWidth)||300,height:parseInt(r.dataset.renderHeight)||240,removeWhiteBg:settings.proteinRemoveWhiteBg,bioAssembly:settings.molviewBioAssembly,chainType:settings.molviewChainType,chainBonds:settings.molviewChainBonds,chainColor:settings.molviewChainColor,proteinBgColor:settings.proteinMolviewBgColor},isMoleculeViewer:!0,flags:{...d,useDefaults:!1,compoundType:"biomolecule"}};else if(f==="mineral")b={nomenclature:c,type:"nomenclature",options:{width:parseInt(r.dataset.renderWidth)||300,height:parseInt(r.dataset.renderHeight)||240,representation:settings.mineralRepresentation,mineralBgColor:settings.mineralMolviewBgColor,crystallography:settings.mineralCrystallography},isMoleculeViewer:!0,flags:{...d,useDefaults:!1,compoundType:"mineral"}};else{const E=S||l||null;b={nomenclature:c,smiles:E,type:E?"smiles":"nomenclature",options:{width:parseInt(r.dataset.renderWidth)||300,height:parseInt(r.dataset.renderHeight)||240},isMoleculeViewer:!0,flags:{...d,useDefaults:!0,compoundType:f}}}const g=btoa(JSON.stringify(b)),u=document.createElement("img");u.className="molecule-diagram molecule-viewer",u.alt=c,u.dataset.moleculeViewer=g,u.dataset.loaded="false",u.dataset.rotation=r.dataset.rotation||"0",u.dataset.nomenclature=c,u.dataset.compoundType=f,b.smiles&&(u.dataset.smiles=b.smiles),u.style.cssText="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;";const M=r.closest(".molecule-container")||r.parentNode;if(M&&M.parentNode)M.parentNode.replaceChild(u,M);else if(r.parentNode)r.parentNode.replaceChild(u,r);else continue;window._loadMoleculeImage&&(window._loadMoleculeImage(u),o++)}catch{}const i=document.querySelectorAll('img.molecule-diagram[data-loaded="false"], img.molecule-viewer[data-loaded="false"]');i.length>0&&window._lazyLoadObserver&&i.forEach(r=>{window._lazyLoadObserver.observe(r)}),settings.sdAverageSize&&settings.sdAverageSize!==100&&setTimeout(()=>{applyAverageSizeScaling(settings.sdAverageSize)},500),isUpdatingImages=!1}let lazyReRenderObserver=null;const imagesBeingRendered=new Set,MAX_IMAGES_BEING_RENDERED=20;function setupLazyReRenderObserver(){if(lazyReRenderObserver)try{lazyReRenderObserver.disconnect()}catch{}lazyReRenderObserver=new IntersectionObserver(e=>{e.forEach(t=>{if(t.isIntersecting){const o=t.target;processImageIfNeeded(o)}})},{rootMargin:"50px",threshold:.1}),document.querySelectorAll("img[data-molecule-viewer]").forEach(e=>{lazyReRenderObserver.observe(e)}),triggerVisibleImagesReRender()}function processImageIfNeeded(e){const t=e.dataset.smiles||"(no smiles)",o=e.dataset.compoundName||"(no name)";if(!(e.dataset.needsReRender!=="true"&&e.getAttribute("data-needs-re-render")!=="true")){if(imagesBeingRendered.has(e)){log.debug(`\u23ED\uFE0F Image already being processed: ${o}`);return}imagesBeingRendered.size>=MAX_IMAGES_BEING_RENDERED||(log.info(`\u{1F504} Processing image for lazy re-render: ${o} (SMILES: ${t?.substring?.(0,30)||"N/A"}...)`),imagesBeingRendered.add(e),addLoadingIndicator(e),reRenderSingleMolecule(e,pendingReRenderSettings||settings).then(()=>{delete e.dataset.needsReRender,e.removeAttribute("data-needs-re-render"),log.debug("\u2705 Successfully re-rendered molecule")}).catch(i=>{log.error("Failed to re-render molecule:",i),delete e.dataset.needsReRender,e.removeAttribute("data-needs-re-render")}).finally(()=>{removeLoadingIndicator(e),imagesBeingRendered.delete(e)}))}}function triggerVisibleImagesReRender(){const e=document.querySelectorAll('img[data-molecule-viewer][data-needs-re-render="true"]');let t=0;e.forEach(o=>{const i=o.getBoundingClientRect();i.top<window.innerHeight&&i.bottom>0&&i.width>0&&i.height>0&&(t++,processImageIfNeeded(o))})}async function reRenderSingleMolecule(e,t){try{const o=e.dataset.smiles,i=e.dataset.moleculeName||e.dataset.nomenclature,r=e.dataset.compoundType||"compound";if(r==="biomolecule"||r==="mineral"){log.debug(`Skipping re-render for ${r} (uses different renderer)`);return}if(!o&&!i){log.debug("Skipping re-render: no SMILES or name data on image");return}let l={},a=null;if(e.dataset.moleculeViewer)try{const S=JSON.parse(atob(e.dataset.moleculeViewer));l=S.flags||{},a=S.smiles||null}catch{}const n={showCarbons:settings.m2cfShowCarbons,showMethyls:settings.m2cfShowMethyls,aromaticCircles:settings.m2cfAromaticCircles,showHydrogens:settings.m2cfAddH2,showImplicitH:settings.m2cfShowImplicitH,atomNumbers:settings.m2cfAtomNumbers,gradientColors:settings.sdGradientColors,compactDrawing:settings.m2cfCompactDrawing,useStereochemistry:settings.m2cfUse3DSmiles,flipHorizontal:settings.m2cfFlipHorizontal,flipVertical:settings.m2cfFlipVertical,renderingEngine:settings.renderingEngine};let m,c;const f=a||o;l.isDirectSmiles&&(l.smilesValue||f)?(m="smiles",c=l.smilesValue||f):l.isIUPAC&&l.iupacValue?(m="iupac",c=l.iupacValue):f?(m="smiles",c=f):(m="mol",c=i);const d=buildServerSvgUrl(m,c,n);log.debug(`\u{1F5BC}\uFE0F Re-rendering via server: ${d}`),await new Promise((S,b)=>{const g=new Image;g.onload=()=>{log.debug("\u2705 New image pre-loaded successfully"),S()},g.onerror=u=>{log.error("\u274C Failed to pre-load new image:",u),b(u)},g.src=d}),log.debug("\u{1F504} Swapping image src..."),e.style.animation="chemtex-fade-in 160ms ease-out",e.src=d,log.debug("\u2705 Image src updated successfully"),setTimeout(()=>{try{e.style.animation=""}catch{}},220)}catch(o){throw log.error("Error re-rendering single molecule:",o),o}}async function reloadAllImages(){log.info("\u{1F504} Reloading all images (forced refresh)...");const e=document.querySelectorAll("img[data-molecule-viewer]");let t=0;for(const o of e){addLoadingIndicator(o);try{await reRenderSingleMolecule(o,settings),t++}catch(i){log.error("Failed to reload image:",i)}finally{removeLoadingIndicator(o)}}log.success(`\u2705 Reloaded ${t} images`)}function applyCssOnlySettings(e){document.querySelectorAll('img[data-molecule-viewer="true"]').forEach(i=>{const r=i.dataset.rawSvg;if(r){const l=decodeURIComponent(r),a=applyThemeColors(l,e.sdTheme||"light");i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)}e.sdGradientColors?i.classList.add("gradient-bonds"):i.classList.remove("gradient-bonds")}),document.querySelectorAll("iframe.biomolecule-viewer, .molecule-3d-viewer").forEach(i=>{e.proteinRemoveWhiteBg?(i.style.filter="drop-shadow(0 0 0 transparent)",i.style.mixBlendMode="multiply"):(i.style.filter="",i.style.mixBlendMode="")})}chrome.runtime.onMessage.addListener((e,t,o)=>{try{if(e.type==="APPLY_SETTINGS"){log.info("\u{1F4EC} Received settings update from popup:",e.settings);const i=["proteinRemoveWhiteBg","sdGradientColors","sdAutoAdapt"],r=e.changedSettings||[];if(r.length>0&&r.every(a=>i.includes(a)))return applyCssOnlySettings(e.settings),o({success:!0,cssOnly:!0}),!0;try{lazyReRenderMolecules(e.settings)}catch{}return o({success:!0}),!0}if(e.type==="RELOAD_ALL_IMAGES"){log.info("\u{1F4EC} Received reload all images command");try{reloadAllImages()}catch{}return o({success:!0}),!0}if(e.type==="CLEAR_CACHE")return clearAllCaches(),chrome.storage.sync.get(null,i=>{lazyReRenderMolecules(i)}),o({success:!0,message:"Cache cleared, re-rendering with fresh content"}),!0}catch(i){return o({success:!1,error:i.message}),!0}});function isDarkModeEnabled(){if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return!0;try{const t=window.getComputedStyle(document.documentElement),o=window.getComputedStyle(document.body);if((t.colorScheme||o.colorScheme||"").includes("dark"))return!0}catch{}try{const t=[document.documentElement,document.body];for(const o of t){if(!o)continue;const i=window.getComputedStyle(o).backgroundColor;if(i&&i!=="rgba(0, 0, 0, 0)"&&i!=="transparent"){const r=i.match(/\d+/g);if(r&&r.length>=3){const l=.299*parseInt(r[0])+.587*parseInt(r[1])+.114*parseInt(r[2]);if(l<100)return!0;if(l>180)return!1}}}}catch{}const e=["dark","dark-mode","dark-theme","night-mode","skin-minerva-dark","client-dark-mode"];for(const t of e)if(document.body?.classList?.contains(t)||document.documentElement?.classList?.contains(t))return!0;try{const t=document.documentElement.getAttribute("data-theme")||document.body.getAttribute("data-theme")||document.documentElement.getAttribute("data-color-mode")||document.body.getAttribute("data-color-mode")||"";if(t.toLowerCase().includes("dark")||t.toLowerCase().includes("night"))return!0}catch{}return!1}function isExtensionContextValid(){try{return!(extensionContextInvalid||!chrome.runtime||!chrome.runtime.id)}catch{return!1}}async function backgroundFetchBlob(e){try{if(!isExtensionContextValid())return directFetchBlob(e);if(chrome.runtime&&chrome.runtime.sendMessage)return new Promise((t,o)=>{chrome.runtime.sendMessage({type:"FETCH_BLOB",url:e},i=>{if(chrome.runtime.lastError){chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("Extension context invalidated")&&(extensionContextInvalid=!0),directFetchBlob(e).then(t).catch(o);return}i&&i.success?t(i.data):o(new Error(i?.error||"Background blob fetch failed"))})})}catch(t){t.message&&t.message.includes("Extension context invalidated")&&(extensionContextInvalid=!0)}return directFetchBlob(e)}async function directFetchBlob(e){const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText} `);const o=await t.blob();return new Promise((i,r)=>{const l=new FileReader;l.onloadend=()=>{const a=l.result.split(",")[1];i({base64:a,type:o.type})},l.onerror=r,l.readAsDataURL(o)})}async function smilesBridge(e,t={}){const{use3DSmiles:o=!1}=t;if(!e||typeof e!="string")return null;const i=stripFlagsFromName(e.trim());if(!i)return null;try{const r=`${CHEMISTRYLATEX_SERVER_URL}/search/${encodeURIComponent(i)}?type=compound`,l=await fetch(r);if(l.ok){const a=await l.json();if(a&&a.smiles)return{smiles:o&&a.isomericSmiles?a.isomericSmiles:a.smiles,source:"ChemTex-Server",cid:a.cid}}}catch{}return null}window.smilesBridge=smilesBridge;async function getCompoundID(e){if(!e||typeof e!="string")return null;const t=e.trim(),o=await smilesBridge(t,{use3DSmiles:!1});return o&&o.cid?o.cid:null}window.getCompoundID=getCompoundID,window.getCompoundID=getCompoundID;var SIZE_STEP=typeof SIZE_STEP<"u"?SIZE_STEP:20,MIN_SIZE=typeof MIN_SIZE<"u"?MIN_SIZE:100,MAX_SIZE=typeof MAX_SIZE<"u"?MAX_SIZE:800,DEFAULT_WIDTH=typeof DEFAULT_WIDTH<"u"?DEFAULT_WIDTH:400,DEFAULT_HEIGHT=typeof DEFAULT_HEIGHT<"u"?DEFAULT_HEIGHT:350,BASE_SIZE=typeof BASE_SIZE<"u"?BASE_SIZE:150,SIZE_SCALE_FACTOR=typeof SIZE_SCALE_FACTOR<"u"?SIZE_SCALE_FACTOR:.5,MAX_DEFAULT_SIZE=typeof MAX_DEFAULT_SIZE<"u"?MAX_DEFAULT_SIZE:400;function getImageKey(e){return e?e.smiles?`smiles:${e.smiles}`:e.nomenclature?`nomenclature:${e.nomenclature}`:null:null}function getPageImageKey(e,t){const o=getImageKey(e);return o?`page:${t}:${o}`:null}async function loadImageSize(e,t,o){try{const i=getImageKey(e);if(!i)return{};if(!o.saveSizePerImage&&!o.saveSizeBySMILES)return{};let r;return o.saveSizePerImage&&!o.saveSizeBySMILES?r=getPageImageKey(e,t):r=i,r?new Promise(l=>{chrome.storage.local.get([r],a=>{if(a[r])if(a[r].scale)l(a[r]);else{const n=a[r].width?a[r].width/DEFAULT_WIDTH:void 0;l(n!==void 0?{scale:n}:{})}else l({})})}):{}}catch{return{}}}async function saveImageSize(e,t,o,i){try{const r=getImageKey(e);if(!r||!i.saveSizePerImage&&!i.saveSizeBySMILES)return;let l;if(i.saveSizePerImage&&!i.saveSizeBySMILES?l=getPageImageKey(e,t):l=r,!l)return;const a={};a[l]=o,chrome.storage.local.set(a,()=>{})}catch{}}function createSizeControls(e,t,o,i){const r=document.createElement("div");r.className="chem-size-controls",r.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex !important;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    pointer-events: auto;
    transition: opacity 0.2s;
    z-index: 1000;
  `;const l=document.createElement("button");l.className="chem-size-btn chem-size-up",l.innerHTML="\u25B2",l.title="Increase size",l.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    pointer-events: auto;
  `;const a=document.createElement("button");return a.className="chem-size-btn chem-size-down",a.innerHTML="\u25BC",a.title="Decrease size",a.style.cssText=l.style.cssText,[l,a].forEach(n=>{n.addEventListener("mouseenter",()=>{n.style.background="rgba(0, 0, 0, 0.9)"}),n.addEventListener("mouseleave",()=>{n.style.background="rgba(0, 0, 0, 0.7)"})}),l.addEventListener("click",n=>{n.stopPropagation(),adjustImageSize(e,t,o,SIZE_STEP,i)}),a.addEventListener("click",n=>{n.stopPropagation(),adjustImageSize(e,t,o,-SIZE_STEP,i)}),r.appendChild(l),r.appendChild(a),e.addEventListener("mouseenter",()=>{r.style.opacity="1"}),e.addEventListener("mouseleave",()=>{r.style.opacity="0"}),r}function adjustImageSize(e,t,o,i,r){let l=parseFloat(t.dataset.scale)||1;const a=i/100;let n=l+a;n=Math.max(.5,Math.min(5,n)),t.dataset.scale=n.toString();const c=(t.style.transform||"").replace(/scale\([^)]+\)\s*/g,"");t.style.transform=`${c} scale(${n})`.trim(),t.style.transformOrigin="top left";const f=window.location.href;saveImageSize(o,f,{scale:n},r)}async function wrapImageWithSizeControls(e,t,o,i){try{const r=document.createElement("div");r.className="chem-image-container",r.style.cssText=`
      position: relative;
      display: inline-block;
      margin: 0 12px 8px 0;
      vertical-align: middle;
      overflow: hidden;
      max-width: 100%;
    `;const l=window.location.href,a=await loadImageSize(o,l,i);let n=1.5;const m=()=>{let g=e.naturalWidth||e.width||0,u=e.naturalHeight||e.height||0;if((!g||!u)&&e.src&&e.src.startsWith("data:image/svg+xml"))try{let M;e.src.includes("base64,")?M=atob(e.src.split("base64,")[1]):M=decodeURIComponent(e.src.split(",")[1]);const E=M.match(/width\s*=\s*["']?(\d+(?:\.\d+)?)/i),A=M.match(/height\s*=\s*["']?(\d+(?:\.\d+)?)/i);if(E&&(g=parseFloat(E[1])),A&&(u=parseFloat(A[1])),!g||!u){const I=M.match(/viewBox\s*=\s*["']?[\d.]+\s+[\d.]+\s+([\d.]+)\s+([\d.]+)/i);I&&(g=g||parseFloat(I[1]),u=u||parseFloat(I[2]))}}catch{}return{width:g,height:u}},{width:c,height:f}=m();if(c>0&&f>0){const g=Math.sqrt(c*c+f*f);n=1.5*Math.pow(300/g,.5),n=Math.max(.4,Math.min(2,n))}const d=a.scale||n;e.dataset.scale=d.toString(),e.dataset.fixedSize||(e.complete?applyScaleToImage(e,d):(e.onload=()=>applyScaleToImage(e,d),setTimeout(()=>applyScaleToImage(e,d),100))),o&&(e.dataset.moleculeData=JSON.stringify(o));const S=createSizeControls(r,e,o,i);t.parentNode.insertBefore(r,t),r.appendChild(e),r.appendChild(S),t.remove();const b=o.flags?.displayName||o.nomenclature||o.smiles||"Unknown";return addHoverControls(r,b,o),r}catch{if(t&&t.parentNode&&e)try{t.parentNode.replaceChild(e,t)}catch{}return e}}function applyScaleToImage(e,t){let o=e.naturalWidth||e.width,i=e.naturalHeight||e.height;if((!o||o===0)&&e.src&&e.src.startsWith("data:image/svg+xml"))try{let a;e.src.includes("base64,")?a=atob(e.src.split("base64,")[1]):a=decodeURIComponent(e.src.split(",")[1]);const n=a.match(/width\s*=\s*["']?(\d+(?:\.\d+)?)/i),m=a.match(/height\s*=\s*["']?(\d+(?:\.\d+)?)/i);if(n&&(o=parseFloat(n[1])),m&&(i=parseFloat(m[1])),!o||!i){const c=a.match(/viewBox\s*=\s*["']?[\d.]+\s+[\d.]+\s+([\d.]+)\s+([\d.]+)/i);c&&(o=o||parseFloat(c[1]),i=i||parseFloat(c[2]))}}catch{}const r=600,l=500;if(e.style.maxWidth=`${r}px`,e.style.maxHeight=`${l}px`,t&&t!==1){const n=(e.style.transform||"").replace(/scale\([^)]+\)\s*/g,"");e.style.transform=`${n} scale(${t})`.trim(),e.style.transformOrigin="top left"}}window.chemRendererDebug={getSettings:()=>settings,scanPage:()=>scanAndRender(),clearCache:()=>clearAllCaches(),async getCacheStats(){return await loadSmilesCache(),{smiles:Object.keys(smilesCache).length,images:renderedImageCache.size}}},window.chemRendererPerformance={recordStructure(){},recordLoad(){},recordFormula(){}},log.info("ChemTex loaded");let settings={enabled:!0,performanceMode:!0,maxVisibleSVGs:5,sizePreset:"auto",rendererEngine:"chemtex",devMode:!1,flipHorizontal:!1,flipVertical:!1,use3DSmiles:!1,sdShowCarbons:!0,sdAromaticCircles:!0,sdShowMethyls:!0,sdCompactDrawing:!0,sdTheme:"light",sdAutoAdapt:!0,enable3DViewer:!1,viewer3DSource:"molview",viewer3DSize:"normal",viewer3DStyle:"stick",molviewRepresentation:"ballAndStick",compoundMolviewBgColor:"black",molviewEngine:"glmol",proteinRemoveWhiteBg:!1,molviewChainType:"ribbon",molviewChainBonds:!1,molviewChainColor:"ss",proteinMolviewBgColor:"black",molviewBioAssembly:!1,bioAssemblyViewer:"molstar",bioAssemblyGraphics:"balanced",bioAssemblyPdbProvider:"rcsb",mineralRepresentation:"ballAndStick",mineralMolviewBgColor:"black",mineralCrystallography:"supercell_2x2x2"};log.info("\u{1F4E6} Loading settings from storage..."),chrome.storage.sync.get(null,e=>{settings={...settings,...e},settings.rendererEngine="chemtex",settings.m2cfShowCarbons=e.sdShowCarbons!==void 0?e.sdShowCarbons:!0,settings.m2cfAromaticCircles=e.sdAromaticRings!==void 0?e.sdAromaticRings:!0,settings.m2cfShowMethyls=e.sdShowMethyls!==void 0?e.sdShowMethyls:!0,settings.m2cfAtomNumbers=e.sdAtomNumbers===!0,settings.m2cfAddH2=e.sdShowExplicitHydrogens===!0,settings.m2cfShowImplicitH=e.sdShowImplicitHydrogens!==!1,settings.m2cfCompactDrawing=e.sdCompactDrawing===!0,settings.m2cfFlipHorizontal=e.sdFlipHorizontal===!0,settings.m2cfFlipVertical=e.sdFlipVertical===!0,settings.m2cfRotate=e.sdRotate||0,settings.sdGradientColors=e.sdGradientColors===!0,settings.sdAutoAdapt=e.sdAutoAdapt!==!1,settings.m2cfUse3DSmiles=e.useStereochemistry!==!1,log.info("\u{1F4CA} Rendering settings:",{showCarbons:settings.m2cfShowCarbons,aromaticRings:settings.m2cfAromaticCircles,showMethyls:settings.m2cfShowMethyls,atomNumbers:settings.m2cfAtomNumbers,explicitHydrogens:settings.m2cfAddH2,implicitHydrogens:settings.m2cfShowImplicitH,gradientColors:settings.sdGradientColors}),log.info("\u{1F50D} Server search enabled"),log.success("\u2705 Settings loaded",settings),log.info("Renderer Engine: ChemTex"),log.info(`Performance mode: ${settings.performanceMode?"ON \u26A1":"OFF"}`),loadSmilesCache().then(t=>{log.info(`\u{1F4E6} SMILES cache ready: ${Object.keys(t).length} cached compounds`)}),settings.enabled?(log.info("\u{1F680} Extension enabled, initializing renderer..."),initializeRenderer(),settings.sdAverageSize=e.sdAverageSize||100,settings.sdAverageSize!==100&&(setTimeout(()=>{applyAverageSizeScaling(settings.sdAverageSize)},2e3),setTimeout(()=>{applyAverageSizeScaling(settings.sdAverageSize)},5e3))):log.info("\u23F8\uFE0F  Extension disabled in settings")}),chrome.storage.onChanged.addListener(e=>{e.enabled&&(log.info("\u2699\uFE0F  Settings changed, reloading...",e),e.enabled.newValue&&location.reload()),e.viewer3DSource&&(log.info("\u{1F504} 3D Viewer source changed, updating...",e.viewer3DSource),settings.viewer3DSource=e.viewer3DSource.newValue,log.success(`\u2705 Switched to ${e.viewer3DSource.newValue} 3D viewer`))}),chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action==="renderPreview"){try{const i=wrapChemicalFormulas(e.code);o({html:i})}catch(i){o({html:`<span style="color: red;">Error: ${i.message}</span>`})}return!0}if(e.type==="SETTINGS_CHANGED"){Object.assign(settings,e.settings);const i=["sdShowCarbons","sdAromaticRings","sdShowMethyls","sdAtomNumbers","sdShowExplicitHydrogens","sdShowImplicitHydrogens","sdCompactDrawing","sdFlipHorizontal","sdFlipVertical","sdTheme","sdAutoAdapt","sdRotate","sdAverageSize","sdGradientColors","sdScaleByWeight","useStereochemistry"];return Object.keys(e.settings).filter(l=>i.includes(l)).length>0,o({success:!0}),!0}});function initializeRenderer(){log.inject("\u{1F527} Initialize renderer - Starting chemical formula processing"),injectStyles(),settings.performanceMode?log.inject("\u26A1 Performance mode ENABLED - Setting up lazy-loading for SVGs"):log.inject("\u26A1 Performance mode disabled - will load images immediately"),setupLazyLoading(),log.inject("\u{1F680} Starting initial page scan..."),scanAndRender(),log.inject("\u{1F504} Setting up dynamic content observer..."),observePageChanges(),log.success("\u2705 Renderer initialized - formulas will be processed as they appear")}function injectStyles(){const e='.molecule-diagram{display:inline-block!important;position:static!important;max-width:100%;max-height:400px;margin:0 12px 8px 0!important;vertical-align:middle;padding:0!important;border:none!important;border-radius:4px;background-color:transparent!important;transition:opacity .3s ease;cursor:pointer;opacity:1}.molecule-diagram[data-loaded="error"]{background-color:transparent!important;border:1px solid rgba(239,83,80,0.3)!important}.molecule-loading{opacity:.1;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 2s infinite}@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}.molecule-fadein{animation:fadeIn .4s ease-in-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.molecule-container{display:inline-flex;flex-wrap:wrap;gap:12px;align-items:center;margin:8px 0}.molecule-container .molecule-diagram{margin:0}.molecule-container.vertical{display:flex;flex-direction:column;align-items:flex-start;gap:16px;margin:12px 0}.molecule-container.vertical .molecule-diagram{margin:0;display:block}.molecule-rotate-0{transform:rotate(0deg)}.molecule-rotate-90{transform:rotate(90deg);max-width:200px;max-height:300px}.molecule-rotate-180{transform:rotate(180deg)}.molecule-rotate-270{transform:rotate(270deg);max-width:200px;max-height:300px}.molecule-diagram:hover{background-color:rgba(100,150,255,.1)!important;box-shadow:0 0 8px rgba(100,150,255,.2)!important}.molecule-viewer-container{display:inline-block!important;margin:8px 12px 8px 0!important;vertical-align:middle;padding:0!important;background:transparent!important;border:none!important;box-shadow:none!important}.molecule-viewer-container:hover{background:transparent!important;border:none!important;box-shadow:none!important}.molecule-viewer-container .molecule-diagram{display:block;max-width:300px;max-height:200px;margin-bottom:6px;cursor:pointer;border-radius:4px}.molecule-viewer-container .molecule-diagram:hover{background-color:rgba(100,150,255,.15)!important;box-shadow:0 0 8px rgba(100,150,255,.3)!important}.molecule-download-btn:hover{background:#45a049!important;transform:scale(1.02)}.molecule-download-btn:active{transform:scale(.98)}@media(max-width:768px){.molecule-diagram{max-width:250px;max-height:150px}.molecule-container{flex-direction:column;gap:8px}.molecule-viewer-container{margin:8px 0!important}}',t=document.createElement("style");t.textContent=e,t.id="chem-renderer-styles",(document.head||document.documentElement).appendChild(t)}function parseChemFlags(e,t=!0){const o={useDefaults:!1,flagsLocked:!1,showCarbons:void 0,aromaticCircles:void 0,showMethyls:void 0,atomNumbers:void 0,flipHorizontal:void 0,flipVertical:void 0,addHydrogens:void 0,showImplicitHydrogens:void 0,size:void 0,rotation:void 0,isCompound:!1,compoundType:void 0,isDirectSmiles:!1,moleculeName:null,isDirectID:!1,idType:void 0,idValue:void 0,smilesValue:void 0,displayName:void 0,isIUPAC:!1,isQuantumOrbital:!1,isHybridOrbital:!1,orbitalElement:void 0,orbitalType:void 0,orbitalSubtype:void 0,hybridType:void 0};if(!e)return o;const i=e.match(/chem:(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid|quan|hybrid)=([^:]+):/i),r=i?null:e.match(/chem:([a-zA-Z0-9][a-zA-Z0-9\-,\s\(\)]{0,}?)(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid|quan|hybrid)=([^:]+):/i);if(i){const l=i[1].toLowerCase(),a=i[2];switch(l){case"smiles":o.compoundType="smiles",o.isDirectSmiles=!0;break;case"mol":o.compoundType="compound",o.isCompound=!0;break;case"biomol":o.compoundType="biomolecule";break;case"mineral":o.compoundType="mineral",o.isMineral=!0;break;case"iupac":o.compoundType="compound",o.isIUPAC=!0,o.isCompound=!0;break;case"pbdid":o.compoundType="biomolecule",o.isDirectID=!0,o.idType="pdbid";break;case"cid":o.compoundType="compound",o.isDirectID=!0,o.idType="cid",o.isCompound=!0;break;case"codid":o.compoundType="mineral",o.isDirectID=!0,o.idType="codid";break;case"quan":o.compoundType="quantum",o.isQuantumOrbital=!0;break;case"hybrid":o.compoundType="hybrid",o.isHybridOrbital=!0;break}let n=a;const c=l==="pbdid"?null:a.match(/^(.+?)([+\-][a-zA-Z](?:[+\-][a-zA-Z])*)$/);c&&(n=c[1],o.flagsLocked=!0),o.moleculeName=n.trim(),l==="smiles"&&(o.smilesValue=n.trim()),(l==="pbdid"||l==="cid"||l==="codid")&&(o.idValue=n.trim());const f=c?c[2]:"";if(!t)return o;f.includes("+d")&&(o.useDefaults=!0);const d=f.match(/\+([a-zA-Z0-9]+)/g);d&&d.forEach(b=>{const g=b.substring(1).toLowerCase();if(g==="c"&&(o.showCarbons=!0),g==="o"&&(o.aromaticCircles=!0),g==="m"&&(o.showMethyls=!0),g==="n"&&(o.atomNumbers=!0),g==="h"&&(o.addHydrogens=!0),g==="i"&&(o.showImplicitHydrogens=!0),g==="p"&&(o.flipHorizontal=!0),g==="q"&&(o.flipVertical=!0),g==="d"&&(o.useDefaults=!0),g.startsWith("s")&&g.length>1){const u=parseInt(g.substring(1));isNaN(u)||(o.size=u/100)}});const S=f.match(/-([a-zA-Z])/g);return S&&S.forEach(b=>{const g=b.substring(1).toLowerCase();g==="c"&&(o.showCarbons=!1),g==="o"&&(o.aromaticCircles=!1),g==="m"&&(o.showMethyls=!1),g==="n"&&(o.atomNumbers=!1),g==="h"&&(o.addHydrogens=!1),g==="i"&&(o.showImplicitHydrogens=!1),g==="p"&&(o.flipHorizontal=!1),g==="q"&&(o.flipVertical=!1)}),o}if(r){const l=r[1].trim(),a=r[2].toLowerCase(),n=r[3];switch(a){case"smiles":o.compoundType="smiles",o.isDirectSmiles=!0;break;case"mol":o.compoundType="compound",o.isCompound=!0;break;case"biomol":o.compoundType="biomolecule";break;case"mineral":o.compoundType="mineral",o.isMineral=!0;break;case"iupac":o.compoundType="compound",o.isIUPAC=!0,o.isCompound=!0;break;case"pbdid":o.compoundType="biomolecule",o.isDirectID=!0,o.idType="pdbid";break;case"cid":o.compoundType="compound",o.isDirectID=!0,o.idType="cid",o.isCompound=!0;break;case"codid":o.compoundType="mineral",o.isDirectID=!0,o.idType="codid",o.isMineral=!0;break;case"quan":o.compoundType="quantum",o.isQuantumOrbital=!0;break;case"hybrid":o.compoundType="hybrid",o.isHybridOrbital=!0;break}o.moleculeName=l;const m=a==="pbdid";let c=-1;if(!m){const g=/[+-](c|o|m|n|h|i|p|q|d|s)(?=[+-]|$)/gi;n.match(g)&&(c=n.search(g))}const f=c!==-1?n.substring(0,c).trim():n.trim();a==="smiles"?o.smilesValue=f:a==="iupac"?o.iupacValue=f:a==="mineral"?o.mineralValue=f:a==="biomol"?o.biomolValue=f:a==="mol"?o.molValue=f:(a==="pbdid"||a==="cid"||a==="codid")&&(o.idValue=f),c!==-1&&(o.flagsLocked=!0),o.displayName=l;const d=c!==-1?n.substring(c):"";if(!t)return o;d.includes("+d")&&(o.useDefaults=!0);const S=d.match(/\+([a-zA-Z0-9]+)/g);S&&S.forEach(g=>{const u=g.substring(1).toLowerCase();if(u==="c"&&(o.showCarbons=!0),u==="o"&&(o.aromaticCircles=!0),u==="m"&&(o.showMethyls=!0),u==="n"&&(o.atomNumbers=!0),u==="h"&&(o.addHydrogens=!0),u==="i"&&(o.showImplicitHydrogens=!0),u==="p"&&(o.flipHorizontal=!0),u==="q"&&(o.flipVertical=!0),u==="d"&&(o.useDefaults=!0),u.startsWith("s")&&u.length>1){const M=parseInt(u.substring(1));isNaN(M)||(o.size=M/100)}if(u.startsWith("r")&&u.length>1){const M=parseInt(u.substring(1));isNaN(M)||(o.rotation=M)}});const b=d.match(/-([a-zA-Z])/g);return b&&b.forEach(g=>{const u=g.substring(1).toLowerCase();u==="c"&&(o.showCarbons=!1),u==="o"&&(o.aromaticCircles=!1),u==="m"&&(o.showMethyls=!1),u==="n"&&(o.atomNumbers=!1),u==="h"&&(o.addHydrogens=!1),u==="i"&&(o.showImplicitHydrogens=!1),u==="p"&&(o.flipHorizontal=!1),u==="q"&&(o.flipVertical=!1)}),o}if(e.includes("/")){const l=e.split("/");if(l.length>1){const a=l[1];if(a.includes(":")){const n=a.split(":")[0].toLowerCase();if(n.includes("d")){o.useDefaults=!0;const m=n.replace("d","");m.includes("-c")&&(o.showCarbons=!1),m.includes("-o")&&(o.aromaticCircles=!1),m.includes("-m")&&(o.showMethyls=!1),m.includes("-n")&&(o.atomNumbers=!1),m.includes("-p")&&(o.flipHorizontal=!0),m.includes("-q")&&(o.flipVertical=!0)}}}}if(e.includes("+")){o.flagsLocked=!0;const l=e.match(/\+([a-zA-Z0-9]+)/g);l&&l.forEach(a=>{const n=a.substring(1).toLowerCase();if(n==="c"&&(o.showCarbons=!0),n==="o"&&(o.aromaticCircles=!0),n==="m"&&(o.showMethyls=!0),n==="n"&&(o.atomNumbers=!0),n==="h"&&(o.addHydrogens=!0),n==="i"&&(o.showImplicitHydrogens=!0),n==="p"&&(o.flipHorizontal=!0),n==="q"&&(o.flipVertical=!0),n==="d"&&(o.useDefaults=!0),n==="compound"&&(o.isCompound=!0),n==="compound"&&(o.compoundType="compound"),(n==="biomolecule"||n==="bio"||n==="protein")&&(o.compoundType="biomolecule"),(n==="mineral"||n==="crystal")&&(o.compoundType="mineral"),(n==="smiles"||n==="smi")&&(o.isDirectSmiles=!0),n.startsWith("s")&&n.length>1){const m=parseInt(n.substring(1));isNaN(m)||(o.size=m/100)}if(n.startsWith("r")&&n.length>1){const m=parseInt(n.substring(1));isNaN(m)||(o.rotation=m)}})}return o}function stripFlagsFromName(e){if(!e)return e;const t=e.indexOf("/");return t!==-1?e.substring(0,t):e}function applyFlagOverrides(e,t){try{const o={...e};return t?.showCarbons!==void 0&&(o.m2cfShowCarbons=t.showCarbons),t?.aromaticCircles!==void 0&&(o.m2cfAromaticCircles=t.aromaticCircles),t?.showMethyls!==void 0&&(o.m2cfShowMethyls=t.showMethyls),t?.atomNumbers!==void 0&&(o.m2cfAtomNumbers=t.atomNumbers),t?.addHydrogens!==void 0&&(o.m2cfAddH2=t.addHydrogens),t?.flipHorizontal!==void 0&&(o.m2cfFlipHorizontal=t.flipHorizontal,o.flipHorizontal=t.flipHorizontal),t?.flipVertical!==void 0&&(o.m2cfFlipVertical=t.flipVertical,o.flipVertical=t.flipVertical),t?.rotation!==void 0&&(o.m2cfRotate=t.rotation,o.mvRotate=t.rotation),o}catch{return e}}function wrapImageWithRotationContainer(e,t,o,i){const r=document.createElement("div");return r.className="molecule-container",r.style.cssText=`
    display: inline-block;
    position: relative;
    vertical-align: middle;
    margin: 0 12px 8px 0;
    background: none;
    background-color: transparent;
    border: none;
    box-shadow: none;
  `,r._moleculeName=o,r._moleculeData=i,r.appendChild(e),r}function addHoverControls(e,t,o){if(e.querySelector(".molecule-name-overlay"))return;const i=document.createElement("div");i.className="molecule-name-overlay",i.textContent=t||"Unknown",i.style.cssText=`
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-family: sans-serif;
    opacity: 0.7;
    transition: opacity 0.2s;
    pointer-events: none;
    z-index: 10;
    white-space: nowrap;
    line-height: 1.4;
  `;const r=o.compoundType==="biomolecule"||o.pdbid||o.flags&&o.flags.compoundType==="biomolecule",l=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" style="display:block;">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
    <line x1="12" y1="22.08" x2="12" y2="12"/>
  </svg>`,a=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="16" height="16" style="display:block;">
    <path d="M12 2v20"/>
    <path d="M2.5 7l19 10"/>
    <path d="M2.5 17l19-10"/>
  </svg>`,n=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="display:block;">
    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(45 12 12)"/>
    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-45 12 12)"/>
    <ellipse cx="12" cy="12" rx="10" ry="4"/>
    <circle cx="12" cy="12" r="2" fill="currentColor"/>
  </svg>`,m=document.createElement("div");m.className="molecule-3d-button-group",m.style.cssText=`
    position: absolute;
    top: 4px;
    right: 4px;
    display: flex;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
    border-radius: 4px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.85);
  `;let c=null,f=settings.molviewBioAssembly===!0;r&&(c=document.createElement("button"),c.className="molecule-bio-toggle",c.innerHTML=f?a:n,c.title=f?"Mol* viewer (click to switch to MolView)":"MolView (click to switch to Mol*)",c.style.cssText=`
      background: transparent;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      border-right: 1px solid rgba(255,255,255,0.3);
      box-sizing: border-box;
    `,c.addEventListener("mouseenter",()=>{c.style.background="rgba(255,255,255,0.15)"}),c.addEventListener("mouseleave",()=>{c.style.background="transparent"}),c.addEventListener("click",async A=>{A.stopPropagation(),f=!f,f?(c.innerHTML=a,c.title="Mol* viewer (click to switch to MolView)"):(c.innerHTML=n,c.title="MolView (click to switch to Mol*)"),o.preferMolstar=f;let I=e.closest(".molecule-3d-viewer");if(I||(I=e.querySelector(".molecule-3d-viewer")),!I&&e.classList.contains("molecule-3d-viewer")&&(I=e),I&&f?I.setAttribute("data-viewer-type","molstar"):I&&I.setAttribute("data-viewer-type","molview"),I){const s=I.querySelector("iframe");if(s&&o.pdbid){const h=o.pdbid.toLowerCase();let p;f?p=`https://molstar.org/viewer/?pdb=${h}&hide-controls=1`:p=buildMolViewEmbedUrl(h,"pdbid","biomolecule");const w=document.createElement("iframe");w.src=p,w.style.cssText=s.style.cssText,w.setAttribute("allow",s.getAttribute("allow")||"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking"),w.setAttribute("allowfullscreen","true"),w.setAttribute("frameborder","0"),w.title=f?`Mol* Viewer: ${h}`:`MolView: ${h}`,s.parentNode&&s.parentNode.replaceChild(w,s)}}}));const d=document.createElement("button");d.className="molecule-3d-cube-btn",d.innerHTML=l,d.title="View in 3D",d.style.cssText=`
    background: transparent;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    padding: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    box-sizing: border-box;
  `,d.addEventListener("mouseenter",()=>{d.style.background="rgba(255,255,255,0.15)"}),d.addEventListener("mouseleave",()=>{d.style.background="transparent"}),d.addEventListener("click",async A=>{A.stopPropagation(),r&&(o.preferMolstar=f);try{await show3DViewerInline(o,e)}catch(I){alert("Failed to load 3D viewer: "+I.message)}}),c&&m.appendChild(c),m.appendChild(d);const S=m,b=null,g=document.createElement("div");g.className="chem-size-controls",g.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 1000;
  `,e.style.position!=="relative"&&e.style.position!=="absolute"&&(e.style.position="relative"),e.offsetWidth;const u=document.createElement("button");u.className="chem-size-btn chem-size-up",u.innerHTML="\u25B2",u.title="Increase size",u.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  `;const M=document.createElement("button");M.className="chem-size-btn chem-size-down",M.innerHTML="\u25BC",M.title="Decrease size",M.style.cssText=u.style.cssText;function E(A,I=100,s=80){const h=e.querySelector("img")||e.querySelector("iframe");if(!h)return;const p=h.offsetWidth||h.width||h.naturalWidth||300,w=h.offsetHeight||h.height||h.naturalHeight||200,y=Math.max(I,Math.round(p*A)),k=Math.max(s,Math.round(w*A));(v=>{v.style.setProperty("width",`${y}px`,"important"),v.style.setProperty("height",`${k}px`,"important"),v.style.setProperty("max-width","none","important"),v.style.setProperty("max-height","none","important")})(h),e.style.setProperty("width",`${y}px`,"important"),e.style.setProperty("height",`${k}px`,"important")}u.addEventListener("click",A=>{A.stopPropagation(),E(1.2)}),M.addEventListener("click",A=>{A.stopPropagation(),E(.8333)}),g.appendChild(u),g.appendChild(M),e.addEventListener("mouseenter",()=>{i.style.opacity="1",S.style.opacity="1",g.style.opacity="1",b&&(b.style.opacity="1")}),e.addEventListener("mouseleave",()=>{i.style.opacity="0.7",S.style.opacity="0",g.style.opacity="0",b&&(b.style.opacity="0")}),getComputedStyle(e).position==="static"&&(e.style.position="relative"),e.style.background="none",e.style.backgroundColor="transparent",e.style.border="none",e.style.boxShadow="none",e.appendChild(i),e.appendChild(S),b&&e.appendChild(b),e.appendChild(g)}function buildBioImageUrl(e){const t=e.toLowerCase(),o=settings.molviewBioAssembly?"assembly-1":"model-1";return`https://cdn.rcsb.org/images/structures/${t}_${o}.jpeg`}function buildMolViewEmbedUrl(e,t,o="compound"){const i="https://embed.molview.org/v1/",r=new URLSearchParams;if(r.set(t,e),o==="biomolecule"&&(settings.molviewChainType&&r.set("chainType",settings.molviewChainType),settings.molviewChainBonds&&r.set("chainBonds","true"),settings.molviewChainColor&&r.set("chainColor",settings.molviewChainColor),settings.proteinMolviewBgColor&&r.set("bg",settings.proteinMolviewBgColor)),o==="mineral"){if(settings.mineralRepresentation){const l={ballAndStick:"balls",stick:"stick",vdwSpheres:"vdw",wireframe:"wireframe",line:"line"};r.set("mode",l[settings.mineralRepresentation]||"balls")}settings.mineralMolviewBgColor&&r.set("bg",settings.mineralMolviewBgColor)}if(t==="smiles"||t==="cid"||o==="compound"){if(settings.molviewRepresentation){const l={ballAndStick:"balls",stick:"stick",vdwSpheres:"vdw",wireframe:"wireframe",line:"line"};r.set("mode",l[settings.molviewRepresentation]||"balls")}else r.has("mode")||r.set("mode","balls");settings.compoundMolviewBgColor&&r.set("bg",settings.compoundMolviewBgColor)}return i+"?"+r.toString()}function parseOrbitalValue(e){if(!e||typeof e!="string")return null;const t=e.match(/^([A-Za-z]{1,2})\+(\d+)([spdf])([a-z0-9]{0,3})?$/i);if(!t)return null;const o=t[1],i=parseInt(t[2]),r=t[3].toLowerCase(),l=t[4]?t[4].toLowerCase():null,n={s:0,p:1,d:2,f:3}[r];let m=0;if(l){if(r==="p"){const c={x:1,y:2,z:0};m=c[l]!==void 0?c[l]:0}if(r==="d"){const c={z2:0,xz:1,yz:2,x2y2:3,"x2-y2":3,xy:4};m=c[l]!==void 0?c[l]:0}}return{element:o,n:i,l:n,m,orbitalLetter:r,suborbital:l}}function buildQuantumOrbitalUrl(e,t=!1){if(!e||typeof e!="string")return"https://falstad.com/qmatom/qmatom.html?vc=0&n=0&l=0&m=0";const o="https://falstad.com/qmatom/qmatom.html",i=new URLSearchParams;if(t){i.set("vc","10");const r=e.toLowerCase().match(/^(sp3d2|sp3d|sp3|sp2|sp)$/);if(r)switch(r[1]){case"sp":case"sp2":case"sp3":i.set("n","1"),i.set("l","1"),i.set("m","0");break;case"sp3d":case"sp3d2":i.set("n","2"),i.set("l","2"),i.set("m","0");break}}else{const r=parseOrbitalValue(e);r?(i.set("vc","0"),i.set("n",String(r.n-1)),i.set("l",String(r.l)),i.set("m",String(r.m))):(i.set("vc","0"),i.set("n","0"),i.set("l","0"),i.set("m","0"))}return o+"?"+i.toString()}window.parseChemFlags=parseChemFlags,window.stripFlagsFromName=stripFlagsFromName,window.applyFlagOverrides=applyFlagOverrides,window.buildMolViewEmbedUrl=buildMolViewEmbedUrl,window.buildQuantumOrbitalUrl=buildQuantumOrbitalUrl,window.parseOrbitalValue=parseOrbitalValue;function setupLazyLoading(){if(window._lazyLoadObserver){try{window._lazyLoadObserver.disconnect()}catch{}window._lazyLoadObserver=null}log.inject("\u{1F680} Setting up Intersection Observer for lazy-loading with performance optimization");let e=0;const t=3;function o(){e--,typeof d=="function"&&setTimeout(d,50)}const i=new IntersectionObserver(s=>{s.forEach(h=>{if(h.isIntersecting){const p=h.target;p.dataset.loaded==="false"&&p.dataset.src&&e<t&&(window.requestIdleCallback?requestIdleCallback(()=>{e<t&&r(p)},{timeout:1e3}):setTimeout(()=>{e<t&&r(p)},50))}})},{rootMargin:"300px"});function r(s){e++,log.debug(`\u{1F5BC}\uFE0F  Loading SVG (#${e}): ${s.dataset.src.substring(0,60)}...`),s.classList.add("molecule-fadein"),s.classList.remove("molecule-loading");const h=new Image;h.onload=()=>{s.src=s.dataset.src,s.dataset.loaded="true",i.unobserve(s),o(),log.debug(`\u2705 SVG loaded (${e} active loads remaining)`)},h.onerror=()=>{o(),log.debug(`\u274C SVG failed to load (${e} active loads remaining)`)},h.src=s.dataset.src}async function l(s,h){try{const p=document.createElement("img");p.src=s.imageUrl,p.alt=s.nomenclature||"Biomolecule",p.className="molecule-diagram molecule-biomolecule",p.crossOrigin="anonymous";const w=settings.viewer3DSize||"normal",y={small:{width:200,height:150},medium:{width:300,height:250},normal:{width:400,height:350},large:{width:600,height:450},xlarge:{width:800,height:600}},k=y[w]||y.normal;if(p.style.cssText=`
        width: ${k.width}px;
        height: ${k.height}px;
        max-width: ${k.width}px;
        max-height: ${k.height}px;
        object-fit: contain;
        display: block;
        margin: 0;
        vertical-align: middle;
        cursor: pointer;
        border-radius: 8px;
      `,p.dataset.fixedSize="true",settings.proteinRemoveWhiteBg)try{const v=await backgroundFetchBlob(s.imageUrl);if(v&&v.base64){const C=new Image;C.onload=()=>{try{const T=document.createElement("canvas"),R=T.getContext("2d");T.width=C.naturalWidth,T.height=C.naturalHeight,R.drawImage(C,0,0);const B=R.getImageData(0,0,T.width,T.height),O=B.data;for(let F=0;F<O.length;F+=4){const N=O[F],H=O[F+1],U=O[F+2],V=Math.sqrt(Math.pow(255-N,2)+Math.pow(255-H,2)+Math.pow(255-U,2));V<15?O[F+3]=0:V<150&&(O[F+3]=Math.floor(255*(V-15)/135))}R.putImageData(B,0,0),p.src=T.toDataURL("image/png")}catch{}},C.src=`data:${v.type||"image/jpeg"};base64,${v.base64}`}}catch{}h.dataset.loaded="true";const x=async()=>{chrome.storage.sync.get({saveSizePerImage:!1,saveSizeBySMILES:!0},async v=>{try{await wrapImageWithSizeControls(p,h,s,v)}catch{}})};p.complete&&p.naturalWidth>0?await x():(p.onload=x,p.onerror=()=>{x()})}catch{h.alt="Failed to load biomolecule image",h.dataset.loaded="error"}}async function a(s,h){e++;try{!s&&h.dataset.moleculeViewer&&(s=JSON.parse(atob(h.dataset.moleculeViewer)));const p=s.flags||{},w=p.displayName||s.nomenclature||s.name||"molecule";let y="mol",k=w;if(p.isDirectSmiles||s.smiles?(y="smiles",k=p.smilesValue||s.smiles||w):p.compoundType==="biomolecule"||p.isBiomolecule?(y="biomol",k=p.biomolValue||s.nomenclature||w):p.compoundType==="mineral"||p.isMineral?(y="mineral",k=p.mineralValue||s.nomenclature||w):p.compoundType==="quantum"||p.isQuantumOrbital?(y="quantum",k=s.nomenclature||w):p.compoundType==="hybrid"||p.isHybridOrbital?(y="hybrid",k=s.nomenclature||w):p.isIUPAC?(y="iupac",k=p.iupacValue||s.nomenclature||w):k=p.molValue||s.nomenclature||w,y==="biomol")try{const $=await fetchFromChemistryLaTeXServer("biomol",k);if($.pdbid){const P={nomenclature:w,compoundType:"biomolecule",embedUrl:buildMolViewEmbedUrl($.pdbid,"pdbid","biomolecule"),imageUrl:buildBioImageUrl($.pdbid),pdbid:$.pdbid,is3D:s.is3D||s.show3D||p.is3D};P.is3D?await n(P,h):await l(P,h),o();return}}catch{h.alt=`Biomolecule not found: ${k}`,o();return}if(y==="quantum"||y==="hybrid")try{const P=buildQuantumOrbitalUrl(k,y==="hybrid"),_=document.createElement("div");_.className="quantum-orbital-container",_.style.cssText=`
            display: inline-block;
            position: relative;
            margin: 8px 12px 8px 0;
            vertical-align: middle;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            width: 350px;
            height: 300px;
          `;const q=document.createElement("div");q.style.cssText=`
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
          `;const W=document.createElement("iframe");W.src=P,W.style.cssText=`
            width: 800px;
            height: 600px;
            border: none;
            display: block;
            position: absolute;
            top: -60px;
            left: -220px;
            transform: scale(0.8);
            transform-origin: top left;
          `,W.allow="fullscreen",W.title=w||"Quantum Orbital Viewer",q.appendChild(W);const X=document.createElement("div");X.className="quantum-orbital-label",X.style.cssText=`
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: system-ui, -apple-system, sans-serif;
            pointer-events: none;
            z-index: 10;
          `,X.textContent=w||k;const G=document.createElement("a");G.href=P,G.target="_blank",G.style.cssText=`
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: system-ui, -apple-system, sans-serif;
            text-decoration: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
          `,G.textContent="\u2197 Full Viewer",_.addEventListener("mouseenter",()=>G.style.opacity="1"),_.addEventListener("mouseleave",()=>G.style.opacity="0"),_.appendChild(q),_.appendChild(X),_.appendChild(G),h.parentNode&&h.parentNode.replaceChild(_,h),o();return}catch{h.alt=`Orbital not supported: ${k}`,o();return}if(s.is3D||s.show3D||p.is3D){await n(s,h),o();return}const x=settings.enableAIFlagControl===!0;let v=settings.m2cfShowCarbons===!0,C=settings.m2cfAromaticCircles===!0,T=settings.m2cfShowMethyls===!0,R=settings.m2cfAtomNumbers===!0,B=settings.m2cfFlipVertical===!0,O=settings.m2cfFlipHorizontal===!0,F=settings.m2cfAddH2===!0,N=settings.m2cfShowImplicitH!==!1,H=settings.m2cfCompactDrawing===!0;x&&p.flagsLocked&&(p.showCarbons!==void 0&&(v=p.showCarbons),p.aromaticCircles!==void 0&&(C=p.aromaticCircles),p.showMethyls!==void 0&&(T=p.showMethyls),p.atomNumbers!==void 0&&(R=p.atomNumbers),p.addHydrogens!==void 0&&(F=p.addHydrogens),p.showImplicitH!==void 0&&(N=p.showImplicitH),p.flipHorizontal!==void 0&&(O=p.flipHorizontal),p.flipVertical!==void 0&&(B=p.flipVertical));const V=settings.sdTheme||"light",D={showCarbons:v,aromaticCircles:C,showMethyls:T,atomNumbers:R,showHydrogens:F,showImplicitH:N,gradientColors:settings.sdGradientColors===!0,compactDrawing:H,flipHorizontal:O,flipVertical:B,useStereochemistry:settings.m2cfUse3DSmiles===!0,theme:V,renderingEngine:settings.renderingEngine||"chemistrylatex"},z=y==="smiles"&&s.smiles||k,Y=buildServerSvgUrl(y,z,D);let Z,Q="";try{const $=await fetch(Y);if(!$.ok)throw new Error(`Server returned ${$.status}`);Q=$.headers.get("X-Local-Flip")||"";const P=$.headers.get("X-Compound-CID");P&&(s.cid=P);const _=$.headers.get("X-Compound-SMILES");_&&(s.smiles=_);const q=await $.text(),W=applyThemeColors(q,V);Z="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(W),h.dataset.rawSvg=encodeURIComponent(q)}catch($){h.alt=`Error loading ${w}: ${$.message}`,o();return}const L=document.createElement("img");L.src=Z,L.alt=w,L.className="molecule-diagram molecule-viewer",h.dataset.moleculeViewer&&h.dataset.moleculeViewer!=="true"?L.dataset.moleculeViewer=h.dataset.moleculeViewer:L.dataset.moleculeViewer=btoa(JSON.stringify(s||{})),L.dataset.nomenclature=w,L.dataset.originalNomenclature=w,L.dataset.compoundType=p.compoundType||y,s?.smiles?L.dataset.smiles=s.smiles:h.dataset.smiles&&(L.dataset.smiles=h.dataset.smiles),L.dataset.serverType=y,L.dataset.rawSvg=h.dataset.rawSvg,L.style.cssText="display: inline-block; margin: 0; padding: 0; border: none; width: auto; height: auto; max-width: 100%; max-height: 400px; vertical-align: middle;";let j=[];Q.includes("q")&&j.push("scaleY(-1)"),Q.includes("p")&&j.push("scaleX(-1)"),p.rotation&&j.push(`rotate(${p.rotation}deg)`),j.length>0&&(L.style.transform=j.join(" "));const J=wrapImageWithRotationContainer(L,p.rotation,w,s),K=()=>{h.parentNode&&(L.naturalWidth&&L.naturalHeight&&(J.style.width=L.naturalWidth+"px",J.style.height=L.naturalHeight+"px",L.style.width="100%",L.style.height="100%",L.style.display="block"),h.parentNode.replaceChild(J,h),addHoverControls(J,w,s),settings.sdAverageSize&&settings.sdAverageSize!==100&&setTimeout(()=>applyAverageSizeScaling(settings.sdAverageSize),100)),o()};L.complete&&L.naturalWidth>0?K():(L.onload=K,L.onerror=()=>{h.alt=`Error loading ${w}`,o()})}catch(p){h.alt=`Error: ${p.message}`,o()}}async function n(s,h){const p=s.flags?.displayName||s.nomenclature||s.smiles||"";let w=h;if(w.classList&&w.classList.contains("molecule-3d-viewer")){const k=w._original2DElement;k&&w.parentNode&&w.parentNode.replaceChild(k,w);return}let y=h;if(h.tagName!=="IMG"){if(y=h.querySelector("img"),!y){const k=h.querySelector(".molecule-size-wrapper");k&&(y=k.querySelector("img"),w=k)}y||h.classList&&(h.classList.contains("chem-3d-placeholder")||h.classList.contains("chem-2d-viewer-container")||h.classList.contains("molecule-viewer-container"))&&(y=null,w=h)}if(!y&&!w)throw new Error("Could not find image element");try{const k=s.compoundType||s.flags?.compoundType||"compound",x=k==="biomolecule";let v;if(x){const F=settings.viewer3DSize||"normal",N={small:{width:200,height:150},medium:{width:300,height:250},normal:{width:400,height:350},large:{width:600,height:450},xlarge:{width:800,height:600}};v=N[F]||N.normal}else{const F=y&&(y.offsetWidth||y.naturalWidth)||300,N=y&&(y.offsetHeight||y.naturalHeight)||200,H=F/N,U=(k==="mineral"?settings.mineral3DSize||100:settings.compound3DSize||100)/100,D=Math.round(300*U),z=Math.round(D/H);v={width:D,height:z}}const C=document.createElement("div");C.className="molecule-viewer-container molecule-3d-viewer",C.style.cssText=`
        display: inline-block;
        width: ${v.width}px;
        height: ${v.height}px;
        margin: 0;
        padding: 0;
        vertical-align: middle;
        position: relative;
        border: none;
        outline: none;
        border-radius: 8px;
        overflow: hidden;
        background: transparent;
        box-shadow: none;
        max-width: 100%;
        box-sizing: border-box;
      `;const T=document.createElement("iframe");let R;if(s.embedUrl||s.pdbid||s.codid){const F=s.compoundType||"compound";if(s.pdbid){const N=s.pdbid.toLowerCase();if(s.preferMolstar===!0||settings.molviewBioAssembly===!0){const U=settings.bioAssemblyGraphics||"balanced",V=settings.bioAssemblyPdbProvider||"rcsb";settings.molviewBioAssembly?"molstar"==="molstar-me"?R=`https://molstar.org/me/viewer/?pdb=${N}&hide-controls=1&graphics-mode=${U}&pdb-provider=${V}`:R=`https://molstar.org/viewer/?pdb=${N}&assembly-id=1&hide-controls=1`:R=`https://molstar.org/viewer/?pdb=${N}&hide-controls=1`}else R=buildMolViewEmbedUrl(s.pdbid,"pdbid","biomolecule")}else s.codid?R=buildMolViewEmbedUrl(s.codid,"codid","mineral"):R=s.embedUrl;T.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking")}else{if(s.cid)R=buildMolViewEmbedUrl(s.cid,"cid","compound");else if(s.smiles)R=buildMolViewEmbedUrl(s.smiles,"smiles","compound");else if(p)try{const F=await fetchFromChemistryLaTeXServer("mol",p);if(F&&F.cid)R=buildMolViewEmbedUrl(F.cid,"cid","compound");else if(F&&F.smiles)R=buildMolViewEmbedUrl(F.smiles,"smiles","compound");else throw new Error("No CID or SMILES found")}catch{R="about:blank"}else R="about:blank";T.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking")}R||(R="about:blank"),T.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking"),T.setAttribute("allowfullscreen","true"),T.setAttribute("frameborder","0"),T.style.cssText=`
        width: 100%;
        height: 100%;
        border: none !important;
        outline: none !important;
        margin: 0;
        padding: 0;
        display: block;
        background: transparent;
        box-shadow: none;
      `,T.title=`3D Viewer: ${p}`,C._original2DElement=w,C.appendChild(T);const B=document.createElement("div");B.className="chem-size-controls",B.style.cssText=`
        position: absolute;
        bottom: 4px;
        left: 4px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s;
      `,C.style.position!=="relative"&&C.style.position!=="absolute"&&(C.style.position="relative"),C.onmouseenter=()=>B.style.opacity="1",C.onmouseleave=()=>B.style.opacity="0";const O=(F,N)=>{const H=document.createElement("button");return H.innerHTML=F,H.style.cssText=`
          width: 24px;
          height: 24px;
          border: none;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background 0.2s;
        `,H.onmouseenter=()=>H.style.background="rgba(0, 0, 0, 0.9)",H.onmouseleave=()=>H.style.background="rgba(0, 0, 0, 0.7)",H.onclick=U=>{U.stopPropagation();const V=parseInt(C.style.width),D=parseInt(C.style.height);if(N<0&&V<200)return;const z=1+N/100;C.style.width=`${Math.round(V*z)}px`,C.style.height=`${Math.round(D*z)}px`},H};if(C.style.position!=="relative"&&C.style.position!=="absolute"&&(C.style.position="relative"),C.offsetWidth,B.appendChild(O("\u25B2",10)),B.appendChild(O("\u25BC",-10)),C.appendChild(B),T.src=R,s.pdbid&&R.includes("embed.molview.org")){const F=s.pdbid.toUpperCase();let N=!1;const H=`https://molstar.org/viewer/?pdb=${F.toLowerCase()}&hide-controls=1`,U=()=>{if(N)return;N=!0;const D=document.createElement("iframe");D.src=H,D.style.cssText=T.style.cssText,D.setAttribute("allow",T.getAttribute("allow")||""),D.setAttribute("allowfullscreen","true"),D.setAttribute("frameborder","0"),D.title=`Mol* Viewer: ${F}`,T.parentNode&&T.parentNode.replaceChild(D,T)},V=D=>{if(D.origin==="https://embed.molview.org"&&!N){const z=D.data;z&&(z.error||z.type==="error"||typeof z=="string"&&z.toLowerCase().includes("error")||typeof z=="string"&&z.toLowerCase().includes("failed")||typeof z=="string"&&z.toLowerCase().includes("404")||typeof z=="string"&&z.toLowerCase().includes("not found"))&&(U(),window.removeEventListener("message",V))}};window.addEventListener("message",V),setTimeout(()=>{window.removeEventListener("message",V)},6e4)}w.parentNode?(w.parentNode.replaceChild(C,w),addHoverControls(C,p,s)):(y.nextSibling?y.parentElement.insertBefore(C,y.nextSibling):y.parentElement.appendChild(C),y.style.display="none"),o()}catch{const x=buildServerSvgUrl("mol",p,{showCarbons:settings.m2cfShowCarbons,aromaticCircles:settings.m2cfAromaticCircles,renderingEngine:settings.renderingEngine});y.src=x,y.classList.add("molecule-fadein"),y.classList.remove("molecule-loading"),o()}}function m(s){try{const h=JSON.parse(atob(s.dataset.moleculeViewer||s.dataset.mol2chemfig));a(h,s)}catch{s.alt="\u26A0\uFE0F Failed to render molecule",s.style.minWidth="100px",s.style.minHeight="50px",s.style.backgroundColor="#ffebee",s.style.border="1px solid #ef5350",s.style.borderRadius="4px",s.style.padding="10px",s.dataset.loaded="error"}}const c=[];let f=!1;function d(){if(!(f||c.length===0)){for(f=!0;c.length>0&&e<t;){const s=c.shift();s.dataset.loaded!=="true"&&s.dataset.loaded!=="loading"&&(s.dataset.loaded="loading",m(s))}f=!1,c.length>0&&setTimeout(d,200)}}const S=i,b=new IntersectionObserver(s=>{s.forEach(h=>{const p=h.target;h.isIntersecting&&p.dataset.loaded!=="true"&&p.dataset.loaded!=="loading"&&(p.classList.contains("molecule-viewer")||p.classList.contains("molecule-compound")||p.classList.contains("molecule-legacy")||p.classList.contains("molecule-quantum")?(b.unobserve(p),e<t?(p.dataset.loaded="loading",m(p)):(c.push(p),setTimeout(d,100))):e<t?r(p):typeof requestIdleCallback<"u"?requestIdleCallback(()=>{e<t&&r(p)}):setTimeout(()=>{e<t&&r(p)},50))})},{rootMargin:"300px"});window._lazyLoadObserver=b,window._loadMoleculeImage=m,window._queueMoleculeLoad=function(s){s.dataset.loaded==="true"||s.dataset.loaded==="loading"||(e<t?(s.dataset.loaded="loading",m(s)):(c.push(s),setTimeout(d,100)))},window.show3DViewerInline=n;const g=10,u=1500;let M=0;const E=500;function A(){const s=Date.now();if(s-M<E)return;M=s;const h=document.querySelectorAll('img.molecule-diagram[data-loaded="false"], img.molecule-diagram:not([data-loaded])');if(h.length===0)return;const p=window.scrollY-u,w=window.scrollY+window.innerHeight+u,y=[];if(h.forEach(x=>{const v=x.getBoundingClientRect(),C=window.scrollY+v.top;C>=p&&C<=w&&y.push({img:x,distance:Math.abs(C-(window.scrollY+window.innerHeight/2))})}),y.length===0)return;y.sort((x,v)=>x.distance-v.distance),y.slice(0,g).forEach(({img:x})=>{window._queueMoleculeLoad&&window._queueMoleculeLoad(x)})}let I=null;window.addEventListener("scroll",()=>{I&&clearTimeout(I),I=setTimeout(A,150)},{passive:!0}),setTimeout(A,1e3),log.success("\u2705 Lazy-loading observer initialized (max 3 concurrent loads)")}let scanAndRenderTimeout=null,lastScanTime=0;const MIN_SCAN_INTERVAL=1e3;function scanAndRender(){scanAndRenderTimeout&&clearTimeout(scanAndRenderTimeout);const t=Date.now()-lastScanTime;if(t<MIN_SCAN_INTERVAL){const o=MIN_SCAN_INTERVAL-t;scanAndRenderTimeout=setTimeout(()=>{scanAndRenderImmediate()},o);return}scanAndRenderImmediate()}function scanAndRenderImmediate(){if(lastScanTime=Date.now(),!settings.enabled){log.debug("scanAndRender() called but extension is disabled");return}log.inject("\u{1F50D} STARTING PAGE SCAN for chemical formulas");const e=document.getElementsByTagName("*");let t=0,o=0,i=0,r=[];const l=1e4;log.debug(`Total elements in DOM: ${e.length}`);for(let a=0;a<e.length&&o<l;a++){const n=e[a];if(o++,n.tagName==="SCRIPT"||n.tagName==="STYLE"||n.tagName==="NOSCRIPT"||n.classList.contains("MathJax")||n.hasAttribute("data-chem-processed"))continue;const m=[];let c="";const f=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,{acceptNode:S=>S.parentNode===n?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});let d;for(;d=f.nextNode();)m.push(d),c+=d.nodeValue;if(!(m.length===0||!c)&&(c.includes("chem:")||c.includes("\\ce{")||c.includes("ce{"))){i++,r.push(c.substring(0,100)),log.debug(`\u{1F52C} Found potential chemistry text: "${c.substring(0,80)}..."`);const S=wrapChemicalFormulas(c);if(S!==c){log.debug(`\u2728 Found formula in text: "${c.substring(0,50)}..."`),log.debug(`Wrapped result: "${S.substring(0,50)}..."`);const b=document.createElement("span");b.innerHTML=S,b.setAttribute("data-chem-processed","true"),n.replaceChild(b,m[0]);for(let u=1;u<m.length;u++)m[u].parentNode&&m[u].parentNode.removeChild(m[u]);const g=b.querySelectorAll('img.molecule-diagram[data-loaded="false"]');if(g.length>0)if(settings.performanceMode&&window._lazyLoadObserver)g.forEach(u=>{window._lazyLoadObserver.observe(u)}),log.debug(`\u{1F4CA} Setup lazy-loading for ${g.length} SVGs`);else if(window._loadMoleculeImage&&window._queueMoleculeLoad){const u=window.scrollY+window.innerHeight/2,M=Array.from(g).map(E=>{const A=E.getBoundingClientRect(),I=window.scrollY+A.top+A.height/2,s=Math.abs(I-u);return{img:E,distance:s}});M.sort((E,A)=>E.distance-A.distance),M.forEach(({img:E},A)=>{window._queueMoleculeLoad(E)}),log.debug(`\u{1F4CA} Queued ${g.length} SVGs for chunk-based loading`)}else window._loadMoleculeImage&&(g.forEach((u,M)=>{u.dataset.loaded="pending",setTimeout(()=>{u.dataset.loaded==="pending"&&(u.dataset.loaded="loading",window._loadMoleculeImage(u))},M*300)}),log.debug(`\u{1F4CA} Triggered fallback loading for ${g.length} SVGs`));t++}}}log.inject("\u{1F4CA} Scan results:"),log.inject(`  - Elements scanned: ${o}`),log.inject(`  - Text nodes found: ${i}`),log.inject(`  - Formulas wrapped: ${t}`),r.length>0&&(log.inject(`  - Chemistry text samples: ${r.length} found`),r.forEach((a,n)=>{log.debug(`    Sample ${n+1}: ${a}`)})),t>0?(log.inject(`\u{1F3A8} ${t} formula(s) found and processed!`),window.MathJax&&window.MathJax.typesetPromise?(log.inject("Calling MathJax.typesetPromise() for final rendering"),MathJax.typesetPromise().then(()=>{log.success("\u2728 RENDERING COMPLETE! Formulas rendered with MathJax")}).catch(a=>{log.debug("MathJax rendering skipped (not available), using fallback")})):log.success("\u2728 Formulas processed - CodeCogs and Unicode rendering active")):log.debug("No formulas found in this scan - page may not contain chemistry notation"),window._chemRendererObserver||(log.inject("Setting up dynamic content observer"),observePageChanges())}function wrapChemicalFormulas(e){if(!e||e.trim().length===0||e.length>5e4)return e;let t=e,o=[];if(log.debug("\u{1F9EA} Applying Pattern 0b: chem:text: \u2192 Using selected renderer engine"),t.length>0){const l=t.substring(0,200)}const i=/\bchem:([^=]*?)(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid|quan|hybrid)=([^:]+):/gi,r=t.match(i);return r&&(r.length>100&&(r.length=100),log.debug(`  Found ${r.length} chem:type=value: patterns`),log.debug(`  Renderer engine: ${settings.rendererEngine}, 3D Viewer enabled: ${settings.enable3DViewer}`),t=t.replace(/\bchem:([^=]*?)(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid|quan|hybrid)=([^:]+):/gi,(l,a,n,m)=>{try{const c=m.trim(),f=a?a.trim():"";if(!c||c.length>500||/\s+[a-zA-Z]{2,}/.test(c)||/\b(should|only|with|that|this|the|and|for|not|use|when|from|have|are|was|were)\b/i.test(c))return l;const S=f?f+n.toLowerCase()+"="+c:n.toLowerCase()+"="+c;log.debug(`  Converting molecule: ${S} (displayName: "${f}")`),window.chemRendererPerformance.recordStructure();let b=f||c,g={useDefaults:!1},u=settings;if(!0)try{const x=settings.enableAIFlagControl===!0;g=window.parseChemFlags("chem:"+S+":",x),g.moleculeName&&!f&&(b=g.moleculeName);let v;g.useDefaults?v=settings:g.flagsLocked?v={...settings,m2cfShowCarbons:!1,m2cfAromaticCircles:!1,m2cfShowMethyls:!1,m2cfAtomNumbers:!1,m2cfAddH2:!1,m2cfFlipHorizontal:!1,m2cfFlipVertical:!1,m2cfInvert:!1}:v=settings,u=window.applyFlagOverrides(v,g),g.moleculeName||(S.includes("/")?b=S.split("/")[0].trim():S.includes("+")?b=S.split("+")[0].trim():S.includes("-")&&(b=S.split("-")[0].trim()))}catch{b=S,u=settings}const E=g.isDirectSmiles,A=g.compoundType,I={...g,compoundType:A==="smiles"?"compound":A,isDirectSmiles:E,smilesValue:g.smilesValue,displayName:g.moleculeName},s=g.smilesValue||(E?b:null);if(g.isDirectID&&g.idValue){const x=g.idValue,v=g.moleculeName||x;if(g.idType==="pdbid"){const R=`<img src="" alt="chem" class="molecule-diagram molecule-biomolecule" data-molecule-viewer="${btoa(JSON.stringify({pdbid:x,name:v,type:"pdbid",compoundType:"biomolecule",flags:I}))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending PDB ID to biomolecule viewer: ${x}`),R}else if(g.idType==="cid"){const C={cid:x,name:v,type:"cid",isCompound:!0,directLookup:!0,flags:{...I,compoundType:"compound",skipIntegratedSearch:!0}},R=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(C))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending CID to server: ${x}`),R}else if(g.idType==="codid"){const R=`<img src="" alt="chem" class="molecule-diagram molecule-mineral" data-molecule-viewer="${btoa(JSON.stringify({codid:x,name:v,type:"codid",compoundType:"mineral",flags:I}))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending COD ID to mineral viewer: ${x}`),R}}if(g.is3D){const x={...s?{smiles:s}:{nomenclature:b},name:b,type:s?"smiles":"nomenclature",isCompound:!0,show3D:!0,auto3D:!0,flags:I},C=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(x))}" data-loaded="false" data-show-3d="true" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending ${s?"SMILES":"nomenclature"} to 3D viewer: ${b}`),C}if(g.isQuantumOrbital||g.isHybridOrbital||A==="quantum"||A==="hybrid"){const x=g.isHybridOrbital||A==="hybrid",v=g.moleculeName||b,T={nomenclature:v,name:f||v,compoundType:x?"hybrid":"quantum",flags:{...I,isQuantumOrbital:!x,isHybridOrbital:x,compoundType:x?"hybrid":"quantum"}},B=`<img src="" alt="orbital" class="molecule-diagram molecule-quantum" data-molecule-viewer="${btoa(JSON.stringify(T))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending ${x?"hybrid":"quantum"} orbital to viewer: ${v}`),B}if(g.isCompound||A==="compound"){const x={...s?{smiles:s}:{nomenclature:b},name:b,type:s?"smiles":"nomenclature",isCompound:!0,directLookup:!0,flags:{...I,compoundType:"compound",skipIntegratedSearch:!0}},C=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(x))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending ${s?"SMILES":"nomenclature"} DIRECTLY to server (mol= syntax): ${b}`),C}const h=u.m2cfRotate||u.mvRotate||0,p=g.size||1,w={...s?{smiles:s}:{nomenclature:b},type:s?"smiles":"nomenclature",options:{width:Math.round(300*p),height:Math.round(200*p),aromaticCircles:u.m2cfAromaticCircles,fancyBonds:u.m2cfFancyBonds,showCarbons:u.m2cfShowCarbons,showMethyls:u.m2cfShowMethyls,atomNumbers:u.m2cfAtomNumbers,hydrogensMode:u.m2cfHydrogensMode,addH2:u.m2cfAddH2,flipHorizontal:u.m2cfFlipHorizontal,flipVertical:u.m2cfFlipVertical,scale:p,rotation:g.rotation||h},isMoleculeViewer:!0,flags:I},k=`<img src="" alt="chem" class="molecule-diagram molecule-viewer" data-molecule-viewer="${btoa(JSON.stringify(w))}" data-loaded="false" data-rotation="${h}" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending ${E?"SMILES":"nomenclature"} to MoleculeViewer: ${b} (type: ${A||"auto-detect"})`),k}catch{return l}})),o.length>0&&log.debug(`\u2705 Total patterns found & converted: ${o.length}`),t}function observePageChanges(){if(window._chemRendererObserver){try{window._chemRendererObserver.disconnect(),clearTimeout(window._chemRendererObserver.timer)}catch{}window._chemRendererObserver=null}log.inject("\u{1F504} Setting up mutation observer for dynamic content detection");let e=0,t=!1,o=0,i=!1,r=0;const l=1e3,a=2e3,n=new MutationObserver(m=>{if(t)return;const c=Math.min(m.length,5);for(let f=0;f<c;f++){const d=m[f].target;if(d&&(d.classList&&(d.classList.contains("molecule-diagram")||d.classList.contains("molecule-container")||d.classList.contains("molecule-viewer")||d.classList.contains("chem-size-controls")||d.classList.contains("chemistrylatex-image-loading-indicator"))||d.closest&&d.closest(".molecule-container, .chem-image-container, .molecule-viewer-container")))return}if(o+=m.length,e++,o>l){const f=Date.now();(!i||f-r>a)&&(log.warn(`\u26A0\uFE0F High mutation rate detected (${o}), throttling to prevent crashes...`),i=!0,r=f),o=0,clearTimeout(n.timer),n.timer=setTimeout(()=>{if(i=!1,o=0,settings.enabled&&!t&&!isUpdatingImages){t=!0;try{log.inject("\u26A1 Delayed re-scan after high mutation period"),scanAndRender()}catch(d){log.error("Error during page scan:",d)}finally{setTimeout(()=>{t=!1},200)}}},1500);return}e%100===0&&log.debug(`Detected ${e} total mutations`),clearTimeout(n.timer),n.timer=setTimeout(()=>{if(o=0,isUpdatingImages){log.debug("\u23ED\uFE0F Skipping re-scan - currently updating images");return}if(settings.enabled){t=!0;try{log.inject("\u26A1 Re-scanning page after dynamic content detected"),scanAndRender()}catch(f){log.error("Error during page scan:",f)}finally{setTimeout(()=>{t=!1},100)}}},500)});n.observe(document.documentElement,{childList:!0,subtree:!0,characterData:!1}),window._chemRendererObserver=n,log.success("\u2705 Dynamic content observer initialized")}function cleanupObservers(){try{window._chemRendererObserver&&(window._chemRendererObserver.disconnect(),clearTimeout(window._chemRendererObserver.timer),window._chemRendererObserver=null),window._lazyLoadObserver&&(window._lazyLoadObserver.disconnect(),window._lazyLoadObserver=null),lazyReRenderObserver&&(lazyReRenderObserver.disconnect(),lazyReRenderObserver=null),renderedImageCache.clear(),pendingSearches.clear(),imagesBeingRendered.clear(),log.info("\u{1F9F9} Cleaned up all observers and caches")}catch{}}if(window.addEventListener("beforeunload",cleanupObservers),window.addEventListener("pagehide",cleanupObservers),window.matchMedia){let t=function(o){document.querySelectorAll("img.molecule-diagram").forEach(l=>{const a=l.src;if(a&&a.startsWith("data:image/svg+xml;base64,"))try{const n=a.replace("data:image/svg+xml;base64,",""),m=atob(n);let c=m;if(o?c=c.replace(/#000000/gi,"#FFFFFF").replace(/#000\b/gi,"#FFF").replace(/rgb\(0,\s*0,\s*0\)/gi,"rgb(255, 255, 255)").replace(/stroke="black"/gi,'stroke="white"').replace(/fill="black"/gi,'fill="white"'):c=m.replace(/#FFFFFF/gi,"#000000").replace(/#FFF\b/gi,"#000").replace(/rgb\(255,\s*255,\s*255\)/gi,"rgb(0, 0, 0)").replace(/stroke="white"/gi,'stroke="black"').replace(/fill="white"/gi,'fill="black"'),l.dataset.originalSrc||(l.dataset.originalSrc=a),!o&&l.dataset.originalSrc){l.src=l.dataset.originalSrc;return}l.src="data:image/svg+xml;base64,"+btoa(c)}catch{}}),document.querySelectorAll("img.compound-diagram").forEach(l=>{})};var updateMoleculeColors=t;window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>{t(o.matches)}),log.success("\u2705 Dark mode listener initialized")}log.success("\u{1F389} ChemRenderer loaded");function renderSelectionAsMolecule(e,t){const o=window.getSelection();if(!o.rangeCount)return;const i=o.getRangeAt(0),r=document.createElement("img");r.className="molecule-diagram molecule-viewer",r.alt=e,r.title=t.title,r.src="";const l={nomenclature:t.nomenclature||e,type:t.type||"nomenclature",options:{width:400,height:300,scale:1,rotation:0},isMoleculeViewer:!0,flags:t.flags};t.smiles&&(l.smiles=t.smiles),r.dataset.moleculeViewer=btoa(JSON.stringify(l)),r.dataset.loaded="false",r.dataset.rotation="0",r.dataset.compoundType=t.flags.compoundType,t.smiles&&(r.dataset.smiles=t.smiles),r.style.cssText="display:inline-block;vertical-align:middle;margin:0 4px;min-width:100px;min-height:80px;background:rgba(128,128,128,0.1);border-radius:4px;padding:4px",i.deleteContents(),i.insertNode(r),o.removeAllRanges(),window._loadMoleculeImage?window._loadMoleculeImage(r):r.alt="Error: Renderer not ready"}chrome.runtime.onMessage.addListener((e,t,o)=>{const i=e.text?.trim();switch(e.type){case"INSPECT_MOLECULE":if(!i)return;renderSelectionAsMolecule(i,{title:`Searching compound database: ${i}`,flags:{compoundType:"compound",isDirectSmiles:!1}});break;case"RENDER_SMILES":if(!i)return;renderSelectionAsMolecule(i,{title:`SMILES: ${i}`,type:"smiles",smiles:i,flags:{compoundType:"compound",isDirectSmiles:!0}});break;case"RENDER_BIOMOLECULE":if(!i)return;renderSelectionAsMolecule(i,{title:`Searching protein database: ${i}`,flags:{compoundType:"biomolecule",isDirectSmiles:!1}});break;case"RENDER_MINERAL":if(!i)return;renderSelectionAsMolecule(i,{title:`Searching mineral database: ${i}`,flags:{compoundType:"mineral",isDirectSmiles:!1}});break;case"RENDER_IUPAC":if(!i)return;renderSelectionAsMolecule(i,{title:`Converting IUPAC Name: ${i}`,isIUPAC:!0,flags:{compoundType:"compound",isDirectSmiles:!1,isIUPAC:!0}});break}if(e.type==="RERENDER_IMAGE"){const r=e.srcUrl,l=e.renderAs,a=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let n=null;for(const d of a)if(d.src===r){n=d;break}if(!n)return;let m=n.dataset.nomenclature||n.dataset.smiles||n.alt?.replace(/^(SMILES|Biomolecule|Mineral):\s*/,"")||n.title?.replace(/^(Searching|Rendering|PDB|COD).*?:\s*/,"");if(!m&&n.dataset.moleculeViewer)try{const d=JSON.parse(atob(n.dataset.moleculeViewer));m=d.smiles||d.nomenclature||d.name}catch{}if(!m){alert("Could not determine the original molecule name/SMILES from this image.");return}m=m.trim();let c,f;switch(l){case"molecule":f={compoundType:"compound",isDirectSmiles:!1},c={nomenclature:m,type:"nomenclature",flags:f};break;case"smiles":f={compoundType:"compound",isDirectSmiles:!0},c={smiles:m,nomenclature:`SMILES: ${m}`,type:"smiles",flags:f},n.dataset.smiles=m;break;case"biomolecule":f={compoundType:"biomolecule",isDirectSmiles:!1},c={nomenclature:m,type:"nomenclature",flags:f};break;case"mineral":f={compoundType:"mineral",isDirectSmiles:!1},c={nomenclature:m,type:"nomenclature",flags:f};break;default:return}c.options={width:400,height:300,scale:1,rotation:0},c.isMoleculeViewer=!0,n.dataset.moleculeViewer=btoa(JSON.stringify(c)),n.dataset.loaded="false",n.dataset.compoundType=f.compoundType||"auto",n.alt=m,n.title=`Re-rendering as ${l}: ${m}`,n.src="",window._loadMoleculeImage?window._loadMoleculeImage(n):n.alt="Error: Renderer not ready"}if(e.type==="EDIT_FLAGS"){const r=e.srcUrl,l=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let a=null;for(const d of l)if(d.src===r){a=d;break}if(!a)return;let n={},m=a.alt||a.title||"Unknown";if(a.dataset.moleculeViewer)try{const d=JSON.parse(atob(a.dataset.moleculeViewer));n=d.flags||{},m=d.nomenclature||d.smiles||m}catch{}const c=document.getElementById("chemistrylatex-flag-editor");c&&c.remove();const f=document.createElement("div");f.id="chemistrylatex-flag-editor",f.innerHTML=`
      <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999999; display: flex; align-items: center; justify-content: center;">
        <div style="background: #fff; border-radius: 12px; padding: 24px; min-width: 350px; max-width: 450px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
          <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">\u{1F39B}\uFE0F ChemistryLaTeX Flag Editor</h3>
          <p style="margin: 0 0 16px 0; font-size: 13px; color: #666; word-break: break-all;">${m}</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-c" ${n.showCarbons?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Carbons (c)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-n" ${n.atomNumbers?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Atom Numbers (n)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-o" ${n.aromaticCircles?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Aromatic Rings (o)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-h" ${n.addHydrogens?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Hydrogens (h)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-m" ${n.showMethyls?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Methyls (m)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-i" ${n.showImplicitHydrogens?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Implicit H (i)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-p" ${n.flipHorizontal?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Flip Horizontal (p)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-q" ${n.flipVertical?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Flip Vertical (q)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; grid-column: span 2;">
              <input type="checkbox" id="flag-3d" ${n.is3D?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show 3D Model First (3d)</span>
            </label>
          </div>
          
          <p style="margin: 0 0 16px 0; font-size: 11px; color: #999;">\u26A0\uFE0F Changes are temporary and will be reset when you change global settings in the popup.</p>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="flag-cancel" style="padding: 10px 20px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button id="flag-apply" style="padding: 10px 20px; border: none; background: #4CAF50; color: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Apply</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(f),document.getElementById("flag-cancel").addEventListener("click",()=>{f.remove()}),document.getElementById("flag-apply").addEventListener("click",()=>{const d={showCarbons:document.getElementById("flag-c").checked,atomNumbers:document.getElementById("flag-n").checked,aromaticCircles:document.getElementById("flag-o").checked,addHydrogens:document.getElementById("flag-h").checked,showMethyls:document.getElementById("flag-m").checked,showImplicitHydrogens:document.getElementById("flag-i").checked,flipHorizontal:document.getElementById("flag-p").checked,flipVertical:document.getElementById("flag-q").checked,is3D:document.getElementById("flag-3d").checked,flagsLocked:!0,...n};let S={};if(a.dataset.moleculeViewer)try{S=JSON.parse(atob(a.dataset.moleculeViewer))}catch{}S.flags=d,S.isMoleculeViewer=!0,a.dataset.moleculeViewer=btoa(JSON.stringify(S)),a.dataset.loaded="false",a.src="",window._loadMoleculeImage&&window._loadMoleculeImage(a),f.remove()}),f.querySelector("div").addEventListener("click",d=>{d.target===f.querySelector("div")&&f.remove()})}});
