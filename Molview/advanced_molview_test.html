<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced MolView Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .viewer-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .test-buttons {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .compound-input {
            margin: 15px 0;
        }
        .compound-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .compound-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ§ª Advanced MolView Solution Test</h1>
        <p>Testing compound-specific MolView loading with CORS-aware URL selection</p>
        
        <div class="compound-input">
            <label for="compound-name">Compound Name or CID:</label>
            <input type="text" id="compound-name" placeholder="e.g., caffeine, 20851, deoxyribonuclease, etc." value="20851">
        </div>
        
        <div class="test-buttons">
            <button class="btn" onclick="loadSmartMolView()">Smart Load (Recommended)</button>
            <button class="btn btn-small" onclick="loadMolViewEmbed()">Force Embed</button>
            <button class="btn btn-small" onclick="loadMolViewDirect()">Force Direct</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <h3>Viewer:</h3>
        <div id="viewer-container" class="viewer-container">
            <p>Enter a compound and click a load button to view in MolView</p>
        </div>
        
        <h3>Test Common Compounds:</h3>
        <div class="test-buttons">
            <button class="btn btn-small" onclick="testCompound('20851', 'Aspirin')">Aspirin (CID: 20851)</button>
            <button class="btn btn-small" onclick="testCompound('702', 'Glucose')">Glucose (CID: 702)</button>
            <button class="btn btn-small" onclick="testCompound('caffeine', 'Caffeine')">Caffeine</button>
            <button class="btn btn-small" onclick="testCompound('deoxyribonuclease', 'DNase')">DNase</button>
        </div>
    </div>

    <script>
        function showStatus(message, isSuccess = true) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${isSuccess ? 'success' : 'error'}`;
            statusDiv.style.display = 'block';
        }
        
        function isLargeCompound(cid) {
            // Check if CID is large (>100k) which often causes embed CORS issues
            if (!isNaN(cid) && parseInt(cid) > 100000) {
                return true;
            }
            return false;
        }
        
        function isProteinOrNucleicAcid(name) {
            const lowerName = name.toLowerCase();
            // Check for proteins, enzymes, DNA/RNA related compounds
            return lowerName.includes('protein') || 
                   lowerName.includes('enzyme') || 
                   lowerName.includes('dna') || 
                   lowerName.includes('rna') || 
                   lowerName.includes('nucleic') ||
                   lowerName.includes('deoxyribo') ||
                   lowerName.includes('nucleas') ||
                   lowerName.includes('peptid') ||
                   lowerName.includes('globin');
        }
        
        function getCompoundType(name) {
            if (isProteinOrNucleicAcid(name)) return 'protein';
            if (isLargeCompound(name) || (!isNaN(name) && parseInt(name) > 100000)) return 'large';
            return 'small';
        }
        
        function getMolViewUrlForCompound(name) {
            // Special handling for known proteins that have PDB entries
            const pdbLookup = {
                'deoxyribonuclease': '2dnj',
                'hemoglobin': '1gdx',
                'insulin': '2hiu',
                'myoglobin': '1mbn',
                'lysozyme': '1d6y',
                'rna': '1ehz',
                'dna': '1bna',
                'trna': '1ehz',
                'albumin': '1e7i'
            };
            
            if (name in pdbLookup) {
                return `https://molview.org/?pdbid=${pdbLookup[name]}`;
            }
            
            // For large compounds, use direct URL to avoid CORS
            if (isLargeCompound(name)) {
                if (name.length === 1 && !isNaN(name)) {
                    // If it's a numeric CID
                    return `https://molview.org/?cid=${encodeURIComponent(name)}`;
                }
                return `https://molview.org/?smiles=${encodeURIComponent(name)}`;
            }
            
            // For proteins/nucleic acids, prefer direct URL
            if (isProteinOrNucleicAcid(name)) {
                return `https://molview.org/?smiles=${encodeURIComponent(name)}`;
            }
            
            // For small compounds, use embed (safe for iframes)
            if (name.length === 1 && !isNaN(name)) {
                return `https://embed.molview.org/v1/?mode=balls&cid=${encodeURIComponent(name)}`;
            }
            return `https://embed.molview.org/v1/?mode=balls&smiles=${encodeURIComponent(name)}`;
        }
        
        async function loadSmartMolView() {
            const compoundInput = document.getElementById('compound-name').value.trim();
            if (!compoundInput) {
                showStatus('Please enter a compound name or CID', false);
                return;
            }

            showStatus(`Analyzing compound: ${compoundInput}`);
            
            try {
                // Determine compound type and appropriate URL
                const compoundType = getCompoundType(compoundInput);
                const molviewUrl = getMolViewUrlForCompound(compoundInput);
                
                showStatus(`Loading ${compoundType} compound using: ${molviewUrl}`);
                
                const viewerContainer = document.getElementById('viewer-container');
                viewerContainer.innerHTML = `
                    <iframe src="${molviewUrl}" 
                            onload="showStatus('MolView loaded successfully')" 
                            onerror="showStatus('Failed to load MolView. This may be due to CORS or CSP restrictions.', false)"></iframe>
                `;
                
                console.log(`Smart load: ${compoundType} compound - ${molviewUrl}`);
            } catch (error) {
                showStatus(`Error loading compound: ${error.message}`, false);
            }
        }
        
        async function loadMolViewEmbed() {
            const compoundInput = document.getElementById('compound-name').value.trim();
            if (!compoundInput) {
                showStatus('Please enter a compound name or CID', false);
                return;
            }
            
            showStatus(`Loading embed version for: ${compoundInput}`);
            
            let embedUrl;
            if (!isNaN(compoundInput)) {
                embedUrl = `https://embed.molview.org/v1/?mode=balls&cid=${encodeURIComponent(compoundInput)}`;
            } else {
                embedUrl = `https://embed.molview.org/v1/?mode=balls&smiles=${encodeURIComponent(compoundInput)}`;
            }
            
            const viewerContainer = document.getElementById('viewer-container');
            viewerContainer.innerHTML = `
                <iframe src="${embedUrl}" 
                        onload="showStatus('Embed version loaded successfully')" 
                        onerror="showStatus('Embed version failed - likely CORS issue with large compounds', false)"></iframe>
            `;
        }
        
        async function loadMolViewDirect() {
            const compoundInput = document.getElementById('compound-name').value.trim();
            if (!compoundInput) {
                showStatus('Please enter a compound name or CID', false);
                return;
            }
            
            showStatus(`Loading direct version for: ${compoundInput}`);
            
            let directUrl;
            if (!isNaN(compoundInput)) {
                directUrl = `https://molview.org/?cid=${encodeURIComponent(compoundInput)}`;
            } else {
                directUrl = `https://molview.org/?smiles=${encodeURIComponent(compoundInput)}`;
            }
            
            const viewerContainer = document.getElementById('viewer-container');
            viewerContainer.innerHTML = `
                <iframe src="${directUrl}" 
                        onload="showStatus('Direct version loaded successfully')" 
                        onerror="showStatus('Direct version failed - possible CSP block', false)"></iframe>
            `;
        }
        
        function testCompound(compound, displayName) {
            document.getElementById('compound-name').value = compound;
            showStatus(`Testing: ${displayName} (${compound})`);
            loadSmartMolView();
        }
    </script>
</body>
</html>