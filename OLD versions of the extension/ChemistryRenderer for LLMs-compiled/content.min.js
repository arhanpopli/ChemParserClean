/**
 * ChemistryRenderer for LLMs
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * Unauthorized copying, modification, or distribution of this software is prohibited.
 */
const CHEMTEX_SERVER_URL="https://server-chemistryrenderer.vercel.app",deathstarversion="v6";let anakinisangrybecausepadmedied="";function buildServerSvgUrl(e,t,o={}){const n=["mol","smiles","iupac"].includes(e.toLowerCase());let c=t;if(n){const d=[];o.showCarbons&&d.push("c"),o.aromaticCircles&&d.push("o"),o.showMethyls&&d.push("m"),o.atomNumbers&&d.push("n"),o.showHydrogens&&d.push("h"),o.showImplicitH&&d.push("i"),o.gradientColors&&d.push("g"),o.use3dforce&&d.push("s"),o.compactDrawing&&d.push("k"),o.flipHorizontal&&d.push("p"),o.flipVertical&&d.push("q"),d.sort(),d.length>0&&(c=`${t}+${d.join("+")}`)}const s=new URLSearchParams;s.set("_v","v6"),anakinisangrybecausepadmedied&&s.set("_t",anakinisangrybecausepadmedied);const m={rdkit:"/rdkit",kekule:"/kekule"}[o.renderingEngine]||"",i=s.toString();return`${CHEMTEX_SERVER_URL}${m}/${e}=${encodeURIComponent(c)}.svg${i?"?"+i:""}`}async function askdarthvader69(e,t){const o=`${CHEMTEX_SERVER_URL}/${e}=${encodeURIComponent(t)}.json`,r=await fetch(o);if(!r.ok)throw new Error(`Server returned ${r.status}`);return r.json()}const ATOM_COLOR_MARKERS={C:"#101010",H:"#181818",N:"#202020",O:"#282828",S:"#303030",P:"#383838",F:"#404040",CL:"#484848",BR:"#505050",I:"#585858",B:"#606060",SI:"#686868",ATOM_NUMBER:"#707070"},ELEMENT_COLOR_SCHEMES={light:{C:"#222222",H:"#666666",N:"#3498db",O:"#e74c3c",S:"#f1c40f",P:"#d35400",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",B:"#e67e22",SI:"#e67e22",ATOM_NUMBER:"#2196F3"},dark:{C:"#ffffff",H:"#aaaaaa",N:"#4dabf7",O:"#ff6b6b",S:"#fcc419",P:"#fd7e14",F:"#51cf66",CL:"#20c997",BR:"#fd7e14",I:"#be4bdb",B:"#f59f00",SI:"#f59f00",ATOM_NUMBER:"#ffd700"},classic_black:{C:"#000000",H:"#000000",N:"#000000",O:"#000000",S:"#000000",P:"#000000",F:"#000000",CL:"#000000",BR:"#000000",I:"#000000",B:"#000000",SI:"#000000",ATOM_NUMBER:"#000000"},classic_white:{C:"#ffffff",H:"#ffffff",N:"#ffffff",O:"#ffffff",S:"#ffffff",P:"#ffffff",F:"#ffffff",CL:"#ffffff",BR:"#ffffff",I:"#ffffff",B:"#ffffff",SI:"#ffffff",ATOM_NUMBER:"#ffffff"},solarized:{C:"#586e75",H:"#657b83",N:"#268bd2",O:"#dc322f",S:"#b58900",P:"#d33682",F:"#859900",CL:"#16a085",BR:"#cb4b16",I:"#6c71c4",B:"#2aa198",SI:"#2aa198",ATOM_NUMBER:"#2196F3"},matrix:{C:"#00FF41",H:"#008F11",N:"#003B00",O:"#0D0208",S:"#00FF41",P:"#00FF41",F:"#00FF41",CL:"#00FF41",BR:"#00FF41",I:"#00FF41",B:"#00FF41",SI:"#00FF41",ATOM_NUMBER:"#00FF41"},github:{C:"#c9d1d9",H:"#8b949e",N:"#58a6ff",O:"#f85149",S:"#d29922",P:"#db6d28",F:"#3fb950",CL:"#3fb950",BR:"#db6d28",I:"#a371f7",B:"#db6d28",SI:"#db6d28",ATOM_NUMBER:"#58a6ff"},carbon:{C:"#f4f4f4",H:"#a8a8a8",N:"#4589ff",O:"#fa4d56",S:"#f1c21b",P:"#ff832b",F:"#42be65",CL:"#42be65",BR:"#ff832b",I:"#a56eff",B:"#ff832b",SI:"#ff832b",ATOM_NUMBER:"#4589ff"}};function applyThemeColors(e,t){const o=ELEMENT_COLOR_SCHEMES[t]||ELEMENT_COLOR_SCHEMES.light;let r=e;for(const[n,c]of Object.entries(ATOM_COLOR_MARKERS)){const s=o[n]||c,u=new RegExp(c,"gi");r=r.replace(u,s)}return r}window.addEventListener("error",function(e){if(e.filename&&e.filename.includes("chrome-extension://"))return e.preventDefault(),!0}),window.addEventListener("unhandledrejection",function(e){const t=e.reason;if(t&&t.stack&&t.stack.includes("ChemRenderer")||t&&t.message&&t.message.includes("Extension context invalidated"))return e.preventDefault(),!0});const bobtag="[ChemRenderer]",bobthelogger={info:(e,t)=>{},success:(e,t)=>{},warn:(e,t)=>{},error:(e,t)=>{},debug:(e,t)=>{},inject:(e,t)=>{}};let bobsnotes=[],theempiredidnothingwrong=!1;const structureRenderCache=new Map,maxjedicache=100;function genStructureKey(e,t={}){const o=[t.showCarbons?"c1":"c0",t.showMethyls?"m1":"m0",t.aromaticCircles?"a1":"a0",t.showHydrogens?"h1":"h0",t.atomNumbers?"n1":"n0",t.theme||"light",t.width||300,t.height||240].join("_");return`${e}__${o}`}const MOLECULE_CACHE_KEY="chemtex_smiles_cache",MOLECULE_CACHE_LIMIT=500;let moleculeCache={},moleculeCacheReady=!1;async function loadMoleculeCache(){if(moleculeCacheReady)return moleculeCache;try{moleculeCache=(await chrome.storage.local.get(MOLECULE_CACHE_KEY))[MOLECULE_CACHE_KEY]||{},moleculeCacheReady=!0,bobthelogger.info(`\u{1F4E6} Loaded SMILES cache: ${Object.keys(moleculeCache).length} entries`)}catch(e){bobthelogger.warn("Failed to load SMILES cache:",e),moleculeCache={}}return moleculeCache}async function saveMoleculeCache(){try{const e=Object.keys(moleculeCache);if(e.length>MOLECULE_CACHE_LIMIT){const t=e.length-MOLECULE_CACHE_LIMIT;e.slice(0,t).forEach(o=>delete moleculeCache[o])}await chrome.storage.local.set({[MOLECULE_CACHE_KEY]:moleculeCache})}catch(e){bobthelogger.warn("Failed to save SMILES cache:",e)}}async function getCachedSmiles(e){await loadMoleculeCache();const t=e.toLowerCase().trim(),o=moleculeCache[t];return o?(bobthelogger.debug(`\u{1F3AF} SMILES cache HIT: ${e}`),o.smiles&&!o.canonicalSmiles&&!o.isomericSmiles&&(bobthelogger.debug(`\u{1F504} Migrating old cache format for: ${e}`),o.isomericSmiles=o.smiles,o.canonicalSmiles=removeChiralCenters(o.smiles),delete o.smiles,moleculeCache[t]=o,clearTimeout(setCachedSmiles._saveTimeout),setCachedSmiles._saveTimeout=setTimeout(()=>saveMoleculeCache(),1e3)),o):null}async function setCachedSmiles(e,t){var n,c;await loadMoleculeCache();const o=e.toLowerCase().trim();moleculeCache[o]={...t,cachedAt:Date.now()},clearTimeout(setCachedSmiles._saveTimeout),setCachedSmiles._saveTimeout=setTimeout(()=>saveMoleculeCache(),1e3);const r=t.isomericSmiles||t.canonicalSmiles||"N/A";bobthelogger.debug(`\u{1F4E6} Cached SMILES: ${e} \u2192 canonical: ${((n=t.canonicalSmiles)==null?void 0:n.substring(0,25))||"N/A"}, isomeric: ${((c=t.isomericSmiles)==null?void 0:c.substring(0,25))||"N/A"}`)}const searchinprogress=new Map,neversaytometheodds=50;async function dikiloveyou2(e,t){const o=e.toLowerCase().trim();if(searchinprogress.has(o))return bobthelogger.debug(`\u{1F504} Reusing pending search for: ${e}`),searchinprogress.get(o);searchinprogress.size>=neversaytometheodds&&(bobthelogger.warn(`\u26A0\uFE0F Too many pending searches (${searchinprogress.size}), clearing old ones...`),Array.from(searchinprogress.keys()).slice(0,Math.floor(neversaytometheodds/2)).forEach(c=>searchinprogress.delete(c)));const r=t().finally(()=>{searchinprogress.delete(o)});return searchinprogress.set(o,r),bobthelogger.debug(`\u{1F195} Started new search for: ${e}`),r}function executechemistryorder66(){structureRenderCache.clear(),moleculeCache={},moleculeCacheReady=!1,searchinprogress.clear(),chrome.storage.local.remove(MOLECULE_CACHE_KEY),anakinisangrybecausepadmedied=Date.now().toString(),bobthelogger.info(`\u{1F5D1}\uFE0F Cache cleared! New cache bust timestamp: ${anakinisangrybecausepadmedied}`)}function removeChiralCenters(e){return e&&e.replace(/@@|@|\/|\\/g,"")}const renderedCompounds=new Map;function getaffectedtypez(e){const t=new Set,o=["showcarbonz","aromaticringz","sdShowMethyls","sdAtomNumbers","sdShowExplicitHydrogens","sdShowImplicitHydrogens","sdFlipHorizontal","sdFlipVertical","viztheme","autoadaptmode","rotatemode","sdBondThickness","gradientcolors","scalebyweight","m2cfShowCarbons","m2cfAromaticCircles","m2cfShowMethyls","m2cfAtomNumbers","m2cfAddH2","m2cfShowImplicitH","m2cfFlipHorizontal","m2cfFlipVertical"],r=["molviewRepresentation","compoundMolviewBgColor","molviewEngine"],n=["removebg","viewer3DStyle","viewer3DAutoRotate","viewer3DBgColor","viewer3DSize","molviewChainType","molviewChainBonds","molviewChainColor","proteinMolviewBgColor","bioassembly"],c=["mineralRepresentation","mineralMolviewBgColor","mineralCrystallography"],s=["hyperdrive","forceguidance"],u=Object.keys(e);for(const m of u)(o.includes(m)||r.includes(m))&&t.add("compound"),n.includes(m)&&t.add("biomolecule"),c.includes(m)&&t.add("mineral"),s.includes(m)&&(t.add("compound"),t.add("biomolecule"),t.add("mineral"));return t.size===0&&(t.add("compound"),t.add("biomolecule"),t.add("mineral")),t}async function reactioncomplete420(e){return bobthelogger.info("\u{1F504} Re-rendering all molecules with lazy loading..."),deferredRenderUpdate(e)}let itsatrappp=null,dikiloveyou_iknow=null,isrefreshn=!1;function showspinner2(e){if(e.dataset.hasLoadingIndicator==="true")return;const t=document.createElement("div");t.className="chemtex-image-loading-indicator",t.setAttribute("aria-label","Updating image"),t.style.cssText=`
    position: absolute;
    top: 50%;
    left: 10px;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid rgba(255, 71, 87, 0.25);
    border-top-color: #ff4757;
    z-index: 10;
    animation: chemtex-spin 0.9s linear infinite;
    pointer-events: none;
  `;const o=e.parentElement;if(o&&(window.getComputedStyle(o).position==="static"&&(o.style.position="relative"),o.appendChild(t)),!document.getElementById("chemtex-loading-indicator-style")){const r=document.createElement("style");r.id="chemtex-loading-indicator-style",r.textContent=`
      @keyframes chemtex-spin {
        from { transform: translateY(-50%) rotate(0deg); }
        to { transform: translateY(-50%) rotate(360deg); }
      }
      @keyframes chemtex-fade-in {
        from { opacity: 0.65; }
        to { opacity: 1; }
      }
    `,document.head.appendChild(r)}e.dataset.hasLoadingIndicator="true",e.dataset.loadingIndicatorElement="true"}function hidespinner2(e){if(e.dataset.hasLoadingIndicator!=="true")return;const t=e.parentElement;if(t){const o=t.querySelector(".chemtex-image-loading-indicator");o&&o.remove()}delete e.dataset.hasLoadingIndicator,delete e.dataset.loadingIndicatorElement}function idontlikesanditscoarse(e){const t=e/100,o=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let r=0;o.forEach(n=>{if(n.closest(".molecule-3d-viewer")||n.closest(".molecule-viewer-container")||n.closest(".biomolecule-viewer")||(n.dataset.compoundType||"")==="biomolecule")return;const s=n.src||"";if(!(s.includes("data:image/svg")||s.endsWith(".svg")))return;const m=n.closest(".molecule-container, .chem-image-container");if(m){const i=n.naturalWidth||parseInt(n.style.width)||n.offsetWidth||300,l=n.naturalHeight||parseInt(n.style.height)||n.offsetHeight||240,d=Math.round(i*t),C=Math.round(l*t);m.style.width=d+"px",m.style.height=C+"px",n.style.width="100%",n.style.height="100%",n.style.transform=""}else{const i=n.naturalWidth||parseInt(n.style.width)||n.offsetWidth||300,l=n.naturalHeight||parseInt(n.style.height)||n.offsetHeight||240;n.style.width=Math.round(i*t)+"px",n.style.height=Math.round(l*t)+"px"}r++})}async function deferredRenderUpdate(e){var n,c;if(isrefreshn=!0,Object.assign(settings,e),e.showcarbonz!==void 0&&(settings.m2cfShowCarbons=e.showcarbonz),e.aromaticringz!==void 0&&(settings.m2cfAromaticCircles=e.aromaticringz),e.sdShowMethyls!==void 0&&(settings.m2cfShowMethyls=e.sdShowMethyls),e.sdAtomNumbers!==void 0&&(settings.m2cfAtomNumbers=e.sdAtomNumbers),e.sdShowExplicitHydrogens!==void 0&&(settings.m2cfAddH2=e.sdShowExplicitHydrogens),e.sdShowImplicitHydrogens!==void 0&&(settings.m2cfShowImplicitH=e.sdShowImplicitHydrogens),e.sdCompactDrawing!==void 0&&(settings.m2cfCompactDrawing=e.sdCompactDrawing),e.sdFlipHorizontal!==void 0&&(settings.m2cfFlipHorizontal=e.sdFlipHorizontal),e.sdFlipVertical!==void 0&&(settings.m2cfFlipVertical=e.sdFlipVertical),e.gradientcolors!==void 0&&(settings.gradientcolors=e.gradientcolors),e.viztheme!==void 0&&(settings.viztheme=e.viztheme),e.autoadaptmode!==void 0&&(settings.autoadaptmode=e.autoadaptmode),e.sdBondThickness!==void 0&&(settings.sdBondThickness=e.sdBondThickness),e.rotatemode!==void 0&&(settings.m2cfRotate=e.rotatemode),e.use3dforce!==void 0&&(settings.m2cfUse3DSmiles=e.use3dforce),e.avgsize!==void 0){settings.avgsize=e.avgsize,idontlikesanditscoarse(e.avgsize),isrefreshn=!1;return}e.compound3dsize!==void 0&&(settings.compound3dsize=e.compound3dsize),e.mineral3dsize!==void 0&&(settings.mineral3dsize=e.mineral3dsize);const t=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");if(t.length===0){isrefreshn=!1;return}let o=0;for(const s of t)try{const u=s.dataset.smiles||"",m=s.dataset.originalNomenclature,i=s.dataset.nomenclature,l=f=>!(!f||f==="molecule"||f.includes("Error loading")||f.includes("Server returned")||f.includes("Failed to"));let d=m||i||"";if(!l(d))continue;const C=s.dataset.compoundType||"compound";if(!d||d==="molecule")continue;if(s.dataset.moleculeViewer)try{const f=JSON.parse(atob(s.dataset.moleculeViewer));if((n=f.flags)!=null&&n.flagsLocked&&!((c=f.flags)!=null&&c.useDefaults))continue}catch{}let y;C==="compound"?y={nomenclature:d,smiles:u||null,type:u?"smiles":"nomenclature",options:{width:parseInt(s.dataset.renderWidth)||300,height:parseInt(s.dataset.renderHeight)||240,aromaticCircles:settings.m2cfAromaticCircles,showCarbons:settings.m2cfShowCarbons,showMethyls:settings.m2cfShowMethyls,atomNumbers:settings.m2cfAtomNumbers,addH2:settings.m2cfAddH2,showImplicitH:settings.m2cfShowImplicitH,flipHorizontal:settings.m2cfFlipHorizontal,flipVertical:settings.m2cfFlipVertical,scale:1,rotation:parseInt(s.dataset.rotation)||0},isMoleculeViewer:!0,flags:{useDefaults:!1,compoundType:"compound"}}:C==="biomolecule"?y={nomenclature:d,type:"nomenclature",options:{width:parseInt(s.dataset.renderWidth)||300,height:parseInt(s.dataset.renderHeight)||240,removeWhiteBg:settings.removebg,bioAssembly:settings.bioassembly,chainType:settings.molviewChainType,chainBonds:settings.molviewChainBonds,chainColor:settings.molviewChainColor,proteinBgColor:settings.proteinMolviewBgColor},isMoleculeViewer:!0,flags:{useDefaults:!1,compoundType:"biomolecule"}}:C==="mineral"?y={nomenclature:d,type:"nomenclature",options:{width:parseInt(s.dataset.renderWidth)||300,height:parseInt(s.dataset.renderHeight)||240,representation:settings.mineralRepresentation,mineralBgColor:settings.mineralMolviewBgColor,crystallography:settings.mineralCrystallography},isMoleculeViewer:!0,flags:{useDefaults:!1,compoundType:"mineral"}}:y={nomenclature:d,smiles:u,type:u?"smiles":"nomenclature",options:{width:parseInt(s.dataset.renderWidth)||300,height:parseInt(s.dataset.renderHeight)||240},isMoleculeViewer:!0,flags:{useDefaults:!0,compoundType:C}};const S=btoa(JSON.stringify(y)),w=document.createElement("img");w.className="molecule-diagram molecule-viewer",w.alt=d,w.dataset.moleculeViewer=S,w.dataset.loaded="false",w.dataset.rotation=s.dataset.rotation||"0",w.style.cssText="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;";const v=s.closest(".molecule-container")||s.parentNode;if(v&&v.parentNode)v.parentNode.replaceChild(w,v);else if(s.parentNode)s.parentNode.replaceChild(w,s);else continue;window._loadMoleculeImage&&(window._loadMoleculeImage(w),o++)}catch{}const r=document.querySelectorAll('img.molecule-diagram[data-loaded="false"], img.molecule-viewer[data-loaded="false"]');r.length>0&&window._lazyLoadObserver&&r.forEach(s=>{window._lazyLoadObserver.observe(s)}),settings.avgsize&&settings.avgsize!==100&&setTimeout(()=>{idontlikesanditscoarse(settings.avgsize)},500),isrefreshn=!1}let intersectionObserverInstance=null;const padawanzzzz=new Set,maxbondsinprogress=20;function initneowatchr(){if(intersectionObserverInstance)try{intersectionObserverInstance.disconnect()}catch{}intersectionObserverInstance=new IntersectionObserver(e=>{e.forEach(t=>{if(t.isIntersecting){const o=t.target;processliketoby(o)}})},{rootMargin:"50px",threshold:.1}),document.querySelectorAll("img[data-molecule-viewer]").forEach(e=>{intersectionObserverInstance.observe(e)}),refreshVisibleElements()}function processliketoby(e){const t=e.dataset.smiles||"(no smiles)",o=e.dataset.compoundName||"(no name)";if(!(e.dataset.needsReRender!=="true"&&e.getAttribute("data-needs-re-render")!=="true")){if(padawanzzzz.has(e)){bobthelogger.debug(`\u23ED\uFE0F Image already being processed: ${o}`);return}padawanzzzz.size>=maxbondsinprogress||(bobthelogger.info(`\u{1F504} Processing image for lazy re-render: ${o} (SMILES: ${t.substring(0,30)}...)`),padawanzzzz.add(e),showspinner2(e),tobynobodylikeshim(e,itsatrappp||settings).then(()=>{delete e.dataset.needsReRender,e.removeAttribute("data-needs-re-render"),bobthelogger.debug("\u2705 Successfully re-rendered molecule")}).catch(r=>{bobthelogger.error("Failed to re-render molecule:",r),delete e.dataset.needsReRender,e.removeAttribute("data-needs-re-render")}).finally(()=>{hidespinner2(e),padawanzzzz.delete(e)}))}}function refreshVisibleElements(){const e=document.querySelectorAll('img[data-molecule-viewer][data-needs-re-render="true"]');let t=0;e.forEach(o=>{const r=o.getBoundingClientRect();r.top<window.innerHeight&&r.bottom>0&&r.width>0&&r.height>0&&(t++,processliketoby(o))})}async function tobynobodylikeshim(e,t){try{const o=e.dataset.smiles,r=e.dataset.moleculeName||e.dataset.nomenclature,n=e.dataset.compoundType||"compound";if(n==="biomolecule"||n==="mineral"){bobthelogger.debug(`Skipping re-render for ${n} (uses different renderer)`);return}if(!o&&!r){bobthelogger.debug("Skipping re-render: no SMILES or name data on image");return}const c={showCarbons:settings.m2cfShowCarbons,showMethyls:settings.m2cfShowMethyls,aromaticCircles:settings.m2cfAromaticCircles,showHydrogens:settings.m2cfAddH2,showImplicitH:settings.m2cfShowImplicitH,atomNumbers:settings.m2cfAtomNumbers,gradientColors:settings.gradientcolors,compactDrawing:settings.m2cfCompactDrawing,use3dforce:settings.m2cfUse3DSmiles,flipHorizontal:settings.m2cfFlipHorizontal,flipVertical:settings.m2cfFlipVertical,renderingEngine:settings.renderingEngine},m=buildServerSvgUrl(o?"smiles":"mol",o||r,c);bobthelogger.debug(`\u{1F5BC}\uFE0F Re-rendering via server: ${m}`),await new Promise((i,l)=>{const d=new Image;d.onload=()=>{bobthelogger.debug("\u2705 New image pre-loaded successfully"),i()},d.onerror=C=>{bobthelogger.error("\u274C Failed to pre-load new image:",C),l(C)},d.src=m}),bobthelogger.debug("\u{1F504} Swapping image src..."),e.style.animation="chemtex-fade-in 160ms ease-out",e.src=m,bobthelogger.debug("\u2705 Image src updated successfully"),setTimeout(()=>{try{e.style.animation=""}catch{}},220)}catch(o){throw bobthelogger.error("Error re-rendering single molecule:",o),o}}async function kevindroppedchili(){bobthelogger.info("\u{1F504} Reloading all images (forced refresh)...");const e=document.querySelectorAll("img[data-molecule-viewer]");let t=0;for(const o of e){showspinner2(o);try{await tobynobodylikeshim(o,settings),t++}catch(r){bobthelogger.error("Failed to reload image:",r)}finally{hidespinner2(o)}}bobthelogger.success(`\u2705 Reloaded ${t} images`)}function applydriponly(e){document.querySelectorAll('img[data-molecule-viewer="true"]').forEach(r=>{const n=r.dataset.rawSvg;if(n){const c=decodeURIComponent(n),s=applyThemeColors(c,e.viztheme||"light");r.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(s)}e.gradientcolors?r.classList.add("gradient-bonds"):r.classList.remove("gradient-bonds")}),document.querySelectorAll("iframe.biomolecule-viewer, .molecule-3d-viewer").forEach(r=>{e.removebg?(r.style.filter="drop-shadow(0 0 0 transparent)",r.style.mixBlendMode="multiply"):(r.style.filter="",r.style.mixBlendMode="")})}chrome.runtime.onMessage.addListener((e,t,o)=>{try{if(e.type==="APPLY_SETTINGS"){bobthelogger.info("\u{1F4EC} Received settings update from popup:",e.settings);const r=["removebg","gradientcolors","autoadaptmode"],n=e.changedSettings||[];if(n.length>0&&n.every(s=>r.includes(s)))return applydriponly(e.settings),o({success:!0,cssOnly:!0}),!0;try{deferredRenderUpdate(e.settings)}catch{}return o({success:!0}),!0}if(e.type==="RELOAD_ALL_IMAGES"){bobthelogger.info("\u{1F4EC} Received reload all images command");try{kevindroppedchili()}catch{}return o({success:!0}),!0}if(e.type==="CLEAR_CACHE")return executechemistryorder66(),chrome.storage.sync.get(null,r=>{deferredRenderUpdate(r)}),o({success:!0,message:"Cache cleared, re-rendering with fresh content"}),!0}catch(r){return o({success:!1,error:r.message}),!0}});function isDarkModeEnabled(){var t,o,r,n;if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return!0;try{const c=window.getComputedStyle(document.documentElement),s=window.getComputedStyle(document.body);if((c.colorScheme||s.colorScheme||"").includes("dark"))return!0}catch{}try{const c=[document.documentElement,document.body];for(const s of c){if(!s)continue;const u=window.getComputedStyle(s).backgroundColor;if(u&&u!=="rgba(0, 0, 0, 0)"&&u!=="transparent"){const m=u.match(/\d+/g);if(m&&m.length>=3){const i=.299*parseInt(m[0])+.587*parseInt(m[1])+.114*parseInt(m[2]);if(i<100)return!0;if(i>180)return!1}}}}catch{}const e=["dark","dark-mode","dark-theme","night-mode","skin-minerva-dark","client-dark-mode"];for(const c of e)if((o=(t=document.body)==null?void 0:t.classList)!=null&&o.contains(c)||(n=(r=document.documentElement)==null?void 0:r.classList)!=null&&n.contains(c))return!0;try{const c=document.documentElement.getAttribute("data-theme")||document.body.getAttribute("data-theme")||document.documentElement.getAttribute("data-color-mode")||document.body.getAttribute("data-color-mode")||"";if(c.toLowerCase().includes("dark")||c.toLowerCase().includes("night"))return!0}catch{}return!1}function rebelscumisalive(){try{return!(theempiredidnothingwrong||!chrome.runtime||!chrome.runtime.id)}catch{return!1}}async function padmewhenanikillsyounglings(e){try{if(!rebelscumisalive())return usedaforce(e);if(chrome.runtime&&chrome.runtime.sendMessage)return new Promise((t,o)=>{chrome.runtime.sendMessage({type:"FETCH_BLOB",url:e},r=>{if(chrome.runtime.lastError){chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("Extension context invalidated")&&(theempiredidnothingwrong=!0),usedaforce(e).then(t).catch(o);return}r&&r.success?t(r.data):o(new Error((r==null?void 0:r.error)||"Background blob fetch failed"))})})}catch(t){t.message&&t.message.includes("Extension context invalidated")&&(theempiredidnothingwrong=!0)}return usedaforce(e)}async function usedaforce(e){const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText} `);const o=await t.blob();return new Promise((r,n)=>{const c=new FileReader;c.onloadend=()=>{const s=c.result.split(",")[1];r({base64:s,type:o.type})},c.onerror=n,c.readAsDataURL(o)})}async function yodabridge(e,t={}){const{use3DSmiles:o=!1}=t;if(!e||typeof e!="string")return null;const r=stripFlagsFromName(e.trim());if(!r)return null;try{const n=`${CHEMTEX_SERVER_URL}/search/${encodeURIComponent(r)}?type=compound`,c=await fetch(n);if(c.ok){const s=await c.json();if(s&&s.smiles)return{smiles:o&&s.isomericSmiles?s.isomericSmiles:s.smiles,source:"ChemTex-Server",cid:s.cid}}}catch{}return null}window.yodabridge=yodabridge;async function getCompoundID(e){if(!e||typeof e!="string")return null;const t=e.trim(),o=await yodabridge(t,{use3DSmiles:!1});return o&&o.cid?o.cid:null}window.getCompoundID=getCompoundID,window.getCompoundID=getCompoundID;const blockstep=20,babyzombie=100,enderdragonsiz=800,stevewidth=400,steveheight=350,cobblestonebase=150,stevescale=.5,youweretheoneanakin=400;function getlightsaberkey(e){return e?e.smiles?`smiles:${e.smiles}`:e.nomenclature?`nomenclature:${e.nomenclature}`:null:null}function ihateyouobi1(e,t){const o=getlightsaberkey(e);return o?`page:${t}:${o}`:null}async function loadblockdimension(e,t,o){try{const r=getlightsaberkey(e);if(!r)return{};if(!o.savesizelightsaber&&!o.savesizeholocron)return{};let n;return o.savesizelightsaber&&!o.savesizeholocron?n=ihateyouobi1(e,t):n=r,n?new Promise(c=>{chrome.storage.local.get([n],s=>{if(s[n])if(s[n].scale)c(s[n]);else{const u=s[n].width?s[n].width/stevewidth:void 0;c(u!==void 0?{scale:u}:{})}else c({})})}):{}}catch{return{}}}async function saveblockdimension(e,t,o,r){try{const n=getlightsaberkey(e);if(!n||!r.savesizelightsaber&&!r.savesizeholocron)return;let c;if(r.savesizelightsaber&&!r.savesizeholocron?c=ihateyouobi1(e,t):c=n,!c)return;const s={};s[c]=o,chrome.storage.local.set(s,()=>{})}catch{}}function createSizeControls(e,t,o,r){const n=document.createElement("div");n.className="chem-size-controls",n.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex !important;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    pointer-events: auto;
    transition: opacity 0.2s;
    z-index: 1000;
  `;const c=document.createElement("button");c.className="chem-size-btn chem-size-up",c.innerHTML="\u25B2",c.title="Increase size",c.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    pointer-events: auto;
  `;const s=document.createElement("button");return s.className="chem-size-btn chem-size-down",s.innerHTML="\u25BC",s.title="Decrease size",s.style.cssText=c.style.cssText,[c,s].forEach(u=>{u.addEventListener("mouseenter",()=>{u.style.background="rgba(0, 0, 0, 0.9)"}),u.addEventListener("mouseleave",()=>{u.style.background="rgba(0, 0, 0, 0.7)"})}),c.addEventListener("click",u=>{u.stopPropagation(),adjustImageSize(e,t,o,blockstep,r)}),s.addEventListener("click",u=>{u.stopPropagation(),adjustImageSize(e,t,o,-blockstep,r)}),n.appendChild(c),n.appendChild(s),e.addEventListener("mouseenter",()=>{n.style.opacity="1"}),e.addEventListener("mouseleave",()=>{n.style.opacity="0"}),n}function adjustImageSize(e,t,o,r,n){let c=parseFloat(t.dataset.scale)||1;const s=r/100;let u=c+s;u=Math.max(.5,Math.min(5,u)),t.dataset.scale=u.toString();const i=(t.style.transform||"").replace(/scale\([^)]+\)\s*/g,"");t.style.transform=`${i} scale(${u})`.trim(),t.style.transformOrigin="top left";const l=window.location.href;saveblockdimension(o,l,{scale:u},n)}async function thatswhatsheresized(e,t,o,r){var n;try{const c=document.createElement("div");c.className="chem-image-container",c.style.cssText=`
      position: relative;
      display: inline-block;
      margin: 0 12px 8px 0;
      vertical-align: middle;
      overflow: hidden;
      max-width: 100%;
    `;const s=window.location.href,u=await loadblockdimension(o,s,r);let m=1.5;const i=()=>{let w=e.naturalWidth||e.width||0,v=e.naturalHeight||e.height||0;if((!w||!v)&&e.src&&e.src.startsWith("data:image/svg+xml"))try{let f;e.src.includes("base64,")?f=atob(e.src.split("base64,")[1]):f=decodeURIComponent(e.src.split(",")[1]);const g=f.match(/width\s*=\s*["']?(\d+(?:\.\d+)?)/i),I=f.match(/height\s*=\s*["']?(\d+(?:\.\d+)?)/i);if(g&&(w=parseFloat(g[1])),I&&(v=parseFloat(I[1])),!w||!v){const a=f.match(/viewBox\s*=\s*["']?[\d.]+\s+[\d.]+\s+([\d.]+)\s+([\d.]+)/i);a&&(w=w||parseFloat(a[1]),v=v||parseFloat(a[2]))}}catch{}return{width:w,height:v}},{width:l,height:d}=i();if(l>0&&d>0){const w=Math.sqrt(l*l+d*d);m=1.5*Math.pow(300/w,.5),m=Math.max(.4,Math.min(2,m))}const C=u.scale||m;e.dataset.scale=C.toString(),e.dataset.fixedSize||(e.complete?fromhereeverythingissoft(e,C):(e.onload=()=>fromhereeverythingissoft(e,C),setTimeout(()=>fromhereeverythingissoft(e,C),100))),o&&(e.dataset.compoundInfo=JSON.stringify(o));const y=createSizeControls(c,e,o,r);t.parentNode.insertBefore(c,t),c.appendChild(e),c.appendChild(y),t.remove();const S=((n=o.flags)==null?void 0:n.displayName)||o.nomenclature||o.smiles||"Unknown";return dundermifflincontrols(c,S,o),c}catch{if(t&&t.parentNode&&e)try{t.parentNode.replaceChild(e,t)}catch{}return e}}function fromhereeverythingissoft(e,t){let o=e.naturalWidth||e.width,r=e.naturalHeight||e.height;if((!o||o===0)&&e.src&&e.src.startsWith("data:image/svg+xml"))try{let s;e.src.includes("base64,")?s=atob(e.src.split("base64,")[1]):s=decodeURIComponent(e.src.split(",")[1]);const u=s.match(/width\s*=\s*["']?(\d+(?:\.\d+)?)/i),m=s.match(/height\s*=\s*["']?(\d+(?:\.\d+)?)/i);if(u&&(o=parseFloat(u[1])),m&&(r=parseFloat(m[1])),!o||!r){const i=s.match(/viewBox\s*=\s*["']?[\d.]+\s+[\d.]+\s+([\d.]+)\s+([\d.]+)/i);i&&(o=o||parseFloat(i[1]),r=r||parseFloat(i[2]))}}catch{}const n=600,c=500;if(e.style.maxWidth=`${n}px`,e.style.maxHeight=`${c}px`,t&&t!==1){const u=(e.style.transform||"").replace(/scale\([^)]+\)\s*/g,"");e.style.transform=`${u} scale(${t})`.trim(),e.style.transformOrigin="top left"}}window.chemRendererDebug={getSettings:()=>settings,scanPage:()=>senddaprobes(),clearCache:()=>executechemistryorder66(),async getCacheStats(){return await loadMoleculeCache(),{smiles:Object.keys(moleculeCache).length,images:structureRenderCache.size}}},window.chemRendererPerformance={recordStructure(){},recordLoad(){},recordFormula(){}},bobthelogger.info("ChemTex loaded");let settings={jedimode:!0,hyperdrive:!0,maxVisibleSVGs:5,sizePreset:"auto",renderengine:"chemtex",sithmode:!1,flipHorizontal:!1,flipVertical:!1,use3DSmiles:!1,showcarbonz:!0,sdAromaticCircles:!0,sdShowMethyls:!0,sdCompactDrawing:!0,viztheme:"light",autoadaptmode:!0,enable3DViewer:!1,viewer3DSource:"molview",viewer3DSize:"normal",viewer3DStyle:"stick",molviewRepresentation:"ballAndStick",compoundMolviewBgColor:"black",molviewEngine:"glmol",removebg:!1,molviewChainType:"ribbon",molviewChainBonds:!1,molviewChainColor:"ss",proteinMolviewBgColor:"black",bioassembly:!1,bioviewer:"molstar",biographics:"balanced",pdbprovider:"rcsb",mineralRepresentation:"ballAndStick",mineralMolviewBgColor:"black",mineralCrystallography:"supercell_2x2x2"};bobthelogger.info("\u{1F4E6} Loading settings from storage..."),chrome.storage.sync.get(null,e=>{settings={...settings,...e},settings.renderengine="chemtex",settings.m2cfShowCarbons=e.showcarbonz!==void 0?e.showcarbonz:!0,settings.m2cfAromaticCircles=e.aromaticringz!==void 0?e.aromaticringz:!0,settings.m2cfShowMethyls=e.sdShowMethyls!==void 0?e.sdShowMethyls:!0,settings.m2cfAtomNumbers=e.sdAtomNumbers===!0,settings.m2cfAddH2=e.sdShowExplicitHydrogens===!0,settings.m2cfShowImplicitH=e.sdShowImplicitHydrogens!==!1,settings.m2cfCompactDrawing=e.sdCompactDrawing===!0,settings.m2cfFlipHorizontal=e.sdFlipHorizontal===!0,settings.m2cfFlipVertical=e.sdFlipVertical===!0,settings.m2cfRotate=e.rotatemode||0,settings.gradientcolors=e.gradientcolors===!0,settings.autoadaptmode=e.autoadaptmode!==!1,settings.m2cfUse3DSmiles=e.use3dforce!==!1,bobthelogger.info("\u{1F4CA} Rendering settings:",{showCarbons:settings.m2cfShowCarbons,aromaticRings:settings.m2cfAromaticCircles,showMethyls:settings.m2cfShowMethyls,atomNumbers:settings.m2cfAtomNumbers,explicitHydrogens:settings.m2cfAddH2,implicitHydrogens:settings.m2cfShowImplicitH,gradientColors:settings.gradientcolors}),bobthelogger.info("\u{1F50D} Server search jedimode"),bobthelogger.success("\u2705 Settings loaded",settings),bobthelogger.info("Renderer Engine: ChemTex"),bobthelogger.info(`Performance mode: ${settings.hyperdrive?"ON \u26A1":"OFF"}`),loadMoleculeCache().then(t=>{bobthelogger.info(`\u{1F4E6} SMILES cache ready: ${Object.keys(t).length} cached compounds`)}),settings.jedimode?(bobthelogger.info("\u{1F680} Extension jedimode, initializing renderer..."),bootxwing(),settings.avgsize=e.avgsize||100,settings.avgsize!==100&&(setTimeout(()=>{idontlikesanditscoarse(settings.avgsize)},2e3),setTimeout(()=>{idontlikesanditscoarse(settings.avgsize)},5e3))):bobthelogger.info("\u23F8\uFE0F  Extension disabled in settings")}),chrome.storage.onChanged.addListener(e=>{e.jedimode&&(bobthelogger.info("\u2699\uFE0F  Settings changed, reloading...",e),e.jedimode.newValue&&location.reload()),e.viewer3DSource&&(bobthelogger.info("\u{1F504} 3D Viewer source changed, updating...",e.viewer3DSource),settings.viewer3DSource=e.viewer3DSource.newValue,bobthelogger.success(`\u2705 Switched to ${e.viewer3DSource.newValue} 3D viewer`))}),chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action==="renderPreview"){try{const r=wrapMolecularFormulas(e.code);o({html:r})}catch(r){o({html:`<span style="color: red;">Error: ${r.message}</span>`})}return!0}if(e.type==="SETTINGS_CHANGED"){Object.assign(settings,e.settings);const r=["showcarbonz","aromaticringz","sdShowMethyls","sdAtomNumbers","sdShowExplicitHydrogens","sdShowImplicitHydrogens","sdCompactDrawing","sdFlipHorizontal","sdFlipVertical","viztheme","autoadaptmode","rotatemode","avgsize","gradientcolors","scalebyweight","use3dforce"];return Object.keys(e.settings).filter(c=>r.includes(c)).length>0,o({success:!0}),!0}});function bootxwing(){bobthelogger.inject("\u{1F527} Initialize renderer - Starting chemical formula processing"),injectdadrip(),settings.hyperdrive?bobthelogger.inject("\u26A1 Performance mode ENABLED - Setting up lazy-loading for SVGs"):bobthelogger.inject("\u26A1 Performance mode disabled - will load images immediately"),initializeLazyLoader(),bobthelogger.inject("\u{1F680} Starting initial page scan..."),senddaprobes(),bobthelogger.inject("\u{1F504} Setting up dynamic content observer..."),observePageChanges(),bobthelogger.success("\u2705 Renderer initialized - formulas will be processed as they appear")}function injectdadrip(){const e='.molecule-diagram{display:inline-block!important;position:static!important;max-width:100%;max-height:400px;margin:0 12px 8px 0!important;vertical-align:middle;padding:0!important;border:none!important;border-radius:4px;background-color:transparent!important;transition:opacity .3s ease;cursor:pointer;opacity:1}.molecule-diagram[data-loaded="error"]{background-color:transparent!important;border:1px solid rgba(239,83,80,0.3)!important}.molecule-loading{opacity:.1;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 2s infinite}@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}.molecule-fadein{animation:fadeIn .4s ease-in-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.molecule-container{display:inline-flex;flex-wrap:wrap;gap:12px;align-items:center;margin:8px 0}.molecule-container .molecule-diagram{margin:0}.molecule-container.vertical{display:flex;flex-direction:column;align-items:flex-start;gap:16px;margin:12px 0}.molecule-container.vertical .molecule-diagram{margin:0;display:block}.molecule-rotate-0{transform:rotate(0deg)}.molecule-rotate-90{transform:rotate(90deg);max-width:200px;max-height:300px}.molecule-rotate-180{transform:rotate(180deg)}.molecule-rotate-270{transform:rotate(270deg);max-width:200px;max-height:300px}.molecule-diagram:hover{background-color:rgba(100,150,255,.1)!important;box-shadow:0 0 8px rgba(100,150,255,.2)!important}.molecule-viewer-container{display:inline-block!important;margin:8px 12px 8px 0!important;vertical-align:middle;padding:0!important;background:transparent!important;border:none!important;box-shadow:none!important}.molecule-viewer-container:hover{background:transparent!important;border:none!important;box-shadow:none!important}.molecule-viewer-container .molecule-diagram{display:block;max-width:300px;max-height:200px;margin-bottom:6px;cursor:pointer;border-radius:4px}.molecule-viewer-container .molecule-diagram:hover{background-color:rgba(100,150,255,.15)!important;box-shadow:0 0 8px rgba(100,150,255,.3)!important}.molecule-download-btn:hover{background:#45a049!important;transform:scale(1.02)}.molecule-download-btn:active{transform:scale(.98)}@media(max-width:768px){.molecule-diagram{max-width:250px;max-height:150px}.molecule-container{flex-direction:column;gap:8px}.molecule-viewer-container{margin:8px 0!important}}',t=document.createElement("style");t.textContent=e,t.id="chem-renderer-styles",(document.head||document.documentElement).appendChild(t)}function parseChemFlags(e,t=!0){const o={useDefaults:!1,flagsLocked:!1,showCarbons:void 0,aromaticCircles:void 0,showMethyls:void 0,atomNumbers:void 0,flipHorizontal:void 0,flipVertical:void 0,addHydrogens:void 0,showImplicitHydrogens:void 0,size:void 0,rotation:void 0,isCompound:!1,compoundType:void 0,isDirectSmiles:!1,moleculeName:null,isDirectID:!1,idType:void 0,idValue:void 0,smilesValue:void 0,displayName:void 0,isIUPAC:!1};if(!e)return o;const r=e.match(/chem:(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid)=([^:]+):/i),n=r?null:e.match(/chem:([a-zA-Z][a-zA-Z0-9\s]{1,}?)(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid)=([^:]+):/i);if(r){const m=r[1].toLowerCase(),i=r[2];switch(m){case"smiles":o.compoundType="smiles",o.isDirectSmiles=!0;break;case"mol":o.compoundType="compound",o.isCompound=!0;break;case"biomol":o.compoundType="biomolecule";break;case"mineral":o.compoundType="mineral",o.isMineral=!0;break;case"iupac":o.compoundType="compound",o.isIUPAC=!0,o.isCompound=!0;break;case"pbdid":o.compoundType="biomolecule",o.isDirectID=!0,o.idType="pdbid";break;case"cid":o.compoundType="compound",o.isDirectID=!0,o.idType="cid",o.isCompound=!0;break;case"codid":o.compoundType="mineral",o.isDirectID=!0,o.idType="codid";break}let l=i;const C=m==="pbdid"?null:i.match(/^(.+?)([+\-][a-zA-Z](?:[+\-][a-zA-Z])*)$/);C&&(l=C[1],o.flagsLocked=!0),o.moleculeName=l.trim(),m==="smiles"&&(o.smilesValue=l.trim()),(m==="pbdid"||m==="cid"||m==="codid")&&(o.idValue=l.trim());const y=C?C[2]:"";if(!t)return o;y.includes("+d")&&(o.useDefaults=!0);const S=y.match(/\+([a-zA-Z0-9]+)/g);S&&S.forEach(v=>{const f=v.substring(1).toLowerCase();if(f==="c"&&(o.showCarbons=!0),f==="o"&&(o.aromaticCircles=!0),f==="m"&&(o.showMethyls=!0),f==="n"&&(o.atomNumbers=!0),f==="h"&&(o.addHydrogens=!0),f==="i"&&(o.showImplicitHydrogens=!0),f==="p"&&(o.flipHorizontal=!0),f==="q"&&(o.flipVertical=!0),f==="d"&&(o.useDefaults=!0),f.startsWith("s")&&f.length>1){const g=parseInt(f.substring(1));isNaN(g)||(o.size=g/100)}});const w=y.match(/-([a-zA-Z])/g);return w&&w.forEach(v=>{const f=v.substring(1).toLowerCase();f==="c"&&(o.showCarbons=!1),f==="o"&&(o.aromaticCircles=!1),f==="m"&&(o.showMethyls=!1),f==="n"&&(o.atomNumbers=!1),f==="h"&&(o.addHydrogens=!1),f==="i"&&(o.showImplicitHydrogens=!1),f==="p"&&(o.flipHorizontal=!1),f==="q"&&(o.flipVertical=!1)}),o}if(n){const m=n[1].trim(),i=n[2].toLowerCase(),l=n[3];switch(i){case"smiles":o.compoundType="smiles",o.isDirectSmiles=!0;break;case"mol":o.compoundType="compound",o.isCompound=!0;break;case"biomol":o.compoundType="biomolecule";break;case"mineral":o.compoundType="mineral",o.isMineral=!0;break;case"iupac":o.compoundType="compound",o.isIUPAC=!0,o.isCompound=!0;break;case"pbdid":o.compoundType="biomolecule",o.isDirectID=!0,o.idType="pdbid";break;case"cid":o.compoundType="compound",o.isDirectID=!0,o.idType="cid",o.isCompound=!0;break;case"codid":o.compoundType="mineral",o.isDirectID=!0,o.idType="codid",o.isMineral=!0;break}o.moleculeName=m;const d=i==="pbdid";let C=-1;if(!d){const f=/[+-][a-z]/i,g=l.match(f);g&&(C=g.index)}const y=C!==-1?l.substring(0,C).trim():l.trim();i==="smiles"?o.smilesValue=y:i==="iupac"?o.iupacValue=y:i==="mineral"?o.mineralValue=y:i==="biomol"?o.biomolValue=y:i==="mol"?o.molValue=y:(i==="pbdid"||i==="cid"||i==="codid")&&(o.idValue=y),C!==-1&&(o.flagsLocked=!0),o.displayName=m;const S=C!==-1?l.substring(C):"";if(!t)return o;S.includes("+d")&&(o.useDefaults=!0);const w=S.match(/\+([a-zA-Z0-9]+)/g);w&&w.forEach(f=>{const g=f.substring(1).toLowerCase();if(g==="c"&&(o.showCarbons=!0),g==="o"&&(o.aromaticCircles=!0),g==="m"&&(o.showMethyls=!0),g==="n"&&(o.atomNumbers=!0),g==="h"&&(o.addHydrogens=!0),g==="i"&&(o.showImplicitHydrogens=!0),g==="p"&&(o.flipHorizontal=!0),g==="q"&&(o.flipVertical=!0),g==="d"&&(o.useDefaults=!0),g.startsWith("s")&&g.length>1){const I=parseInt(g.substring(1));isNaN(I)||(o.size=I/100)}if(g.startsWith("r")&&g.length>1){const I=parseInt(g.substring(1));isNaN(I)||(o.rotation=I)}});const v=S.match(/-([a-zA-Z])/g);return v&&v.forEach(f=>{const g=f.substring(1).toLowerCase();g==="c"&&(o.showCarbons=!1),g==="o"&&(o.aromaticCircles=!1),g==="m"&&(o.showMethyls=!1),g==="n"&&(o.atomNumbers=!1),g==="h"&&(o.addHydrogens=!1),g==="i"&&(o.showImplicitHydrogens=!1),g==="p"&&(o.flipHorizontal=!1),g==="q"&&(o.flipVertical=!1)}),o}if(e.includes("/")){const m=e.split("/");if(m.length>1){const i=m[1];if(i.includes(":")){const l=i.split(":")[0].toLowerCase();if(l.includes("d")){o.useDefaults=!0;const d=l.replace("d","");d.includes("-c")&&(o.showCarbons=!1),d.includes("-o")&&(o.aromaticCircles=!1),d.includes("-m")&&(o.showMethyls=!1),d.includes("-n")&&(o.atomNumbers=!1),d.includes("-p")&&(o.flipHorizontal=!0),d.includes("-q")&&(o.flipVertical=!0)}}}}if(e.includes("+")){o.flagsLocked=!0;const m=e.match(/\+([a-zA-Z0-9]+)/g);m&&m.forEach(i=>{const l=i.substring(1).toLowerCase();if(l==="c"&&(o.showCarbons=!0),l==="o"&&(o.aromaticCircles=!0),l==="m"&&(o.showMethyls=!0),l==="n"&&(o.atomNumbers=!0),l==="h"&&(o.addHydrogens=!0),l==="i"&&(o.showImplicitHydrogens=!0),l==="p"&&(o.flipHorizontal=!0),l==="q"&&(o.flipVertical=!0),l==="d"&&(o.useDefaults=!0),l==="compound"&&(o.isCompound=!0),l==="compound"&&(o.compoundType="compound"),(l==="biomolecule"||l==="bio"||l==="protein")&&(o.compoundType="biomolecule"),(l==="mineral"||l==="crystal")&&(o.compoundType="mineral"),(l==="smiles"||l==="smi")&&(o.isDirectSmiles=!0),l.startsWith("s")&&l.length>1){const d=parseInt(l.substring(1));isNaN(d)||(o.size=d/100)}if(l.startsWith("r")&&l.length>1){const d=parseInt(l.substring(1));isNaN(d)||(o.rotation=d)}})}const c=e.indexOf("/"),s=c!==-1?e.substring(c):"",u=e.match(/-([cmnhopqi])/gi);return u&&(o.flagsLocked=!0,u.forEach(m=>{if(!s.toLowerCase().includes(m.toLowerCase())){const i=m.substring(1).toLowerCase();i==="c"&&(o.showCarbons=!1),i==="o"&&(o.aromaticCircles=!1),i==="m"&&(o.showMethyls=!1),i==="n"&&(o.atomNumbers=!1),i==="h"&&(o.addHydrogens=!1),i==="i"&&(o.showImplicitHydrogens=!1),i==="p"&&(o.flipHorizontal=!1),i==="q"&&(o.flipVertical=!1)}})),o}function stripFlagsFromName(e){if(!e)return e;const t=e.indexOf("/");return t!==-1?e.substring(0,t):e}function applyFlagOverrides(e,t){try{const o={...e};return(t==null?void 0:t.showCarbons)!==void 0&&(o.m2cfShowCarbons=t.showCarbons),(t==null?void 0:t.aromaticCircles)!==void 0&&(o.m2cfAromaticCircles=t.aromaticCircles),(t==null?void 0:t.showMethyls)!==void 0&&(o.m2cfShowMethyls=t.showMethyls),(t==null?void 0:t.atomNumbers)!==void 0&&(o.m2cfAtomNumbers=t.atomNumbers),(t==null?void 0:t.addHydrogens)!==void 0&&(o.m2cfAddH2=t.addHydrogens),(t==null?void 0:t.flipHorizontal)!==void 0&&(o.m2cfFlipHorizontal=t.flipHorizontal,o.flipHorizontal=t.flipHorizontal),(t==null?void 0:t.flipVertical)!==void 0&&(o.m2cfFlipVertical=t.flipVertical,o.flipVertical=t.flipVertical),(t==null?void 0:t.rotation)!==void 0&&(o.m2cfRotate=t.rotation,o.mvRotate=t.rotation),o}catch{return e}}function michaelscottspin(e,t,o,r){const n=document.createElement("div");return n.className="molecule-container",n.style.cssText=`
    display: inline-block;
    position: relative;
    vertical-align: middle;
    margin: 0 12px 8px 0;
    background: none;
    background-color: transparent;
    border: none;
    box-shadow: none;
  `,n._moleculeName=o,n._moleculeData=r,n.appendChild(e),n}function dundermifflincontrols(e,t,o){if(e.querySelector(".molecule-name-overlay"))return;const r=document.createElement("div");r.className="molecule-name-overlay",r.textContent=t||"Unknown",r.style.cssText=`
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-family: sans-serif;
    opacity: 0.7;
    transition: opacity 0.2s;
    pointer-events: none;
    z-index: 10;
    white-space: nowrap;
    line-height: 1.4;
  `;const n=o.compoundType==="biomolecule"||o.pdbid||o.flags&&o.flags.compoundType==="biomolecule",c=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" style="display:block;">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
    <line x1="12" y1="22.08" x2="12" y2="12"/>
  </svg>`,s=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="16" height="16" style="display:block;">
    <path d="M12 2v20"/>
    <path d="M2.5 7l19 10"/>
    <path d="M2.5 17l19-10"/>
  </svg>`,u=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="display:block;">
    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(45 12 12)"/>
    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-45 12 12)"/>
    <ellipse cx="12" cy="12" rx="10" ry="4"/>
    <circle cx="12" cy="12" r="2" fill="currentColor"/>
  </svg>`,m=document.createElement("div");m.className="molecule-3d-button-group",m.style.cssText=`
    position: absolute;
    top: 4px;
    right: 4px;
    display: flex;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
    border-radius: 4px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.85);
  `;let i=null,l=settings.bioassembly===!0;n&&(i=document.createElement("button"),i.className="molecule-bio-toggle",i.innerHTML=l?s:u,i.title=l?"Mol* viewer (click to switch to MolView)":"MolView (click to switch to Mol*)",i.style.cssText=`
      background: transparent;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      border-right: 1px solid rgba(255,255,255,0.3);
      box-sizing: border-box;
    `,i.addEventListener("mouseenter",()=>{i.style.background="rgba(255,255,255,0.15)"}),i.addEventListener("mouseleave",()=>{i.style.background="transparent"}),i.addEventListener("click",async g=>{g.stopPropagation(),l=!l,l?(i.innerHTML=s,i.title="Mol* viewer (click to switch to MolView)"):(i.innerHTML=u,i.title="MolView (click to switch to Mol*)"),o.preferMolstar=l;let I=e.closest(".molecule-3d-viewer");if(I||(I=e.querySelector(".molecule-3d-viewer")),!I&&e.classList.contains("molecule-3d-viewer")&&(I=e),I){const a=I.querySelector("iframe");if(a&&o.pdbid){const h=o.pdbid.toLowerCase();let p;l?p=`https://molstar.org/viewer/?pdb=${h}&hide-controls=1`:p=`https://embed.molview.org/v1/?mode=balls&pdbid=${h}&bg=black`;const x=document.createElement("iframe");x.src=p,x.style.cssText=a.style.cssText,x.setAttribute("allow",a.getAttribute("allow")||"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking"),x.setAttribute("allowfullscreen","true"),x.setAttribute("frameborder","0"),x.title=l?`Mol* Viewer: ${h}`:`MolView: ${h}`,a.parentNode&&a.parentNode.replaceChild(x,a)}}}));const d=document.createElement("button");d.className="molecule-3d-cube-btn",d.innerHTML=c,d.title="View in 3D",d.style.cssText=`
    background: transparent;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    padding: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    box-sizing: border-box;
  `,d.addEventListener("mouseenter",()=>{d.style.background="rgba(255,255,255,0.15)"}),d.addEventListener("mouseleave",()=>{d.style.background="transparent"}),d.addEventListener("click",async g=>{g.stopPropagation(),n&&(o.preferMolstar=l);try{await dwightshows3d(o,e)}catch(I){alert("Failed to load 3D viewer: "+I.message)}}),i&&m.appendChild(i),m.appendChild(d);const C=m,y=null,S=document.createElement("div");S.className="chem-size-controls",S.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 1000;
  `;const w=document.createElement("button");w.className="chem-size-btn chem-size-up",w.innerHTML="\u25B2",w.title="Increase size",w.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  `;const v=document.createElement("button");v.className="chem-size-btn chem-size-down",v.innerHTML="\u25BC",v.title="Decrease size",v.style.cssText=w.style.cssText;function f(g,I=100,a=80){const h=e.querySelector("img")||e.querySelector("iframe");if(!h)return;const p=h.offsetWidth||h.width||h.naturalWidth||300,x=h.offsetHeight||h.height||h.naturalHeight||200,b=Math.max(I,Math.round(p*g)),E=Math.max(a,Math.round(x*g));(M=>{M.style.setProperty("width",`${b}px`,"important"),M.style.setProperty("height",`${E}px`,"important"),M.style.setProperty("max-width","none","important"),M.style.setProperty("max-height","none","important")})(h),e.style.setProperty("width",`${b}px`,"important"),e.style.setProperty("height",`${E}px`,"important")}w.addEventListener("click",g=>{g.stopPropagation(),f(1.2)}),v.addEventListener("click",g=>{g.stopPropagation(),f(.8333)}),S.appendChild(w),S.appendChild(v),e.addEventListener("mouseenter",()=>{r.style.opacity="1",C.style.opacity="1",S.style.opacity="1",y&&(y.style.opacity="1")}),e.addEventListener("mouseleave",()=>{r.style.opacity="0.7",C.style.opacity="0",S.style.opacity="0",y&&(y.style.opacity="0")}),getComputedStyle(e).position==="static"&&(e.style.position="relative"),e.style.background="none",e.style.backgroundColor="transparent",e.style.border="none",e.style.boxShadow="none",e.appendChild(r),e.appendChild(C),y&&e.appendChild(y),e.appendChild(S)}function buildProteinImageUrl(e){const t=e.toLowerCase(),o=settings.bioassembly?"assembly-1":"model-1";return`https://cdn.rcsb.org/images/structures/${t}_${o}.jpeg`}function buildMolecularViewerUrl(e,t,o="compound"){const r="https://embed.molview.org/v1/",n=new URLSearchParams;if(n.set(t,e),o==="biomolecule"&&(settings.molviewChainType&&n.set("chainType",settings.molviewChainType),settings.molviewChainBonds&&n.set("chainBonds","true"),settings.molviewChainColor&&n.set("chainColor",settings.molviewChainColor),settings.proteinMolviewBgColor&&n.set("bg",settings.proteinMolviewBgColor)),o==="mineral"){if(settings.mineralRepresentation){const c={ballAndStick:"balls",stick:"stick",vdwSpheres:"vdw",wireframe:"wireframe",line:"line"};n.set("mode",c[settings.mineralRepresentation]||"balls")}settings.mineralMolviewBgColor&&n.set("bg",settings.mineralMolviewBgColor)}if(t==="smiles"||t==="cid"||o==="compound"){if(settings.molviewRepresentation){const c={ballAndStick:"balls",stick:"stick",vdwSpheres:"vdw",wireframe:"wireframe",line:"line"};n.set("mode",c[settings.molviewRepresentation]||"balls")}else n.has("mode")||n.set("mode","balls");settings.compoundMolviewBgColor&&n.set("bg",settings.compoundMolviewBgColor)}return r+"?"+n.toString()}window.parseChemFlags=parseChemFlags,window.stripFlagsFromName=stripFlagsFromName,window.applyFlagOverrides=applyFlagOverrides,window.buildMolecularViewerUrl=buildMolecularViewerUrl;function initializeLazyLoader(){if(window._lazyLoadObserver){try{window._lazyLoadObserver.disconnect()}catch{}window._lazyLoadObserver=null}bobthelogger.inject("\u{1F680} Setting up Intersection Observer for lazy-loading with performance optimization");let e=0;const t=3;function o(){e--,typeof d=="function"&&setTimeout(d,50)}const r=new IntersectionObserver(a=>{a.forEach(h=>{if(h.isIntersecting){const p=h.target;p.dataset.loaded==="false"&&p.dataset.src&&e<t&&(window.requestIdleCallback?requestIdleCallback(()=>{e<t&&n(p)},{timeout:1e3}):setTimeout(()=>{e<t&&n(p)},50))}})},{rootMargin:"300px"});function n(a){e++,bobthelogger.debug(`\u{1F5BC}\uFE0F  Loading SVG (#${e}): ${a.dataset.src.substring(0,60)}...`),a.classList.add("molecule-fadein"),a.classList.remove("molecule-loading");const h=new Image;h.onload=()=>{a.src=a.dataset.src,a.dataset.loaded="true",r.unobserve(a),o(),bobthelogger.debug(`\u2705 SVG loaded (${e} active loads remaining)`)},h.onerror=()=>{o(),bobthelogger.debug(`\u274C SVG failed to load (${e} active loads remaining)`)},h.src=a.dataset.src}async function c(a,h){try{const p=document.createElement("img");p.src=a.imageUrl,p.alt=a.nomenclature||"Biomolecule",p.className="molecule-diagram molecule-biomolecule",p.crossOrigin="anonymous";const x=settings.viewer3DSize||"normal",b={small:{width:200,height:150},medium:{width:300,height:250},normal:{width:400,height:350},large:{width:600,height:450},xlarge:{width:800,height:600}},E=b[x]||b.normal;if(p.style.cssText=`
        width: ${E.width}px;
        height: ${E.height}px;
        max-width: ${E.width}px;
        max-height: ${E.height}px;
        object-fit: contain;
        display: block;
        margin: 0;
        vertical-align: middle;
        cursor: pointer;
        border-radius: 8px;
      `,p.dataset.fixedSize="true",settings.removebg)try{const k=await padmewhenanikillsyounglings(a.imageUrl);if(k&&k.base64){const M=new Image;M.onload=()=>{try{const R=document.createElement("canvas"),_=R.getContext("2d");R.width=M.naturalWidth,R.height=M.naturalHeight,_.drawImage(M,0,0);const T=_.getImageData(0,0,R.width,R.height),F=T.data;for(let A=0;A<F.length;A+=4){const V=F[A],O=F[A+1],L=F[A+2],N=Math.sqrt(Math.pow(255-V,2)+Math.pow(255-O,2)+Math.pow(255-L,2));N<15?F[A+3]=0:N<150&&(F[A+3]=Math.floor(255*(N-15)/135))}_.putImageData(T,0,0),p.src=R.toDataURL("image/png")}catch{}},M.src=`data:${k.type||"image/jpeg"};base64,${k.base64}`}}catch{}h.dataset.loaded="true",chrome.storage.sync.get({savesizelightsaber:!1,savesizeholocron:!0},async k=>{await thatswhatsheresized(p,h,a,k)})}catch{h.alt="Failed to load biomolecule image",h.dataset.loaded="error"}}async function s(a,h){e++;try{!a&&h.dataset.moleculeViewer&&(a=JSON.parse(atob(h.dataset.moleculeViewer)));const p=a.flags||{},x=p.displayName||a.nomenclature||a.name||"molecule";let b="mol",E=x;if(p.isDirectSmiles||a.smiles?(b="smiles",E=p.smilesValue||a.smiles||x):p.compoundType==="biomolecule"||p.isBiomolecule?(b="biomol",E=p.biomolValue||a.nomenclature||x):p.compoundType==="mineral"||p.isMineral?(b="mineral",E=p.mineralValue||a.nomenclature||x):p.isIUPAC?(b="iupac",E=p.iupacValue||a.nomenclature||x):E=p.molValue||a.nomenclature||x,b==="biomol")try{const B=await askdarthvader69("biomol",E);if(B.pdbid){const W={nomenclature:x,compoundType:"biomolecule",embedUrl:buildMolecularViewerUrl(B.pdbid,"pdbid","biomolecule"),imageUrl:buildProteinImageUrl(B.pdbid),pdbid:B.pdbid,is3D:a.is3D||a.show3D||p.is3D};W.is3D?await u(W,h):await c(W,h),o();return}}catch{h.alt=`Biomolecule not found: ${E}`,o();return}if(a.is3D||a.show3D||p.is3D){await u(a,h),o();return}const k=settings.forceguidance===!0;let M=settings.m2cfShowCarbons===!0,R=settings.m2cfAromaticCircles===!0,_=settings.m2cfShowMethyls===!0,T=settings.m2cfAtomNumbers===!0,F=settings.m2cfFlipVertical===!0,A=settings.m2cfFlipHorizontal===!0,V=settings.m2cfAddH2===!0,O=settings.m2cfShowImplicitH!==!1,L=settings.m2cfCompactDrawing===!0;k&&p.flagsLocked&&(p.showCarbons!==void 0&&(M=p.showCarbons),p.aromaticCircles!==void 0&&(R=p.aromaticCircles),p.showMethyls!==void 0&&(_=p.showMethyls),p.atomNumbers!==void 0&&(T=p.atomNumbers),p.addHydrogens!==void 0&&(V=p.addHydrogens),p.showImplicitH!==void 0&&(O=p.showImplicitH),p.flipHorizontal!==void 0&&(A=p.flipHorizontal),p.flipVertical!==void 0&&(F=p.flipVertical));const H=settings.viztheme||"light",P={showCarbons:M,aromaticCircles:R,showMethyls:_,atomNumbers:T,showHydrogens:V,showImplicitH:O,gradientColors:settings.gradientcolors===!0,compactDrawing:L,flipHorizontal:A,flipVertical:F,use3dforce:settings.m2cfUse3DSmiles===!0,theme:H,renderingEngine:settings.renderingEngine||"chemtex"},U=b==="smiles"&&a.smiles||E,D=buildServerSvgUrl(b,U,P);let z,G="";try{const B=await fetch(D);if(!B.ok)throw new Error(`Server returned ${B.status}`);G=B.headers.get("X-Local-Flip")||"";const W=B.headers.get("X-Compound-CID");W&&(a.cid=W);const X=B.headers.get("X-Compound-SMILES");X&&(a.smiles=X);const Z=await B.text(),K=applyThemeColors(Z,H);z="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(K),h.dataset.rawSvg=encodeURIComponent(Z)}catch(B){h.alt=`Error loading ${x}: ${B.message}`,o();return}const $=document.createElement("img");$.src=z,$.alt=x,$.className="molecule-diagram",$.dataset.moleculeViewer="true",$.dataset.nomenclature=x,$.dataset.originalNomenclature=x,$.dataset.compoundType=p.compoundType||b,$.dataset.rawSvg=h.dataset.rawSvg,$.style.cssText="display: inline-block; margin: 0; padding: 0; border: none; width: auto; height: auto; max-width: 100%; max-height: 400px; vertical-align: middle;";let j=[];G.includes("q")&&j.push("scaleY(-1)"),G.includes("p")&&j.push("scaleX(-1)"),p.rotation&&j.push(`rotate(${p.rotation}deg)`),j.length>0&&($.style.transform=j.join(" "));const q=michaelscottspin($,p.rotation,x,a),J=()=>{h.parentNode&&(h.parentNode.replaceChild(q,h),dundermifflincontrols(q,x,a),settings.avgsize&&settings.avgsize!==100&&setTimeout(()=>idontlikesanditscoarse(settings.avgsize),100)),o()};$.complete&&$.naturalWidth>0?J():($.onload=J,$.onerror=()=>{h.alt=`Error loading ${x}`,o()})}catch(p){h.alt=`Error: ${p.message}`,o()}}async function u(a,h){var E,k;const p=((E=a.flags)==null?void 0:E.displayName)||a.nomenclature||a.smiles||"";let x=h;if(x.classList&&x.classList.contains("molecule-3d-viewer")){const M=x._original2DElement;M&&x.parentNode&&x.parentNode.replaceChild(M,x);return}let b=h;if(h.tagName!=="IMG"){if(b=h.querySelector("img"),!b){const M=h.querySelector(".molecule-size-wrapper");M&&(b=M.querySelector("img"),x=M)}b||h.classList&&(h.classList.contains("chem-3d-placeholder")||h.classList.contains("chem-2d-viewer-container")||h.classList.contains("molecule-viewer-container"))&&(b=null,x=h)}if(!b&&!x)throw new Error("Could not find image element");try{const M=a.compoundType||((k=a.flags)==null?void 0:k.compoundType)||"compound",R=M==="biomolecule";let _;if(R){const L=settings.viewer3DSize||"normal",N={small:{width:200,height:150},medium:{width:300,height:250},normal:{width:400,height:350},large:{width:600,height:450},xlarge:{width:800,height:600}};_=N[L]||N.normal}else{const L=b&&(b.offsetWidth||b.naturalWidth)||300,N=b&&(b.offsetHeight||b.naturalHeight)||200,H=L/N,P=(M==="mineral"?settings.mineral3dsize||100:settings.compound3dsize||100)/100,D=Math.round(300*P),z=Math.round(D/H);_={width:D,height:z}}const T=document.createElement("div");T.className="molecule-viewer-container molecule-3d-viewer",T.style.cssText=`
        display: inline-block;
        width: ${_.width}px;
        height: ${_.height}px;
        margin: 0;
        padding: 0;
        vertical-align: middle;
        position: relative;
        border: none;
        outline: none;
        border-radius: 8px;
        overflow: hidden;
        background: transparent;
        box-shadow: none;
        max-width: 100%;
        box-sizing: border-box;
      `;const F=document.createElement("iframe");let A;if(a.embedUrl||a.pdbid||a.codid){const L=a.compoundType||"compound";if(a.pdbid){const N=a.pdbid.toLowerCase();if(a.preferMolstar===!0||settings.bioassembly===!0){const P=settings.biographics||"balanced",U=settings.pdbprovider||"rcsb";settings.bioassembly?(settings.bioviewer||"molstar")==="molstar-me"?A=`https://molstar.org/me/viewer/?pdb=${N}&hide-controls=1&graphics-mode=${P}&pdb-provider=${U}`:A=`https://molstar.org/viewer/?pdb=${N}&assembly-id=1&hide-controls=1`:A=`https://molstar.org/viewer/?pdb=${N}&hide-controls=1`}else A=buildMolecularViewerUrl(a.pdbid,"pdbid","biomolecule")}else a.codid?A=buildMolecularViewerUrl(a.codid,"codid","mineral"):A=a.embedUrl;F.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking")}else{if(a.cid)A=buildMolecularViewerUrl(a.cid,"cid","compound");else if(a.smiles)A=buildMolecularViewerUrl(a.smiles,"smiles","compound");else if(p)try{const L=await askdarthvader69("mol",p);if(L&&L.cid)A=buildMolecularViewerUrl(L.cid,"cid","compound");else if(L&&L.smiles)A=buildMolecularViewerUrl(L.smiles,"smiles","compound");else throw new Error("No CID or SMILES found")}catch{A="about:blank"}else A="about:blank";F.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking")}A||(A="about:blank"),F.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking"),F.setAttribute("allowfullscreen","true"),F.setAttribute("frameborder","0"),F.style.cssText=`
        width: 100%;
        height: 100%;
        border: none !important;
        outline: none !important;
        margin: 0;
        padding: 0;
        display: block;
        background: transparent;
        box-shadow: none;
      `,F.title=`3D Viewer: ${p}`,T._original2DElement=x,T.appendChild(F);const V=document.createElement("div");V.className="chem-size-controls",V.style.cssText=`
        position: absolute;
        bottom: 4px;
        left: 4px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s;
      `,T.onmouseenter=()=>V.style.opacity="1",T.onmouseleave=()=>V.style.opacity="0";const O=(L,N)=>{const H=document.createElement("button");return H.innerHTML=L,H.style.cssText=`
          width: 24px;
          height: 24px;
          border: none;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background 0.2s;
        `,H.onmouseenter=()=>H.style.background="rgba(0, 0, 0, 0.9)",H.onmouseleave=()=>H.style.background="rgba(0, 0, 0, 0.7)",H.onclick=P=>{P.stopPropagation();const U=parseInt(T.style.width),D=parseInt(T.style.height);if(N<0&&U<200)return;const z=1+N/100;T.style.width=`${Math.round(U*z)}px`,T.style.height=`${Math.round(D*z)}px`},H};if(V.appendChild(O("\u25B2",10)),V.appendChild(O("\u25BC",-10)),T.appendChild(V),F.src=A,a.pdbid&&A.includes("embed.molview.org")){const L=a.pdbid.toUpperCase();let N=!1;const H=`https://molstar.org/viewer/?pdb=${L.toLowerCase()}&hide-controls=1`,P=()=>{if(N)return;N=!0;const D=document.createElement("iframe");D.src=H,D.style.cssText=F.style.cssText,D.setAttribute("allow",F.getAttribute("allow")||""),D.setAttribute("allowfullscreen","true"),D.setAttribute("frameborder","0"),D.title=`Mol* Viewer: ${L}`,F.parentNode&&F.parentNode.replaceChild(D,F)},U=D=>{if(D.origin==="https://embed.molview.org"&&!N){const z=D.data;z&&(z.error||z.type==="error"||typeof z=="string"&&z.toLowerCase().includes("error")||typeof z=="string"&&z.toLowerCase().includes("failed")||typeof z=="string"&&z.toLowerCase().includes("404")||typeof z=="string"&&z.toLowerCase().includes("not found"))&&(P(),window.removeEventListener("message",U))}};window.addEventListener("message",U),setTimeout(()=>{window.removeEventListener("message",U)},6e4)}x.parentNode?(x.parentNode.replaceChild(T,x),dundermifflincontrols(T,p,a)):(b.nextSibling?b.parentElement.insertBefore(T,b.nextSibling):b.parentElement.appendChild(T),b.style.display="none"),o()}catch{const R=buildServerSvgUrl("mol",p,{showCarbons:settings.m2cfShowCarbons,aromaticCircles:settings.m2cfAromaticCircles,renderingEngine:settings.renderingEngine});b.src=R,b.classList.add("molecule-fadein"),b.classList.remove("molecule-loading"),o()}}function m(a){try{const h=JSON.parse(atob(a.dataset.moleculeViewer||a.dataset.mol2chemfig));s(h,a)}catch{a.alt="\u26A0\uFE0F Failed to render molecule",a.style.minWidth="100px",a.style.minHeight="50px",a.style.backgroundColor="#ffebee",a.style.border="1px solid #ef5350",a.style.borderRadius="4px",a.style.padding="10px",a.dataset.loaded="error"}}const i=[];let l=!1;function d(){if(!(l||i.length===0)){for(l=!0;i.length>0&&e<t;){const a=i.shift();a.dataset.loaded!=="true"&&a.dataset.loaded!=="loading"&&(a.dataset.loaded="loading",m(a))}l=!1,i.length>0&&setTimeout(d,200)}}const C=r,y=new IntersectionObserver(a=>{a.forEach(h=>{const p=h.target;h.isIntersecting&&p.dataset.loaded!=="true"&&p.dataset.loaded!=="loading"&&(p.classList.contains("molecule-viewer")||p.classList.contains("molecule-compound")||p.classList.contains("molecule-legacy")?(y.unobserve(p),e<t?(p.dataset.loaded="loading",m(p)):(i.push(p),setTimeout(d,100))):e<t?n(p):typeof requestIdleCallback<"u"?requestIdleCallback(()=>{e<t&&n(p)}):setTimeout(()=>{e<t&&n(p)},50))})},{rootMargin:"300px"});window._lazyLoadObserver=y,window._loadMoleculeImage=m,window._queueMoleculeLoad=function(a){a.dataset.loaded==="true"||a.dataset.loaded==="loading"||(e<t?(a.dataset.loaded="loading",m(a)):(i.push(a),setTimeout(d,100)))},window.dwightshows3d=u;const S=10,w=1500;let v=0;const f=500;function g(){const a=Date.now();if(a-v<f)return;v=a;const h=document.querySelectorAll('img.molecule-diagram[data-loaded="false"], img.molecule-diagram:not([data-loaded])');if(h.length===0)return;const p=window.scrollY-w,x=window.scrollY+window.innerHeight+w,b=[];if(h.forEach(k=>{const M=k.getBoundingClientRect(),R=window.scrollY+M.top;R>=p&&R<=x&&b.push({img:k,distance:Math.abs(R-(window.scrollY+window.innerHeight/2))})}),b.length===0)return;b.sort((k,M)=>k.distance-M.distance),b.slice(0,S).forEach(({img:k})=>{window._queueMoleculeLoad&&window._queueMoleculeLoad(k)})}let I=null;window.addEventListener("scroll",()=>{I&&clearTimeout(I),I=setTimeout(g,150)},{passive:!0}),setTimeout(g,1e3),bobthelogger.success("\u2705 Lazy-loading observer initialized (max 3 concurrent loads)")}let probedelay=null,lastprobetime=0;const probecooldown=1e3;function senddaprobes(){probedelay&&clearTimeout(probedelay);const t=Date.now()-lastprobetime;if(t<probecooldown){const o=probecooldown-t;probedelay=setTimeout(()=>{probesnow()},o);return}probesnow()}function probesnow(){if(lastprobetime=Date.now(),!settings.jedimode){bobthelogger.debug("senddaprobes() called but extension is disabled");return}bobthelogger.inject("\u{1F50D} STARTING PAGE SCAN for chemical formulas");const e=document.getElementsByTagName("*");let t=0,o=0,r=0,n=[];const c=1e4;bobthelogger.debug(`Total elements in DOM: ${e.length}`);for(let s=0;s<e.length&&o<c;s++){const u=e[s];if(o++,u.tagName==="SCRIPT"||u.tagName==="STYLE"||u.tagName==="NOSCRIPT"||u.classList.contains("MathJax")||u.hasAttribute("data-chem-processed"))continue;const m=[];let i="";const l=document.createTreeWalker(u,NodeFilter.SHOW_TEXT,{acceptNode:C=>C.parentNode===u?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});let d;for(;d=l.nextNode();)m.push(d),i+=d.nodeValue;if(!(m.length===0||!i)&&(i.includes("chem:")||i.includes("\\ce{")||i.includes("ce{"))){r++,n.push(i.substring(0,100)),bobthelogger.debug(`\u{1F52C} Found potential chemistry text: "${i.substring(0,80)}..."`);const C=wrapMolecularFormulas(i);if(C!==i){bobthelogger.debug(`\u2728 Found formula in text: "${i.substring(0,50)}..."`),bobthelogger.debug(`Wrapped result: "${C.substring(0,50)}..."`);const y=document.createElement("span");y.innerHTML=C,y.setAttribute("data-chem-processed","true"),u.replaceChild(y,m[0]);for(let w=1;w<m.length;w++)m[w].parentNode&&m[w].parentNode.removeChild(m[w]);const S=y.querySelectorAll('img.molecule-diagram[data-loaded="false"]');if(S.length>0)if(settings.hyperdrive&&window._lazyLoadObserver)S.forEach(w=>{window._lazyLoadObserver.observe(w)}),bobthelogger.debug(`\u{1F4CA} Setup lazy-loading for ${S.length} SVGs`);else if(window._loadMoleculeImage&&window._queueMoleculeLoad){const w=window.scrollY+window.innerHeight/2,v=Array.from(S).map(f=>{const g=f.getBoundingClientRect(),I=window.scrollY+g.top+g.height/2,a=Math.abs(I-w);return{img:f,distance:a}});v.sort((f,g)=>f.distance-g.distance),v.forEach(({img:f},g)=>{window._queueMoleculeLoad(f)}),bobthelogger.debug(`\u{1F4CA} Queued ${S.length} SVGs for chunk-based loading`)}else window._loadMoleculeImage&&(S.forEach((w,v)=>{w.dataset.loaded="pending",setTimeout(()=>{w.dataset.loaded==="pending"&&(w.dataset.loaded="loading",window._loadMoleculeImage(w))},v*300)}),bobthelogger.debug(`\u{1F4CA} Triggered fallback loading for ${S.length} SVGs`));t++}}}bobthelogger.inject("\u{1F4CA} Scan results:"),bobthelogger.inject(`  - Elements scanned: ${o}`),bobthelogger.inject(`  - Text nodes found: ${r}`),bobthelogger.inject(`  - Formulas wrapped: ${t}`),n.length>0&&(bobthelogger.inject(`  - Chemistry text samples: ${n.length} found`),n.forEach((s,u)=>{bobthelogger.debug(`    Sample ${u+1}: ${s}`)})),t>0?(bobthelogger.inject(`\u{1F3A8} ${t} formula(s) found and processed!`),window.MathJax&&window.MathJax.typesetPromise?(bobthelogger.inject("Calling MathJax.typesetPromise() for final rendering"),MathJax.typesetPromise().then(()=>{bobthelogger.success("\u2728 RENDERING COMPLETE! Formulas rendered with MathJax")}).catch(s=>{bobthelogger.debug("MathJax rendering skipped (not available), using fallback")})):bobthelogger.success("\u2728 Formulas processed - CodeCogs and Unicode rendering active")):bobthelogger.debug("No formulas found in this scan - page may not contain chemistry notation"),window._chemRendererObserver||(bobthelogger.inject("Setting up dynamic content observer"),observePageChanges())}function wrapMolecularFormulas(e){if(!e||e.trim().length===0||e.length>5e4)return e;let t=e,o=[];if(bobthelogger.debug("\u{1F9EA} Applying Pattern 0b: chem:text: \u2192 Using selected renderer engine"),t.length>0){const n=t.substring(0,200)}const r=t.match(/\bchem:([^:]+):/g);return r&&(r.length>100&&(r.length=100),bobthelogger.debug(`  Found ${r.length} chem:text: patterns`),bobthelogger.debug(`  Renderer engine: ${settings.renderengine}, 3D Viewer jedimode: ${settings.enable3DViewer}`),t=t.replace(/\bchem:([^:]+):/g,(n,c)=>{try{const s=c.trim();if(!s||s.length>500||/\s+[a-zA-Z]{2,}/.test(s)&&!s.includes("=")||/\b(should|only|with|that|this|the|and|for|not|use|when|from|have|are|was|were)\b/i.test(s)||s.length>100&&!s.includes("="))return n;bobthelogger.debug(`  Converting molecule: ${s}`),window.chemRendererPerformance.recordStructure();let m=s,i={useDefaults:!1},l=settings;const d=s.includes("="),C=s.includes("/"),y=/[+\-][a-zA-Z](?:[+\-][a-zA-Z])*$/.test(s)&&!s.match(/^[a-zA-Z0-9()\[\]-]+$/);if(d||(C||y||d))try{const b=settings.forceguidance===!0;i=window.parseChemFlags("chem:"+s+":",b),i.moleculeName&&(m=i.moleculeName);let E;i.useDefaults?E=settings:i.flagsLocked?E={...settings,m2cfShowCarbons:!1,m2cfAromaticCircles:!1,m2cfShowMethyls:!1,m2cfAtomNumbers:!1,m2cfAddH2:!1,m2cfFlipHorizontal:!1,m2cfFlipVertical:!1,m2cfInvert:!1}:E=settings,l=window.applyFlagOverrides(E,i),i.moleculeName||(s.includes("/")?m=s.split("/")[0].trim():s.includes("+")?m=s.split("+")[0].trim():s.includes("-")&&(m=s.split("-")[0].trim()))}catch{m=s,l=settings}const w=i.isDirectSmiles,v=i.compoundType,f={...i,compoundType:v==="smiles"?"compound":v,isDirectSmiles:w,smilesValue:i.smilesValue,displayName:i.moleculeName},g=i.smilesValue||(w?m:null);if(i.isDirectID&&i.idValue){const b=i.idValue,E=i.moleculeName||b;if(i.idType==="pdbid"){const R=`<img src="" alt="chem" class="molecule-diagram molecule-biomolecule" data-molecule-viewer="${btoa(JSON.stringify({pdbid:b,name:E,type:"pdbid",compoundType:"biomolecule",flags:f}))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return bobthelogger.debug(`  \u{1F4E4} Sending PDB ID to biomolecule viewer: ${b}`),R}else if(i.idType==="cid"){const k={cid:b,name:E,type:"cid",isCompound:!0,directLookup:!0,flags:{...f,compoundType:"compound",skipIntegratedSearch:!0}},R=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(k))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return bobthelogger.debug(`  \u{1F4E4} Sending CID to server: ${b}`),R}else if(i.idType==="codid"){const R=`<img src="" alt="chem" class="molecule-diagram molecule-mineral" data-molecule-viewer="${btoa(JSON.stringify({codid:b,name:E,type:"codid",compoundType:"mineral",flags:f}))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return bobthelogger.debug(`  \u{1F4E4} Sending COD ID to mineral viewer: ${b}`),R}}if(i.is3D){const b={...g?{smiles:g}:{nomenclature:m},name:m,type:g?"smiles":"nomenclature",isCompound:!0,show3D:!0,auto3D:!0,flags:f},k=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(b))}" data-loaded="false" data-show-3d="true" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return bobthelogger.debug(`  \u{1F4E4} Sending ${g?"SMILES":"nomenclature"} to 3D viewer: ${m}`),k}if(i.isCompound||v==="compound"){const b={...g?{smiles:g}:{nomenclature:m},name:m,type:g?"smiles":"nomenclature",isCompound:!0,directLookup:!0,flags:{...f,compoundType:"compound",skipIntegratedSearch:!0}},k=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(b))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return bobthelogger.debug(`  \u{1F4E4} Sending ${g?"SMILES":"nomenclature"} DIRECTLY to server (mol= syntax): ${m}`),k}const I=l.m2cfRotate||l.mvRotate||0,a=i.size||1,h={...g?{smiles:g}:{nomenclature:m},type:g?"smiles":"nomenclature",options:{width:Math.round(300*a),height:Math.round(200*a),aromaticCircles:l.m2cfAromaticCircles,fancyBonds:l.m2cfFancyBonds,showCarbons:l.m2cfShowCarbons,showMethyls:l.m2cfShowMethyls,atomNumbers:l.m2cfAtomNumbers,hydrogensMode:l.m2cfHydrogensMode,addH2:l.m2cfAddH2,flipHorizontal:l.m2cfFlipHorizontal,flipVertical:l.m2cfFlipVertical,scale:a,rotation:i.rotation||I},isMoleculeViewer:!0,flags:f},x=`<img src="" alt="chem" class="molecule-diagram molecule-viewer" data-molecule-viewer="${btoa(JSON.stringify(h))}" data-loaded="false" data-rotation="${I}" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return bobthelogger.debug(`  \u{1F4E4} Sending ${w?"SMILES":"nomenclature"} to MoleculeViewer: ${m} (type: ${v||"auto-detect"})`),x}catch{return n}})),o.length>0&&bobthelogger.debug(`\u2705 Total patterns found & converted: ${o.length}`),t}function observePageChanges(){if(window._chemRendererObserver){try{window._chemRendererObserver.disconnect(),clearTimeout(window._chemRendererObserver.timer)}catch{}window._chemRendererObserver=null}bobthelogger.inject("\u{1F504} Setting up mutation observer for dynamic content detection");let e=0,t=!1,o=0,r=!1,n=0;const c=1e3,s=2e3,u=new MutationObserver(m=>{if(t)return;const i=Math.min(m.length,5);for(let l=0;l<i;l++){const d=m[l].target;if(d&&(d.classList&&(d.classList.contains("molecule-diagram")||d.classList.contains("molecule-container")||d.classList.contains("molecule-viewer")||d.classList.contains("chem-size-controls")||d.classList.contains("chemtex-image-loading-indicator"))||d.closest&&d.closest(".molecule-container, .chem-image-container, .molecule-viewer-container")))return}if(o+=m.length,e++,o>c){const l=Date.now();(!r||l-n>s)&&(bobthelogger.warn(`\u26A0\uFE0F High mutation rate detected (${o}), throttling to prevent crashes...`),r=!0,n=l),o=0,clearTimeout(u.timer),u.timer=setTimeout(()=>{if(r=!1,o=0,settings.jedimode&&!t&&!isrefreshn){t=!0;try{bobthelogger.inject("\u26A1 Delayed re-scan after high mutation period"),senddaprobes()}catch(d){bobthelogger.error("Error during page scan:",d)}finally{setTimeout(()=>{t=!1},200)}}},1500);return}e%100===0&&bobthelogger.debug(`Detected ${e} total mutations`),clearTimeout(u.timer),u.timer=setTimeout(()=>{if(o=0,isrefreshn){bobthelogger.debug("\u23ED\uFE0F Skipping re-scan - currently updating images");return}if(settings.jedimode){t=!0;try{bobthelogger.inject("\u26A1 Re-scanning page after dynamic content detected"),senddaprobes()}catch(l){bobthelogger.error("Error during page scan:",l)}finally{setTimeout(()=>{t=!1},100)}}},500)});u.observe(document.documentElement,{childList:!0,subtree:!0,characterData:!1}),window._chemRendererObserver=u,bobthelogger.success("\u2705 Dynamic content observer initialized")}function disconnectAllObservers(){try{window._chemRendererObserver&&(window._chemRendererObserver.disconnect(),clearTimeout(window._chemRendererObserver.timer),window._chemRendererObserver=null),window._lazyLoadObserver&&(window._lazyLoadObserver.disconnect(),window._lazyLoadObserver=null),intersectionObserverInstance&&(intersectionObserverInstance.disconnect(),intersectionObserverInstance=null),structureRenderCache.clear(),searchinprogress.clear(),padawanzzzz.clear(),bobthelogger.info("\u{1F9F9} Cleaned up all observers and caches")}catch{}}if(window.addEventListener("beforeunload",disconnectAllObservers),window.addEventListener("pagehide",disconnectAllObservers),window.matchMedia){let t=function(o){document.querySelectorAll("img.molecule-diagram").forEach(c=>{const s=c.src;if(s&&s.startsWith("data:image/svg+xml;base64,"))try{const u=s.replace("data:image/svg+xml;base64,",""),m=atob(u);let i=m;if(o?i=i.replace(/#000000/gi,"#FFFFFF").replace(/#000\b/gi,"#FFF").replace(/rgb\(0,\s*0,\s*0\)/gi,"rgb(255, 255, 255)").replace(/stroke="black"/gi,'stroke="white"').replace(/fill="black"/gi,'fill="white"'):i=m.replace(/#FFFFFF/gi,"#000000").replace(/#FFF\b/gi,"#000").replace(/rgb\(255,\s*255,\s*255\)/gi,"rgb(0, 0, 0)").replace(/stroke="white"/gi,'stroke="black"').replace(/fill="white"/gi,'fill="black"'),c.dataset.originalSrc||(c.dataset.originalSrc=s),!o&&c.dataset.originalSrc){c.src=c.dataset.originalSrc;return}c.src="data:image/svg+xml;base64,"+btoa(i)}catch{}}),document.querySelectorAll("img.compound-diagram").forEach(c=>{})};var updateMoleculeColors=t;window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>{t(o.matches)}),bobthelogger.success("\u2705 Dark mode listener initialized")}bobthelogger.success("\u{1F389} ChemRenderer loaded");function padmestilllovedanakineventhoughhedidwarcrimes(e,t){const o=window.getSelection();if(!o.rangeCount)return;const r=o.getRangeAt(0),n=document.createElement("img");n.className="molecule-diagram molecule-viewer",n.alt=e,n.title=t.title,n.src="";const c={nomenclature:t.nomenclature||e,type:t.type||"nomenclature",options:{width:400,height:300,scale:1,rotation:0},isMoleculeViewer:!0,flags:t.flags};t.smiles&&(c.smiles=t.smiles),n.dataset.moleculeViewer=btoa(JSON.stringify(c)),n.dataset.loaded="false",n.dataset.rotation="0",n.dataset.compoundType=t.flags.compoundType,t.smiles&&(n.dataset.smiles=t.smiles),n.style.cssText="display:inline-block;vertical-align:middle;margin:0 4px;min-width:100px;min-height:80px;background:rgba(128,128,128,0.1);border-radius:4px;padding:4px",r.deleteContents(),r.insertNode(n),o.removeAllRanges(),window._loadMoleculeImage?window._loadMoleculeImage(n):n.alt="Error: Renderer not ready"}chrome.runtime.onMessage.addListener((e,t,o)=>{var n,c,s;const r=(n=e.text)==null?void 0:n.trim();switch(e.type){case"INSPECT_MOLECULE":if(!r)return;padmestilllovedanakineventhoughhedidwarcrimes(r,{title:`Searching compound database: ${r}`,flags:{compoundType:"compound",isDirectSmiles:!1}});break;case"RENDER_SMILES":if(!r)return;padmestilllovedanakineventhoughhedidwarcrimes(r,{title:`SMILES: ${r}`,type:"smiles",smiles:r,flags:{compoundType:"compound",isDirectSmiles:!0}});break;case"RENDER_BIOMOLECULE":if(!r)return;padmestilllovedanakineventhoughhedidwarcrimes(r,{title:`Searching protein database: ${r}`,flags:{compoundType:"biomolecule",isDirectSmiles:!1}});break;case"RENDER_MINERAL":if(!r)return;padmestilllovedanakineventhoughhedidwarcrimes(r,{title:`Searching mineral database: ${r}`,flags:{compoundType:"mineral",isDirectSmiles:!1}});break}if(e.type==="RERENDER_IMAGE"){const u=e.srcUrl,m=e.renderAs,i=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let l=null;for(const S of i)if(S.src===u){l=S;break}if(!l)return;let d=l.dataset.nomenclature||l.dataset.smiles||((c=l.alt)==null?void 0:c.replace(/^(SMILES|Biomolecule|Mineral):\s*/,""))||((s=l.title)==null?void 0:s.replace(/^(Searching|Rendering|PDB|COD).*?:\s*/,""));if(!d&&l.dataset.moleculeViewer)try{const S=JSON.parse(atob(l.dataset.moleculeViewer));d=S.smiles||S.nomenclature||S.name}catch{}if(!d){alert("Could not determine the original molecule name/SMILES from this image.");return}d=d.trim();let C,y;switch(m){case"molecule":y={compoundType:"compound",isDirectSmiles:!1},C={nomenclature:d,type:"nomenclature",flags:y};break;case"smiles":y={compoundType:"compound",isDirectSmiles:!0},C={smiles:d,nomenclature:`SMILES: ${d}`,type:"smiles",flags:y},l.dataset.smiles=d;break;case"biomolecule":y={compoundType:"biomolecule",isDirectSmiles:!1},C={nomenclature:d,type:"nomenclature",flags:y};break;case"mineral":y={compoundType:"mineral",isDirectSmiles:!1},C={nomenclature:d,type:"nomenclature",flags:y};break;default:return}C.options={width:400,height:300,scale:1,rotation:0},C.isMoleculeViewer=!0,l.dataset.moleculeViewer=btoa(JSON.stringify(C)),l.dataset.loaded="false",l.dataset.compoundType=y.compoundType||"auto",l.alt=d,l.title=`Re-rendering as ${m}: ${d}`,l.src="",window._loadMoleculeImage?window._loadMoleculeImage(l):l.alt="Error: Renderer not ready"}if(e.type==="EDIT_FLAGS"){const u=e.srcUrl,m=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let i=null;for(const S of m)if(S.src===u){i=S;break}if(!i)return;let l={},d=i.alt||i.title||"Unknown";if(i.dataset.moleculeViewer)try{const S=JSON.parse(atob(i.dataset.moleculeViewer));l=S.flags||{},d=S.nomenclature||S.smiles||d}catch{}const C=document.getElementById("chemtex-flag-editor");C&&C.remove();const y=document.createElement("div");y.id="chemtex-flag-editor",y.innerHTML=`
      <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999999; display: flex; align-items: center; justify-content: center;">
        <div style="background: #fff; border-radius: 12px; padding: 24px; min-width: 350px; max-width: 450px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
          <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">\u{1F39B}\uFE0F ChemTex Flag Editor</h3>
          <p style="margin: 0 0 16px 0; font-size: 13px; color: #666; word-break: break-all;">${d}</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-c" ${l.showCarbons?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Carbons (c)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-n" ${l.atomNumbers?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Atom Numbers (n)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-o" ${l.aromaticCircles?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Aromatic Rings (o)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-h" ${l.addHydrogens?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Hydrogens (h)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-m" ${l.showMethyls?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Methyls (m)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-i" ${l.showImplicitHydrogens?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Implicit H (i)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-p" ${l.flipHorizontal?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Flip Horizontal (p)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-q" ${l.flipVertical?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Flip Vertical (q)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; grid-column: span 2;">
              <input type="checkbox" id="flag-3d" ${l.is3D?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show 3D Model First (3d)</span>
            </label>
          </div>
          
          <p style="margin: 0 0 16px 0; font-size: 11px; color: #999;">\u26A0\uFE0F Changes are temporary and will be reset when you change global settings in the popup.</p>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="flag-cancel" style="padding: 10px 20px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button id="flag-apply" style="padding: 10px 20px; border: none; background: #4CAF50; color: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Apply</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(y),document.getElementById("flag-cancel").addEventListener("click",()=>{y.remove()}),document.getElementById("flag-apply").addEventListener("click",()=>{const S={showCarbons:document.getElementById("flag-c").checked,atomNumbers:document.getElementById("flag-n").checked,aromaticCircles:document.getElementById("flag-o").checked,addHydrogens:document.getElementById("flag-h").checked,showMethyls:document.getElementById("flag-m").checked,showImplicitHydrogens:document.getElementById("flag-i").checked,flipHorizontal:document.getElementById("flag-p").checked,flipVertical:document.getElementById("flag-q").checked,is3D:document.getElementById("flag-3d").checked,flagsLocked:!0,...l};let w={};if(i.dataset.moleculeViewer)try{w=JSON.parse(atob(i.dataset.moleculeViewer))}catch{}w.flags=S,w.isMoleculeViewer=!0,i.dataset.moleculeViewer=btoa(JSON.stringify(w)),i.dataset.loaded="false",i.src="",window._loadMoleculeImage&&window._loadMoleculeImage(i),y.remove()}),y.querySelector("div").addEventListener("click",S=>{S.target===y.querySelector("div")&&y.remove()})}});
