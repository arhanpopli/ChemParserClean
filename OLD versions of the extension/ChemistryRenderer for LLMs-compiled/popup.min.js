/**
 * ChemistryRenderer for LLMs
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * Unauthorized copying, modification, or distribution of this software is prohibited.
 */
const enabledToggle=document.getElementById("enabledToggle"),perfModeToggle=document.getElementById("perfModeToggle"),devModeToggle=document.getElementById("devModeToggle"),reloadAllBtn=document.getElementById("reloadAllBtn"),statusDiv=document.getElementById("status"),renderingOptionsSection=document.getElementById("renderingOptions"),sdUseStereochemistryToggle=document.getElementById("sdUseStereochemistryToggle"),sdShowCarbonsToggle=document.getElementById("sdShowCarbonsToggle"),sdAromaticRingsToggle=document.getElementById("sdAromaticRingsToggle"),sdShowMethylsToggle=document.getElementById("sdShowMethylsToggle"),sdAtomNumbersToggle=document.getElementById("sdAtomNumbersToggle"),sdShowExplicitHydrogensToggle=document.getElementById("sdShowExplicitHydrogensToggle"),sdShowImplicitHydrogensToggle=document.getElementById("sdShowImplicitHydrogensToggle"),sdCompactDrawingToggle=document.getElementById("sdCompactDrawingToggle"),sdFlipHorizontalToggle=document.getElementById("sdFlipHorizontalToggle"),sdFlipVerticalToggle=document.getElementById("sdFlipVerticalToggle"),sdThemeSelect=document.getElementById("sdThemeSelect"),sdRotateSlider=document.getElementById("sdRotateSlider"),sdRotateValue=document.getElementById("sdRotateValue"),sdAverageSizeSlider=document.getElementById("sdAverageSizeSlider"),sdAverageSizeValue=document.getElementById("sdAverageSizeValue"),sdGradientColorsToggle=document.getElementById("sdGradientColorsToggle"),sdScaleByWeightToggle=document.getElementById("sdScaleByWeightToggle"),renderingEngineSelect=document.getElementById("renderingEngineSelect"),compoundOptions=document.getElementById("compoundOptions"),molviewRepresentationSelect=document.getElementById("molviewRepresentationSelect"),compoundMolviewBgColorSelect=document.getElementById("compoundMolviewBgColorSelect"),molviewEngineSelect=document.getElementById("molviewEngineSelect"),compound3DSizeSlider=document.getElementById("compound3DSizeSlider"),compound3DSizeValue=document.getElementById("compound3DSizeValue"),proteinRemoveWhiteBgToggle=document.getElementById("proteinRemoveWhiteBgToggle"),molviewBioAssemblyToggle=document.getElementById("molviewBioAssemblyToggle"),molviewChainTypeSelect=document.getElementById("molviewChainTypeSelect"),molviewChainBondsToggle=document.getElementById("molviewChainBondsToggle"),molviewChainColorSelect=document.getElementById("molviewChainColorSelect"),proteinMolviewBgColorSelect=document.getElementById("proteinMolviewBgColorSelect"),bioAssemblySettings=document.getElementById("bioAssemblySettings"),bioAssemblyViewerSelect=document.getElementById("bioAssemblyViewerSelect"),bioAssemblyGraphicsSelect=document.getElementById("bioAssemblyGraphicsSelect"),bioAssemblyPdbProviderSelect=document.getElementById("bioAssemblyPdbProviderSelect"),mineralRepresentationSelect=document.getElementById("mineralRepresentationSelect"),mineralMolviewBgColorSelect=document.getElementById("mineralMolviewBgColorSelect"),mineralCrystallographySelect=document.getElementById("mineralCrystallographySelect"),mineral3DSizeSlider=document.getElementById("mineral3DSizeSlider"),mineral3DSizeValue=document.getElementById("mineral3DSizeValue"),saveSizePerImageToggle=document.getElementById("saveSizePerImageToggle"),saveSizeBySMILESToggle=document.getElementById("saveSizeBySMILESToggle"),enable3DViewerToggle=document.getElementById("enable3DViewerToggle"),default3DViewSelect=document.getElementById("default3DViewSelect"),viewer3DSourceSelect=document.getElementById("viewer3DSourceSelect"),viewer3DStyleSelect=document.getElementById("viewer3DStyleSelect"),viewer3DAutoRotateToggle=document.getElementById("viewer3DAutoRotateToggle"),viewer3DSizeSelect=document.getElementById("viewer3DSizeSelect"),viewer3DBgColorSelect=document.getElementById("viewer3DBgColorSelect"),molSearchModeToggle=document.getElementById("molSearchModeToggle"),disableFormulaFallbackToggle=document.getElementById("disableFormulaFallbackToggle"),enableAIFlagControlToggle=document.getElementById("enableAIFlagControlToggle"),searchCompoundsToggle=document.getElementById("searchCompoundsToggle"),searchBiomoleculesToggle=document.getElementById("searchBiomoleculesToggle"),searchMineralsToggle=document.getElementById("searchMineralsToggle");function safeGetElement(e){const t=document.getElementById(e);return t}function saveSetting(e,t,o){chrome.storage.sync.set(e,()=>{if(chrome.runtime.lastError){const n=chrome.runtime.lastError.message||"Unknown error";showStatus("Error saving: "+n,"error"),o&&o(!1);return}t&&showStatus(t,"success"),o&&o(!0)})}function saveSettingWithVerification(e,t,o){const n={};n[e]=t,chrome.storage.sync.set(n,()=>{if(chrome.runtime.lastError){o&&o(!1,chrome.runtime.lastError.message);return}chrome.storage.sync.get([e],r=>{if(chrome.runtime.lastError){o&&o(!1,chrome.runtime.lastError.message);return}r[e]===t?o&&o(!0):o&&o(!1,"Verification failed")})})}chrome.storage.sync.get(null,e=>{e.molviewRepresentation?showStatus("DEBUG: Loaded representation = "+e.molviewRepresentation,"success"):showStatus("DEBUG: No representation stored, using default","error");const t={jedimode:!0,hyperdrive:!0,renderengine:"chemtex",sithmode:!1,use3dforce:!1,showcarbonz:!0,aromaticringz:!0,sdShowMethyls:!0,sdAtomNumbers:!1,sdShowExplicitHydrogens:!1,sdShowImplicitHydrogens:!0,sdCompactDrawing:!1,sdFlipHorizontal:!1,sdFlipVertical:!1,viztheme:"light",autoadaptmode:!0,rotatemode:0,sdBondThickness:1,avgsize:100,gradientcolors:!1,scalebyweight:!1,savesizelightsaber:!1,savesizeholocron:!0,findcompounds:!0,findproteins:!0,findcrystals:!0,renderingEngine:"chemtex",compoundMolviewBgColor:"black",disableFormulaFallback:!1,enable3DViewer:!1,default3DView:"2d",viewer3DSource:"3dmol",viewer3DStyle:"stick:sphere",viewer3DAutoRotate:!0,viewer3DSize:"normal",viewer3DBgColor:"#1a1a2e",molviewRepresentation:"ballAndStick",molviewEngine:"glmol",removebg:!1,bioassembly:!1,bioviewer:"molstar",biographics:"balanced",pdbprovider:"rcsb",molviewChainType:"ribbon",molviewChainBonds:!1,molviewChainColor:"ss",proteinMolviewBgColor:"black",mineralRepresentation:"ballAndStick",mineralMolviewBgColor:"black",mineralCrystallography:"supercell_2x2x2",compound3dsize:100,mineral3dsize:100,viewer3DStyleSettings:{stick:{stickRadius:"0.15"},line:{},cross:{},sphere:{sphereRadius:"0.7"},"stick:sphere":{stickRadius:"0.15",sphereRadius:"0.3"},cartoon:{}},enableAIMolecularControl:!1,molSearchMode:!1,forceguidance:!1,uiBlur:7,uiOpacity:23,moleculeCount:22,moleculeScale:.4,cursorGravityStrength:-.9,initialVelocity:10},o={};for(const s in t)o[s]=e[s]!==void 0?e[s]:t[s];enabledToggle&&(enabledToggle.checked=o.jedimode),perfModeToggle&&(perfModeToggle.checked=o.hyperdrive),devModeToggle&&(devModeToggle.checked=o.sithmode),enableAIFlagControlToggle&&(enableAIFlagControlToggle.checked=o.forceguidance===!0),sdUseStereochemistryToggle&&(sdUseStereochemistryToggle.checked=o.use3dforce),sdShowCarbonsToggle&&(sdShowCarbonsToggle.checked=o.showcarbonz),sdAromaticRingsToggle&&(sdAromaticRingsToggle.checked=o.aromaticringz),sdShowMethylsToggle&&(sdShowMethylsToggle.checked=o.sdShowMethyls),sdAtomNumbersToggle&&(sdAtomNumbersToggle.checked=o.sdAtomNumbers),sdShowExplicitHydrogensToggle&&(sdShowExplicitHydrogensToggle.checked=o.sdShowExplicitHydrogens),sdShowImplicitHydrogensToggle&&(sdShowImplicitHydrogensToggle.checked=o.sdShowImplicitHydrogens),sdCompactDrawingToggle&&(sdCompactDrawingToggle.checked=o.sdCompactDrawing),sdFlipHorizontalToggle&&(sdFlipHorizontalToggle.checked=o.sdFlipHorizontal),sdFlipVerticalToggle&&(sdFlipVerticalToggle.checked=o.sdFlipVertical),sdThemeSelect&&(sdThemeSelect.value=o.viztheme||"light"),sdRotateSlider&&(sdRotateSlider.value=o.rotatemode||0,sdRotateValue&&(sdRotateValue.textContent=(o.rotatemode||0)+"\xB0")),sdAverageSizeSlider&&(sdAverageSizeSlider.value=o.avgsize||100,sdAverageSizeValue&&(sdAverageSizeValue.textContent=(o.avgsize||100)+"%")),sdGradientColorsToggle&&(sdGradientColorsToggle.checked=o.gradientcolors||!1),sdScaleByWeightToggle&&(sdScaleByWeightToggle.checked=o.scalebyweight||!1),searchCompoundsToggle&&(searchCompoundsToggle.checked=o.findcompounds!==!1),searchBiomoleculesToggle&&(searchBiomoleculesToggle.checked=o.findproteins!==!1),searchMineralsToggle&&(searchMineralsToggle.checked=o.findcrystals!==!1);const n=document.getElementById("useStereochemistryToggle");if(n&&(n.checked=o.use3dforce!==!1),saveSizePerImageToggle&&(saveSizePerImageToggle.checked=o.savesizelightsaber),saveSizeBySMILESToggle&&(saveSizeBySMILESToggle.checked=o.savesizeholocron),enable3DViewerToggle&&(enable3DViewerToggle.checked=o.enable3DViewer),default3DViewSelect&&(default3DViewSelect.value=o.default3DView),viewer3DSourceSelect&&(viewer3DSourceSelect.value=o.viewer3DSource||"3dmol"),viewer3DStyleSelect&&(viewer3DStyleSelect.value=o.viewer3DStyle||"stick:sphere"),viewer3DAutoRotateToggle&&(viewer3DAutoRotateToggle.checked=o.viewer3DAutoRotate!==!1),viewer3DSizeSelect&&(viewer3DSizeSelect.value=o.viewer3DSize||"normal"),viewer3DBgColorSelect&&(viewer3DBgColorSelect.value=o.viewer3DBgColor||"#1a1a2e"),molviewRepresentationSelect){const s=o.molviewRepresentation||"ballAndStick";molviewRepresentationSelect.value=s,molviewRepresentationSelect.value!==s&&showStatus("Warning: Could not set representation to: "+s,"error")}if(compoundMolviewBgColorSelect&&(compoundMolviewBgColorSelect.value=o.compoundMolviewBgColor||"black"),molviewEngineSelect&&(molviewEngineSelect.value=o.molviewEngine||"glmol"),compound3DSizeSlider&&(compound3DSizeSlider.value=o.compound3dsize||100,compound3DSizeValue&&(compound3DSizeValue.textContent=(o.compound3dsize||100)+"%")),proteinRemoveWhiteBgToggle&&(proteinRemoveWhiteBgToggle.checked=o.removebg===!0),molviewBioAssemblyToggle&&(molviewBioAssemblyToggle.checked=o.bioassembly),bioAssemblyViewerSelect&&(bioAssemblyViewerSelect.value=o.bioviewer||"molstar"),bioAssemblyGraphicsSelect&&(bioAssemblyGraphicsSelect.value=o.biographics||"balanced"),bioAssemblyPdbProviderSelect&&(bioAssemblyPdbProviderSelect.value=o.pdbprovider||"rcsb"),bioAssemblySettings&&(o.bioassembly?(bioAssemblySettings.style.opacity="1",bioAssemblySettings.style.pointerEvents="auto"):(bioAssemblySettings.style.opacity="0.5",bioAssemblySettings.style.pointerEvents="none")),molviewChainTypeSelect){const s=o.molviewChainType||"ribbon";molviewChainTypeSelect.value=s,molviewChainTypeSelect.value!==s&&showStatus("Warning: Could not set chain type to: "+s,"error")}molviewChainBondsToggle&&(molviewChainBondsToggle.checked=o.molviewChainBonds),molviewChainColorSelect&&(molviewChainColorSelect.value=o.molviewChainColor||"ss"),proteinMolviewBgColorSelect&&(proteinMolviewBgColorSelect.value=o.proteinMolviewBgColor||"black"),mineralRepresentationSelect&&(mineralRepresentationSelect.value=o.mineralRepresentation||"ballAndStick"),mineralMolviewBgColorSelect&&(mineralMolviewBgColorSelect.value=o.mineralMolviewBgColor||"black"),mineralCrystallographySelect&&(mineralCrystallographySelect.value=o.mineralCrystallography||"supercell_2x2x2"),mineral3DSizeSlider&&(mineral3DSizeSlider.value=o.mineral3dsize||100,mineral3DSizeValue&&(mineral3DSizeValue.textContent=(o.mineral3dsize||100)+"%")),compoundOptions&&(compoundOptions.style.display="block"),molSearchModeToggle&&(molSearchModeToggle.checked=o.molSearchMode),disableFormulaFallbackToggle&&(disableFormulaFallbackToggle.checked=o.disableFormulaFallback),renderingEngineSelect&&(renderingEngineSelect.value=o.renderingEngine||"chemtex"),document.querySelectorAll('input[name="renderingEngine"]').forEach(s=>{s.checked=s.value===o.renderengine});const l=document.getElementById("compoundOptions");l&&(l.style.display="block");const i=document.getElementById("biomoleculeOptions");i&&(i.style.display="block");const c=document.getElementById("mineralOptions");c&&(c.style.display="block")}),enabledToggle&&enabledToggle.addEventListener("change",e=>{chrome.storage.sync.set({jedimode:e.target.checked},()=>{showStatus("ChemTex "+(e.target.checked?"jedimode":"disabled"),"success")})}),perfModeToggle&&perfModeToggle.addEventListener("change",e=>{chrome.storage.sync.set({hyperdrive:e.target.checked},()=>{broadcastSettingsChange({hyperdrive:e.target.checked}),showStatus("Lazy-loading "+(e.target.checked?"jedimode":"disabled"),"success")})}),devModeToggle&&devModeToggle.addEventListener("change",e=>{chrome.storage.sync.set({sithmode:e.target.checked},()=>{showStatus("Developer mode "+(e.target.checked?"jedimode":"disabled"),"success")})}),enableAIFlagControlToggle&&enableAIFlagControlToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({forceguidance:t},()=>{broadcastSettingsChange({forceguidance:t}),showStatus("AI flag control "+(t?"jedimode":"disabled"),"success")})}),reloadAllBtn&&reloadAllBtn.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"RELOAD_ALL_IMAGES"},e=>{}),showStatus("Reloading all images...","success")});const clearCacheBtn=document.getElementById("clearCacheBtn");clearCacheBtn&&clearCacheBtn.addEventListener("click",()=>{chrome.tabs.query({},e=>{e.forEach(t=>{chrome.tabs.sendMessage(t.id,{type:"CLEAR_CACHE"}).catch(()=>{})})}),chrome.runtime.sendMessage({type:"CLEAR_CACHE"},e=>{}),chrome.storage.local.get(null,e=>{const t=Object.keys(e).filter(o=>o.startsWith("smiles_")||o.startsWith("cid_")||o.startsWith("cache_")||o.startsWith("search_")||o==="chemtex_smiles_cache"||o==="chemtex_svg_cache");t.length>0?chrome.storage.local.remove(t,()=>{}):chrome.storage.local.remove(["chemtex_smiles_cache","chemtex_svg_cache"],()=>{})}),showStatus("Cache cleared! Reload images to fetch fresh data.","success")}),saveSizePerImageToggle&&saveSizePerImageToggle.addEventListener("change",e=>{chrome.storage.sync.set({savesizelightsaber:e.target.checked},()=>{showStatus("Save size per page "+(e.target.checked?"jedimode":"disabled")+". Size changes will be remembered for each page.","success")})}),saveSizeBySMILESToggle&&saveSizeBySMILESToggle.addEventListener("change",e=>{chrome.storage.sync.set({savesizeholocron:e.target.checked},()=>{showStatus("Save size by SMILES "+(e.target.checked?"jedimode":"disabled")+". Same size will be used for all molecules with the same SMILES.","success")})});function broadcastSettingsChange(e){const t=Object.keys(e);chrome.runtime.sendMessage({type:"SETTINGS_CHANGED",settings:e,changedKeys:t})}sdUseStereochemistryToggle&&sdUseStereochemistryToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({use3dforce:t},()=>{if(chrome.runtime.lastError){showStatus("Error saving setting: "+chrome.runtime.lastError.message,"error");return}broadcastSettingsChange({use3dforce:t}),showStatus("Stereochemistry "+(t?"jedimode":"disabled"),"success")})}),sdShowCarbonsToggle&&sdShowCarbonsToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({showcarbonz:t},()=>{if(chrome.runtime.lastError){showStatus("Error saving setting: "+chrome.runtime.lastError.message,"error");return}broadcastSettingsChange({showcarbonz:t}),showStatus("Show carbons "+(t?"jedimode":"disabled"),"success")})}),sdAromaticRingsToggle&&sdAromaticRingsToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({aromaticringz:t},()=>{if(chrome.runtime.lastError){showStatus("Error saving setting: "+chrome.runtime.lastError.message,"error");return}broadcastSettingsChange({aromaticringz:t}),showStatus("Aromatic ring circles "+(t?"jedimode":"disabled"),"success")})}),sdShowMethylsToggle&&sdShowMethylsToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdShowMethyls",t,(o,n)=>{o?(broadcastSettingsChange({sdShowMethyls:t}),showStatus("Show methyls "+(t?"jedimode":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdShowMethylsToggle.checked=!t)})}),sdAtomNumbersToggle&&sdAtomNumbersToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdAtomNumbers",t,(o,n)=>{o?(broadcastSettingsChange({sdAtomNumbers:t}),showStatus("Atom numbers "+(t?"jedimode":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdAtomNumbersToggle.checked=!t)})}),sdShowExplicitHydrogensToggle&&sdShowExplicitHydrogensToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdShowExplicitHydrogens",t,(o,n)=>{o?(broadcastSettingsChange({sdShowExplicitHydrogens:t}),showStatus("Explicit hydrogens "+(t?"jedimode":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdShowExplicitHydrogensToggle.checked=!t)})}),sdShowImplicitHydrogensToggle&&sdShowImplicitHydrogensToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdShowImplicitHydrogens",t,(o,n)=>{o?(broadcastSettingsChange({sdShowImplicitHydrogens:t}),showStatus("Implicit hydrogens "+(t?"shown":"hidden"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdShowImplicitHydrogensToggle.checked=!t)})}),sdCompactDrawingToggle&&sdCompactDrawingToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdCompactDrawing",t,(o,n)=>{o?(broadcastSettingsChange({sdCompactDrawing:t}),showStatus("Compact drawing "+(t?"jedimode":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdCompactDrawingToggle.checked=!t)})}),sdFlipHorizontalToggle&&sdFlipHorizontalToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdFlipHorizontal",t,(o,n)=>{o?(broadcastSettingsChange({sdFlipHorizontal:t}),showStatus("Horizontal flip "+(t?"jedimode":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdFlipHorizontalToggle.checked=!t)})}),sdFlipVerticalToggle&&sdFlipVerticalToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdFlipVertical",t,(o,n)=>{o?(broadcastSettingsChange({sdFlipVertical:t}),showStatus("Vertical flip "+(t?"jedimode":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdFlipVerticalToggle.checked=!t)})}),sdThemeSelect&&sdThemeSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({viztheme:t},()=>{broadcastSettingsChange({viztheme:t}),showStatus("Theme set to "+t,"success")})}),sdRotateSlider&&(sdRotateSlider.addEventListener("input",e=>{sdRotateValue.textContent=e.target.value+"\xB0"}),sdRotateSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({rotatemode:t},()=>{broadcastSettingsChange({rotatemode:t}),showStatus("Rotation set to "+t+"\xB0","success")})})),sdAverageSizeSlider&&(sdAverageSizeSlider.addEventListener("input",e=>{sdAverageSizeValue.textContent=e.target.value+"%",broadcastSettingsChange({avgsize:parseInt(e.target.value)})}),sdAverageSizeSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({avgsize:t},()=>{broadcastSettingsChange({avgsize:t}),showStatus("Average size set to "+t+"%","success")})})),sdGradientColorsToggle&&sdGradientColorsToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({gradientcolors:t},()=>{broadcastSettingsChange({gradientcolors:t}),showStatus("Gradient colors "+(t?"jedimode":"disabled"),"success")})}),sdScaleByWeightToggle&&sdScaleByWeightToggle.addEventListener("change",e=>{chrome.storage.sync.set({scalebyweight:e.target.checked},()=>{showStatus("Scale by weight "+(e.target.checked?"jedimode":"disabled")+". Reload page to apply.","success")})});const useStereochemistryToggleHandler=document.getElementById("useStereochemistryToggle");useStereochemistryToggleHandler&&useStereochemistryToggleHandler.addEventListener("change",e=>{chrome.storage.sync.set({use3dforce:e.target.checked},()=>{showStatus("Stereochemistry "+(e.target.checked?"jedimode":"disabled"),"success")})}),molviewRepresentationSelect&&molviewRepresentationSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewRepresentation:t},"Representation set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewRepresentation:t})})}),compoundMolviewBgColorSelect&&compoundMolviewBgColorSelect.addEventListener("change",e=>{const t=e.target.value;saveSettingWithVerification("compoundMolviewBgColor",t,(o,n)=>{o?(broadcastSettingsChange({compoundMolviewBgColor:t}),showStatus("Compound background set to "+e.target.options[e.target.selectedIndex].text,"success")):showStatus("Error saving background color: "+(n||"Unknown error"),"error")})}),molviewEngineSelect&&molviewEngineSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewEngine:t},"Engine set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewEngine:t})})}),renderingEngineSelect&&renderingEngineSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({renderingEngine:t},"Rendering engine set to "+({chemtex:"ChemTex",rdkit:"RDKit",kekule:"Kekule"}[t]||t),n=>{n&&broadcastSettingsChange({renderingEngine:t})})}),proteinRemoveWhiteBgToggle&&proteinRemoveWhiteBgToggle.addEventListener("change",e=>{try{const t=e.target.checked;chrome.storage.sync.set({removebg:t},()=>{chrome.runtime.lastError||(broadcastSettingsChange({removebg:t}),showStatus("White background removal "+(t?"jedimode":"disabled"),"success"))})}catch{}}),molviewBioAssemblyToggle&&molviewBioAssemblyToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({bioassembly:t},()=>{broadcastSettingsChange({bioassembly:t}),showStatus("Bio Assembly "+(t?"shown":"hidden"),"success"),bioAssemblySettings&&(t?(bioAssemblySettings.style.opacity="1",bioAssemblySettings.style.pointerEvents="auto"):(bioAssemblySettings.style.opacity="0.5",bioAssemblySettings.style.pointerEvents="none"))})}),bioAssemblyViewerSelect&&bioAssemblyViewerSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({bioviewer:t},()=>{broadcastSettingsChange({bioviewer:t}),showStatus("Bio Viewer set to "+e.target.options[e.target.selectedIndex].text,"success")})}),bioAssemblyGraphicsSelect&&bioAssemblyGraphicsSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({biographics:t},()=>{broadcastSettingsChange({biographics:t}),showStatus("Graphics mode set to "+e.target.options[e.target.selectedIndex].text,"success")})}),bioAssemblyPdbProviderSelect&&bioAssemblyPdbProviderSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({pdbprovider:t},()=>{broadcastSettingsChange({pdbprovider:t}),showStatus("PDB Provider set to "+e.target.options[e.target.selectedIndex].text,"success")})}),molviewChainTypeSelect&&molviewChainTypeSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewChainType:t},"Chain Type set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewChainType:t})})}),molviewChainBondsToggle&&molviewChainBondsToggle.addEventListener("change",e=>{const t=e.target.checked;saveSetting({molviewChainBonds:t},"Chain Bonds "+(t?"shown":"hidden"),o=>{o&&broadcastSettingsChange({molviewChainBonds:t})})}),molviewChainColorSelect&&molviewChainColorSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewChainColor:t},"Chain Color set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewChainColor:t})})}),proteinMolviewBgColorSelect&&proteinMolviewBgColorSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({proteinMolviewBgColor:t},"Protein background color set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({proteinMolviewBgColor:t})})}),mineralRepresentationSelect&&mineralRepresentationSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({mineralRepresentation:t},"Mineral representation set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({mineralRepresentation:t})})}),mineralMolviewBgColorSelect&&mineralMolviewBgColorSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({mineralMolviewBgColor:t},"Mineral background color set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({mineralMolviewBgColor:t})})}),mineralCrystallographySelect&&mineralCrystallographySelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({mineralCrystallography:t},"Mineral crystallography set to "+e.target.options[e.target.selectedIndex].text+". Reload page to apply.")});const engineRadios=document.querySelectorAll('input[name="renderingEngine"]');engineRadios.forEach(e=>{e.addEventListener("change",t=>{if(t.target.checked){const o=t.target.value;chrome.storage.sync.set({renderengine:o},()=>{updateEngineInfo(),showStatus("Rendering engine updated. Reload page to apply.","success")})}})});const biomoleculeOptions=document.getElementById("biomoleculeOptions"),mineralOptions=document.getElementById("mineralOptions");function updateEngineInfo(){compoundOptions&&(compoundOptions.style.display="block"),biomoleculeOptions&&(biomoleculeOptions.style.display="block"),mineralOptions&&(mineralOptions.style.display="block")}function showStatus(e,t){statusDiv.textContent=e,statusDiv.className="status show",setTimeout(()=>{statusDiv.className="status"},2500)}function openConsole(){statusDiv&&showStatus("Open DevTools with F12 to debug. Check console for errors.","info")}const codeEditor=document.getElementById("codeEditor"),renderCodeBtn=document.getElementById("renderCodeBtn"),codePreview=document.getElementById("codePreview"),codePreviewContent=document.getElementById("codePreviewContent");renderCodeBtn&&codeEditor&&codePreview&&codePreviewContent&&renderCodeBtn.addEventListener("click",()=>{const e=codeEditor.value.trim();if(!e){showStatus("\u26A0\uFE0F Please enter some code to render","warning");return}codePreview.style.display="block",codePreviewContent.innerHTML=e,chrome.tabs.query({active:!0,currentWindow:!0},t=>{t[0]&&chrome.tabs.sendMessage(t[0].id,{action:"renderPreview",code:e},o=>{o&&o.html?(codePreviewContent.innerHTML=o.html,showStatus("\u2705 Preview rendered successfully","success")):showStatus("\u26A0\uFE0F Could not render preview. Reload page to see changes.","warning")})})});const blurSlider=document.getElementById("blurSlider"),opacitySlider=document.getElementById("opacitySlider"),blurValue=document.getElementById("blurValue"),opacityValue=document.getElementById("opacityValue");function applyGlassmorphism(e,t){var o=document.querySelectorAll(".section"),n=document.querySelector(".header"),r=document.querySelector(".footer"),l=document.querySelectorAll(".radio-option"),i=e+"px",c=t/100;o.forEach(function(s){s.style.backdropFilter="blur("+i+")",s.style.webkitBackdropFilter="blur("+i+")",s.style.background="rgba(255, 255, 255, "+c+")"}),n&&(n.style.backdropFilter="blur("+i+")",n.style.webkitBackdropFilter="blur("+i+")",n.style.background="rgba(255, 255, 255, "+c*.9+")"),r&&(r.style.backdropFilter="blur("+i+")",r.style.webkitBackdropFilter="blur("+i+")",r.style.background="rgba(255, 255, 255, "+c*.9+")"),l.forEach(function(s){s.style.background="rgba(255, 255, 255, "+c*.8+")"})}chrome.storage.sync.get({uiBlur:7,uiOpacity:23},function(e){blurSlider&&(blurSlider.value=e.uiBlur,blurValue.textContent=e.uiBlur+"px"),opacitySlider&&(opacitySlider.value=e.uiOpacity,opacityValue.textContent=e.uiOpacity+"%"),applyGlassmorphism(e.uiBlur,e.uiOpacity)}),blurSlider&&(blurSlider.addEventListener("input",function(e){var t=parseInt(e.target.value);blurValue.textContent=t+"px";var o=parseInt(opacitySlider.value);applyGlassmorphism(t,o)}),blurSlider.addEventListener("change",function(e){chrome.storage.sync.set({uiBlur:parseInt(e.target.value)})})),opacitySlider&&(opacitySlider.addEventListener("input",function(e){var t=parseInt(e.target.value);opacityValue.textContent=t+"%";var o=parseInt(blurSlider.value);applyGlassmorphism(o,t)}),opacitySlider.addEventListener("change",function(e){chrome.storage.sync.set({uiOpacity:parseInt(e.target.value)})}));const molCountSlider=document.getElementById("molCountSlider"),molCountValue=document.getElementById("molCountValue");molCountSlider&&(molCountSlider.addEventListener("input",function(e){molCountValue.textContent=e.target.value}),molCountSlider.addEventListener("change",function(e){chrome.storage.sync.set({moleculeCount:parseInt(e.target.value)},()=>{window.updateMoleculeAnimation&&window.updateMoleculeAnimation()})}));const molScaleSlider=document.getElementById("molScaleSlider"),molScaleValue=document.getElementById("molScaleValue");molScaleSlider&&(molScaleSlider.addEventListener("input",function(e){molScaleValue.textContent=e.target.value}),molScaleSlider.addEventListener("change",function(e){chrome.storage.sync.set({moleculeScale:parseFloat(e.target.value)},()=>{window.updateMoleculeAnimation&&window.updateMoleculeAnimation()})})),chrome.storage.sync.get({moleculeCount:22,moleculeScale:.4,cursorGravityStrength:-.9,initialVelocity:10},function(e){molCountSlider&&(molCountSlider.value=e.moleculeCount,molCountValue.textContent=e.moleculeCount),molScaleSlider&&(molScaleSlider.value=e.moleculeScale,molScaleValue.textContent=e.moleculeScale),cursorGravitySlider&&(cursorGravitySlider.value=e.cursorGravityStrength,cursorGravityValue.textContent=e.cursorGravityStrength),initialVelocitySlider&&(initialVelocitySlider.value=e.initialVelocity,initialVelocityValue.textContent=e.initialVelocity)});const cursorGravitySlider=document.getElementById("cursorGravitySlider"),cursorGravityValue=document.getElementById("cursorGravityValue"),initialVelocitySlider=document.getElementById("initialVelocitySlider"),initialVelocityValue=document.getElementById("initialVelocityValue");function triggerPopupPhysicsUpdate(){try{window.updateMoleculeAnimation&&window.updateMoleculeAnimation()}catch{}}cursorGravitySlider&&(cursorGravitySlider.addEventListener("input",function(e){cursorGravityValue&&(cursorGravityValue.textContent=e.target.value)}),cursorGravitySlider.addEventListener("change",function(e){chrome.storage.sync.set({cursorGravityStrength:parseFloat(e.target.value)},()=>{triggerPopupPhysicsUpdate()})})),initialVelocitySlider&&(initialVelocitySlider.addEventListener("input",function(e){initialVelocityValue&&(initialVelocityValue.textContent=e.target.value)}),initialVelocitySlider.addEventListener("change",function(e){chrome.storage.sync.set({initialVelocity:parseFloat(e.target.value)},()=>{triggerPopupPhysicsUpdate()})})),(function(){const t=document.querySelectorAll(".section-title");chrome.storage.sync.get({hiddensections:[]},function(o){const n=o.hiddensections||[];t.forEach(function(r){var c,s;const l=(s=(c=r.querySelector("span"))==null?void 0:c.textContent)==null?void 0:s.trim(),i=r.closest(".section");l&&n.includes(l)&&i.classList.add("collapsed"),r.addEventListener("click",function(){i.classList.toggle("collapsed");const a=[];document.querySelectorAll(".section.collapsed .section-title span").forEach(function(d){a.push(d.textContent.trim())}),chrome.storage.sync.set({hiddensections:a})})})})})();const copyChatGPTPromptBtn=document.getElementById("copyChatGPTPrompt");copyChatGPTPromptBtn&&copyChatGPTPromptBtn.addEventListener("click",async()=>{try{const t=await(await fetch(chrome.runtime.getURL("USAGE.md"))).text();await navigator.clipboard.writeText(t);const o=copyChatGPTPromptBtn.innerHTML,n=copyChatGPTPromptBtn.style.background;copyChatGPTPromptBtn.innerHTML="Copied",copyChatGPTPromptBtn.style.background="#22c55e",setTimeout(()=>{copyChatGPTPromptBtn.innerHTML=o,copyChatGPTPromptBtn.style.background=n},2e3)}catch{copyChatGPTPromptBtn.innerHTML="Failed",setTimeout(()=>{copyChatGPTPromptBtn.innerHTML="Copy"},2e3)}});const donationWalletBtn=document.getElementById("donationWallet");donationWalletBtn&&donationWalletBtn.addEventListener("click",async e=>{e.preventDefault();const t="0x20E8D5f0BeA0fdffF470a6DBb89013Ff9Fd51933",o="4guoDVFaQc5qJQ8geLhCgUCJxdvWqmGXFAA6Ed26wXk8",n=document.createElement("div");n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;const r=document.createElement("div");r.style.cssText=`
      background: rgba(255, 255, 255, 0.98);
      padding: 32px;
      border-radius: 16px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
      color: #1a1a1a;
      border: 1px solid rgba(0, 0, 0, 0.05);
      backdrop-filter: blur(10px);
    `,r.innerHTML=`
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1a1a1a;">Support ChemistryRenderer</h3>
        <button id="closeWalletModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; line-height: 1;">&times;</button>
      </div>
      
      <p style="margin-bottom: 20px; color: #555; line-height: 1.5; font-size: 13px;">
        If you find this extension helpful, consider supporting development.
      </p>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-size: 11px; font-weight: 600; color: #666; margin-bottom: 6px;">ETH / L2</label>
        <div style="display: flex; align-items: center; gap: 8px; background: #f5f5f5; padding: 10px 12px; border-radius: 8px;">
          <code id="ethAddress" style="font-family: monospace; font-size: 11px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis;">${t}</code>
          <button id="copyEthBtn" style="background: #1a1a1a; color: #fff; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;">Copy</button>
        </div>
      </div>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-size: 11px; font-weight: 600; color: #666; margin-bottom: 6px;">Solana</label>
        <div style="display: flex; align-items: center; gap: 8px; background: #f5f5f5; padding: 10px 12px; border-radius: 8px;">
          <code id="solAddress" style="font-family: monospace; font-size: 11px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis;">${o}</code>
          <button id="copySolBtn" style="background: #1a1a1a; color: #fff; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer;">Copy</button>
        </div>
      </div>

      <div style="text-align: center; font-size: 11px; color: #999; margin-top: 16px;">Thank you!</div>
    `,n.appendChild(r),document.body.appendChild(n),document.getElementById("copyEthBtn").addEventListener("click",async()=>{await navigator.clipboard.writeText(t);const l=document.getElementById("copyEthBtn");l.textContent="Copied!",l.style.background="#27ae60",setTimeout(()=>{l.textContent="Copy",l.style.background="#000"},2e3)}),document.getElementById("copySolBtn").addEventListener("click",async()=>{await navigator.clipboard.writeText(o);const l=document.getElementById("copySolBtn");l.textContent="Copied!",l.style.background="#27ae60",setTimeout(()=>{l.textContent="Copy",l.style.background="#000"},2e3)}),document.getElementById("closeWalletModal").addEventListener("click",()=>{n.remove()}),n.addEventListener("click",l=>{l.target===n&&n.remove()})}),compound3DSizeSlider&&(compound3DSizeSlider.addEventListener("input",e=>{compound3DSizeValue.textContent=e.target.value+"%",broadcastSettingsChange({compound3dsize:parseInt(e.target.value)})}),compound3DSizeSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({compound3dsize:t},()=>{broadcastSettingsChange({compound3dsize:t}),showStatus("Compound 3D viewer size set to "+t+"%","success")})})),mineral3DSizeSlider&&(mineral3DSizeSlider.addEventListener("input",e=>{mineral3DSizeValue.textContent=e.target.value+"%",broadcastSettingsChange({mineral3dsize:parseInt(e.target.value)})}),mineral3DSizeSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({mineral3dsize:t},()=>{broadcastSettingsChange({mineral3dsize:t}),showStatus("Mineral 3D viewer size set to "+t+"%","success")})}));const patchNotesBtn=document.getElementById("patchNotesBtn"),notesModal=document.getElementById("notesModal"),closeNotesModal=document.getElementById("closeNotesModal"),notesContent=document.getElementById("notesContent"),NOTES_SERVER="https://server-chemistryrenderer.vercel.app";let cachedNotes=null;patchNotesBtn&&notesModal&&(patchNotesBtn.addEventListener("click",async()=>{if(notesModal.classList.add("show"),cachedNotes)notesContent.textContent=cachedNotes;else{notesContent.textContent="Loading...";try{const t=await(await fetch(`${NOTES_SERVER}/api/note`)).json();t.success?(cachedNotes=t.note,notesContent.textContent=t.note):notesContent.textContent="Failed to load notes."}catch{notesContent.textContent="Could not connect to server."}}}),closeNotesModal.addEventListener("click",()=>{notesModal.classList.remove("show")}),notesModal.addEventListener("click",e=>{e.target===notesModal&&notesModal.classList.remove("show")}));
