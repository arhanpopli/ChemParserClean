/**
 * ChemistryRenderer for LLMs
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * Unauthorized copying, modification, or distribution of this software is prohibited.
 */
chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.type==="FETCH_API")return handleFetchRequest(e.url,e.options).then(s=>{t({success:!0,data:s})}).catch(s=>{t({success:!1,error:s.message})}),!0;if(e.type==="FETCH_BLOB")return handleBlobRequest(e.url).then(s=>{t({success:!0,data:s})}).catch(s=>{t({success:!1,error:s.message})}),!0;if(e.type==="FETCH_TEXT")return handleTextRequest(e.url,e.options).then(s=>{t({success:!0,data:s})}).catch(s=>{t({success:!1,error:s.message})}),!0});async function handleFetchRequest(e,r={}){try{const t={method:r.method||"GET",headers:{Accept:"application/json",...r.headers}};r.body&&r.method&&r.method.toUpperCase()!=="GET"&&(t.body=r.body);const s=await fetch(e,t);if(!s.ok){const c=await s.text();throw new Error(`HTTP ${s.status}: ${s.statusText}`)}return await s.json()}catch(t){throw t}}async function handleBlobRequest(e){try{const r=await fetch(e);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const t=await r.blob();return{base64:await blobToBase64(t),type:t.type}}catch(r){throw r}}async function handleTextRequest(e,r={}){try{let t;try{t=new URL(e)}catch{throw new Error(`Invalid URL: ${e}`)}const s={method:r.method||"GET",headers:{Accept:"text/plain, */*",...r.headers||{}},mode:"cors",credentials:"omit"};r.body&&s.method.toUpperCase()!=="GET"&&(s.body=r.body);const o=await fetch(e,s);if(!o.ok){const n=await o.text().catch(()=>"(could not read error body)");throw new Error(`HTTP ${o.status}: ${o.statusText} - ${n.substring(0,200)}`)}const c=await o.text();return c.includes("<?xml")||c.includes("<svg"),c}catch(t){throw t}}function blobToBase64(e){return new Promise((r,t)=>{const s=new FileReader;s.onloadend=()=>{const o=s.result.split(",")[1];r(o)},s.onerror=t,s.readAsDataURL(e)})}chrome.tabs.onUpdated.addListener((e,r,t)=>{r.status}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"inspect-molecule",title:"Render as Molecule: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"render-smiles",title:"Render as SMILES: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"render-biomolecule",title:"Render as Biomolecule: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"render-mineral",title:"Render as Mineral: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"rerender-parent",title:"ChemTex: Re-render as...",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-molecule",parentId:"rerender-parent",title:"Molecule (PubChem)",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-smiles",parentId:"rerender-parent",title:"SMILES (direct render)",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-biomolecule",parentId:"rerender-parent",title:"Biomolecule (RCSB PDB)",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-mineral",parentId:"rerender-parent",title:"Mineral (COD)",contexts:["image"]}),chrome.contextMenus.create({id:"separator-flags",parentId:"rerender-parent",type:"separator",contexts:["image"]}),chrome.contextMenus.create({id:"edit-flags",parentId:"rerender-parent",title:"Edit Flags...",contexts:["image"]})}),chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.type==="SETTINGS_CHANGED")return chrome.tabs.query({},s=>{s.forEach(o=>{o.url&&!o.url.startsWith("chrome://")&&!o.url.startsWith("edge://")&&chrome.tabs.sendMessage(o.id,{type:"APPLY_SETTINGS",settings:e.settings,changedSettings:e.changedKeys||[]}).catch(()=>{})})}),t({success:!0}),!0;if(e.type==="RELOAD_ALL_IMAGES")return chrome.tabs.query({},s=>{s.forEach(o=>{o.url&&!o.url.startsWith("chrome://")&&!o.url.startsWith("edge://")&&chrome.tabs.sendMessage(o.id,{type:"RELOAD_ALL_IMAGES"}).catch(()=>{})})}),t({success:!0}),!0;if(e.type==="CLEAR_CACHE")return chrome.tabs.query({},s=>{s.forEach(o=>{o.url&&!o.url.startsWith("chrome://")&&!o.url.startsWith("edge://")&&chrome.tabs.sendMessage(o.id,{type:"CLEAR_CACHE"}).catch(()=>{})})}),t({success:!0}),!0}),chrome.contextMenus.onClicked.addListener((e,r)=>{if(e.menuItemId==="inspect-molecule"){const t=e.selectionText;chrome.tabs.sendMessage(r.id,{type:"INSPECT_MOLECULE",text:t})}if(e.menuItemId==="render-smiles"){const t=e.selectionText;chrome.tabs.sendMessage(r.id,{type:"RENDER_SMILES",text:t})}if(e.menuItemId==="render-biomolecule"){const t=e.selectionText;chrome.tabs.sendMessage(r.id,{type:"RENDER_BIOMOLECULE",text:t})}if(e.menuItemId==="render-mineral"){const t=e.selectionText;chrome.tabs.sendMessage(r.id,{type:"RENDER_MINERAL",text:t})}e.menuItemId==="rerender-molecule"&&chrome.tabs.sendMessage(r.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"molecule"}),e.menuItemId==="rerender-smiles"&&chrome.tabs.sendMessage(r.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"smiles"}),e.menuItemId==="rerender-biomolecule"&&chrome.tabs.sendMessage(r.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"biomolecule"}),e.menuItemId==="rerender-mineral"&&chrome.tabs.sendMessage(r.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"mineral"}),e.menuItemId==="edit-flags"&&chrome.tabs.sendMessage(r.id,{type:"EDIT_FLAGS",srcUrl:e.srcUrl})});
