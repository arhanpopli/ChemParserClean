/**
 * ChemistryRenderer for LLMs
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * Unauthorized copying, modification, or distribution of this software is prohibited.
 */
const SIZE_STEP=20,MIN_SIZE=100,BASE_SIZE=300,DEFAULT_WIDTH=300,DEFAULT_HEIGHT=Math.round(240);function calculateDefaultSize(e){return{width:300,height:DEFAULT_HEIGHT}}function getImageKey(e){return e?e.smiles?`smiles:${e.smiles}`:e.nomenclature?`nomenclature:${e.nomenclature}`:null:null}function getPageImageKey(e,n){const i=getImageKey(e);return i?`page:${n}:${i}`:null}async function loadImageSize(e,n,i){try{const a=getImageKey(e),t=calculateDefaultSize(e);if(!a||!i.saveSizePerImage&&!i.saveSizeBySMILES)return t;let r;return i.saveSizePerImage&&!i.saveSizeBySMILES?r=getPageImageKey(e,n):r=a,r?new Promise(o=>{chrome.storage.local.get([r],s=>{s[r]?o(s[r]):o(t)})}):t}catch{return calculateDefaultSize(e)}}async function saveImageSize(e,n,i,a){try{const t=getImageKey(e);if(!t||!a.saveSizePerImage&&!a.saveSizeBySMILES)return;let r;if(a.saveSizePerImage&&!a.saveSizeBySMILES?r=getPageImageKey(e,n):r=t,!r)return;const o={};o[r]=i,chrome.storage.local.set(o,()=>{})}catch{}}function createSizeControls(e,n,i,a){const t=document.createElement("div");t.className="chem-size-controls",t.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
  `;const r=document.createElement("button");r.className="chem-size-btn chem-size-up",r.innerHTML="\u25B2",r.title="Increase size",r.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  `;const o=document.createElement("button");return o.className="chem-size-btn chem-size-down",o.innerHTML="\u25BC",o.title="Decrease size",o.style.cssText=r.style.cssText,[r,o].forEach(s=>{s.addEventListener("mouseenter",()=>{s.style.background="rgba(0, 0, 0, 0.9)"}),s.addEventListener("mouseleave",()=>{s.style.background="rgba(0, 0, 0, 0.7)"})}),r.addEventListener("click",s=>{s.stopPropagation(),adjustImageSize(e,n,i,20,a)}),o.addEventListener("click",s=>{s.stopPropagation(),adjustImageSize(e,n,i,-20,a)}),t.appendChild(r),t.appendChild(o),e.addEventListener("mouseenter",()=>{t.style.opacity="1"}),e.addEventListener("mouseleave",()=>{t.style.opacity="0"}),t}function adjustImageSize(e,n,i,a,t){const r=parseInt(n.style.width)||n.offsetWidth||300,o=parseInt(n.style.height)||n.offsetHeight||DEFAULT_HEIGHT;let s=r+a,c=o+Math.round(a*(o/r));s=Math.max(100,s),c=Math.max(100,c),n.style.width=`${s}px`,n.style.height=`${c}px`;const l=window.location.href;saveImageSize(i,l,{width:s,height:c},t)}async function wrapImageWithSizeControls(e,n,i,a){try{const t=document.createElement("div");t.className="chem-image-container",t.style.cssText=`
      position: relative;
      display: inline-block;
      margin: 0 12px 8px 0;
      vertical-align: middle;
    `;const r=window.location.href,o=await loadImageSize(i,r,a);e.style.width=`${o.width}px`,e.style.height=`${o.height}px`,i&&(e.dataset.moleculeData=JSON.stringify(i));const s=createSizeControls(t,e,i,a);return n.parentNode.insertBefore(t,n),t.appendChild(e),t.appendChild(s),n.remove(),t}catch{return n.parentNode.replaceChild(e,n),e}}
