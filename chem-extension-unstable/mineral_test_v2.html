<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mineral Rendering Test v2 - SDF/MOL vs SMILES</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { text-align: center; color: #00d4ff; }
        h2 { color: #ff6b6b; border-bottom: 2px solid #ff6b6b; padding-bottom: 10px; }
        h3 { color: #4ecdc4; margin-top: 30px; }
        .section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .render-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .render-card {
            background: #0f0f23;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #333;
        }
        .render-card h4 {
            color: #ffd93d;
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .render-card .source {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #888;
            background: #1a1a2e;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
        .render-card canvas, .render-card svg {
            background: white;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }
        .status {
            margin-top: 10px;
            font-size: 12px;
            padding: 5px;
            border-radius: 4px;
        }
        .status.success { background: #1b4332; color: #95d5b2; }
        .status.error { background: #3d0000; color: #ff6b6b; }
        .status.loading { background: #1a1a2e; color: #ffd93d; }
        .note {
            background: #2d2d44;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #00d4ff;
        }
        .log-output {
            background: #0a0a15;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #4ecdc4;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        #ketcher-frame {
            width: 100%;
            height: 400px;
            border: none;
            background: white;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üî¨ Mineral Rendering Test v2 - Debug Mode</h1>
    
    <div class="note">
        <strong>This test checks:</strong><br>
        1. Whether SmilesDrawer can parse ionic SMILES like <code>[Ca+2].C(=O)([O-])[O-]</code><br>
        2. What error SmilesDrawer returns when parsing fails<br>
        3. MOL/SDF file rendering (what MolView uses for 2D sketches)<br>
        4. Whether the formula fallback is being triggered
    </div>

    <!-- SMILES PARSING TEST -->
    <div class="section">
        <h2>üß™ Test 1: SmilesDrawer Ionic SMILES Parsing</h2>
        <p>Testing if SmilesDrawer can parse the exact SMILES from MolSearch API</p>
        
        <div class="render-grid">
            <div class="render-card">
                <h4>Calcite: [Ca+2].C(=O)([O-])[O-]</h4>
                <div class="source">[Ca+2].C(=O)([O-])[O-]</div>
                <canvas id="test-calcite" width="350" height="280"></canvas>
                <div class="status loading" id="status-calcite">Testing...</div>
                <div class="log-output" id="log-calcite"></div>
            </div>
            
            <div class="render-card">
                <h4>Quartz: O=[Si]=O</h4>
                <div class="source">O=[Si]=O</div>
                <canvas id="test-quartz" width="350" height="280"></canvas>
                <div class="status loading" id="status-quartz">Testing...</div>
                <div class="log-output" id="log-quartz"></div>
            </div>
        </div>
    </div>

    <!-- MOL FILE RENDERING -->
    <div class="section">
        <h2>üìÑ Test 2: MOL File Rendering (What MolView Uses)</h2>
        <p>MolView's 2D sketch uses MOL/SDF format, not SMILES. Let's test MOL rendering.</p>
        
        <div class="render-grid">
            <div class="render-card">
                <h4>Calcite from MOL data</h4>
                <div class="source" id="calcite-mol-source">Loading MOL data...</div>
                <canvas id="mol-calcite" width="350" height="280"></canvas>
                <div class="status loading" id="status-mol-calcite">Testing...</div>
                <div class="log-output" id="log-mol-calcite"></div>
            </div>
            
            <div class="render-card">
                <h4>Calcite from PubChem MOL</h4>
                <div class="source">PubChem CID 10112 SDF</div>
                <canvas id="pubchem-mol-calcite" width="350" height="280"></canvas>
                <div class="status loading" id="status-pubchem-mol">Loading from PubChem...</div>
                <div class="log-output" id="log-pubchem-mol"></div>
            </div>
        </div>
    </div>

    <!-- FORMULA VS SMILES -->
    <div class="section">
        <h2>‚ö†Ô∏è Test 3: Formula Fallback Detection</h2>
        <p>Testing what happens when SMILES fails - does it fall back to formula?</p>
        
        <div class="render-grid">
            <div class="render-card">
                <h4>Invalid SMILES (should fail)</h4>
                <div class="source">INVALID_SMILES_123</div>
                <canvas id="test-invalid" width="350" height="280"></canvas>
                <div class="status loading" id="status-invalid">Testing...</div>
                <div class="log-output" id="log-invalid"></div>
            </div>
            
            <div class="render-card">
                <h4>Empty SMILES</h4>
                <div class="source">(empty string)</div>
                <canvas id="test-empty" width="350" height="280"></canvas>
                <div class="status loading" id="status-empty">Testing...</div>
                <div class="log-output" id="log-empty"></div>
            </div>
        </div>
    </div>

    <!-- KETCHER (ALTERNATIVE RENDERER) -->
    <div class="section">
        <h2>üé® Alternative: Ketcher Editor (MOL-based)</h2>
        <p>Ketcher is another library that renders from MOL files. MolView might use something similar.</p>
        <div class="note">
            Ketcher requires a server setup. For now, here's an embedded demo with Calcite's structure.
        </div>
    </div>

    <!-- Load SmilesDrawer -->
    <script src="smiles-drawer.min.js"></script>
    <script>
        // Logging helper
        function log(elementId, message, type = 'info') {
            const logEl = document.getElementById(elementId);
            if (logEl) {
                const colors = { info: '#4ecdc4', error: '#ff6b6b', success: '#95d5b2', warn: '#ffd93d' };
                logEl.innerHTML += `<span style="color:${colors[type]}">[${type.toUpperCase()}] ${message}</span><br>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
            console.log(`[${type}] ${message}`);
        }

        // SmilesDrawer options
        const options = {
            width: 350,
            height: 280,
            bondThickness: 1.5,
            bondLength: 30,
            shortBondLength: 0.85,
            bondSpacing: 4,
            atomVisualization: 'default',
            isomeric: true,
            debug: false,
            terminalCarbons: true,
            explicitHydrogens: false,
            overlapSensitivity: 0.42,
            overlapResolutionIterations: 1,
            compactDrawing: false,
            fontSizeLarge: 12,
            fontSizeSmall: 7,
            padding: 25,
            themes: {
                light: {
                    C: '#222',
                    O: '#e74c3c',
                    N: '#3498db',
                    S: '#f1c40f',
                    Ca: '#1abc9c',
                    Si: '#95a5a6',
                    BACKGROUND: '#ffffff'
                }
            }
        };

        const drawer = new SmilesDrawer.Drawer(options);

        // Test SMILES parsing with detailed logging
        function testSmilesParsing(smiles, canvasId, logId, statusId) {
            log(logId, `Testing SMILES: "${smiles}"`);
            log(logId, `SMILES length: ${smiles.length}`);
            log(logId, `Contains dot (fragment separator): ${smiles.includes('.')}`);
            log(logId, `Contains charges: ${smiles.includes('+') || smiles.includes('-')}`);
            
            const statusEl = document.getElementById(statusId);
            
            try {
                log(logId, 'Calling SmilesDrawer.parse()...');
                
                SmilesDrawer.parse(smiles, function(tree) {
                    log(logId, '‚úì Parse SUCCESS!', 'success');
                    log(logId, `Tree has ${tree.graph.vertices.length} vertices`, 'success');
                    log(logId, `Tree has ${tree.graph.edges.length} edges`, 'success');
                    
                    // Log atom types
                    const atoms = tree.graph.vertices.map(v => v.value.element).filter(e => e);
                    log(logId, `Atoms: ${atoms.join(', ')}`, 'success');
                    
                    // Check for fragments (disconnected components)
                    const ringCount = tree.rings ? tree.rings.length : 0;
                    log(logId, `Rings: ${ringCount}`, 'info');
                    
                    try {
                        drawer.draw(tree, canvasId, 'light', false);
                        log(logId, '‚úì Draw SUCCESS!', 'success');
                        statusEl.className = 'status success';
                        statusEl.textContent = '‚úì Rendered successfully';
                    } catch (drawErr) {
                        log(logId, `‚úó Draw FAILED: ${drawErr.message}`, 'error');
                        statusEl.className = 'status error';
                        statusEl.textContent = '‚úó Draw failed: ' + drawErr.message;
                    }
                }, function(err) {
                    log(logId, `‚úó Parse FAILED: ${err}`, 'error');
                    log(logId, 'This explains why formula fallback happens!', 'warn');
                    statusEl.className = 'status error';
                    statusEl.textContent = '‚úó Parse error: ' + err;
                });
            } catch (e) {
                log(logId, `‚úó Exception: ${e.message}`, 'error');
                statusEl.className = 'status error';
                statusEl.textContent = '‚úó Exception: ' + e.message;
            }
        }

        // MOL file for Calcite (manually created based on structure)
        const calciteMolFile = `Calcite
  Created for testing
  
  4  3  0  0  0  0  0  0  0  0999 V2000
    0.0000    0.0000    0.0000 Ca  0  2  0  0  0  0  0  0  0  0  0  0
    2.0000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0
    3.0000    1.0000    0.0000 O   0  0  0  0  0  0  0  0  0  0  0  0
    3.0000   -1.0000    0.0000 O   0  5  0  0  0  0  0  0  0  0  0  0
    1.0000    0.0000    0.0000 O   0  5  0  0  0  0  0  0  0  0  0  0
  1  5  1  0  0  0  0
  2  3  2  0  0  0  0
  2  4  1  0  0  0  0
  2  5  1  0  0  0  0
M  CHG  3   1   2   4  -1   5  -1
M  END`;

        // Test MOL file parsing
        function testMolParsing() {
            const logId = 'log-mol-calcite';
            const statusId = 'status-mol-calcite';
            const canvasId = 'mol-calcite';
            
            document.getElementById('calcite-mol-source').textContent = calciteMolFile.substring(0, 200) + '...';
            
            log(logId, 'Testing MOL file parsing...');
            log(logId, `MOL file length: ${calciteMolFile.length} chars`);
            
            // Check if SmilesDrawer supports MOL files
            if (typeof SmilesDrawer.parseMol === 'function') {
                log(logId, 'SmilesDrawer.parseMol() exists!', 'success');
                try {
                    SmilesDrawer.parseMol(calciteMolFile, function(tree) {
                        log(logId, '‚úì MOL Parse SUCCESS!', 'success');
                        drawer.draw(tree, canvasId, 'light', false);
                        document.getElementById(statusId).className = 'status success';
                        document.getElementById(statusId).textContent = '‚úì MOL rendered!';
                    }, function(err) {
                        log(logId, `‚úó MOL Parse failed: ${err}`, 'error');
                        document.getElementById(statusId).className = 'status error';
                        document.getElementById(statusId).textContent = '‚úó MOL parse error';
                    });
                } catch (e) {
                    log(logId, `‚úó Exception: ${e.message}`, 'error');
                }
            } else {
                log(logId, 'SmilesDrawer.parseMol() NOT found', 'warn');
                log(logId, 'SmilesDrawer only supports SMILES, not MOL files', 'warn');
                log(logId, 'Available methods: ' + Object.keys(SmilesDrawer).join(', '), 'info');
                document.getElementById(statusId).className = 'status error';
                document.getElementById(statusId).textContent = 'SmilesDrawer does not support MOL files';
            }
        }

        // Fetch MOL from PubChem
        async function fetchPubChemMol() {
            const logId = 'log-pubchem-mol';
            const statusId = 'status-pubchem-mol';
            
            log(logId, 'Fetching SDF from PubChem CID 10112...');
            
            try {
                const response = await fetch('https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/10112/SDF');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const sdfContent = await response.text();
                log(logId, `‚úì Fetched ${sdfContent.length} bytes`, 'success');
                log(logId, 'First 200 chars: ' + sdfContent.substring(0, 200).replace(/\n/g, '\\n'), 'info');
                
                // Check for SmilesDrawer MOL support
                if (typeof SmilesDrawer.parseMol === 'function') {
                    SmilesDrawer.parseMol(sdfContent, function(tree) {
                        drawer.draw(tree, 'pubchem-mol-calcite', 'light', false);
                        document.getElementById(statusId).className = 'status success';
                        document.getElementById(statusId).textContent = '‚úì PubChem SDF rendered!';
                    }, function(err) {
                        log(logId, `Parse error: ${err}`, 'error');
                    });
                } else {
                    log(logId, 'Cannot render - SmilesDrawer has no MOL support', 'error');
                    document.getElementById(statusId).className = 'status error';
                    document.getElementById(statusId).textContent = 'No MOL support in SmilesDrawer';
                }
            } catch (e) {
                log(logId, `Fetch error: ${e.message}`, 'error');
                document.getElementById(statusId).className = 'status error';
                document.getElementById(statusId).textContent = 'Fetch failed: ' + e.message;
            }
        }

        // Run all tests
        function runTests() {
            console.log('=== MINERAL RENDERING DEBUG TEST ===');
            console.log('SmilesDrawer version:', SmilesDrawer.VERSION || 'unknown');
            console.log('Available SmilesDrawer methods:', Object.keys(SmilesDrawer));
            
            // Test 1: SMILES parsing
            testSmilesParsing('[Ca+2].C(=O)([O-])[O-]', 'test-calcite', 'log-calcite', 'status-calcite');
            testSmilesParsing('O=[Si]=O', 'test-quartz', 'log-quartz', 'status-quartz');
            
            // Test 2: MOL parsing
            testMolParsing();
            fetchPubChemMol();
            
            // Test 3: Invalid inputs
            testSmilesParsing('INVALID_SMILES_123', 'test-invalid', 'log-invalid', 'status-invalid');
            testSmilesParsing('', 'test-empty', 'log-empty', 'status-empty');
        }

        // Wait for load
        if (typeof SmilesDrawer !== 'undefined') {
            runTests();
        } else {
            document.body.innerHTML = '<h1 style="color:red">SmilesDrawer not loaded!</h1>';
        }
    </script>
</body>
</html>
