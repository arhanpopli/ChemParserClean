<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>ChemTex</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 360px;
      min-height: 600px;
      max-height: 650px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      color: #1a1a1a;
      background: #fafafa;
      overflow: hidden;
      position: relative;
    }

    /* Container for floating SVG molecules */
    #moleculeContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 360px;
      height: 650px;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .floating-molecule {
      position: absolute;
      pointer-events: none;
    }

    .container {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      min-height: 600px;
      max-height: 650px;
      overflow: hidden;
    }

    .header {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: #1a1a1a;
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .header p {
      font-size: 12px;
      color: #666;
      font-weight: 400;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .content::-webkit-scrollbar {
      width: 6px;
    }

    .content::-webkit-scrollbar-track {
      background: transparent;
    }

    .content::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 3px;
    }

    .content::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.25);
    }

    /* Glassmorphic sections - more transparent */
    .section {
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    }

    .section-title {
      font-size: 11px;
      font-weight: 700;
      color: #1a1a1a;
      text-transform: uppercase;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      letter-spacing: 0.8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .section-title:hover {
      color: #333;
    }

    .section-title .chevron {
      width: 16px;
      height: 16px;
      transition: transform 0.25s ease;
      opacity: 0.6;
    }

    .section-title:hover .chevron {
      opacity: 1;
    }

    .section.collapsed .section-title {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .section.collapsed .section-title .chevron {
      transform: rotate(-90deg);
    }

    .section-content {
      transition: max-height 0.25s ease, opacity 0.2s ease;
      overflow: hidden;
    }

    .section.collapsed .section-content {
      max-height: 0 !important;
      opacity: 0;
      padding-top: 0;
    }

    .option {
      padding: 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      gap: 10px;
    }

    .option:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .option:first-of-type {
      padding-top: 0;
    }

    .option-label {
      flex: 1;
      cursor: pointer;
      min-width: 0;
    }

    .option strong {
      display: block;
      font-weight: 600;
      color: #1a1a1a;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .option small {
      display: block;
      color: #555;
      font-size: 11px;
      line-height: 1.3;
    }

    input[type="checkbox"],
    input[type="radio"] {
      display: none;
    }

    /* Fixed toggle switch */
    .toggle {
      width: 40px;
      height: 22px;
      min-width: 40px;
      max-width: 40px;
      background: #ccc;
      border-radius: 11px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s ease;
      flex-shrink: 0;
      flex-grow: 0;
      display: block;
    }

    .toggle::before {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    input:checked+.toggle {
      background: #1a1a1a;
    }

    input:checked+.toggle::before {
      transform: translateX(18px);
    }

    /* Radio group */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .radio-option {
      padding: 10px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .radio-option:hover {
      background: rgba(255, 255, 255, 0.6);
    }

    input[type="radio"]:checked+.radio-option {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.15);
    }

    .radio-indicator {
      width: 16px;
      height: 16px;
      min-width: 16px;
      border-radius: 50%;
      border: 2px solid #999;
      position: relative;
      flex-shrink: 0;
      transition: border-color 0.2s;
    }

    input[type="radio"]:checked+.radio-option .radio-indicator {
      border-color: #1a1a1a;
    }

    input[type="radio"]:checked+.radio-option .radio-indicator::after {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      background: #1a1a1a;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .radio-option strong {
      font-size: 13px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .radio-option small {
      display: block;
      margin-top: 2px;
      color: #555;
      font-size: 11px;
    }

    /* Info box */
    .info-box {
      background: rgba(0, 0, 0, 0.03);
      padding: 8px 10px;
      margin-top: 10px;
      border-radius: 8px;
      font-size: 11px;
      color: #444;
      line-height: 1.4;
      border-left: 3px solid #1a1a1a;
    }

    .info-box strong {
      color: #1a1a1a;
    }

    /* Footer */
    .footer {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: #666;
      padding: 10px 12px;
      text-align: center;
      font-size: 10px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .footer a {
      color: #1a1a1a;
      text-decoration: none;
      font-weight: 600;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Status message */
    .status {
      display: none;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 11px;
      margin: 10px 0;
      font-weight: 500;
      animation: slideIn 0.2s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status.show {
      display: block;
      background: rgba(0, 0, 0, 0.04);
      color: #1a1a1a;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    /* Select dropdown */
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      font-size: 12px;
      margin-top: 6px;
      background: rgba(255, 255, 255, 0.5);
      color: #1a1a1a;
      font-family: inherit;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    select:focus {
      outline: none;
      border-color: #1a1a1a;
    }

    /* Slider styles */
    .slider-option {
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    }

    .slider-option:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .slider-header label strong {
      font-size: 12px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .slider-header span {
      font-size: 11px;
      color: #555;
      font-weight: 500;
      min-width: 30px;
      text-align: right;
    }

    .slider {
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1a1a1a;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: transform 0.1s;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .slider::-webkit-slider-thumb:active {
      transform: scale(0.95);
    }

    .slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1a1a1a;
      cursor: pointer;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>
  <!-- Container for floating SVG molecules -->
  <div id="moleculeContainer"></div>

  <div class="container">
    <div class="header">
      <h1>ChemTex</h1>
      <p>Chemical Structure Renderer</p>
    </div>

    <div class="content">
      <!-- Main Controls -->
      <div class="section">
        <div class="section-title">
          <span>Main Controls</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="enabledToggle">
              <strong>Extension Status</strong>
              <small>Enable/disable formula rendering</small>
            </label>
            <input type="checkbox" id="enabledToggle" checked>
            <label class="toggle" for="enabledToggle"></label>
          </div>


        </div>
      </div>

      <!-- Renderer Selection -->
      <div class="section">
        <div class="section-title">
          <span>Rendering Engine</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="radio-group">
            <input type="radio" name="renderingEngine" value="client-side" id="engine1" checked>
            <label for="engine1" class="radio-option">
              <div class="radio-indicator"></div>
              <div>
                <strong>SmilesDrawer (Recommended)</strong>
                <small>Fast client-side rendering, no server needed!</small>
              </div>
            </label>

            <input type="radio" name="renderingEngine" value="cdk-depict" id="engine2">
            <label for="engine2" class="radio-option">
              <div class="radio-indicator"></div>
              <div>
                <strong>CDK Depict</strong>
                <small>External API with advanced options (requires internet)</small>
              </div>
            </label>
          </div>


        </div>
      </div>

      <!-- SmilesDrawer Rendering Options -->
      <div id="smilesDrawerOptions" class="section">
        <div class="section-title">
          <span>Rendering Options</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="sdShowCarbonsToggle">
              <strong>Show Carbon Atoms</strong>
              <small>Display C labels (+c flag)</small>
            </label>
            <input type="checkbox" id="sdShowCarbonsToggle">
            <label class="toggle" for="sdShowCarbonsToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="sdAromaticRingsToggle">
              <strong>Aromatic Ring Circles</strong>
              <small>Draw circles inside aromatic rings (+o flag)</small>
            </label>
            <input type="checkbox" id="sdAromaticRingsToggle" checked>
            <label class="toggle" for="sdAromaticRingsToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="sdShowMethylsToggle">
              <strong>Show Methyl Groups</strong>
              <small>Display terminal CH‚ÇÉ labels (+m flag)</small>
            </label>
            <input type="checkbox" id="sdShowMethylsToggle">
            <label class="toggle" for="sdShowMethylsToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="sdAtomNumbersToggle">
              <strong>Atom Numbers</strong>
              <small>Number all atoms (+n flag)</small>
            </label>
            <input type="checkbox" id="sdAtomNumbersToggle">
            <label class="toggle" for="sdAtomNumbersToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="sdShowHydrogensToggle">
              <strong>Show Hydrogens</strong>
              <small>Explicitly display H atoms (+h flag)</small>
            </label>
            <input type="checkbox" id="sdShowHydrogensToggle">
            <label class="toggle" for="sdShowHydrogensToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="sdFlipHorizontalToggle">
              <strong>Flip Horizontal</strong>
              <small>Mirror image (+p flag)</small>
            </label>
            <input type="checkbox" id="sdFlipHorizontalToggle">
            <label class="toggle" for="sdFlipHorizontalToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="sdFlipVerticalToggle">
              <strong>Flip Vertical</strong>
              <small>Upside down (+q flag)</small>
            </label>
            <input type="checkbox" id="sdFlipVerticalToggle">
            <label class="toggle" for="sdFlipVerticalToggle"></label>
          </div>

          <div class="option">
            <label class="option-label">
              <strong>Theme</strong>
              <small>Color scheme for molecules</small>
            </label>
          </div>
          <select id="sdThemeSelect">
            <option value="light">Light (dark bonds on light bg)</option>
            <option value="dark">Dark (light bonds on dark bg)</option>
            <option value="oldschool">Oldschool (all black)</option>
            <option value="solarized">Solarized</option>
            <option value="matrix">Matrix (green)</option>
            <option value="github">GitHub</option>
            <option value="carbon">Carbon</option>
          </select>

          <div class="slider-option">
            <div class="slider-header">
              <label><strong>Rotation</strong></label>
              <span id="sdRotateValue">0¬∞</span>
            </div>
            <input type="range" id="sdRotateSlider" min="0" max="360" step="15" value="0" class="slider">
          </div>

          <div class="slider-option">
            <div class="slider-header">
              <label><strong>Bond Thickness</strong></label>
              <span id="sdBondThicknessValue">1.0</span>
            </div>
            <input type="range" id="sdBondThicknessSlider" min="0.5" max="4" step="0.5" value="1.0" class="slider">
          </div>

          <div class="option">
            <label class="option-label" for="sdGradientColorsToggle">
              <strong>Gradient Bond Colors</strong>
              <small>Smooth color transitions at heteroatoms (vs sharp cutoff)</small>
            </label>
            <input type="checkbox" id="sdGradientColorsToggle">
            <label class="toggle" for="sdGradientColorsToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="sdScaleByWeightToggle">
              <strong>Scale by Molecular Weight</strong>
              <small>Larger molecules render bigger automatically</small>
            </label>
            <input type="checkbox" id="sdScaleByWeightToggle">
            <label class="toggle" for="sdScaleByWeightToggle"></label>
          </div>

          <!-- Flag Reference -->
          <div class="flag-reference"
            style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.08);">
            <details>
              <summary style="cursor: pointer; font-weight: 600; font-size: 12px; color: #555; user-select: none;">
                üìù Per-Molecule Flag Reference
              </summary>
              <div
                style="margin-top: 8px; font-size: 11px; line-height: 1.5; color: #666; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 6px;">
                <p style="margin-bottom: 6px; font-weight: 600; color: #333;">Format: <code>chem:molecule/flags:</code>
                </p>
                <code
                  style="display: block; font-family: monospace; background: rgba(0,0,0,0.05); padding: 4px 6px; border-radius: 4px; margin-bottom: 8px;">
                chem:benzene/d+c+h+o+r45+p+q:
              </code>

                <p style="margin: 8px 0 4px; font-weight: 600; color: #27ae60;">Enable options with +flag:</p>
                <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                  <tr>
                    <td style="padding: 2px 4px;"><code>+c</code></td>
                    <td>Show carbon atoms</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+h</code></td>
                    <td>Show hydrogen atoms</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+o</code></td>
                    <td>Aromatic ring circles</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+m</code></td>
                    <td>Show methyl groups (CH‚ÇÉ)</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+n</code></td>
                    <td>Atom numbering</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+p</code></td>
                    <td>Flip horizontal</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+q</code></td>
                    <td>Flip vertical</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+r45</code></td>
                    <td>Rotate 45¬∞</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+s150</code></td>
                    <td>Size 150%</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>+3d</code></td>
                    <td>Show 3D viewer</td>
                  </tr>
                </table>

                <p style="margin: 8px 0 4px; font-weight: 600; color: #e74c3c;">Disable defaults with -flag:</p>
                <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                  <tr>
                    <td style="padding: 2px 4px;"><code>d</code></td>
                    <td>Use popup defaults first</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>d-c</code></td>
                    <td>Defaults but hide carbons</td>
                  </tr>
                  <tr>
                    <td style="padding: 2px 4px;"><code>d-o</code></td>
                    <td>Defaults but no aromatic circles</td>
                  </tr>
                </table>

                <p style="margin-top: 8px; font-size: 10px; color: #666;">
                  üí° ChatGPT can use these flags: <code>chem:histamine/d+c+h+r90:</code>
                </p>
              </div>
            </details>
          </div>
        </div>
      </div>

      <!-- CDK Depict Options -->
      <div id="cdkDepictOptions" class="section" style="display: none;">
        <div class="section-title">
          <span>CDK Depict Options</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="info-box"
            style="background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4CAF50; margin-bottom: 12px;">
            <strong>üåê Free Online Service</strong><br>
            <small>No server hosting required! Uses Chemistry Development Kit (CDK) API.</small>
          </div>

          <!-- Show Carbon Atoms -->
          <div class="option">
            <label class="option-label" for="cdkShowCarbonsToggle">
              <strong>Show Carbon Atoms</strong>
              <small>Display C labels on all carbons</small>
            </label>
            <input type="checkbox" id="cdkShowCarbonsToggle">
            <label class="toggle" for="cdkShowCarbonsToggle"></label>
          </div>

          <!-- Show Methyl Groups (same as Show Carbons but more specific) -->
          <div class="option">
            <label class="option-label" for="cdkShowMethylsToggle">
              <strong>Show Methyl Groups (CH‚ÇÉ)</strong>
              <small>Display terminal carbon labels (methyls)</small>
            </label>
            <input type="checkbox" id="cdkShowMethylsToggle">
            <label class="toggle" for="cdkShowMethylsToggle"></label>
          </div>

          <!-- Hydrogen Display -->
          <div class="option">
            <label class="option-label">
              <strong>Hydrogen Display</strong>
              <small>Control how hydrogens are shown</small>
            </label>
          </div>
          <select id="cdkHydrogenDisplaySelect">
            <option value="minimal" selected>Minimal Hydrogens (default)</option>
            <option value="smart">Smart Hydrogens</option>
            <option value="chiral">Chiral Hydrogens Only</option>
            <option value="explicit">Explicit Hydrogens (show ALL H)</option>
          </select>

          <!-- Atom Numbers -->
          <div class="option">
            <label class="option-label" for="cdkAtomNumbersToggle">
              <strong>Atom Numbers</strong>
              <small>Number all atoms (like mol2chemfig -n)</small>
            </label>
            <input type="checkbox" id="cdkAtomNumbersToggle">
            <label class="toggle" for="cdkAtomNumbersToggle"></label>
          </div>

          <!-- Color Scheme -->
          <div class="option">
            <label class="option-label">
              <strong>Color Scheme</strong>
              <small>Background and atom colors</small>
            </label>
          </div>
          <select id="cdkColorSchemeSelect">
            <option value="coc" selected>Clear/Transparent (recommended)</option>
            <option value="cow">Color on White</option>
            <option value="cob">Color on Black</option>
            <option value="bow">Black on White</option>
            <option value="wob">White on Black</option>
            <option value="nob">Neon on Black</option>
          </select>

          <!-- Zoom Level -->
          <div class="option">
            <label class="option-label">
              <strong>Zoom Level</strong>
              <small>Scale the structure (1.0 - 3.0)</small>
            </label>
          </div>
          <input type="range" id="cdkZoomSlider" min="1.0" max="3.0" step="0.1" value="1.5"
            style="width: 100%; margin-top: 8px;">
          <div style="text-align: center; font-size: 12px; color: #666; margin-top: 4px;">
            <span id="cdkZoomValue">1.5x</span>
          </div>

          <!-- Advanced Annotations -->
          <div class="option" style="margin-top: 12px;">
            <label class="option-label">
              <strong>Advanced Annotations</strong>
              <small>Additional labels (optional)</small>
            </label>
          </div>
          <select id="cdkAnnotationSelect">
            <option value="none" selected>None</option>
            <option value="colmap">Color Map</option>
            <option value="cip">CIP Stereo Labels</option>
            <option value="atomvalue">Atom Values</option>
            <option value="atommapping">Atom Mapping</option>
            <option value="bondnumber">Bond Numbers</option>
          </select>
        </div>
      </div>

      <!-- 3D Viewer Settings -->
      <div id="viewer3DSettings" class="section" style="display: none;">
        <div class="section-title">
          <span>3D Viewer Settings</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="enable3DViewerToggle">
              <strong>Enable 3D Viewer</strong>
              <small>Show interactive 3D models inline</small>
            </label>
            <input type="checkbox" id="enable3DViewerToggle">
            <label class="toggle" for="enable3DViewerToggle"></label>
          </div>

          <div class="option">
            <label class="option-label">
              <strong>3D Viewer Source</strong>
              <small>Choose where to load 3D models from</small>
            </label>
          </div>
          <select id="viewer3DSourceSelect">
            <option value="3dmol" selected>3Dmol.js - Client-side, customizable (recommended)</option>
            <option value="molview">MolView (Local) - Advanced features</option>
            <option value="pubchem">PubChem Official - Fallback option</option>
          </select>

          <!-- MolView Specific Options -->
          <div id="molviewOptions"
            style="display: none; margin-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px;">
            <div class="option">
              <label class="option-label"><strong>Representation</strong></label>
            </div>
            <select id="molviewRepresentationSelect">
              <option value="ballAndStick">Ball and Stick</option>
              <option value="stick">Stick</option>
              <option value="vdwSpheres">van der Waals Spheres</option>
              <option value="wireframe">Wireframe</option>
              <option value="line">Line</option>
            </select>

            <div class="option">
              <label class="option-label"><strong>Engine</strong></label>
            </div>
            <select id="molviewEngineSelect">
              <option value="glmol">GLmol</option>
              <option value="jmol">Jmol</option>
              <option value="chemdoodle">ChemDoodle</option>
            </select>

            <div class="option">
              <label class="option-label"><strong>Crystallography</strong></label>
            </div>
            <select id="molviewCrystallographySelect">
              <option value="none">None</option>
              <option value="unitcell">Load unit cell</option>
              <option value="supercell_2x2x2">Load 2x2x2 supercell</option>
              <option value="supercell_1x3x3">Load 1x3x3 supercell</option>
            </select>
          </div>

          <div class="option">
            <label class="option-label">
              <strong>3D Visualization Style</strong>
              <small>For 3Dmol.js only</small>
            </label>
          </div>
          <select id="viewer3DStyleSelect">
            <option value="stick">Stick - Lines only (thin)</option>
            <option value="line">Line - Very thin wireframe</option>
            <option value="cross">Cross - Simple cross marks</option>
            <option value="sphere">Sphere - Space-filling (CPK)</option>
            <option value="stick:sphere" selected>Ball and Stick - Sticks with atom spheres</option>
            <option value="cartoon">Cartoon - For proteins (not for small molecules)</option>
          </select>

          <div class="option">
            <label class="option-label">
              <strong>Stick Thickness</strong>
              <small>Only applies to: stick, ball-and-stick modes</small>
            </label>
          </div>
          <select id="viewer3DStickRadiusSelect">
            <option value="0.1">Thin (0.1)</option>
            <option value="0.15" selected>Normal (0.15)</option>
            <option value="0.2">Medium (0.2)</option>
            <option value="0.25">Thick (0.25)</option>
            <option value="0.3">Very Thick (0.3)</option>
          </select>

          <div class="option">
            <label class="option-label">
              <strong>Atom Sphere Size</strong>
              <small>Only applies to: sphere, ball-and-stick modes</small>
            </label>
          </div>
          <select id="viewer3DSphereRadiusSelect">
            <option value="0.2">Small (0.2)</option>
            <option value="0.3" selected>Normal (0.3)</option>
            <option value="0.4">Medium (0.4)</option>
            <option value="0.5">Large (0.5)</option>
            <option value="0.7">Very Large (0.7)</option>
            <option value="0.9">XXL (0.9)</option>
            <option value="1.2">XXXL (1.2)</option>
          </select>

          <div class="option">
            <label class="option-label" for="viewer3DAutoRotateToggle">
              <strong>Auto-Rotate 3D Models</strong>
              <small>Automatically spin molecules</small>
            </label>
            <input type="checkbox" id="viewer3DAutoRotateToggle" checked>
            <label class="toggle" for="viewer3DAutoRotateToggle"></label>
          </div>

          <div class="option">
            <label class="option-label">
              <strong>3D Viewer Size</strong>
              <small>Dimensions of embedded 3D viewer</small>
            </label>
          </div>
          <select id="viewer3DSizeSelect">
            <option value="small">Small (200x150)</option>
            <option value="medium">Medium (300x250)</option>
            <option value="normal" selected>Normal (400x350)</option>
            <option value="large">Large (600x450)</option>
            <option value="xlarge">Extra Large (800x600)</option>
          </select>

          <div class="option">
            <label class="option-label">
              <strong>3D Background Color</strong>
              <small>Background color for 3D viewer</small>
            </label>
          </div>
          <select id="viewer3DBgColorSelect">
            <option value="#1a1a2e" selected>Dark Blue (default)</option>
            <option value="#000000">Black</option>
            <option value="#FFFFFF">White</option>
            <option value="#808080">Gray</option>
            <option value="#2c3e50">Slate Gray</option>
            <option value="#34495e">Dark Gray</option>
            <option value="transparent">Transparent</option>
          </select>
        </div>
      </div>

      <!-- MolView Protein Options -->
      <div id="molviewProteinOptions" class="section">
        <div class="section-title">
          <span>MolView Protein Options</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="proteinRemoveWhiteBgToggle">
              <strong>Remove White Background</strong>
              <small>Remove white (#FFFFFF) background from RCSB protein images</small>
            </label>
            <input type="checkbox" id="proteinRemoveWhiteBgToggle">
            <label class="toggle" for="proteinRemoveWhiteBgToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="molviewBioAssemblyToggle">
              <strong>Show Biological Assembly</strong>
              <small>Display bio assembly instead of asymmetric unit</small>
            </label>
            <input type="checkbox" id="molviewBioAssemblyToggle">
            <label class="toggle" for="molviewBioAssemblyToggle"></label>
          </div>

          <div class="option">
            <label class="option-label">
              <strong>Chain Representation</strong>
              <small>How protein backbone is rendered</small>
            </label>
          </div>
          <select id="molviewChainTypeSelect">
            <option value="ribbon" selected>Ribbon</option>
            <option value="cylinders">Cylinder and Plate</option>
            <option value="btube">B-factor Tube</option>
            <option value="ctrace">C-alpha Trace</option>
            <option value="bonds">Bonds</option>
          </select>

          <div class="option">
            <label class="option-label" for="molviewChainBondsToggle">
              <strong>Show Chain Bonds</strong>
              <small>Display bonds in chain representation</small>
            </label>
            <input type="checkbox" id="molviewChainBondsToggle">
            <label class="toggle" for="molviewChainBondsToggle"></label>
          </div>

          <div class="option">
            <label class="option-label">
              <strong>Chain Color Scheme</strong>
              <small>How to color the protein chain</small>
            </label>
          </div>
          <select id="molviewChainColorSelect">
            <option value="ss" selected>Secondary Structure</option>
            <option value="spectrum">Spectrum (rainbow)</option>
            <option value="chain">By Chain</option>
            <option value="residue">By Residue</option>
            <option value="polarity">By Polarity</option>
            <option value="bfactor">B-factor (temperature)</option>
          </select>

          <div class="option">
            <label class="option-label">
              <strong>Background Color (MolView)</strong>
              <small>Background for MolView 3D viewer (proteins only)</small>
            </label>
          </div>
          <select id="proteinMolviewBgColorSelect">
            <option value="black" selected>Black</option>
            <option value="gray">Gray</option>
            <option value="white">White</option>
          </select>
        </div>
      </div>

      <!-- Mineral Options -->
      <div id="mineralOptions" class="section">
        <div class="section-title">
          <span>Mineral Options</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label">
              <strong>Representation</strong>
              <small>How to display mineral structure</small>
            </label>
          </div>
          <select id="mineralRepresentationSelect">
            <option value="ballAndStick" selected>Ball and Stick</option>
            <option value="stick">Stick</option>
            <option value="vdwSpheres">van der Waals Spheres</option>
            <option value="wireframe">Wireframe</option>
            <option value="line">Line</option>
          </select>

          <div class="option">
            <label class="option-label">
              <strong>Background Color (MolView)</strong>
              <small>Background for MolView 3D viewer (minerals only)</small>
            </label>
          </div>
          <select id="mineralMolviewBgColorSelect">
            <option value="black" selected>Black</option>
            <option value="gray">Gray</option>
            <option value="white">White</option>
          </select>

          <div class="option">
            <label class="option-label">
              <strong>Crystallography</strong>
              <small>Unit cell or supercell display</small>
            </label>
          </div>
          <select id="mineralCrystallographySelect">
            <option value="none">None</option>
            <option value="unitcell">Load unit cell</option>
            <option value="supercell_2x2x2" selected>Load 2√ó2√ó2 supercell</option>
            <option value="supercell_1x3x3">Load 1√ó3√ó3 supercell</option>
          </select>
        </div>
      </div>

      <!-- Image Size Controls -->
      <div class="section">
        <div class="section-title">
          <span>Image Size Controls</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="saveSizePerImageToggle">
              <strong>Save Size Per Page</strong>
              <small>Remember size for each page separately</small>
            </label>
            <input type="checkbox" id="saveSizePerImageToggle">
            <label class="toggle" for="saveSizePerImageToggle"></label>
          </div>

          <div class="option">
            <label class="option-label" for="saveSizeBySMILESToggle">
              <strong>Save Size By SMILES</strong>
              <small>Use same size for identical molecules</small>
            </label>
            <input type="checkbox" id="saveSizeBySMILESToggle">
            <label class="toggle" for="saveSizeBySMILESToggle"></label>
          </div>
        </div>
      </div>

      <!-- Performance -->
      <div class="section">
        <div class="section-title">
          <span>Performance</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="perfModeToggle">
              <strong>Lazy-Loading Mode</strong>
              <small>Only render visible formulas</small>
            </label>
            <input type="checkbox" id="perfModeToggle" checked>
            <label class="toggle" for="perfModeToggle"></label>
          </div>
        </div>
      </div>

      <!-- AI Molecular Control -->
      <div class="section">
        <div class="section-title">
          <span>AI Molecular Control</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="aiMolecularControlToggle">
              <strong>Enable AI Flag Control</strong>
              <small>Use flags in chem:...:/d to override settings</small>
            </label>
            <input type="checkbox" id="aiMolecularControlToggle">
            <label class="toggle" for="aiMolecularControlToggle"></label>
          </div>
        </div>
      </div>

      <!-- Developer Mode -->
      <div class="section">
        <div class="section-title">
          <span>Developer Mode</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="option">
            <label class="option-label" for="devModeToggle">
              <strong>Show Raw Text</strong>
              <small>Display chemfig text instead of images</small>
            </label>
            <input type="checkbox" id="devModeToggle">
            <label class="toggle" for="devModeToggle"></label>
          </div>
        </div>
      </div>

      <!-- UI Settings -->
      <div class="section">
        <div class="section-title">
          <span>UI Settings</span>
          <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 12,15 18,9"></polyline>
          </svg>
        </div>
        <div class="section-content">
          <div class="slider-option">
            <div class="slider-header">
              <label><strong>Molecule Count</strong></label>
              <span id="molCountValue">20</span>
            </div>
            <input type="range" id="molCountSlider" min="0" max="50" value="20" class="slider">
          </div>

          <div class="slider-option">
            <div class="slider-header">
              <label><strong>Molecule Size</strong></label>
              <span id="molScaleValue">0.6</span>
            </div>
            <input type="range" id="molScaleSlider" min="0.1" max="1.5" step="0.1" value="0.6" class="slider">
          </div>

          <div class="slider-option">
            <div class="slider-header">
              <label><strong>Background Blur</strong></label>
              <span id="blurValue">10px</span>
            </div>
            <input type="range" id="blurSlider" min="0" max="20" value="10" class="slider">
          </div>

          <div class="slider-option">
            <div class="slider-header">
              <label><strong>Box Opacity</strong></label>
              <span id="opacityValue">45%</span>
            </div>
            <input type="range" id="opacitySlider" min="0" max="100" value="45" class="slider">
          </div>
        </div>
      </div>

      <div class="status" id="status"></div>

    </div>

    <div class="footer" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 16px;">
      <span style="font-size: 11px; color: #666;">ChemTex v6.0</span>
      <div style="display: flex; gap: 12px; align-items: center;">
        <!-- Discord Button -->
        <a href="https://discord.gg/YOUR_INVITE" target="_blank" title="Join Discord"
          style="display: flex; align-items: center; text-decoration: none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 127.14 96.36"
            style="fill: #5865F2;">
            <path
              d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.25,105.25,0,0,0,126.6,80.22h0C129.24,52.84,122.09,29.11,107.7,8.07ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z" />
          </svg>
        </a>
        <!-- MetaMask Donate Button -->
        <a href="#" id="metamaskDonate" title="Donate with MetaMask"
          style="display: flex; align-items: center; text-decoration: none; cursor: pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="20" viewBox="0 0 507.83 470.86">
            <polygon fill="#E2761B" points="482.09 0.5 284.32 147.38 320.9 60.72 482.09 0.5" />
            <polygon fill="#E4761B" points="25.54 0.5 221.72 148.77 186.93 60.72 25.54 0.5" />
            <polygon fill="#D7C1B3" points="410.93 340.97 358.26 421.67 470.96 452.67 503.36 342.76 410.93 340.97" />
            <polygon fill="#D7C1B3" points="4.67 342.76 36.87 452.67 149.57 421.67 96.9 340.97 4.67 342.76" />
            <polygon fill="#233447" points="143.21 204.62 111.8 252.13 223.71 257.1 219.73 136.06 143.21 204.62" />
            <polygon fill="#233447" points="364.42 204.62 286.71 134.67 284.32 257.1 396.03 252.13 364.42 204.62" />
            <polygon fill="#CD6116" points="149.57 421.67 216.75 388.28 158.72 343.55 149.57 421.67" />
            <polygon fill="#CD6116" points="290.88 388.28 358.26 421.67 348.91 343.55 290.88 388.28" />
            <polygon fill="#E4751F" points="358.26 421.67 290.88 388.28 296.25 432.22 295.65 451.28 358.26 421.67" />
            <polygon fill="#E4751F" points="149.57 421.67 212.18 451.28 211.78 432.22 216.75 388.28 149.57 421.67" />
            <polygon fill="#F6851B" points="213.17 314.54 157.13 297.67 196.67 278.81 213.17 314.54" />
            <polygon fill="#F6851B" points="294.46 314.54 310.96 278.81 350.7 297.67 294.46 314.54" />
          </svg>
        </a>
      </div>
    </div>
  </div>

  <!-- External scripts (CSP compliant) -->
  <script src="popup-animation.js"></script>
  <script src="popup.js"></script>
</body>

</html>