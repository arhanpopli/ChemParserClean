/**
 * ChemistryLaTeX (Developer Build)
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * DEBUG MODE: Console logs ENABLED
 */
const enabledToggle=document.getElementById("enabledToggle"),perfModeToggle=document.getElementById("perfModeToggle"),devModeToggle=document.getElementById("devModeToggle"),reloadAllBtn=document.getElementById("reloadAllBtn"),statusDiv=document.getElementById("status"),renderingOptionsSection=document.getElementById("renderingOptions"),sdUseStereochemistryToggle=document.getElementById("sdUseStereochemistryToggle"),sdShowCarbonsToggle=document.getElementById("sdShowCarbonsToggle"),sdAromaticRingsToggle=document.getElementById("sdAromaticRingsToggle"),sdShowMethylsToggle=document.getElementById("sdShowMethylsToggle"),sdAtomNumbersToggle=document.getElementById("sdAtomNumbersToggle"),sdShowExplicitHydrogensToggle=document.getElementById("sdShowExplicitHydrogensToggle"),sdShowImplicitHydrogensToggle=document.getElementById("sdShowImplicitHydrogensToggle"),sdCompactDrawingToggle=document.getElementById("sdCompactDrawingToggle"),sdFlipHorizontalToggle=document.getElementById("sdFlipHorizontalToggle"),sdFlipVerticalToggle=document.getElementById("sdFlipVerticalToggle"),sdThemeSelect=document.getElementById("sdThemeSelect"),sdRotateSlider=document.getElementById("sdRotateSlider"),sdRotateValue=document.getElementById("sdRotateValue"),sdAverageSizeSlider=document.getElementById("sdAverageSizeSlider"),sdAverageSizeValue=document.getElementById("sdAverageSizeValue"),sdGradientColorsToggle=document.getElementById("sdGradientColorsToggle"),sdScaleByWeightToggle=document.getElementById("sdScaleByWeightToggle"),renderingEngineSelect=document.getElementById("renderingEngineSelect"),compoundOptions=document.getElementById("compoundOptions"),molviewRepresentationSelect=document.getElementById("molviewRepresentationSelect"),compoundMolviewBgColorSelect=document.getElementById("compoundMolviewBgColorSelect"),molviewEngineSelect=document.getElementById("molviewEngineSelect"),compound3DSizeSlider=document.getElementById("compound3DSizeSlider"),compound3DSizeValue=document.getElementById("compound3DSizeValue");console.log("%c[Popup] \u{1F50D} DOM Element Check:","color: #9C27B0; font-weight: bold;",{compoundOptions:!!compoundOptions,molviewRepresentationSelect:!!molviewRepresentationSelect,compoundMolviewBgColorSelect:!!compoundMolviewBgColorSelect,molviewEngineSelect:!!molviewEngineSelect,compound3DSizeSlider:!!compound3DSizeSlider});const proteinRemoveWhiteBgToggle=document.getElementById("proteinRemoveWhiteBgToggle"),molviewBioAssemblyToggle=document.getElementById("molviewBioAssemblyToggle"),molviewChainTypeSelect=document.getElementById("molviewChainTypeSelect"),molviewChainBondsToggle=document.getElementById("molviewChainBondsToggle"),molviewChainColorSelect=document.getElementById("molviewChainColorSelect"),proteinMolviewBgColorSelect=document.getElementById("proteinMolviewBgColorSelect"),bioAssemblySettings=document.getElementById("bioAssemblySettings"),bioAssemblyViewerSelect=document.getElementById("bioAssemblyViewerSelect"),bioAssemblyGraphicsSelect=document.getElementById("bioAssemblyGraphicsSelect"),bioAssemblyPdbProviderSelect=document.getElementById("bioAssemblyPdbProviderSelect"),mineralRepresentationSelect=document.getElementById("mineralRepresentationSelect"),mineralMolviewBgColorSelect=document.getElementById("mineralMolviewBgColorSelect"),mineralCrystallographySelect=document.getElementById("mineralCrystallographySelect"),mineral3DSizeSlider=document.getElementById("mineral3DSizeSlider"),mineral3DSizeValue=document.getElementById("mineral3DSizeValue"),saveSizePerImageToggle=document.getElementById("saveSizePerImageToggle"),saveSizeBySMILESToggle=document.getElementById("saveSizeBySMILESToggle"),enable3DViewerToggle=document.getElementById("enable3DViewerToggle"),default3DViewSelect=document.getElementById("default3DViewSelect"),viewer3DSourceSelect=document.getElementById("viewer3DSourceSelect"),viewer3DStyleSelect=document.getElementById("viewer3DStyleSelect"),viewer3DAutoRotateToggle=document.getElementById("viewer3DAutoRotateToggle"),viewer3DSizeSelect=document.getElementById("viewer3DSizeSelect"),viewer3DBgColorSelect=document.getElementById("viewer3DBgColorSelect"),molSearchModeToggle=document.getElementById("molSearchModeToggle"),disableFormulaFallbackToggle=document.getElementById("disableFormulaFallbackToggle"),enableAIFlagControlToggle=document.getElementById("enableAIFlagControlToggle"),searchCompoundsToggle=document.getElementById("searchCompoundsToggle"),searchBiomoleculesToggle=document.getElementById("searchBiomoleculesToggle"),searchMineralsToggle=document.getElementById("searchMineralsToggle");function safeGetElement(e){const t=document.getElementById(e);return t||console.warn(`Element ${e} not found in DOM`),t}function saveSetting(e,t,o){chrome.storage.sync.set(e,()=>{if(chrome.runtime.lastError){const n=chrome.runtime.lastError.message||"Unknown error";console.error("[Popup] \u274C Error saving settings:",n,e),showStatus("Error saving: "+n,"error"),o&&o(!1);return}console.log("[Popup] \u2705 Saved:",e),t&&showStatus(t,"success"),trackUserModifiedSettings(Object.keys(e)),o&&o(!0)})}function saveSettingWithVerification(e,t,o){console.log(`[Popup] Saving ${e}:`,t);const n={};n[e]=t,chrome.storage.sync.set(n,()=>{if(chrome.runtime.lastError){console.error(`[Popup] Error saving ${e}:`,chrome.runtime.lastError),o&&o(!1,chrome.runtime.lastError.message);return}chrome.storage.sync.get([e],s=>{if(chrome.runtime.lastError){console.error(`[Popup] Error verifying ${e}:`,chrome.runtime.lastError),o&&o(!1,chrome.runtime.lastError.message);return}const i=s[e];console.log(`[Popup] Verified ${e} saved as:`,i),i===t?(console.log(`[Popup] Successfully saved and verified ${e}:`,t),trackUserModifiedSettings([e]),o&&o(!0)):(console.error(`[Popup] Save verification failed for ${e}. Expected:`,t,"Got:",i),o&&o(!1,"Verification failed"))})})}function trackUserModifiedSettings(e){chrome.storage.sync.get(["userModifiedSettings"],t=>{const o=t.userModifiedSettings||{};e.forEach(n=>{o[n]=!0}),chrome.storage.sync.set({userModifiedSettings:o})})}(function(){const t=document.getElementById("patchNotesBtn"),o=document.getElementById("notesModal"),n=document.getElementById("notesContent"),s=document.getElementById("closeNotesModal");t&&t.addEventListener("click",()=>{if(o&&n){const i=window._serverPatchNotes||`Version 7.7
- Fixed biomolecule 3D button visibility
- Fixed button positioning for biomolecules  
- Improved rendering performance
- Added notification system for updates

Version 7.6
- Added server-controlled configuration
- Improved SMILES/IUPAC handling
- Fixed re-rendering issues`;n.textContent=i,o.style.display="flex",window._serverPatchNotesVersion&&chrome.storage.local.set({lastSeenPatchNotesVersion:window._serverPatchNotesVersion});const r=document.getElementById("patchNotifDot");r&&(r.style.display="none"),t.classList.remove("important","ringing")}}),s&&o&&(s.addEventListener("click",()=>{o.style.display="none"}),o.addEventListener("click",i=>{i.target===o&&(o.style.display="none")}))})(),chrome.storage.sync.get(null,e=>{console.log("%c[Popup] \u{1F4E6} RAW STORED SETTINGS:","color: #FF6B00; font-weight: bold; font-size: 14px;"),console.log(JSON.stringify(e,null,2)),console.log("%c[Popup] Key settings check:","color: #2196F3; font-weight: bold;",{compoundMolviewBgColor:e.compoundMolviewBgColor,molviewBioAssembly:e.molviewBioAssembly,proteinRemoveWhiteBg:e.proteinRemoveWhiteBg,compound3DSize:e.compound3DSize,sdAverageSize:e.sdAverageSize}),e.molviewRepresentation?showStatus("DEBUG: Loaded representation = "+e.molviewRepresentation,"success"):showStatus("DEBUG: No representation stored, using default","error");const t={enabled:!0,performanceMode:!0,rendererEngine:"chemistrylatex",devMode:!1,useStereochemistry:!1,sdShowCarbons:!0,sdAromaticRings:!0,sdShowMethyls:!0,sdAtomNumbers:!1,sdShowExplicitHydrogens:!1,sdShowImplicitHydrogens:!0,sdCompactDrawing:!1,sdFlipHorizontal:!1,sdFlipVertical:!1,sdTheme:"light",sdAutoAdapt:!0,sdRotate:0,sdBondThickness:1,sdAverageSize:100,sdGradientColors:!1,sdScaleByWeight:!1,saveSizePerImage:!1,saveSizeBySMILES:!0,searchCompounds:!0,searchBiomolecules:!0,searchMinerals:!0,renderingEngine:"chemistrylatex",compoundMolviewBgColor:"black",disableFormulaFallback:!1,enable3DViewer:!1,default3DView:"2d",viewer3DSource:"3dmol",viewer3DStyle:"stick:sphere",viewer3DAutoRotate:!0,viewer3DSize:"normal",viewer3DBgColor:"#1a1a2e",molviewRepresentation:"ballAndStick",molviewEngine:"glmol",proteinRemoveWhiteBg:!1,molviewBioAssembly:!1,bioAssemblyViewer:"molstar",bioAssemblyGraphics:"balanced",bioAssemblyPdbProvider:"rcsb",molviewChainType:"ribbon",molviewChainBonds:!1,molviewChainColor:"ss",proteinMolviewBgColor:"black",mineralRepresentation:"ballAndStick",mineralMolviewBgColor:"black",mineralCrystallography:"supercell_2x2x2",compound3DSize:100,mineral3DSize:100,viewer3DStyleSettings:{stick:{stickRadius:"0.15"},line:{},cross:{},sphere:{sphereRadius:"0.7"},"stick:sphere":{stickRadius:"0.15",sphereRadius:"0.3"},cartoon:{}},enableAIMolecularControl:!1,molSearchMode:!1,enableAIFlagControl:!1,uiBlur:7,uiOpacity:23,moleculeCount:22,moleculeScale:.4,cursorGravityStrength:-.9,initialVelocity:10},o={};for(const l in t)o[l]=e[l]!==void 0?e[l]:t[l];console.log("[Popup] ========== SETTINGS LOADING DEBUG =========="),console.log("[Popup] Raw storage (storedSettings):",e),console.log("[Popup] Defaults object:",t),console.log("[Popup] Final merged settings:",o),console.log("[Popup] Rendering settings:",{useStereochemistry:o.useStereochemistry,sdShowCarbons:o.sdShowCarbons,sdAromaticRings:o.sdAromaticRings,sdShowMethyls:o.sdShowMethyls,sdAtomNumbers:o.sdAtomNumbers,sdShowExplicitHydrogens:o.sdShowExplicitHydrogens,sdShowImplicitHydrogens:o.sdShowImplicitHydrogens,sdCompactDrawing:o.sdCompactDrawing,sdFlipHorizontal:o.sdFlipHorizontal,sdFlipVertical:o.sdFlipVertical}),console.log("[Popup] ================================================"),enabledToggle&&(enabledToggle.checked=o.enabled),perfModeToggle&&(perfModeToggle.checked=o.performanceMode),devModeToggle&&(devModeToggle.checked=o.devMode),enableAIFlagControlToggle&&(enableAIFlagControlToggle.checked=o.enableAIFlagControl===!0),console.log("[Popup] ========== TOGGLE ELEMENT CHECK =========="),console.log("[Popup] sdShowCarbonsToggle exists?",!!sdShowCarbonsToggle),console.log("[Popup] sdAromaticRingsToggle exists?",!!sdAromaticRingsToggle),console.log("[Popup] sdShowMethylsToggle exists?",!!sdShowMethylsToggle),console.log("[Popup] sdAtomNumbersToggle exists?",!!sdAtomNumbersToggle),console.log("[Popup] sdShowExplicitHydrogensToggle exists?",!!sdShowExplicitHydrogensToggle),console.log("[Popup] sdShowImplicitHydrogensToggle exists?",!!sdShowImplicitHydrogensToggle),console.log("[Popup] sdFlipHorizontalToggle exists?",!!sdFlipHorizontalToggle),console.log("[Popup] sdFlipVerticalToggle exists?",!!sdFlipVerticalToggle),console.log("[Popup] ================================================"),sdUseStereochemistryToggle&&(sdUseStereochemistryToggle.checked=o.useStereochemistry,console.log("[Popup] Set sdUseStereochemistryToggle.checked to:",o.useStereochemistry,"| Actual value now:",sdUseStereochemistryToggle.checked)),sdShowCarbonsToggle&&(sdShowCarbonsToggle.checked=o.sdShowCarbons,console.log("[Popup] Set sdShowCarbonsToggle.checked to:",o.sdShowCarbons,"| Actual value now:",sdShowCarbonsToggle.checked)),sdAromaticRingsToggle&&(sdAromaticRingsToggle.checked=o.sdAromaticRings,console.log("[Popup] Set sdAromaticRingsToggle.checked to:",o.sdAromaticRings,"| Actual value now:",sdAromaticRingsToggle.checked)),sdShowMethylsToggle&&(sdShowMethylsToggle.checked=o.sdShowMethyls,console.log("[Popup] Set sdShowMethylsToggle.checked to:",o.sdShowMethyls,"| Actual value now:",sdShowMethylsToggle.checked)),sdAtomNumbersToggle&&(sdAtomNumbersToggle.checked=o.sdAtomNumbers,console.log("[Popup] Set sdAtomNumbersToggle.checked to:",o.sdAtomNumbers,"| Actual value now:",sdAtomNumbersToggle.checked)),sdShowExplicitHydrogensToggle&&(sdShowExplicitHydrogensToggle.checked=o.sdShowExplicitHydrogens,console.log("[Popup] Set sdShowExplicitHydrogensToggle.checked to:",o.sdShowExplicitHydrogens,"| Actual value now:",sdShowExplicitHydrogensToggle.checked)),sdShowImplicitHydrogensToggle&&(sdShowImplicitHydrogensToggle.checked=o.sdShowImplicitHydrogens,console.log("[Popup] Set sdShowImplicitHydrogensToggle.checked to:",o.sdShowImplicitHydrogens,"| Actual value now:",sdShowImplicitHydrogensToggle.checked)),sdCompactDrawingToggle&&(sdCompactDrawingToggle.checked=o.sdCompactDrawing,console.log("[Popup] Set sdCompactDrawingToggle.checked to:",o.sdCompactDrawing,"| Actual value now:",sdCompactDrawingToggle.checked)),sdFlipHorizontalToggle&&(sdFlipHorizontalToggle.checked=o.sdFlipHorizontal,console.log("[Popup] Set sdFlipHorizontalToggle.checked to:",o.sdFlipHorizontal,"| Actual value now:",sdFlipHorizontalToggle.checked)),sdFlipVerticalToggle&&(sdFlipVerticalToggle.checked=o.sdFlipVertical,console.log("[Popup] Set sdFlipVerticalToggle.checked to:",o.sdFlipVertical,"| Actual value now:",sdFlipVerticalToggle.checked)),sdThemeSelect&&(sdThemeSelect.value=o.sdTheme||"light"),sdRotateSlider&&(sdRotateSlider.value=o.sdRotate||0,sdRotateValue&&(sdRotateValue.textContent=(o.sdRotate||0)+"\xB0")),sdAverageSizeSlider&&(sdAverageSizeSlider.value=o.sdAverageSize||100,sdAverageSizeValue&&(sdAverageSizeValue.textContent=(o.sdAverageSize||100)+"%")),sdGradientColorsToggle&&(sdGradientColorsToggle.checked=o.sdGradientColors||!1),sdScaleByWeightToggle&&(sdScaleByWeightToggle.checked=o.sdScaleByWeight||!1),searchCompoundsToggle&&(searchCompoundsToggle.checked=o.searchCompounds!==!1),searchBiomoleculesToggle&&(searchBiomoleculesToggle.checked=o.searchBiomolecules!==!1),searchMineralsToggle&&(searchMineralsToggle.checked=o.searchMinerals!==!1);const n=document.getElementById("useStereochemistryToggle");if(n&&(n.checked=o.useStereochemistry!==!1),saveSizePerImageToggle&&(saveSizePerImageToggle.checked=o.saveSizePerImage),saveSizeBySMILESToggle&&(saveSizeBySMILESToggle.checked=o.saveSizeBySMILES),enable3DViewerToggle&&(enable3DViewerToggle.checked=o.enable3DViewer),default3DViewSelect&&(default3DViewSelect.value=o.default3DView),viewer3DSourceSelect&&(viewer3DSourceSelect.value=o.viewer3DSource||"3dmol"),viewer3DStyleSelect&&(viewer3DStyleSelect.value=o.viewer3DStyle||"stick:sphere"),viewer3DAutoRotateToggle&&(viewer3DAutoRotateToggle.checked=o.viewer3DAutoRotate!==!1),viewer3DSizeSelect&&(viewer3DSizeSelect.value=o.viewer3DSize||"normal"),viewer3DBgColorSelect&&(viewer3DBgColorSelect.value=o.viewer3DBgColor||"#1a1a2e"),console.log("[Popup] Loading compound settings:",{storedBgColor:e.compoundMolviewBgColor,mergedBgColor:o.compoundMolviewBgColor,willSetTo:o.compoundMolviewBgColor||"black"}),molviewRepresentationSelect){const l=o.molviewRepresentation||"ballAndStick";molviewRepresentationSelect.value=l,molviewRepresentationSelect.value!==l&&showStatus("Warning: Could not set representation to: "+l,"error")}if(compoundMolviewBgColorSelect&&(compoundMolviewBgColorSelect.value=o.compoundMolviewBgColor||"black"),molviewEngineSelect&&(molviewEngineSelect.value=o.molviewEngine||"glmol"),compound3DSizeSlider&&(compound3DSizeSlider.value=o.compound3DSize||100,compound3DSizeValue&&(compound3DSizeValue.textContent=(o.compound3DSize||100)+"%")),proteinRemoveWhiteBgToggle&&(proteinRemoveWhiteBgToggle.checked=o.proteinRemoveWhiteBg===!0),molviewBioAssemblyToggle&&(molviewBioAssemblyToggle.checked=o.molviewBioAssembly),bioAssemblyViewerSelect&&(bioAssemblyViewerSelect.value=o.bioAssemblyViewer||"molstar"),bioAssemblyGraphicsSelect&&(bioAssemblyGraphicsSelect.value=o.bioAssemblyGraphics||"balanced"),bioAssemblyPdbProviderSelect&&(bioAssemblyPdbProviderSelect.value=o.bioAssemblyPdbProvider||"rcsb"),bioAssemblySettings&&(o.molviewBioAssembly?(bioAssemblySettings.style.opacity="1",bioAssemblySettings.style.pointerEvents="auto"):(bioAssemblySettings.style.opacity="0.5",bioAssemblySettings.style.pointerEvents="none")),molviewChainTypeSelect){const l=o.molviewChainType||"ribbon";molviewChainTypeSelect.value=l,molviewChainTypeSelect.value!==l&&showStatus("Warning: Could not set chain type to: "+l,"error")}molviewChainBondsToggle&&(molviewChainBondsToggle.checked=o.molviewChainBonds),molviewChainColorSelect&&(molviewChainColorSelect.value=o.molviewChainColor||"ss"),proteinMolviewBgColorSelect&&(proteinMolviewBgColorSelect.value=o.proteinMolviewBgColor||"black"),mineralRepresentationSelect&&(mineralRepresentationSelect.value=o.mineralRepresentation||"ballAndStick"),mineralMolviewBgColorSelect&&(mineralMolviewBgColorSelect.value=o.mineralMolviewBgColor||"black"),mineralCrystallographySelect&&(mineralCrystallographySelect.value=o.mineralCrystallography||"supercell_2x2x2"),mineral3DSizeSlider&&(mineral3DSizeSlider.value=o.mineral3DSize||100,mineral3DSizeValue&&(mineral3DSizeValue.textContent=(o.mineral3DSize||100)+"%")),compoundOptions&&(compoundOptions.style.display="block"),molSearchModeToggle&&(molSearchModeToggle.checked=o.molSearchMode),disableFormulaFallbackToggle&&(disableFormulaFallbackToggle.checked=o.disableFormulaFallback),renderingEngineSelect&&(renderingEngineSelect.value=o.renderingEngine||"chemistrylatex"),document.querySelectorAll('input[name="renderingEngine"]').forEach(l=>{l.checked=l.value===o.rendererEngine});const i=document.getElementById("compoundOptions");i&&(i.style.display="block");const r=document.getElementById("biomoleculeOptions");r&&(r.style.display="block");const c=document.getElementById("mineralOptions");c&&(c.style.display="block")}),enabledToggle&&enabledToggle.addEventListener("change",e=>{chrome.storage.sync.set({enabled:e.target.checked},()=>{showStatus("ChemistryLaTeX "+(e.target.checked?"enabled":"disabled"),"success")})}),perfModeToggle&&perfModeToggle.addEventListener("change",e=>{chrome.storage.sync.set({performanceMode:e.target.checked},()=>{broadcastSettingsChange({performanceMode:e.target.checked}),showStatus("Lazy-loading "+(e.target.checked?"enabled":"disabled"),"success")})}),devModeToggle&&devModeToggle.addEventListener("change",e=>{chrome.storage.sync.set({devMode:e.target.checked},()=>{showStatus("Developer mode "+(e.target.checked?"enabled":"disabled"),"success")})}),enableAIFlagControlToggle&&enableAIFlagControlToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({enableAIFlagControl:t},()=>{broadcastSettingsChange({enableAIFlagControl:t}),showStatus("AI flag control "+(t?"enabled":"disabled"),"success")})}),console.log("[Popup] reloadAllBtn:",reloadAllBtn),reloadAllBtn?reloadAllBtn.addEventListener("click",()=>{console.log("[Popup] Reload All button clicked!"),chrome.runtime.sendMessage({type:"RELOAD_ALL_IMAGES"},e=>{console.log("[Popup] Reload message sent, response:",e)}),showStatus("Reloading all images...","success")}):console.warn("[Popup] reloadAllBtn not found in DOM!");const clearCacheBtn=document.getElementById("clearCacheBtn");console.log("[Popup] clearCacheBtn:",clearCacheBtn),clearCacheBtn?clearCacheBtn.addEventListener("click",()=>{console.log("[Popup] Clear Cache button clicked!"),chrome.tabs.query({},e=>{e.forEach(t=>{chrome.tabs.sendMessage(t.id,{type:"CLEAR_CACHE"}).catch(()=>{})}),console.log("[Popup] Sent CLEAR_CACHE to",e.length,"tabs")}),chrome.runtime.sendMessage({type:"CLEAR_CACHE"},e=>{console.log("[Popup] Clear cache message sent to runtime, response:",e)}),chrome.storage.local.get(null,e=>{const t=Object.keys(e).filter(o=>o.startsWith("smiles_")||o.startsWith("cid_")||o.startsWith("cache_")||o.startsWith("search_")||o==="chemistrylatex_smiles_cache"||o==="chemistrylatex_svg_cache");t.length>0?chrome.storage.local.remove(t,()=>{console.log("[Popup] Cleared",t.length,"cached items from storage:",t)}):chrome.storage.local.remove(["chemistrylatex_smiles_cache","chemistrylatex_svg_cache"],()=>{console.log("[Popup] Cleared chemistrylatex_smiles_cache and chemistrylatex_svg_cache")})}),showStatus("Cache cleared! Reload images to fetch fresh data.","success")}):console.warn("[Popup] clearCacheBtn not found in DOM!"),saveSizePerImageToggle&&saveSizePerImageToggle.addEventListener("change",e=>{chrome.storage.sync.set({saveSizePerImage:e.target.checked},()=>{showStatus("Save size per page "+(e.target.checked?"enabled":"disabled")+". Size changes will be remembered for each page.","success")})}),saveSizeBySMILESToggle&&saveSizeBySMILESToggle.addEventListener("change",e=>{chrome.storage.sync.set({saveSizeBySMILES:e.target.checked},()=>{showStatus("Save size by SMILES "+(e.target.checked?"enabled":"disabled")+". Same size will be used for all molecules with the same SMILES.","success")})});function broadcastSettingsChange(e){const t=Object.keys(e);chrome.runtime.sendMessage({type:"SETTINGS_CHANGED",settings:e,changedKeys:t})}sdUseStereochemistryToggle&&sdUseStereochemistryToggle.addEventListener("change",e=>{const t=e.target.checked;console.log("[Popup] Setting useStereochemistry to:",t),chrome.storage.sync.set({useStereochemistry:t},()=>{if(chrome.runtime.lastError){console.error("[Popup] Error saving useStereochemistry:",chrome.runtime.lastError),showStatus("Error saving setting: "+chrome.runtime.lastError.message,"error");return}console.log("[Popup] Successfully saved useStereochemistry:",t),broadcastSettingsChange({useStereochemistry:t}),showStatus("Stereochemistry "+(t?"enabled":"disabled"),"success")})}),sdShowCarbonsToggle&&sdShowCarbonsToggle.addEventListener("change",e=>{const t=e.target.checked;console.log("[Popup] Setting sdShowCarbons to:",t),chrome.storage.sync.set({sdShowCarbons:t},()=>{if(chrome.runtime.lastError){console.error("[Popup] Error saving sdShowCarbons:",chrome.runtime.lastError),showStatus("Error saving setting: "+chrome.runtime.lastError.message,"error");return}console.log("[Popup] Successfully saved sdShowCarbons:",t),broadcastSettingsChange({sdShowCarbons:t}),showStatus("Show carbons "+(t?"enabled":"disabled"),"success")})}),sdAromaticRingsToggle&&sdAromaticRingsToggle.addEventListener("change",e=>{const t=e.target.checked;console.log("[Popup] Setting sdAromaticRings to:",t),chrome.storage.sync.set({sdAromaticRings:t},()=>{if(chrome.runtime.lastError){console.error("[Popup] Error saving sdAromaticRings:",chrome.runtime.lastError),showStatus("Error saving setting: "+chrome.runtime.lastError.message,"error");return}console.log("[Popup] Successfully saved sdAromaticRings:",t),broadcastSettingsChange({sdAromaticRings:t}),showStatus("Aromatic ring circles "+(t?"enabled":"disabled"),"success")})}),sdShowMethylsToggle&&sdShowMethylsToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdShowMethyls",t,(o,n)=>{o?(broadcastSettingsChange({sdShowMethyls:t}),showStatus("Show methyls "+(t?"enabled":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdShowMethylsToggle.checked=!t)})}),sdAtomNumbersToggle&&sdAtomNumbersToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdAtomNumbers",t,(o,n)=>{o?(broadcastSettingsChange({sdAtomNumbers:t}),showStatus("Atom numbers "+(t?"enabled":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdAtomNumbersToggle.checked=!t)})}),sdShowExplicitHydrogensToggle&&sdShowExplicitHydrogensToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdShowExplicitHydrogens",t,(o,n)=>{o?(broadcastSettingsChange({sdShowExplicitHydrogens:t}),showStatus("Explicit hydrogens "+(t?"enabled":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdShowExplicitHydrogensToggle.checked=!t)})}),sdShowImplicitHydrogensToggle&&sdShowImplicitHydrogensToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdShowImplicitHydrogens",t,(o,n)=>{o?(broadcastSettingsChange({sdShowImplicitHydrogens:t}),showStatus("Implicit hydrogens "+(t?"shown":"hidden"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdShowImplicitHydrogensToggle.checked=!t)})}),sdCompactDrawingToggle&&sdCompactDrawingToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdCompactDrawing",t,(o,n)=>{o?(broadcastSettingsChange({sdCompactDrawing:t}),showStatus("Compact drawing "+(t?"enabled":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdCompactDrawingToggle.checked=!t)})}),sdFlipHorizontalToggle&&sdFlipHorizontalToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdFlipHorizontal",t,(o,n)=>{o?(broadcastSettingsChange({sdFlipHorizontal:t}),showStatus("Horizontal flip "+(t?"enabled":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdFlipHorizontalToggle.checked=!t)})}),sdFlipVerticalToggle&&sdFlipVerticalToggle.addEventListener("change",e=>{const t=e.target.checked;saveSettingWithVerification("sdFlipVertical",t,(o,n)=>{o?(broadcastSettingsChange({sdFlipVertical:t}),showStatus("Vertical flip "+(t?"enabled":"disabled"),"success")):(showStatus("Error saving setting: "+(n||"Unknown error"),"error"),sdFlipVerticalToggle.checked=!t)})}),sdThemeSelect&&sdThemeSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({sdTheme:t},()=>{broadcastSettingsChange({sdTheme:t}),showStatus("Theme set to "+t,"success")})}),sdRotateSlider&&(sdRotateSlider.addEventListener("input",e=>{sdRotateValue.textContent=e.target.value+"\xB0"}),sdRotateSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({sdRotate:t},()=>{broadcastSettingsChange({sdRotate:t}),showStatus("Rotation set to "+t+"\xB0","success")})})),sdAverageSizeSlider&&(sdAverageSizeSlider.addEventListener("input",e=>{sdAverageSizeValue.textContent=e.target.value+"%",broadcastSettingsChange({sdAverageSize:parseInt(e.target.value)})}),sdAverageSizeSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({sdAverageSize:t},()=>{broadcastSettingsChange({sdAverageSize:t}),showStatus("Average size set to "+t+"%","success")})})),sdGradientColorsToggle&&sdGradientColorsToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({sdGradientColors:t},()=>{broadcastSettingsChange({sdGradientColors:t}),showStatus("Gradient colors "+(t?"enabled":"disabled"),"success")})}),sdScaleByWeightToggle&&sdScaleByWeightToggle.addEventListener("change",e=>{chrome.storage.sync.set({sdScaleByWeight:e.target.checked},()=>{showStatus("Scale by weight "+(e.target.checked?"enabled":"disabled")+". Reload page to apply.","success")})});const useStereochemistryToggleHandler=document.getElementById("useStereochemistryToggle");useStereochemistryToggleHandler&&useStereochemistryToggleHandler.addEventListener("change",e=>{chrome.storage.sync.set({useStereochemistry:e.target.checked},()=>{showStatus("Stereochemistry "+(e.target.checked?"enabled":"disabled"),"success")})}),molviewRepresentationSelect&&molviewRepresentationSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewRepresentation:t},"Representation set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewRepresentation:t})})}),compoundMolviewBgColorSelect?(console.log("[Popup] \u2705 Adding event listener to compoundMolviewBgColorSelect"),compoundMolviewBgColorSelect.addEventListener("change",e=>{const t=e.target.value;console.log("[Popup] \u{1F504} compoundMolviewBgColorSelect CHANGED to:",t),saveSettingWithVerification("compoundMolviewBgColor",t,(o,n)=>{o?(broadcastSettingsChange({compoundMolviewBgColor:t}),showStatus("Compound background set to "+e.target.options[e.target.selectedIndex].text,"success")):(console.error("[Popup] \u274C Failed to save compoundMolviewBgColor:",n),showStatus("Error saving background color: "+(n||"Unknown error"),"error"))})})):console.error("[Popup] \u274C compoundMolviewBgColorSelect NOT FOUND IN DOM!"),molviewEngineSelect&&molviewEngineSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewEngine:t},"Engine set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewEngine:t})})}),renderingEngineSelect&&renderingEngineSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({renderingEngine:t},"Rendering engine set to "+({chemistrylatex:"ChemistryLaTeX",rdkit:"RDKit",kekule:"Kekule"}[t]||t),n=>{n&&broadcastSettingsChange({renderingEngine:t})})}),proteinRemoveWhiteBgToggle?(console.log("[Popup] \u2705 Adding event listener to proteinRemoveWhiteBgToggle"),proteinRemoveWhiteBgToggle.addEventListener("change",e=>{try{console.log("[Popup] \u{1F504} proteinRemoveWhiteBgToggle CHANGED to:",e.target.checked);const t=e.target.checked;chrome.storage.sync.set({proteinRemoveWhiteBg:t},()=>{if(chrome.runtime.lastError){console.error("[Popup] \u274C ERROR saving proteinRemoveWhiteBg:",chrome.runtime.lastError);return}console.log("[Popup] \u2705 SAVED proteinRemoveWhiteBg:",t),broadcastSettingsChange({proteinRemoveWhiteBg:t}),showStatus("White background removal "+(t?"enabled":"disabled"),"success")})}catch(t){console.error("[Popup] \u274C EXCEPTION in proteinRemoveWhiteBgToggle handler:",t)}})):console.error("[Popup] \u274C proteinRemoveWhiteBgToggle NOT FOUND IN DOM!"),molviewBioAssemblyToggle&&molviewBioAssemblyToggle.addEventListener("change",e=>{const t=e.target.checked;chrome.storage.sync.set({molviewBioAssembly:t},()=>{broadcastSettingsChange({molviewBioAssembly:t}),showStatus("Bio Assembly "+(t?"shown":"hidden"),"success"),bioAssemblySettings&&(t?(bioAssemblySettings.style.opacity="1",bioAssemblySettings.style.pointerEvents="auto"):(bioAssemblySettings.style.opacity="0.5",bioAssemblySettings.style.pointerEvents="none"))})}),bioAssemblyViewerSelect&&bioAssemblyViewerSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({bioAssemblyViewer:t},()=>{broadcastSettingsChange({bioAssemblyViewer:t}),showStatus("Bio Viewer set to "+e.target.options[e.target.selectedIndex].text,"success")})}),bioAssemblyGraphicsSelect&&bioAssemblyGraphicsSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({bioAssemblyGraphics:t},()=>{broadcastSettingsChange({bioAssemblyGraphics:t}),showStatus("Graphics mode set to "+e.target.options[e.target.selectedIndex].text,"success")})}),bioAssemblyPdbProviderSelect&&bioAssemblyPdbProviderSelect.addEventListener("change",e=>{const t=e.target.value;chrome.storage.sync.set({bioAssemblyPdbProvider:t},()=>{broadcastSettingsChange({bioAssemblyPdbProvider:t}),showStatus("PDB Provider set to "+e.target.options[e.target.selectedIndex].text,"success")})}),molviewChainTypeSelect&&molviewChainTypeSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewChainType:t},"Chain Type set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewChainType:t})})}),molviewChainBondsToggle&&molviewChainBondsToggle.addEventListener("change",e=>{const t=e.target.checked;saveSetting({molviewChainBonds:t},"Chain Bonds "+(t?"shown":"hidden"),o=>{o&&broadcastSettingsChange({molviewChainBonds:t})})}),molviewChainColorSelect&&molviewChainColorSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({molviewChainColor:t},"Chain Color set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({molviewChainColor:t})})}),proteinMolviewBgColorSelect&&proteinMolviewBgColorSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({proteinMolviewBgColor:t},"Protein background color set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({proteinMolviewBgColor:t})})}),mineralRepresentationSelect&&mineralRepresentationSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({mineralRepresentation:t},"Mineral representation set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({mineralRepresentation:t})})}),mineralMolviewBgColorSelect&&mineralMolviewBgColorSelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({mineralMolviewBgColor:t},"Mineral background color set to "+e.target.options[e.target.selectedIndex].text,o=>{o&&broadcastSettingsChange({mineralMolviewBgColor:t})})}),mineralCrystallographySelect&&mineralCrystallographySelect.addEventListener("change",e=>{const t=e.target.value;saveSetting({mineralCrystallography:t},"Mineral crystallography set to "+e.target.options[e.target.selectedIndex].text+". Reload page to apply.")});const engineRadios=document.querySelectorAll('input[name="renderingEngine"]');engineRadios.forEach(e=>{e.addEventListener("change",t=>{if(t.target.checked){const o=t.target.value;chrome.storage.sync.set({rendererEngine:o},()=>{updateEngineInfo(),showStatus("Rendering engine updated. Reload page to apply.","success")})}})});const biomoleculeOptions=document.getElementById("biomoleculeOptions"),mineralOptions=document.getElementById("mineralOptions");function updateEngineInfo(){compoundOptions&&(compoundOptions.style.display="block"),biomoleculeOptions&&(biomoleculeOptions.style.display="block"),mineralOptions&&(mineralOptions.style.display="block")}function showStatus(e,t){statusDiv.textContent=e,statusDiv.className="status show",setTimeout(()=>{statusDiv.className="status"},2500)}function openConsole(){statusDiv&&showStatus("Open DevTools with F12 to debug. Check console for errors.","info")}const codeEditor=document.getElementById("codeEditor"),renderCodeBtn=document.getElementById("renderCodeBtn"),codePreview=document.getElementById("codePreview"),codePreviewContent=document.getElementById("codePreviewContent");renderCodeBtn&&codeEditor&&codePreview&&codePreviewContent&&renderCodeBtn.addEventListener("click",()=>{const e=codeEditor.value.trim();if(!e){showStatus("\u26A0\uFE0F Please enter some code to render","warning");return}codePreview.style.display="block",codePreviewContent.innerHTML=e,chrome.tabs.query({active:!0,currentWindow:!0},t=>{t[0]&&chrome.tabs.sendMessage(t[0].id,{action:"renderPreview",code:e},o=>{o&&o.html?(codePreviewContent.innerHTML=o.html,showStatus("\u2705 Preview rendered successfully","success")):showStatus("\u26A0\uFE0F Could not render preview. Reload page to see changes.","warning")})})});const blurSlider=document.getElementById("blurSlider"),opacitySlider=document.getElementById("opacitySlider"),blurValue=document.getElementById("blurValue"),opacityValue=document.getElementById("opacityValue");function applyGlassmorphism(e,t){var o=document.querySelectorAll(".section"),n=document.querySelector(".header"),s=document.querySelector(".footer"),i=document.querySelectorAll(".radio-option"),r=e+"px",c=t/100,l=document.body.classList.contains("dark-mode"),d=l?30:255,u=l?30:255,h=l?30:255,g="rgba("+d+", "+u+", "+h+", ";if(o.forEach(function(a){a.style.backdropFilter="blur("+r+")",a.style.webkitBackdropFilter="blur("+r+")",a.style.background=g+c+")",l?a.style.borderColor="rgba(255, 255, 255, 0.05)":a.style.borderColor="rgba(255, 255, 255, 0.5)"}),n){n.style.backdropFilter="blur("+r+")",n.style.webkitBackdropFilter="blur("+r+")";var m=l?c*1.5:c*.9;m>.95&&(m=.95),n.style.background=g+m+")"}if(s){s.style.backdropFilter="blur("+r+")",s.style.webkitBackdropFilter="blur("+r+")";var p=l?c*1.5:c*.9;p>.95&&(p=.95),s.style.background=g+p+")"}i.forEach(function(a){a.style.background=g+c*.8+")"})}chrome.storage.sync.get({darkMode:!1,uiBlur:7,uiOpacity:23,moleculeCount:22,moleculeScale:.4,cursorGravityStrength:-.9,initialVelocity:10},function(e){e.darkMode?(document.body.classList.add("dark-mode"),updateDarkModeIcon(!0)):updateDarkModeIcon(!1),blurSlider&&(blurSlider.value=e.uiBlur,blurValue.textContent=e.uiBlur+"px"),opacitySlider&&(opacitySlider.value=e.uiOpacity,opacityValue.textContent=e.uiOpacity+"%"),applyGlassmorphism(e.uiBlur,e.uiOpacity),molCountSlider&&(molCountSlider.value=e.moleculeCount,molCountValue.textContent=e.moleculeCount),molScaleSlider&&(molScaleSlider.value=e.moleculeScale,molScaleValue.textContent=e.moleculeScale),cursorGravitySlider&&(cursorGravitySlider.value=e.cursorGravityStrength,cursorGravityValue.textContent=e.cursorGravityStrength),initialVelocitySlider&&(initialVelocitySlider.value=e.initialVelocity,initialVelocityValue.textContent=e.initialVelocity)}),blurSlider&&(blurSlider.addEventListener("input",function(e){var t=parseInt(e.target.value);blurValue.textContent=t+"px";var o=parseInt(opacitySlider.value);applyGlassmorphism(t,o)}),blurSlider.addEventListener("change",function(e){chrome.storage.sync.set({uiBlur:parseInt(e.target.value)})})),opacitySlider&&(opacitySlider.addEventListener("input",function(e){var t=parseInt(e.target.value);opacityValue.textContent=t+"%";var o=parseInt(blurSlider.value);applyGlassmorphism(o,t)}),opacitySlider.addEventListener("change",function(e){chrome.storage.sync.set({uiOpacity:parseInt(e.target.value)})}));const molCountSlider=document.getElementById("molCountSlider"),molCountValue=document.getElementById("molCountValue");molCountSlider&&(molCountSlider.addEventListener("input",function(e){molCountValue.textContent=e.target.value}),molCountSlider.addEventListener("change",function(e){chrome.storage.sync.set({moleculeCount:parseInt(e.target.value)},()=>{window.updateMoleculeAnimation&&window.updateMoleculeAnimation()})}));const molScaleSlider=document.getElementById("molScaleSlider"),molScaleValue=document.getElementById("molScaleValue");molScaleSlider&&(molScaleSlider.addEventListener("input",function(e){molScaleValue.textContent=e.target.value}),molScaleSlider.addEventListener("change",function(e){chrome.storage.sync.set({moleculeScale:parseFloat(e.target.value)},()=>{window.updateMoleculeAnimation&&window.updateMoleculeAnimation()})}));const cursorGravitySlider=document.getElementById("cursorGravitySlider"),cursorGravityValue=document.getElementById("cursorGravityValue"),initialVelocitySlider=document.getElementById("initialVelocitySlider"),initialVelocityValue=document.getElementById("initialVelocityValue");function triggerPopupPhysicsUpdate(){try{window.updateMoleculeAnimation&&window.updateMoleculeAnimation()}catch{}}cursorGravitySlider&&(cursorGravitySlider.addEventListener("input",function(e){cursorGravityValue&&(cursorGravityValue.textContent=e.target.value)}),cursorGravitySlider.addEventListener("change",function(e){chrome.storage.sync.set({cursorGravityStrength:parseFloat(e.target.value)},()=>{triggerPopupPhysicsUpdate()})})),initialVelocitySlider&&(initialVelocitySlider.addEventListener("input",function(e){initialVelocityValue&&(initialVelocityValue.textContent=e.target.value)}),initialVelocitySlider.addEventListener("change",function(e){chrome.storage.sync.set({initialVelocity:parseFloat(e.target.value)},()=>{triggerPopupPhysicsUpdate()})})),(function(){const t=document.querySelectorAll(".section-title");chrome.storage.sync.get({collapsedSections:[]},function(o){const n=o.collapsedSections||[];t.forEach(function(s){var c,l;const i=(l=(c=s.querySelector("span"))==null?void 0:c.textContent)==null?void 0:l.trim(),r=s.closest(".section");i&&n.includes(i)&&r.classList.add("collapsed"),s.addEventListener("click",function(){r.classList.toggle("collapsed");const d=[];document.querySelectorAll(".section.collapsed .section-title span").forEach(function(u){d.push(u.textContent.trim())}),chrome.storage.sync.set({collapsedSections:d})})})})})();const copyChatGPTPromptBtn=document.getElementById("copyChatGPTPrompt"),savePromptToMemoryToggle=document.getElementById("savePromptToMemoryToggle"),MEMORY_INSTRUCTION=`SAVE TO MEMORY WITH THE EXACT INSTRUCTIONS SPECIFIED DO NOT REMOVE OR COMPRESS, SAVE EXACTLY AS IS

`;copyChatGPTPromptBtn&&copyChatGPTPromptBtn.addEventListener("click",async()=>{try{let e;if(window._serverChatGptPrompt)e=window._serverChatGptPrompt,console.log("[Popup] \u2705 Using server ChatGPT prompt (current session)");else{const n=await new Promise(s=>{chrome.storage.local.get(["serverChatGptPrompt"],i=>{s(i.serverChatGptPrompt)})});n?(e=n,console.log("[Popup] \u2705 Using cached server ChatGPT prompt")):(e=await(await fetch(chrome.runtime.getURL("USAGE.md"))).text(),console.log("[Popup] \u26A0\uFE0F Using local USAGE.md (server unavailable)"))}savePromptToMemoryToggle&&savePromptToMemoryToggle.checked&&(e=MEMORY_INSTRUCTION+e),await navigator.clipboard.writeText(e);const t=copyChatGPTPromptBtn.innerHTML,o=copyChatGPTPromptBtn.style.background;copyChatGPTPromptBtn.innerHTML="Copied",copyChatGPTPromptBtn.style.background="#22c55e",setTimeout(()=>{copyChatGPTPromptBtn.innerHTML=t,copyChatGPTPromptBtn.style.background=o},2e3)}catch(e){console.error("Failed to copy prompt:",e),copyChatGPTPromptBtn.innerHTML="Failed",setTimeout(()=>{copyChatGPTPromptBtn.innerHTML="Copy"},2e3)}});const donationWalletBtn=document.getElementById("donationWallet");donationWalletBtn&&donationWalletBtn.addEventListener("click",async e=>{e.preventDefault();const t="0x20E8D5f0BeA0fdffF470a6DBb89013Ff9Fd51933",o="4guoDVFaQc5qJQ8geLhCgUCJxdvWqmGXFAA6Ed26wXk8",n=document.createElement("div");n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;const s=document.body.classList.contains("dark-mode"),i=document.createElement("div");i.style.cssText=`
      background: ${s?"#1e1e1e":"rgba(255, 255, 255, 0.98)"};
      padding: 32px;
      border-radius: 16px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 12px 48px rgba(0, 0, 0, ${s?"0.6":"0.15"});
      color: ${s?"#e0e0e0":"#1a1a1a"};
      border: 1px solid ${s?"#333":"rgba(0, 0, 0, 0.05)"};
      backdrop-filter: blur(10px);
    `,i.innerHTML=`
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: ${s?"#e0e0e0":"#1a1a1a"};">Support ChemistryLaTeX</h3>
        <button id="closeWalletModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: ${s?"#aaa":"#999"}; padding: 0; line-height: 1;">&times;</button>
      </div>
      
      <p style="margin-bottom: 20px; color: ${s?"#ccc":"#555"}; line-height: 1.5; font-size: 13px;">
        If you find this extension helpful, consider supporting development.
      </p>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-size: 11px; font-weight: 600; color: ${s?"#999":"#666"}; margin-bottom: 6px;">ETH / L2</label>
        <div style="display: flex; align-items: center; gap: 8px; background: ${s?"#333":"#f5f5f5"}; padding: 10px 12px; border-radius: 8px;">
          <code id="ethAddress" style="font-family: monospace; font-size: 11px; color: ${s?"#fff":"#333"}; flex: 1; overflow: hidden; text-overflow: ellipsis;">${t}</code>
          <button id="copyEthBtn" style="background: ${s?"#444":"#1a1a1a"}; color: #fff; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; border: 1px solid ${s?"#555":"transparent"};">Copy</button>
        </div>
      </div>

      <div style="margin-bottom: 16px;">
        <label style="display: block; font-size: 11px; font-weight: 600; color: ${s?"#999":"#666"}; margin-bottom: 6px;">Solana</label>
        <div style="display: flex; align-items: center; gap: 8px; background: ${s?"#333":"#f5f5f5"}; padding: 10px 12px; border-radius: 8px;">
          <code id="solAddress" style="font-family: monospace; font-size: 11px; color: ${s?"#fff":"#333"}; flex: 1; overflow: hidden; text-overflow: ellipsis;">${o}</code>
          <button id="copySolBtn" style="background: ${s?"#444":"#1a1a1a"}; color: #fff; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; border: 1px solid ${s?"#555":"transparent"};">Copy</button>
        </div>
      </div>

      <div style="text-align: center; font-size: 11px; color: #999; margin-top: 16px;">Thank you!</div>
    `,n.appendChild(i),document.body.appendChild(n),document.getElementById("copyEthBtn").addEventListener("click",async()=>{await navigator.clipboard.writeText(t);const r=document.getElementById("copyEthBtn");r.textContent="Copied!",r.style.background="#27ae60",setTimeout(()=>{r.textContent="Copy",r.style.background="#000"},2e3)}),document.getElementById("copySolBtn").addEventListener("click",async()=>{await navigator.clipboard.writeText(o);const r=document.getElementById("copySolBtn");r.textContent="Copied!",r.style.background="#27ae60",setTimeout(()=>{r.textContent="Copy",r.style.background="#000"},2e3)}),document.getElementById("closeWalletModal").addEventListener("click",()=>{n.remove()}),n.addEventListener("click",r=>{r.target===n&&n.remove()})}),compound3DSizeSlider&&(compound3DSizeSlider.addEventListener("input",e=>{compound3DSizeValue.textContent=e.target.value+"%",broadcastSettingsChange({compound3DSize:parseInt(e.target.value)})}),compound3DSizeSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({compound3DSize:t},()=>{broadcastSettingsChange({compound3DSize:t}),showStatus("Compound 3D viewer size set to "+t+"%","success")})})),mineral3DSizeSlider&&(mineral3DSizeSlider.addEventListener("input",e=>{mineral3DSizeValue.textContent=e.target.value+"%",broadcastSettingsChange({mineral3DSize:parseInt(e.target.value)})}),mineral3DSizeSlider.addEventListener("change",e=>{const t=parseInt(e.target.value);chrome.storage.sync.set({mineral3DSize:t},()=>{broadcastSettingsChange({mineral3DSize:t}),showStatus("Mineral 3D viewer size set to "+t+"%","success")})}));const patchNotesBtn=document.getElementById("patchNotesBtn"),notesModal=document.getElementById("notesModal"),closeNotesModal=document.getElementById("closeNotesModal"),notesContent=document.getElementById("notesContent"),NOTES_SERVER="https://server-chemistryrenderer.vercel.app";let cachedNotes=null;patchNotesBtn&&notesModal&&(patchNotesBtn.addEventListener("click",async()=>{if(notesModal.classList.add("show"),cachedNotes)notesContent.textContent=cachedNotes;else{notesContent.textContent="Loading...";try{const t=await(await fetch(`${NOTES_SERVER}/api/note`)).json();t.success?(cachedNotes=t.note,notesContent.textContent=t.note):notesContent.textContent="Failed to load notes."}catch{notesContent.textContent="Could not connect to server."}}}),closeNotesModal.addEventListener("click",()=>{notesModal.classList.remove("show")}),notesModal.addEventListener("click",e=>{e.target===notesModal&&notesModal.classList.remove("show")}));const darkModeBtn=document.getElementById("darkModeBtn"),darkModeIcon=document.getElementById("darkModeIcon");function updateDarkModeIcon(e){darkModeIcon&&(e?darkModeIcon.innerHTML='<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>':darkModeIcon.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>')}darkModeBtn&&darkModeBtn.addEventListener("click",()=>{const e=document.body.classList.toggle("dark-mode");updateDarkModeIcon(e),opacitySlider&&blurSlider&&applyGlassmorphism(parseInt(blurSlider.value),parseInt(opacitySlider.value)),chrome.storage.sync.set({darkMode:e}),window.updateMoleculeAnimation&&window.updateMoleculeAnimation()});const CONFIG_SERVER="https://server-chemistryrenderer.vercel.app",CONFIG_CACHE_KEY="chemistrylatex_server_config",SEEN_ANNOUNCEMENTS_KEY="chemistrylatex_seen_announcements";async function fetchServerConfig(){try{const e=await new Promise(s=>{chrome.storage.local.get([CONFIG_CACHE_KEY],i=>s(i[CONFIG_CACHE_KEY]))}),t=e?Date.now()-(e.fetchedAt||0):1/0;if(e&&t<300*1e3){console.log("[Popup] \u{1F4E6} Using cached server config (age:",Math.round(t/1e3),"s)"),applyServerConfig(e.config);return}console.log("[Popup] \u{1F310} Fetching server config...");const o=await fetch(`${CONFIG_SERVER}/api/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`Server returned ${o.status}`);const n=await o.json();if(!n.success||!n.config)throw new Error("Invalid config response");chrome.storage.local.set({[CONFIG_CACHE_KEY]:{config:n.config,fetchedAt:Date.now()}}),console.log("[Popup] \u2705 Server config loaded:",n.config.version),applyServerConfig(n.config)}catch(e){console.warn("[Popup] \u26A0\uFE0F Could not fetch server config:",e.message)}}function applyServerConfig(e){if(!e)return;const t=document.getElementById("discordLink");t&&e.discordLink&&(t.href=e.discordLink,console.log("[Popup] \u{1F517} Discord link updated:",e.discordLink)),e.wallets&&(window._serverWallets=e.wallets,console.log("[Popup] \u{1F4B0} Wallet addresses loaded")),e.chatGptPrompt&&(window._serverChatGptPrompt=e.chatGptPrompt,chrome.storage.local.set({serverChatGptPrompt:e.chatGptPrompt}),console.log("[Popup] \u{1F916} ChatGPT prompt loaded")),e.patchNotes&&e.patchNotesVersion&&handlePatchNotesNotification(e.patchNotes,e.patchNotesVersion),e.defaultSettings&&applyDefaultSettings(e.defaultSettings),e.defaultUI&&applyDefaultUISettings(e.defaultUI),e.announcement&&showAnnouncement(e.announcement)}function handlePatchNotesNotification(e,t){window._serverPatchNotes=e,window._serverPatchNotesVersion=t,chrome.storage.local.get(["lastSeenPatchNotesVersion"],o=>{const s=o.lastSeenPatchNotesVersion!==t,i=e.startsWith("$important$"),r=e.startsWith("$notif$")||i,c=document.getElementById("patchNotesBtn"),l=document.getElementById("patchNotifDot");let d=e.replace("$important$","").replace("$notif$","").trim();window._serverPatchNotes=d,s&&r?(l&&(l.style.display="block"),i&&c&&c.classList.add("important","ringing"),console.log("[Popup] \u{1F514} New patch notes available (v"+t+")")):s&&l&&(l.style.display="block")})}function applyDefaultSettings(e){chrome.storage.sync.get(["userModifiedSettings"],t=>{const o=t.userModifiedSettings||{},n={};let s=0;for(const[i,r]of Object.entries(e))o[i]||(n[i]=r,s++);s>0&&chrome.storage.sync.set(n,()=>{console.log(`[Popup] \u{1F4DD} Applied ${s} default settings from server`)})})}function applyDefaultUISettings(e){chrome.storage.sync.get(["userModifiedUI"],t=>{const o=t.userModifiedUI||{},n={};let s=0;for(const[i,r]of Object.entries(e))o[i]||(n[i]=r,s++);s>0&&chrome.storage.sync.set(n,()=>{console.log(`[Popup] \u{1F3A8} Applied ${s} default UI settings from server`)})})}function showAnnouncement(e){!e||!e.id||chrome.storage.local.get([SEEN_ANNOUNCEMENTS_KEY],t=>{const o=t[SEEN_ANNOUNCEMENTS_KEY]||[];if(o.includes(e.id))return;const n=document.body.classList.contains("dark-mode"),s={info:"#2196F3",warning:"#ff9800",success:"#4CAF50"},i=s[e.type]||s.info,r=document.createElement("div");r.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: ${i};
      color: white;
      padding: 10px 16px;
      font-size: 13px;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `;const c=document.createElement("div");c.innerHTML=`
      <strong>${e.title||"Announcement"}</strong>
      <span style="margin-left: 8px;">${e.message||""}</span>
      ${e.link?`<a href="${e.link}" target="_blank" style="color: white; margin-left: 8px; text-decoration: underline;">Learn More</a>`:""}
    `;const l=document.createElement("button");l.textContent="\xD7",l.style.cssText=`
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0 4px;
    `,l.onclick=()=>{r.remove(),o.push(e.id),chrome.storage.local.set({[SEEN_ANNOUNCEMENTS_KEY]:o})},r.appendChild(c),r.appendChild(l),document.body.appendChild(r),setTimeout(()=>{r.parentNode&&(r.remove(),o.push(e.id),chrome.storage.local.set({[SEEN_ANNOUNCEMENTS_KEY]:o}))},1e4)})}fetchServerConfig();
