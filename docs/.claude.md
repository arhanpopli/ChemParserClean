# Chemparser Project

## Quick Overview
Chemistry visualization project with Chrome extension + backend servers for rendering molecules from text notation.

## Components

### 1. Chrome Extension (`chem-extension/`)
Detects `chem:molecule_name` or `chem:SMILES` syntax and displays molecule images.

**Key Files:**
- `content.js` - Main rendering logic (2500+ lines)
- `popup.html` + `popup.js` - Settings UI
- `manifest.json` - Extension configuration

**API Endpoints Used:**
- `http://localhost:5000` - MoleculeViewer (RDKit)
- `http://localhost:8000` - mol2chemfig (Docker)
- `http://localhost:5002` - PubChem (planned)

### 2. MoleculeViewer Server (Port 5000)
Node.js server using RDKit to generate SVG from SMILES.

**Files:**
- `MoleculeViewer/server.js` - Express server
- `MoleculeViewer/generate_svg.py` - Python RDKit backend
- `MoleculeViewer/cache/moleculeviewer/` - SVG cache

**Endpoints:**
- `GET /img/smiles?smiles=CCO` - Generate SVG from SMILES
- `GET /img/nomenclature?nomenclature=ethanol` - Generate from name
- `GET /health` - Health check
- `GET /cache-info` - Cache statistics

### 3. mol2chemfig Backend (Port 8000)
Docker container converting molecules to ChemFig LaTeX + SVG.

**Files:**
- `docker-compose.yml` - Container config
- `m2cf_fixed.py` - Main backend (mounted to container)
- `.env` - Port configuration

**Endpoints:**
- `POST /m2cf/submit` - Convert SMILES/MOL to chemfig
- `GET /m2cf/search?searchTerm=aspirin` - Search by name
- `POST /m2cf/apply` - Apply options to molecule

**Recent Changes:**
- âœ… SVG size increased: 16pt â†’ 28pt atom separation
- âœ… Font size increased: 8pt â†’ 12pt
- âœ… Dark mode colors fixed in extension

### 4. mol2chemfig Wrapper (Port 5001)
Optional Flask wrapper for persistent storage.

**Files:**
- `mol2chemfig_server.py` - Flask server
- `cache/mol2chemfig/` - Persistent cache

### 5. PubChem Server (Port 5002) - IN PROGRESS
Fetches images and 3D models from PubChem API.

## Testing

### Start All Servers
```bash
# Terminal 1 - MoleculeViewer
cd MoleculeViewer && node server.js

# Terminal 2 - mol2chemfig Docker
docker-compose up -d

# Terminal 3 - mol2chemfig wrapper (optional)
python mol2chemfig_server.py

# Terminal 4 - Test runner
python test_runner.py
```

### Test Endpoints
```bash
# MoleculeViewer
curl "http://localhost:5000/img/smiles?smiles=CCO"

# mol2chemfig
curl -X POST http://localhost:8000/m2cf/submit \
  -H "Content-Type: application/json" \
  -d '{"textAreaData":"CCO"}'
```

## Development Workflow

### Extension Changes
1. Edit files in `chem-extension/`
2. Reload extension at `chrome://extensions`
3. Test on any webpage

### Backend Changes
1. **MoleculeViewer**: Edit files â†’ restart Node server
2. **mol2chemfig**: Edit `m2cf_fixed.py` â†’ restart Docker: `docker-compose restart backend`
3. Test with curl or extension

## Common Tasks

### Clear Caches
```bash
# MoleculeViewer
curl -X DELETE http://localhost:5000/clear-cache

# mol2chemfig
curl -X POST http://localhost:5001/api/cache/clear

# Manual
rm -rf MoleculeViewer/cache/moleculeviewer/*
rm -rf cache/mol2chemfig/*
```

### View Logs
```bash
# Docker logs
docker-compose logs -f backend

# Node server (visible in terminal)
cd MoleculeViewer && node server.js
```

## File Structure
```
Chemparser/
â”œâ”€â”€ chem-extension/          # Chrome extension
â”‚   â”œâ”€â”€ content.js           # Main logic
â”‚   â”œâ”€â”€ popup.html           # Settings UI
â”‚   â””â”€â”€ manifest.json        # Config
â”œâ”€â”€ MoleculeViewer/          # RDKit server
â”‚   â”œâ”€â”€ server.js            # Node server
â”‚   â”œâ”€â”€ generate_svg.py      # Python backend
â”‚   â””â”€â”€ cache/moleculeviewer/ # Cache
â”œâ”€â”€ m2cf_fixed.py            # mol2chemfig backend
â”œâ”€â”€ mol2chemfig_server.py    # Flask wrapper
â”œâ”€â”€ cache/mol2chemfig/       # mol2chemfig cache
â”œâ”€â”€ docker-compose.yml       # Docker config
â”œâ”€â”€ test_runner.py           # Test suite
â””â”€â”€ CLAUDE_CONTEXT.md        # Detailed docs
```

## Current Status (Updated: 2025-11-09)

### âœ… Completed (8/12 tasks - 67%)
1. Test infrastructure (`test_runner.py`)
2. mol2chemfig SVG size increase (28pt/12pt)
3. Dark mode color fixes for mol2chemfig
4. Separate cache folders for each server
5. Settings persistence for chemfig options
6. PubChem 3D integration (port 5002)
7. Auto-approval setup
8. Documentation

### ðŸ”„ In Progress (4 Agents Working in Parallel)

**Agent 1: Size Controls Agent**
- Task: Image size controls with up/down arrows
- Files: `chem-extension/content.js`, `popup.html`, `popup.js`
- Spec: Todolist.md lines 5-7
- Requirements:
  * Add up/down arrows in bottom left of each image
  * Developer Option 1: Save per-page (URL + image key)
  * Developer Option 2: Save per-molecule (SMILES key)
  * Test: Resize histamine, reload â†’ size persists

**Agent 2: UI Design Agent**
- Task: Create 10 different popup UI designs
- Files: `chem-extension/popup.html` + styles
- Spec: Todolist.md lines 10-11
- Requirements:
  * 10 DIFFERENT layouts (not just colors)
  * Keep all functionality intact
  * Modern, dark, minimal, cards, sidebar, glassmorphism, cyberpunk, neumorphism, material, retro

**Agent 3: OPSIN Agent**
- Task: 3D nomenclature with OPSIN API
- Files: `m2cf_fixed.py`, `content.js`, `popup.html`
- Spec: Todolist.md line 18
- Requirements:
  * Integrate OPSIN API: `https://opsin.ch.cam.ac.uk/opsin/{name}.smi`
  * Support 3D SMILES: `O=C[C@H](O)[C@@H](O)[C@H](O)[C@H](O)CO`
  * Add toggle in extension popup
  * Test with glucose, alanine

**Agent 4: Cache Agent**
- Task: Cache deduplication using canonical SMILES
- Files: `MoleculeViewer/server.js`, `mol2chemfig_server.py`
- Spec: Todolist.md line 19
- Requirements:
  * Use RDKit to canonicalize SMILES before hashing
  * Merge duplicates (e.g., "ethanol" + "CCO" â†’ one file)
  * Update cache key generation
  * Scan and deduplicate existing cache

## Important Notes

- **Docker restart required** after editing `m2cf_fixed.py`
- **Extension reload required** after editing extension files
- **SVG colors**: Mix of `#000000`, `stroke='black'`, `stroke="black"`
- **Cache separation**: Each server has dedicated cache folder
- **Port conflicts**: Ensure ports 5000, 5001, 5002, 8000, 8080 are available

## Troubleshooting

### Extension not showing molecules
1. Check all servers are running
2. Check browser console for errors
3. Reload extension at `chrome://extensions`
4. Verify API URLs in `content.js` lines 11-12

### Docker container won't start
```bash
docker rm -f m2cf_backend m2cf_frontend
docker-compose up -d
```

### Changes not taking effect
- **Backend**: Restart Docker: `docker-compose restart backend`
- **Extension**: Reload at `chrome://extensions`
- **MoleculeViewer**: Restart Node: Kill terminal â†’ restart

## Resources
- Full detailed todos: `MoleculeViewer/docs/Todolist.md`
- Agent context: `CLAUDE_CONTEXT.md`
- Implementation docs: `CACHE_SEPARATION_IMPLEMENTATION.md`, etc.
