/**
 * ChemistryLaTeX - Independent Client-Side Edition
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * Unauthorized copying, modification, or distribution of this software is prohibited.
 */
console.log("[ChemistryLaTeX] Background service worker loaded"),chrome.runtime.onMessage.addListener((e,s,r)=>{if(e.type==="FETCH_API")return console.log("[Background] FETCH_API request:",e.url),handleFetchRequest(e.url,e.options).then(t=>{console.log("[Background] FETCH_API success"),r({success:!0,data:t})}).catch(t=>{console.error("[Background] FETCH_API error:",t.message),r({success:!1,error:t.message})}),!0;if(e.type==="FETCH_BLOB")return console.log("[Background] FETCH_BLOB request:",e.url),handleBlobRequest(e.url).then(t=>{console.log("[Background] FETCH_BLOB success"),r({success:!0,data:t})}).catch(t=>{console.error("[Background] FETCH_BLOB error:",t.message),r({success:!1,error:t.message})}),!0;if(e.type==="FETCH_TEXT")return console.log("[Background] FETCH_TEXT request:",e.url),handleTextRequest(e.url,e.options).then(t=>{console.log("[Background] FETCH_TEXT success"),r({success:!0,data:t})}).catch(t=>{console.error("[Background] FETCH_TEXT error:",t.message),r({success:!1,error:t.message})}),!0});async function handleFetchRequest(e,s={}){try{console.log("[Background] handleFetchRequest called with:",{url:e,options:s});const r={method:s.method||"GET",headers:{Accept:"application/json",...s.headers}};s.body&&s.method&&s.method.toUpperCase()!=="GET"&&(r.body=s.body),console.log("[Background] Final fetch options:",r);const t=await fetch(e,r);if(console.log("[Background] Response status:",t.status,t.statusText),!t.ok){const c=await t.text();throw console.error("[Background] Error response body:",c),new Error(`HTTP ${t.status}: ${t.statusText}`)}const o=await t.json();return console.log("[Background] Response data received, keys:",Object.keys(o)),o}catch(r){throw console.error("[Background] Fetch error:",r),r}}async function handleBlobRequest(e){try{const s=await fetch(e);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const r=await s.blob();return{base64:await blobToBase64(r),type:r.type}}catch(s){throw console.error("[Background] Blob fetch error:",s),s}}async function handleTextRequest(e,s={}){console.log("[Background] handleTextRequest called with:",{url:e,options:s});try{let r;try{r=new URL(e),console.log("[Background] Parsed URL:",r.href,"Protocol:",r.protocol)}catch(n){throw console.error("[Background] Invalid URL:",e,n),new Error(`Invalid URL: ${e}`)}const t={method:s.method||"GET",headers:{Accept:"text/plain, */*",...s.headers||{}},mode:"cors",credentials:"omit"};s.body&&t.method.toUpperCase()!=="GET"&&(t.body=s.body),console.log("[Background] Fetching with options:",JSON.stringify(t));const o=await fetch(e,t);if(console.log("[Background] Response received:",{status:o.status,statusText:o.statusText,ok:o.ok,type:o.type,url:o.url,headers:Object.fromEntries([...o.headers.entries()])}),!o.ok){const n=await o.text().catch(()=>"(could not read error body)");throw console.error("[Background] HTTP Error response body:",n),new Error(`HTTP ${o.status}: ${o.statusText} - ${n.substring(0,200)}`)}const c=await o.text();return console.log("[Background] Text response received, length:",c.length,"preview:",c.substring(0,150)),c.includes("<?xml")||c.includes("<svg")?console.log("[Background] \u2705 Valid SVG detected"):console.warn("[Background] \u26A0\uFE0F Response may not be valid SVG"),c}catch(r){throw console.error("[Background] Text fetch error:",{message:r.message,name:r.name,stack:r.stack,url:e}),r}}function blobToBase64(e){return new Promise((s,r)=>{const t=new FileReader;t.onloadend=()=>{const o=t.result.split(",")[1];s(o)},t.onerror=r,t.readAsDataURL(e)})}chrome.tabs.onUpdated.addListener((e,s,r)=>{s.status==="complete"&&console.log("[ChemistryLaTeX] Tab updated:",r.url)}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"inspect-molecule",title:"Render as Molecule: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"render-smiles",title:"Render as SMILES: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"render-biomolecule",title:"Render as Biomolecule: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"render-mineral",title:"Render as Mineral: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"render-iupac",title:"Render as IUPAC: '%s'",contexts:["selection"]}),chrome.contextMenus.create({id:"rerender-parent",title:"ChemistryLaTeX: Re-render as...",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-molecule",parentId:"rerender-parent",title:"Molecule (PubChem)",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-smiles",parentId:"rerender-parent",title:"SMILES (direct render)",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-biomolecule",parentId:"rerender-parent",title:"Biomolecule (RCSB PDB)",contexts:["image"]}),chrome.contextMenus.create({id:"rerender-mineral",parentId:"rerender-parent",title:"Mineral (COD)",contexts:["image"]}),chrome.contextMenus.create({id:"separator-flags",parentId:"rerender-parent",type:"separator",contexts:["image"]}),chrome.contextMenus.create({id:"edit-flags",parentId:"rerender-parent",title:"Edit Flags...",contexts:["image"]})}),chrome.runtime.onMessage.addListener((e,s,r)=>{if(e.type==="SETTINGS_CHANGED")return console.log("[Background] Broadcasting settings change to all tabs:",e.settings,"Changed keys:",e.changedKeys),chrome.tabs.query({},t=>{t.forEach(o=>{o.url&&!o.url.startsWith("chrome://")&&!o.url.startsWith("edge://")&&chrome.tabs.sendMessage(o.id,{type:"APPLY_SETTINGS",settings:e.settings,changedSettings:e.changedKeys||[]}).catch(()=>{})})}),r({success:!0}),!0;if(e.type==="RELOAD_ALL_IMAGES")return console.log("[Background] Broadcasting reload all images to all tabs"),chrome.tabs.query({},t=>{t.forEach(o=>{o.url&&!o.url.startsWith("chrome://")&&!o.url.startsWith("edge://")&&chrome.tabs.sendMessage(o.id,{type:"RELOAD_ALL_IMAGES"}).catch(()=>{})})}),r({success:!0}),!0;if(e.type==="CLEAR_CACHE")return console.log("[Background] Broadcasting clear cache to all tabs"),chrome.tabs.query({},t=>{t.forEach(o=>{o.url&&!o.url.startsWith("chrome://")&&!o.url.startsWith("edge://")&&chrome.tabs.sendMessage(o.id,{type:"CLEAR_CACHE"}).catch(()=>{})})}),r({success:!0}),!0}),chrome.contextMenus.onClicked.addListener((e,s)=>{if(e.menuItemId==="inspect-molecule"){const r=e.selectionText;console.log("[Background] Inspecting molecule (nomenclature):",r),chrome.tabs.sendMessage(s.id,{type:"INSPECT_MOLECULE",text:r})}if(e.menuItemId==="render-smiles"){const r=e.selectionText;console.log("[Background] Rendering as SMILES:",r),chrome.tabs.sendMessage(s.id,{type:"RENDER_SMILES",text:r})}if(e.menuItemId==="render-biomolecule"){const r=e.selectionText;console.log("[Background] Rendering as Biomolecule (RCSB PDB):",r),chrome.tabs.sendMessage(s.id,{type:"RENDER_BIOMOLECULE",text:r})}if(e.menuItemId==="render-mineral"){const r=e.selectionText;console.log("[Background] Rendering as Mineral (COD):",r),chrome.tabs.sendMessage(s.id,{type:"RENDER_MINERAL",text:r})}if(e.menuItemId==="render-iupac"){const r=e.selectionText;console.log("[Background] Rendering as IUPAC (OPSIN):",r),chrome.tabs.sendMessage(s.id,{type:"RENDER_IUPAC",text:r})}e.menuItemId==="rerender-molecule"&&(console.log("[Background] Re-rendering image as Molecule (auto-detect)"),chrome.tabs.sendMessage(s.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"molecule"})),e.menuItemId==="rerender-smiles"&&(console.log("[Background] Re-rendering image as SMILES"),chrome.tabs.sendMessage(s.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"smiles"})),e.menuItemId==="rerender-biomolecule"&&(console.log("[Background] Re-rendering image as Biomolecule"),chrome.tabs.sendMessage(s.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"biomolecule"})),e.menuItemId==="rerender-mineral"&&(console.log("[Background] Re-rendering image as Mineral"),chrome.tabs.sendMessage(s.id,{type:"RERENDER_IMAGE",srcUrl:e.srcUrl,renderAs:"mineral"})),e.menuItemId==="edit-flags"&&(console.log("[Background] Opening flag editor for image"),chrome.tabs.sendMessage(s.id,{type:"EDIT_FLAGS",srcUrl:e.srcUrl}))});
