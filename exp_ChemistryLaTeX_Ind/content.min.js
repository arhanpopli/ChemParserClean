/**
 * ChemistryLaTeX - Independent Client-Side Edition
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * Unauthorized copying, modification, or distribution of this software is prohibited.
 */
const CHEMTEX_CACHE_VERSION="v7-client";let cacheBustTimestamp="";const API_ENDPOINTS={PUBCHEM_NAME_TO_CID:"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/",PUBCHEM_CID_PROPS:"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/",PUBCHEM_AUTOCOMPLETE:"https://pubchem.ncbi.nlm.nih.gov/rest/autocomplete/compound/",RCSB_SEARCH:"https://search.rcsb.org/rcsbsearch/v2/query",RCSB_ENTRY:"https://data.rcsb.org/rest/v1/core/entry/",RCSB_STRUCTURE_IMG:"https://cdn.rcsb.org/images/structures/",COD_SEARCH:"https://www.crystallography.net/cod/result",COD_CIF:"https://www.crystallography.net/cod/",OPSIN_IUPAC:"https://opsin.ch.cam.ac.uk/opsin/"};let globalSmilesDrawerInstance=null,globalSvgDrawerInstance=null,smilesDrawerOptions=null;function getOrCreateSvgDrawer(e={}){if(!window.SmilesDrawer)return console.error("[exp_ChemistryLaTeX_Ind] SmilesDrawer not loaded!"),null;const t=JSON.stringify(e);return(!globalSvgDrawerInstance||smilesDrawerOptions!==t)&&(globalSvgDrawerInstance=new SmilesDrawer.SvgDrawer(e),smilesDrawerOptions=t),globalSvgDrawerInstance}const parseQueue=[];let isParsingActive=!1;const MAX_CONCURRENT_PARSES=2;let activeParseCount=0;function queueSmilesDrawerParse(e,t,o){parseQueue.push({smiles:e,successCallback:t,errorCallback:o}),processParseQueue()}function processParseQueue(){if(activeParseCount>=MAX_CONCURRENT_PARSES||parseQueue.length===0)return;activeParseCount++;const{smiles:e,successCallback:t,errorCallback:o}=parseQueue.shift();try{if(!window.SmilesDrawer){o(new Error("SmilesDrawer not available")),activeParseCount--,processParseQueue();return}SmilesDrawer.parse(e,n=>{t(n),activeParseCount--,processParseQueue()},n=>{o(n),activeParseCount--,processParseQueue()})}catch(n){o(n),activeParseCount--,processParseQueue()}}async function backgroundFetchJSON(e,t=15e3){return new Promise((o,n)=>{const r=setTimeout(()=>n(new Error("Timeout")),t);chrome.runtime.sendMessage({type:"FETCH_JSON",url:e},i=>{if(clearTimeout(r),chrome.runtime.lastError){directFetchJSON(e,t).then(o).catch(n);return}i&&i.success?o(i.data):n(new Error((i==null?void 0:i.error)||"Background fetch failed"))})})}async function directFetchJSON(e,t=15e3){const o=new AbortController,n=setTimeout(()=>o.abort(),t);try{const r=await fetch(e,{signal:o.signal});if(clearTimeout(n),!r.ok)throw new Error(`HTTP ${r.status}`);return await r.json()}catch(r){throw clearTimeout(n),r}}async function queryPubChemByName(e){var t,o;console.log("%c\u{1F9EA} Querying PubChem for:","color: #2196F3; font-weight: bold;",e);try{const n=`${API_ENDPOINTS.PUBCHEM_NAME_TO_CID}${encodeURIComponent(e)}/cids/JSON`,r=await backgroundFetchJSON(n);if(!r.IdentifierList||!r.IdentifierList.CID||r.IdentifierList.CID.length===0)return console.warn("%c\u26A0\uFE0F PubChem: No CID found for","color: #FF9800;",e),null;const i=r.IdentifierList.CID[0];console.log("%c\u2705 PubChem CID:","color: #4CAF50;",i);const l=`${API_ENDPOINTS.PUBCHEM_CID_PROPS}${i}/property/CanonicalSMILES,IsomericSMILES,MolecularFormula,Title,IUPACName/JSON`,s=await backgroundFetchJSON(l);if(!s.PropertyTable||!s.PropertyTable.Properties||s.PropertyTable.Properties.length===0)return console.warn("%c\u26A0\uFE0F PubChem: No properties found for CID","color: #FF9800;",i),null;const u=s.PropertyTable.Properties[0];return{cid:i,canonicalSmiles:(t=u.CanonicalSMILES)==null?void 0:t.replace(/\s+/g,""),isomericSmiles:(o=u.IsomericSMILES)==null?void 0:o.replace(/\s+/g,""),formula:u.MolecularFormula,name:u.Title,iupacName:u.IUPACName}}catch(n){return console.warn("%c\u26A0\uFE0F PubChem query failed:","color: #FF9800;",n.message),null}}async function queryPubChemAutocomplete(e){try{const t=`${API_ENDPOINTS.PUBCHEM_AUTOCOMPLETE}${encodeURIComponent(e)}/json?limit=5`,o=await backgroundFetchJSON(t);return o.dictionary_terms&&o.dictionary_terms.compound?o.dictionary_terms.compound:[]}catch(t){return console.warn("%c\u26A0\uFE0F PubChem autocomplete failed:","color: #FF9800;",t.message),[]}}async function queryOPSIN(e){console.log("%c\u{1F52C} Querying OPSIN for IUPAC:","color: #FF5722; font-weight: bold;",e);try{const t=`${API_ENDPOINTS.OPSIN_IUPAC}${encodeURIComponent(e)}.json`,o=await backgroundFetchJSON(t);return o&&o.smiles?(console.log("%c\u2705 OPSIN SMILES:","color: #4CAF50;",o.smiles),o.smiles):null}catch(t){return console.warn("%c\u26A0\uFE0F OPSIN query failed:","color: #FF9800;",t.message),null}}async function queryRCSB(e){var t,o;console.log("%c\u{1F9EC} Querying RCSB for:","color: #E91E63; font-weight: bold;",e);try{const n={query:{type:"terminal",service:"full_text",parameters:{value:e}},return_type:"entry",request_options:{return_all_hits:!1,paginate:{start:0,rows:5}}},r=await fetch(API_ENDPOINTS.RCSB_SEARCH,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok)throw new Error(`RCSB search returned ${r.status}`);const i=await r.json();if(!i.result_set||i.result_set.length===0)return console.warn("%c\u26A0\uFE0F RCSB: No results for","color: #FF9800;",e),null;const l=i.result_set[0].identifier;console.log("%c\u2705 RCSB PDB ID:","color: #4CAF50;",l);try{const s=`${API_ENDPOINTS.RCSB_ENTRY}${l}`,u=await backgroundFetchJSON(s),c=((t=u.struct)==null?void 0:t.title)||((o=u.rcsb_entry_info)==null?void 0:o.title)||e;return{pdbid:l,title:c,imageUrl:`${API_ENDPOINTS.RCSB_STRUCTURE_IMG}${l.toLowerCase()}_model-1.jpeg`}}catch{return{pdbid:l,title:e,imageUrl:`${API_ENDPOINTS.RCSB_STRUCTURE_IMG}${l.toLowerCase()}_model-1.jpeg`}}}catch(n){return console.warn("%c\u26A0\uFE0F RCSB query failed:","color: #FF9800;",n.message),null}}async function queryCOD(e){console.log("%c\u{1F48E} Querying COD for:","color: #00BCD4; font-weight: bold;",e);try{const t=`${API_ENDPOINTS.COD_SEARCH}?text=${encodeURIComponent(e)}&format=json`,o=await backgroundFetchJSON(t);if(!o||!Array.isArray(o)||o.length===0)return console.warn("%c\u26A0\uFE0F COD: No results for","color: #FF9800;",e),null;const n=o[0],r=n.file||n.id;console.log("%c\u2705 COD ID:","color: #4CAF50;",r);let i=null;try{const l=`${API_ENDPOINTS.COD_CIF}${r}.cif`,s=await fetch(l);if(s.ok){const c=(await s.text()).match(/_chemical_smiles_canonical\s+['"]?([^'"\r\n]+)['"]?/i);c&&(i=c[1].trim())}}catch(l){console.warn("%c\u26A0\uFE0F CIF fetch failed:","color: #FF9800;",l.message)}return{codid:r,name:n.commonname||n.chemname||e,formula:n.formula,smiles:i}}catch(t){return console.warn("%c\u26A0\uFE0F COD query failed:","color: #FF9800;",t.message),null}}async function queryMineralNamesFallback(e){console.log("%c\u{1F48E} Trying MineralNames.js fallback for:","color: #FF9800; font-weight: bold;",e);try{if(!window.MineralNames){const t=chrome.runtime.getURL("MineralNames.js");await new Promise((o,n)=>{const r=document.createElement("script");r.src=t,r.onload=o,r.onerror=n,document.head.appendChild(r)})}if(window.MineralNames&&window.MineralNames.lookup){const t=window.MineralNames.lookup(e);if(t)return console.log("%c\u2705 MineralNames fallback found:","color: #4CAF50;",t),t}return null}catch(t){return console.warn("%c\u26A0\uFE0F MineralNames fallback failed:","color: #FF9800;",t.message),null}}const ELEMENT_MARKERS={C:"#101010",H:"#181818",N:"#202020",O:"#282828",S:"#303030",P:"#383838",F:"#404040",CL:"#484848",BR:"#505050",I:"#585858",B:"#606060",SI:"#686868",ATOM_NUMBER:"#707070"},THEME_COLORS={light:{C:"#222222",H:"#666666",N:"#3498db",O:"#e74c3c",S:"#f1c40f",P:"#d35400",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",B:"#e67e22",SI:"#e67e22",ATOM_NUMBER:"#2196F3"},dark:{C:"#ffffff",H:"#aaaaaa",N:"#4dabf7",O:"#ff6b6b",S:"#fcc419",P:"#fd7e14",F:"#51cf66",CL:"#20c997",BR:"#fd7e14",I:"#be4bdb",B:"#f59f00",SI:"#f59f00",ATOM_NUMBER:"#ffd700"},classic_black:{C:"#000000",H:"#000000",N:"#000000",O:"#000000",S:"#000000",P:"#000000",F:"#000000",CL:"#000000",BR:"#000000",I:"#000000",B:"#000000",SI:"#000000",ATOM_NUMBER:"#000000"},classic_white:{C:"#ffffff",H:"#ffffff",N:"#ffffff",O:"#ffffff",S:"#ffffff",P:"#ffffff",F:"#ffffff",CL:"#ffffff",BR:"#ffffff",I:"#ffffff",B:"#ffffff",SI:"#ffffff",ATOM_NUMBER:"#ffffff"},warm_paper:{C:"#586e75",H:"#657b83",N:"#268bd2",O:"#dc322f",S:"#b58900",P:"#d33682",F:"#859900",CL:"#16a085",BR:"#cb4b16",I:"#6c71c4",B:"#2aa198",SI:"#2aa198",ATOM_NUMBER:"#2196F3"},terminal_green:{C:"#00FF41",H:"#008F11",N:"#003B00",O:"#0D0208",S:"#00FF41",P:"#00FF41",F:"#00FF41",CL:"#00FF41",BR:"#00FF41",I:"#00FF41",B:"#00FF41",SI:"#00FF41",ATOM_NUMBER:"#00FF41"},modern_dark:{C:"#c9d1d9",H:"#8b949e",N:"#58a6ff",O:"#f85149",S:"#d29922",P:"#db6d28",F:"#3fb950",CL:"#3fb950",BR:"#db6d28",I:"#a371f7",B:"#db6d28",SI:"#db6d28",ATOM_NUMBER:"#58a6ff"},carbon:{C:"#f4f4f4",H:"#a8a8a8",N:"#4589ff",O:"#fa4d56",S:"#f1c21b",P:"#ff832b",F:"#42be65",CL:"#42be65",BR:"#ff832b",I:"#a56eff",B:"#ff832b",SI:"#ff832b",ATOM_NUMBER:"#4589ff"}};function applyThemeColors(e,t){const o=THEME_COLORS[t]||THEME_COLORS.light;let n=e;for(const[r,i]of Object.entries(ELEMENT_MARKERS)){const l=o[r]||i,s=new RegExp(i,"gi");n=n.replace(s,l)}return console.log("%c\u{1F3A8} Applied theme colors:","color: #9C27B0;",t),n}window.addEventListener("error",function(e){if(e.filename&&e.filename.includes("chrome-extension://"))return console.error("[ChemRenderer] \u{1F6E1}\uFE0F Caught unhandled error:",e.message),e.preventDefault(),!0}),window.addEventListener("unhandledrejection",function(e){const t=e.reason;if(t&&t.stack&&t.stack.includes("ChemRenderer"))return console.error("[ChemRenderer] \u{1F6E1}\uFE0F Caught unhandled promise rejection:",t),e.preventDefault(),!0;if(t&&t.message&&t.message.includes("Extension context invalidated"))return console.warn("[ChemRenderer] Extension context invalidated, ignoring..."),e.preventDefault(),!0});const LOG_PREFIX="[ChemRenderer]",log={info:(e,t)=>console.log(`${LOG_PREFIX} [INFO] ${e}`,t||""),success:(e,t)=>console.log(`%c${LOG_PREFIX} [SUCCESS] ${e}`,"color: green; font-weight: bold;",t||""),warn:(e,t)=>console.warn(`${LOG_PREFIX} [WARN] ${e}`,t||""),error:(e,t)=>console.error(`${LOG_PREFIX} [ERROR] ${e}`,t||""),debug:(e,t)=>console.debug(`${LOG_PREFIX} [DEBUG] ${e}`,t||""),inject:(e,t)=>console.log(`%c${LOG_PREFIX} [INJECT] ${e}`,"color: blue; font-weight: bold;",t||"")};let logHistory=[],extensionContextInvalid=!1;const renderedImageCache=new Map,MAX_IMAGE_CACHE_SIZE=100;function generateImageCacheKey(e,t={}){const o=[t.showCarbons?"c1":"c0",t.showMethyls?"m1":"m0",t.aromaticCircles?"a1":"a0",t.showHydrogens?"h1":"h0",t.atomNumbers?"n1":"n0",t.theme||"light",t.width||300,t.height||240].join("_");return`${e}__${o}`}const SMILES_CACHE_KEY="chemistrylatex_smiles_cache",SMILES_CACHE_MAX_SIZE=500;let smilesCache={},smilesCacheLoaded=!1;async function loadSmilesCache(){if(smilesCacheLoaded)return smilesCache;try{smilesCache=(await chrome.storage.local.get(SMILES_CACHE_KEY))[SMILES_CACHE_KEY]||{},smilesCacheLoaded=!0,log.info(`\u{1F4E6} Loaded SMILES cache: ${Object.keys(smilesCache).length} entries`)}catch(e){log.warn("Failed to load SMILES cache:",e),smilesCache={}}return smilesCache}async function saveSmilesCache(){try{const e=Object.keys(smilesCache);if(e.length>SMILES_CACHE_MAX_SIZE){const t=e.length-SMILES_CACHE_MAX_SIZE;e.slice(0,t).forEach(o=>delete smilesCache[o])}await chrome.storage.local.set({[SMILES_CACHE_KEY]:smilesCache})}catch(e){log.warn("Failed to save SMILES cache:",e)}}async function getCachedSmiles(e){await loadSmilesCache();const t=e.toLowerCase().trim(),o=smilesCache[t];return o?(log.debug(`\u{1F3AF} SMILES cache HIT: ${e}`),o.smiles&&!o.canonicalSmiles&&!o.isomericSmiles&&(log.debug(`\u{1F504} Migrating old cache format for: ${e}`),o.isomericSmiles=o.smiles,o.canonicalSmiles=stripStereochemistry(o.smiles),delete o.smiles,smilesCache[t]=o,clearTimeout(setCachedSmiles._saveTimeout),setCachedSmiles._saveTimeout=setTimeout(()=>saveSmilesCache(),1e3)),o):null}async function setCachedSmiles(e,t){var r,i;await loadSmilesCache();const o=e.toLowerCase().trim();smilesCache[o]={...t,cachedAt:Date.now()},clearTimeout(setCachedSmiles._saveTimeout),setCachedSmiles._saveTimeout=setTimeout(()=>saveSmilesCache(),1e3);const n=t.isomericSmiles||t.canonicalSmiles||"N/A";log.debug(`\u{1F4E6} Cached SMILES: ${e} \u2192 canonical: ${((r=t.canonicalSmiles)==null?void 0:r.substring(0,25))||"N/A"}, isomeric: ${((i=t.isomericSmiles)==null?void 0:i.substring(0,25))||"N/A"}`)}const pendingSearches=new Map,MAX_PENDING_SEARCHES=50;async function getOrCreatePendingSearch(e,t){const o=e.toLowerCase().trim();if(pendingSearches.has(o))return log.debug(`\u{1F504} Reusing pending search for: ${e}`),pendingSearches.get(o);pendingSearches.size>=MAX_PENDING_SEARCHES&&(log.warn(`\u26A0\uFE0F Too many pending searches (${pendingSearches.size}), clearing old ones...`),Array.from(pendingSearches.keys()).slice(0,Math.floor(MAX_PENDING_SEARCHES/2)).forEach(i=>pendingSearches.delete(i)));const n=t().finally(()=>{pendingSearches.delete(o)});return pendingSearches.set(o,n),log.debug(`\u{1F195} Started new search for: ${e}`),n}function clearAllCaches(){renderedImageCache.clear(),smilesCache={},smilesCacheLoaded=!1,pendingSearches.clear(),chrome.storage.local.remove(SMILES_CACHE_KEY),cacheBustTimestamp=Date.now().toString(),log.info(`\u{1F5D1}\uFE0F Cache cleared! New cache bust timestamp: ${cacheBustTimestamp}`),console.log("%c\u{1F5D1}\uFE0F CACHE CLEARED - All new SVG requests will bypass browser cache","background: #F44336; color: white; font-weight: bold; padding: 8px;")}function stripStereochemistry(e){return e&&e.replace(/@@|@|\/|\\/g,"")}const renderedMolecules=new Map;function getAffectedImageTypes(e){const t=new Set,o=["sdShowCarbons","sdAromaticRings","sdShowMethyls","sdAtomNumbers","sdShowExplicitHydrogens","sdShowImplicitHydrogens","sdFlipHorizontal","sdFlipVertical","sdTheme","sdAutoAdapt","sdRotate","sdBondThickness","sdGradientColors","sdScaleByWeight","m2cfShowCarbons","m2cfAromaticCircles","m2cfShowMethyls","m2cfAtomNumbers","m2cfAddH2","m2cfShowImplicitH","m2cfFlipHorizontal","m2cfFlipVertical"],n=["molviewRepresentation","compoundMolviewBgColor","molviewEngine"],r=["proteinRemoveWhiteBg","viewer3DStyle","viewer3DAutoRotate","viewer3DBgColor","viewer3DSize","molviewChainType","molviewChainBonds","molviewChainColor","proteinMolviewBgColor","molviewBioAssembly"],i=["mineralRepresentation","mineralMolviewBgColor","mineralCrystallography"],l=["performanceMode","enableAIFlagControl"],s=Object.keys(e);for(const u of s)(o.includes(u)||n.includes(u))&&t.add("compound"),r.includes(u)&&t.add("biomolecule"),i.includes(u)&&t.add("mineral"),l.includes(u)&&(t.add("compound"),t.add("biomolecule"),t.add("mineral"));return t.size===0&&(t.add("compound"),t.add("biomolecule"),t.add("mineral")),t}async function reRenderAllMolecules(e){return log.info("\u{1F504} Re-rendering all molecules with lazy loading..."),lazyReRenderMolecules(e)}let pendingReRenderSettings=null,pendingUpdateIndicator=null,isUpdatingImages=!1;function addLoadingIndicator(e){if(e.dataset.hasLoadingIndicator==="true")return;const t=document.createElement("div");t.className="chemistrylatex-image-loading-indicator",t.setAttribute("aria-label","Updating image"),t.style.cssText=`
    position: absolute;
    top: 50%;
    left: 10px;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid rgba(255, 71, 87, 0.25);
    border-top-color: #ff4757;
    z-index: 10;
    animation: chemtex-spin 0.9s linear infinite;
    pointer-events: none;
  `;const o=e.parentElement;if(o&&(window.getComputedStyle(o).position==="static"&&(o.style.position="relative"),o.appendChild(t)),!document.getElementById("chemtex-loading-indicator-style")){const n=document.createElement("style");n.id="chemtex-loading-indicator-style",n.textContent=`
      @keyframes chemtex-spin {
        from { transform: translateY(-50%) rotate(0deg); }
        to { transform: translateY(-50%) rotate(360deg); }
      }
      @keyframes chemtex-fade-in {
        from { opacity: 0.65; }
        to { opacity: 1; }
      }
    `,document.head.appendChild(n)}e.dataset.hasLoadingIndicator="true",e.dataset.loadingIndicatorElement="true"}function removeLoadingIndicator(e){if(e.dataset.hasLoadingIndicator!=="true")return;const t=e.parentElement;if(t){const o=t.querySelector(".chemistrylatex-image-loading-indicator");o&&o.remove()}delete e.dataset.hasLoadingIndicator,delete e.dataset.loadingIndicatorElement}function applyAverageSizeScaling(e){const t=e/100;console.log(`%c\u{1F4D0} Applying average size scaling: ${e}% (factor: ${t})`,"color: #9C27B0; font-weight: bold;");const o=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let n=0;o.forEach(r=>{if(r.closest(".molecule-3d-viewer")||r.closest(".molecule-viewer-container")||r.closest(".biomolecule-viewer")||(r.dataset.compoundType||"")==="biomolecule")return;const l=r.src||"";if(!(l.includes("data:image/svg")||l.endsWith(".svg")))return;const u=r.closest(".molecule-container, .chem-image-container");if(u){const c=r.naturalWidth||parseInt(r.style.width)||r.offsetWidth||300,f=r.naturalHeight||parseInt(r.style.height)||r.offsetHeight||240,g=Math.round(c*t),y=Math.round(f*t);u.style.width=g+"px",u.style.height=y+"px",r.style.width="100%",r.style.height="100%",r.style.transform=""}else{const c=r.naturalWidth||parseInt(r.style.width)||r.offsetWidth||300,f=r.naturalHeight||parseInt(r.style.height)||r.offsetHeight||240;r.style.width=Math.round(c*t)+"px",r.style.height=Math.round(f*t)+"px"}n++}),console.log(`%c\u2705 Applied scaling to ${n} SVG molecule images (skipped ${o.length-n} non-SVG/biomolecules)`,"color: #4CAF50;")}async function lazyReRenderMolecules(e){var r,i;if(console.warn("[ChemRenderer] \u{1F504} RE-RENDERING with new settings using loadMoleculeImage pipeline"),isUpdatingImages=!0,Object.assign(settings,e),e.sdShowCarbons!==void 0&&(settings.m2cfShowCarbons=e.sdShowCarbons),e.sdAromaticRings!==void 0&&(settings.m2cfAromaticCircles=e.sdAromaticRings),e.sdShowMethyls!==void 0&&(settings.m2cfShowMethyls=e.sdShowMethyls),e.sdAtomNumbers!==void 0&&(settings.m2cfAtomNumbers=e.sdAtomNumbers),e.sdShowExplicitHydrogens!==void 0&&(settings.m2cfAddH2=e.sdShowExplicitHydrogens),e.sdShowImplicitHydrogens!==void 0&&(settings.m2cfShowImplicitH=e.sdShowImplicitHydrogens),e.sdCompactDrawing!==void 0&&(settings.m2cfCompactDrawing=e.sdCompactDrawing),e.sdFlipHorizontal!==void 0&&(settings.m2cfFlipHorizontal=e.sdFlipHorizontal),e.sdFlipVertical!==void 0&&(settings.m2cfFlipVertical=e.sdFlipVertical),e.sdGradientColors!==void 0&&(settings.sdGradientColors=e.sdGradientColors),e.sdTheme!==void 0&&(settings.sdTheme=e.sdTheme),e.sdAutoAdapt!==void 0&&(settings.sdAutoAdapt=e.sdAutoAdapt,console.log("[ChemRenderer] sdAutoAdapt setting updated:",settings.sdAutoAdapt)),e.sdBondThickness!==void 0&&(settings.sdBondThickness=e.sdBondThickness),e.sdRotate!==void 0&&(settings.m2cfRotate=e.sdRotate),e.useStereochemistry!==void 0&&(settings.m2cfUse3DSmiles=e.useStereochemistry,console.log("[ChemRenderer] Stereochemistry setting updated:",settings.m2cfUse3DSmiles)),e.sdAverageSize!==void 0){settings.sdAverageSize=e.sdAverageSize,applyAverageSizeScaling(e.sdAverageSize),isUpdatingImages=!1;return}e.compound3DSize!==void 0&&(settings.compound3DSize=e.compound3DSize),e.mineral3DSize!==void 0&&(settings.mineral3DSize=e.mineral3DSize);const t=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");if(console.log("[ChemRenderer] \u{1F50D} Found molecule images to re-render:",t.length),t.length===0){console.log("[ChemRenderer] No images found"),isUpdatingImages=!1;return}let o=0;for(const l of t)try{const s=l.dataset.smiles||"",u=l.dataset.originalNomenclature,c=l.dataset.nomenclature,f=A=>!(!A||A==="molecule"||A.includes("Error loading")||A.includes("Server returned")||A.includes("Failed to"));let g=u||c||"";if(!f(g)){console.log(`[ChemRenderer] \u23ED\uFE0F Skipping image - invalid/error nomenclature: "${g.substring(0,50)}..."`);continue}const y=l.dataset.compoundType||"compound";if(!g||g==="molecule"){console.log("[ChemRenderer] \u23ED\uFE0F Skipping image - no nomenclature");continue}if(l.dataset.moleculeViewer)try{const A=JSON.parse(atob(l.dataset.moleculeViewer));if((r=A.flags)!=null&&r.flagsLocked&&!((i=A.flags)!=null&&i.useDefaults)){console.log(`[ChemRenderer] \u23ED\uFE0F Skipping ${g} - flags are locked (explicit flags set)`);continue}}catch{}console.log(`[ChemRenderer] \u{1F504} Re-rendering: ${g} (type: ${y})`);let w;y==="compound"?w={nomenclature:g,smiles:s||null,type:s?"smiles":"nomenclature",options:{width:parseInt(l.dataset.renderWidth)||300,height:parseInt(l.dataset.renderHeight)||240,aromaticCircles:settings.m2cfAromaticCircles,showCarbons:settings.m2cfShowCarbons,showMethyls:settings.m2cfShowMethyls,atomNumbers:settings.m2cfAtomNumbers,addH2:settings.m2cfAddH2,showImplicitH:settings.m2cfShowImplicitH,flipHorizontal:settings.m2cfFlipHorizontal,flipVertical:settings.m2cfFlipVertical,scale:1,rotation:parseInt(l.dataset.rotation)||0},isMoleculeViewer:!0,flags:{useDefaults:!1,compoundType:"compound"}}:y==="biomolecule"?w={nomenclature:g,type:"nomenclature",options:{width:parseInt(l.dataset.renderWidth)||300,height:parseInt(l.dataset.renderHeight)||240,removeWhiteBg:settings.proteinRemoveWhiteBg,bioAssembly:settings.molviewBioAssembly,chainType:settings.molviewChainType,chainBonds:settings.molviewChainBonds,chainColor:settings.molviewChainColor,proteinBgColor:settings.proteinMolviewBgColor},isMoleculeViewer:!0,flags:{useDefaults:!1,compoundType:"biomolecule"}}:y==="mineral"?w={nomenclature:g,type:"nomenclature",options:{width:parseInt(l.dataset.renderWidth)||300,height:parseInt(l.dataset.renderHeight)||240,representation:settings.mineralRepresentation,mineralBgColor:settings.mineralMolviewBgColor,crystallography:settings.mineralCrystallography},isMoleculeViewer:!0,flags:{useDefaults:!1,compoundType:"mineral"}}:w={nomenclature:g,smiles:s,type:s?"smiles":"nomenclature",options:{width:parseInt(l.dataset.renderWidth)||300,height:parseInt(l.dataset.renderHeight)||240},isMoleculeViewer:!0,flags:{useDefaults:!0,compoundType:y}};const d=btoa(JSON.stringify(w)),m=document.createElement("img");m.className="molecule-diagram molecule-viewer",m.alt=g,m.dataset.moleculeViewer=d,m.dataset.loaded="false",m.dataset.rotation=l.dataset.rotation||"0",m.style.cssText="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;";const I=l.closest(".molecule-container")||l.parentNode;if(I&&I.parentNode)I.parentNode.replaceChild(m,I);else if(l.parentNode)l.parentNode.replaceChild(m,l);else{console.error("[ChemRenderer] \u274C Image has no parent!");continue}window._loadMoleculeImage?(window._loadMoleculeImage(m),o++,console.log(`[ChemRenderer] \u2705 Triggered loadMoleculeImage for: ${g}`)):console.error("[ChemRenderer] \u274C _loadMoleculeImage not available!")}catch(s){console.error("[ChemRenderer] Error re-rendering:",s)}console.log(`[ChemRenderer] \u2705 Re-rendered ${o} molecules`);const n=document.querySelectorAll('img.molecule-diagram[data-loaded="false"], img.molecule-viewer[data-loaded="false"]');n.length>0&&window._lazyLoadObserver&&(console.log(`[ChemRenderer] \u{1F441}\uFE0F Re-observing ${n.length} unloaded images for lazy loading`),n.forEach(l=>{window._lazyLoadObserver.observe(l)})),settings.sdAverageSize&&settings.sdAverageSize!==100&&setTimeout(()=>{console.log("[ChemRenderer] \u{1F504} Reapplying average size scaling after re-render:",settings.sdAverageSize+"%"),applyAverageSizeScaling(settings.sdAverageSize)},500),isUpdatingImages=!1}let lazyReRenderObserver=null;const imagesBeingRendered=new Set,MAX_IMAGES_BEING_RENDERED=20;function setupLazyReRenderObserver(){if(lazyReRenderObserver)try{lazyReRenderObserver.disconnect()}catch{}lazyReRenderObserver=new IntersectionObserver(e=>{e.forEach(t=>{if(t.isIntersecting){const o=t.target;processImageIfNeeded(o)}})},{rootMargin:"50px",threshold:.1}),document.querySelectorAll("img[data-molecule-viewer]").forEach(e=>{lazyReRenderObserver.observe(e)}),triggerVisibleImagesReRender()}function processImageIfNeeded(e){const t=e.dataset.smiles||"(no smiles)",o=e.dataset.compoundName||"(no name)";if(console.log("[ChemRenderer] \u{1F527} processImageIfNeeded called for:",o),e.dataset.needsReRender!=="true"&&e.getAttribute("data-needs-re-render")!=="true"){console.log("[ChemRenderer] \u23ED\uFE0F Image does not need re-render (no flag)");return}if(imagesBeingRendered.has(e)){console.log("[ChemRenderer] \u23ED\uFE0F Image already being processed"),log.debug(`\u23ED\uFE0F Image already being processed: ${o}`);return}if(imagesBeingRendered.size>=MAX_IMAGES_BEING_RENDERED){console.log("[ChemRenderer] \u26A0\uFE0F Too many images being rendered, skipping:",o);return}console.log("[ChemRenderer] \u2705 Image will be processed:",o),log.info(`\u{1F504} Processing image for lazy re-render: ${o} (SMILES: ${t.substring(0,30)}...)`),imagesBeingRendered.add(e),console.log("[ChemRenderer] \u{1F534} Adding loading indicator..."),addLoadingIndicator(e),console.log("[ChemRenderer] \u{1F504} Starting reRenderSingleMolecule..."),reRenderSingleMolecule(e,pendingReRenderSettings||settings).then(()=>{console.log("[ChemRenderer] \u2705 Re-render SUCCESS for:",o),delete e.dataset.needsReRender,e.removeAttribute("data-needs-re-render"),log.debug("\u2705 Successfully re-rendered molecule")}).catch(n=>{console.log("[ChemRenderer] \u274C Re-render FAILED for:",o,n),log.error("Failed to re-render molecule:",n),delete e.dataset.needsReRender,e.removeAttribute("data-needs-re-render")}).finally(()=>{console.log("[ChemRenderer] \u{1F535} Removing loading indicator..."),removeLoadingIndicator(e),imagesBeingRendered.delete(e)})}function triggerVisibleImagesReRender(){console.log("[ChemRenderer] \u{1F440} triggerVisibleImagesReRender called");const e=document.querySelectorAll('img[data-molecule-viewer][data-needs-re-render="true"]');console.log("[ChemRenderer] \u{1F50D} Found images needing re-render:",e.length);let t=0;e.forEach(o=>{var i;const n=o.getBoundingClientRect(),r=n.top<window.innerHeight&&n.bottom>0&&n.width>0&&n.height>0;console.log("[ChemRenderer] \u{1F5BC}\uFE0F Image check:",{name:o.dataset.compoundName||((i=o.dataset.smiles)==null?void 0:i.substring(0,20)),isVisible:r,rect:{top:n.top,bottom:n.bottom,width:n.width,height:n.height}}),r&&(t++,console.log("[ChemRenderer] \u25B6\uFE0F Processing visible image..."),processImageIfNeeded(o))}),console.log("[ChemRenderer] \u{1F4CA} Processed",t,"visible images")}async function reRenderSingleMolecule(e,t){try{const o=e.dataset.smiles,n=e.dataset.moleculeName||e.dataset.nomenclature,r=e.dataset.compoundType||"compound";if(r==="biomolecule"||r==="mineral"){log.debug(`Skipping re-render for ${r} (uses different renderer)`);return}if(!o&&!n){log.debug("Skipping re-render: no SMILES or name data on image");return}const i={showCarbons:settings.m2cfShowCarbons,showMethyls:settings.m2cfShowMethyls,aromaticCircles:settings.m2cfAromaticCircles,showHydrogens:settings.m2cfAddH2,showImplicitH:settings.m2cfShowImplicitH,atomNumbers:settings.m2cfAtomNumbers,gradientColors:settings.sdGradientColors,compactDrawing:settings.m2cfCompactDrawing,useStereochemistry:settings.m2cfUse3DSmiles,flipHorizontal:settings.m2cfFlipHorizontal,flipVertical:settings.m2cfFlipVertical,renderingEngine:settings.renderingEngine},l=o?"smiles":"mol",s=o||n,u=buildServerSvgUrl(l,s,i);log.debug(`\u{1F5BC}\uFE0F Re-rendering via server: ${u}`),await new Promise((c,f)=>{const g=new Image;g.onload=()=>{log.debug("\u2705 New image pre-loaded successfully"),c()},g.onerror=y=>{log.error("\u274C Failed to pre-load new image:",y),f(y)},g.src=u}),log.debug("\u{1F504} Swapping image src..."),e.style.animation="chemtex-fade-in 160ms ease-out",e.src=u,log.debug("\u2705 Image src updated successfully"),setTimeout(()=>{try{e.style.animation=""}catch{}},220)}catch(o){throw log.error("Error re-rendering single molecule:",o),o}}async function reloadAllImages(){log.info("\u{1F504} Reloading all images (forced refresh)...");const e=document.querySelectorAll("img[data-molecule-viewer]");let t=0;for(const o of e){addLoadingIndicator(o);try{await reRenderSingleMolecule(o,settings),t++}catch(n){log.error("Failed to reload image:",n)}finally{removeLoadingIndicator(o)}}log.success(`\u2705 Reloaded ${t} images`)}function applyCssOnlySettings(e){console.log("[ChemRenderer] \u{1F3A8} Applying CSS-only settings to existing images");const t=document.querySelectorAll('img[data-molecule-viewer="true"]');t.forEach(n=>{const r=n.dataset.rawSvg;if(r){const i=decodeURIComponent(r),l=applyThemeColors(i,e.sdTheme||"light");n.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(l),console.log("[ChemRenderer] \u2705 Applied theme instantly to molecule:",n.dataset.nomenclature)}e.sdGradientColors?n.classList.add("gradient-bonds"):n.classList.remove("gradient-bonds")});const o=document.querySelectorAll("iframe.biomolecule-viewer, .molecule-3d-viewer");o.forEach(n=>{e.proteinRemoveWhiteBg?(n.style.filter="drop-shadow(0 0 0 transparent)",n.style.mixBlendMode="multiply",console.log("[ChemRenderer] \u2705 Applied white-removal effect to biomolecule viewer")):(n.style.filter="",n.style.mixBlendMode="")}),console.log(`[ChemRenderer] \u{1F3A8} Applied CSS settings to ${t.length} molecules and ${o.length} 3D viewers`)}chrome.runtime.onMessage.addListener((e,t,o)=>{try{if(console.warn("[ChemRenderer] \u{1F4E9}\u{1F4E9}\u{1F4E9} MESSAGE RECEIVED:",e.type),console.log("%c[ChemRenderer] Message details:","background: yellow; color: black; font-weight: bold;",e),e.type==="APPLY_SETTINGS"){console.warn("[ChemRenderer] \u2699\uFE0F\u2699\uFE0F\u2699\uFE0F APPLY_SETTINGS - STARTING UPDATE"),console.log("%c[ChemRenderer] Settings to apply:","background: green; color: white; font-weight: bold;",e.settings),log.info("\u{1F4EC} Received settings update from popup:",e.settings);const n=["proteinRemoveWhiteBg","sdGradientColors","sdAutoAdapt"],r=e.changedSettings||[];if(r.length>0&&r.every(l=>n.includes(l)))return console.log("[ChemRenderer] \u{1F3A8} CSS-only change detected, applying without re-render"),applyCssOnlySettings(e.settings),o({success:!0,cssOnly:!0}),!0;try{console.warn("[ChemRenderer] \u{1F504}\u{1F504}\u{1F504} CALLING lazyReRenderMolecules NOW..."),lazyReRenderMolecules(e.settings),console.warn("[ChemRenderer] \u2705\u2705\u2705 lazyReRenderMolecules FINISHED")}catch(l){console.error("[ChemRenderer] Error in lazyReRenderMolecules:",l)}return o({success:!0}),!0}if(e.type==="RELOAD_ALL_IMAGES"){console.warn("[ChemRenderer] \u{1F504} RELOAD_ALL_IMAGES received"),log.info("\u{1F4EC} Received reload all images command");try{reloadAllImages()}catch(n){console.error("[ChemRenderer] Error in reloadAllImages:",n)}return o({success:!0}),!0}if(e.type==="CLEAR_CACHE")return console.warn("[ChemRenderer] \u{1F5D1}\uFE0F CLEAR_CACHE received"),clearAllCaches(),chrome.storage.sync.get(null,n=>{console.log("[ChemRenderer] \u{1F504} Re-rendering all molecules with fresh cache..."),lazyReRenderMolecules(n)}),o({success:!0,message:"Cache cleared, re-rendering with fresh content"}),!0}catch(n){return console.error("[ChemRenderer] Error handling message:",n),o({success:!1,error:n.message}),!0}});function isDarkModeEnabled(){var t,o,n,r;if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return!0;try{const i=window.getComputedStyle(document.documentElement),l=window.getComputedStyle(document.body);if((i.colorScheme||l.colorScheme||"").includes("dark"))return!0}catch{}try{const i=[document.documentElement,document.body];for(const l of i){if(!l)continue;const s=window.getComputedStyle(l).backgroundColor;if(s&&s!=="rgba(0, 0, 0, 0)"&&s!=="transparent"){const u=s.match(/\d+/g);if(u&&u.length>=3){const c=.299*parseInt(u[0])+.587*parseInt(u[1])+.114*parseInt(u[2]);if(c<100)return!0;if(c>180)return!1}}}}catch{}const e=["dark","dark-mode","dark-theme","night-mode","skin-minerva-dark","client-dark-mode"];for(const i of e)if((o=(t=document.body)==null?void 0:t.classList)!=null&&o.contains(i)||(r=(n=document.documentElement)==null?void 0:n.classList)!=null&&r.contains(i))return!0;try{const i=document.documentElement.getAttribute("data-theme")||document.body.getAttribute("data-theme")||document.documentElement.getAttribute("data-color-mode")||document.body.getAttribute("data-color-mode")||"";if(i.toLowerCase().includes("dark")||i.toLowerCase().includes("night"))return!0}catch{}return!1}function isExtensionContextValid(){try{return!(extensionContextInvalid||!chrome.runtime||!chrome.runtime.id)}catch{return!1}}async function backgroundFetchBlob(e){try{if(!isExtensionContextValid())return directFetchBlob(e);if(chrome.runtime&&chrome.runtime.sendMessage)return new Promise((t,o)=>{chrome.runtime.sendMessage({type:"FETCH_BLOB",url:e},n=>{if(chrome.runtime.lastError){chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("Extension context invalidated")&&(extensionContextInvalid=!0),directFetchBlob(e).then(t).catch(o);return}n&&n.success?t(n.data):o(new Error((n==null?void 0:n.error)||"Background blob fetch failed"))})})}catch(t){t.message&&t.message.includes("Extension context invalidated")&&(extensionContextInvalid=!0)}return directFetchBlob(e)}async function directFetchBlob(e){const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText} `);const o=await t.blob();return new Promise((n,r)=>{const i=new FileReader;i.onloadend=()=>{const l=i.result.split(",")[1];n({base64:l,type:o.type})},i.onerror=r,i.readAsDataURL(o)})}async function smilesBridge(e,t={}){const{use3DSmiles:o=!1}=t;if(!e||typeof e!="string")return console.error("\u274C SMILES Bridge: Invalid name provided"),null;const n=stripFlagsFromName(e.trim());if(!n)return console.error("\u274C SMILES Bridge: Empty name after stripping flags"),null;try{const r=`${CHEMISTRYLATEX_SERVER_URL}/search/${encodeURIComponent(n)}?type=compound`;console.log("%c\u{1F309} SMILES Bridge: Using server search","color: #4A90D9; font-weight: bold;",r);const i=await fetch(r);if(i.ok){const l=await i.json();if(l&&l.smiles)return{smiles:o&&l.isomericSmiles?l.isomericSmiles:l.smiles,source:"ChemTex-Server",cid:l.cid}}}catch(r){console.warn("\u26A0\uFE0F [Bridge] Server search failed:",r.message)}return console.error("%c\u274C [Bridge] Name\u2192SMILES conversion failed","color: #FF0000; font-weight: bold;"),null}window.smilesBridge=smilesBridge;async function getCompoundID(e){if(!e||typeof e!="string")return console.error("\u274C Invalid input for getCompoundID"),null;const t=e.trim(),o=await smilesBridge(t,{use3DSmiles:!1});return o&&o.cid?(console.log("%c\u2705 [CID] Got ID from server:","color: #00FF00; font-weight: bold;",o.cid),o.cid):(console.error("%c\u274C [CID] Could not find CID for:","color: #FF0000; font-weight: bold;",e),null)}window.getCompoundID=getCompoundID,window.getCompoundID=getCompoundID;const SIZE_STEP=20,MIN_SIZE=100,MAX_SIZE=800,DEFAULT_WIDTH=400,DEFAULT_HEIGHT=350,BASE_SIZE=150,SIZE_SCALE_FACTOR=.5,MAX_DEFAULT_SIZE=400;function getImageKey(e){return e?e.smiles?`smiles:${e.smiles}`:e.nomenclature?`nomenclature:${e.nomenclature}`:null:null}function getPageImageKey(e,t){const o=getImageKey(e);return o?`page:${t}:${o}`:null}async function loadImageSize(e,t,o){try{const n=getImageKey(e);if(!n)return{};if(!o.saveSizePerImage&&!o.saveSizeBySMILES)return{};let r;return o.saveSizePerImage&&!o.saveSizeBySMILES?r=getPageImageKey(e,t):r=n,r?new Promise(i=>{chrome.storage.local.get([r],l=>{if(l[r])if(l[r].scale)i(l[r]);else{const s=l[r].width?l[r].width/DEFAULT_WIDTH:void 0;i(s!==void 0?{scale:s}:{})}else i({})})}):{}}catch(n){return console.error("Error loading image size:",n),{}}}async function saveImageSize(e,t,o,n){try{const r=getImageKey(e);if(!r||!n.saveSizePerImage&&!n.saveSizeBySMILES)return;let i;if(n.saveSizePerImage&&!n.saveSizeBySMILES?i=getPageImageKey(e,t):i=r,!i)return;const l={};l[i]=o,chrome.storage.local.set(l,()=>{console.log(`Saved size for ${i}:`,o)})}catch(r){console.error("Error saving image size:",r)}}function createSizeControls(e,t,o,n){console.log("\u{1F39B}\uFE0F Creating size controls:",{settings:n,moleculeData:o});const r=document.createElement("div");r.className="chem-size-controls",r.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex !important;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    pointer-events: auto;
    transition: opacity 0.2s;
    z-index: 1000;
  `;const i=document.createElement("button");i.className="chem-size-btn chem-size-up",i.innerHTML="\u25B2",i.title="Increase size",i.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    pointer-events: auto;
  `;const l=document.createElement("button");return l.className="chem-size-btn chem-size-down",l.innerHTML="\u25BC",l.title="Decrease size",l.style.cssText=i.style.cssText,[i,l].forEach(s=>{s.addEventListener("mouseenter",()=>{s.style.background="rgba(0, 0, 0, 0.9)"}),s.addEventListener("mouseleave",()=>{s.style.background="rgba(0, 0, 0, 0.7)"})}),i.addEventListener("click",s=>{s.stopPropagation(),adjustImageSize(e,t,o,SIZE_STEP,n)}),l.addEventListener("click",s=>{s.stopPropagation(),adjustImageSize(e,t,o,-SIZE_STEP,n)}),r.appendChild(i),r.appendChild(l),e.addEventListener("mouseenter",()=>{console.log("\u{1F5B1}\uFE0F Mouse entered container"),r.style.opacity="1"}),e.addEventListener("mouseleave",()=>{r.style.opacity="0"}),r}function adjustImageSize(e,t,o,n,r){let i=parseFloat(t.dataset.scale)||1;const l=n/100;let s=i+l;s=Math.max(.5,Math.min(5,s)),t.dataset.scale=s.toString();const c=(t.style.transform||"").replace(/scale\([^)]+\)\s*/g,"");t.style.transform=`${c} scale(${s})`.trim(),t.style.transformOrigin="top left";const f=window.location.href;saveImageSize(o,f,{scale:s},r),console.log(`Adjusted scale: ${s.toFixed(2)}x (was ${i.toFixed(2)}x)`)}async function wrapImageWithSizeControls(e,t,o,n){var r;try{console.log("\u{1F4E6} Wrapping image with size controls",{settings:n,moleculeData:o});const i=document.createElement("div");i.className="chem-image-container",i.style.cssText=`
      position: relative;
      display: inline-block;
      margin: 0 12px 8px 0;
      vertical-align: middle;
      overflow: hidden;
      max-width: 100%;
    `;const l=window.location.href,s=await loadImageSize(o,l,n);let u=1.5;const c=()=>{let m=e.naturalWidth||e.width||0,I=e.naturalHeight||e.height||0;if((!m||!I)&&e.src&&e.src.startsWith("data:image/svg+xml"))try{let A;e.src.includes("base64,")?A=atob(e.src.split("base64,")[1]):A=decodeURIComponent(e.src.split(",")[1]);const T=A.match(/width\s*=\s*["']?(\d+(?:\.\d+)?)/i),k=A.match(/height\s*=\s*["']?(\d+(?:\.\d+)?)/i);if(T&&(m=parseFloat(T[1])),k&&(I=parseFloat(k[1])),!m||!I){const a=A.match(/viewBox\s*=\s*["']?[\d.]+\s+[\d.]+\s+([\d.]+)\s+([\d.]+)/i);a&&(m=m||parseFloat(a[1]),I=I||parseFloat(a[2]))}}catch(A){console.warn("Could not extract SVG dimensions:",A)}return{width:m,height:I}},{width:f,height:g}=c();if(f>0&&g>0){const m=Math.sqrt(f*f+g*g);u=1.5*Math.pow(300/m,.5),u=Math.max(.4,Math.min(2,u)),console.log(`%c\u{1F4CF} Smart Scaling: ${f}x${g} (diagonal: ${m.toFixed(0)}px) \u2192 ${u.toFixed(2)}x scale`,"color: #9C27B0; font-weight: bold;")}else console.log("%c\u{1F4CF} Using default scale (dimensions not available yet)","color: #FF9800;");const y=s.scale||u;e.dataset.scale=y.toString(),e.dataset.fixedSize||(e.complete?applyScaleToImage(e,y):(e.onload=()=>applyScaleToImage(e,y),setTimeout(()=>applyScaleToImage(e,y),100))),o&&(e.dataset.moleculeData=JSON.stringify(o));const w=createSizeControls(i,e,o,n);t.parentNode.insertBefore(i,t),i.appendChild(e),i.appendChild(w),t.remove();const d=((r=o.flags)==null?void 0:r.displayName)||o.nomenclature||o.smiles||"Unknown";return addHoverControls(i,d,o),console.log("\u2705 Size controls wrapper created successfully with scale:",y),i}catch(i){if(console.error("\u274C Error wrapping image with size controls:",i),t&&t.parentNode&&e)try{t.parentNode.replaceChild(e,t)}catch(l){console.error("\u274C Failed to replace element:",l)}return e}}function applyScaleToImage(e,t){let o=e.naturalWidth||e.width,n=e.naturalHeight||e.height;if((!o||o===0)&&e.src&&e.src.startsWith("data:image/svg+xml"))try{let l;e.src.includes("base64,")?l=atob(e.src.split("base64,")[1]):l=decodeURIComponent(e.src.split(",")[1]);const s=l.match(/width\s*=\s*["']?(\d+(?:\.\d+)?)/i),u=l.match(/height\s*=\s*["']?(\d+(?:\.\d+)?)/i);if(s&&(o=parseFloat(s[1])),u&&(n=parseFloat(u[1])),!o||!n){const c=l.match(/viewBox\s*=\s*["']?[\d.]+\s+[\d.]+\s+([\d.]+)\s+([\d.]+)/i);c&&(o=o||parseFloat(c[1]),n=n||parseFloat(c[2]))}}catch(l){console.warn("Could not extract SVG dimensions from data URL:",l)}const r=600,i=500;if(e.style.maxWidth=`${r}px`,e.style.maxHeight=`${i}px`,t&&t!==1){const s=(e.style.transform||"").replace(/scale\([^)]+\)\s*/g,"");e.style.transform=`${s} scale(${t})`.trim(),e.style.transformOrigin="top left"}console.log(`Applied scale ${t}x`)}window.chemRendererDebug={getSettings:()=>settings,scanPage:()=>scanAndRender(),clearCache:()=>clearAllCaches(),async getCacheStats(){return await loadSmilesCache(),{smiles:Object.keys(smilesCache).length,images:renderedImageCache.size}}},window.chemRendererPerformance={recordStructure(){},recordLoad(){},recordFormula(){}},log.info("exp_ChemistryLaTeX_Ind loaded");let settings={enabled:!0,performanceMode:!0,maxVisibleSVGs:5,sizePreset:"auto",rendererEngine:"chemtex",devMode:!1,flipHorizontal:!1,flipVertical:!1,use3DSmiles:!1,sdShowCarbons:!0,sdAromaticCircles:!0,sdShowMethyls:!0,sdCompactDrawing:!0,sdTheme:"light",sdAutoAdapt:!0,enable3DViewer:!1,viewer3DSource:"molview",viewer3DSize:"normal",viewer3DStyle:"stick",molviewRepresentation:"ballAndStick",compoundMolviewBgColor:"black",molviewEngine:"glmol",proteinRemoveWhiteBg:!1,molviewChainType:"ribbon",molviewChainBonds:!1,molviewChainColor:"ss",proteinMolviewBgColor:"black",molviewBioAssembly:!1,bioAssemblyViewer:"molstar",bioAssemblyGraphics:"balanced",bioAssemblyPdbProvider:"rcsb",mineralRepresentation:"ballAndStick",mineralMolviewBgColor:"black",mineralCrystallography:"supercell_2x2x2"};log.info("\u{1F4E6} Loading settings from storage..."),chrome.storage.sync.get(null,e=>{settings={...settings,...e},settings.rendererEngine="chemtex",settings.m2cfShowCarbons=e.sdShowCarbons!==void 0?e.sdShowCarbons:!0,settings.m2cfAromaticCircles=e.sdAromaticRings!==void 0?e.sdAromaticRings:!0,settings.m2cfShowMethyls=e.sdShowMethyls!==void 0?e.sdShowMethyls:!0,settings.m2cfAtomNumbers=e.sdAtomNumbers===!0,settings.m2cfAddH2=e.sdShowExplicitHydrogens===!0,settings.m2cfShowImplicitH=e.sdShowImplicitHydrogens!==!1,settings.m2cfCompactDrawing=e.sdCompactDrawing===!0,settings.m2cfFlipHorizontal=e.sdFlipHorizontal===!0,settings.m2cfFlipVertical=e.sdFlipVertical===!0,settings.m2cfRotate=e.sdRotate||0,settings.sdGradientColors=e.sdGradientColors===!0,settings.sdAutoAdapt=e.sdAutoAdapt!==!1,console.log("[Content] Auto-adapt setting loaded:",settings.sdAutoAdapt),settings.m2cfUse3DSmiles=e.useStereochemistry!==!1,console.log("[Content] Stereochemistry setting:",{useStereochemistry:e.useStereochemistry,m2cfUse3DSmiles:settings.m2cfUse3DSmiles}),console.log("[Content] Raw storage values:",{sdShowCarbons:e.sdShowCarbons,sdAromaticRings:e.sdAromaticRings,sdShowMethyls:e.sdShowMethyls,sdAtomNumbers:e.sdAtomNumbers,sdShowExplicitHydrogens:e.sdShowExplicitHydrogens,sdShowImplicitHydrogens:e.sdShowImplicitHydrogens,sdFlipHorizontal:e.sdFlipHorizontal,sdFlipVertical:e.sdFlipVertical}),log.info("\u{1F4CA} Rendering settings:",{showCarbons:settings.m2cfShowCarbons,aromaticRings:settings.m2cfAromaticCircles,showMethyls:settings.m2cfShowMethyls,atomNumbers:settings.m2cfAtomNumbers,explicitHydrogens:settings.m2cfAddH2,implicitHydrogens:settings.m2cfShowImplicitH,gradientColors:settings.sdGradientColors}),log.info("\u{1F50D} Server search enabled"),log.success("\u2705 Settings loaded",settings),log.info("Renderer Engine: ChemTex"),log.info(`Performance mode: ${settings.performanceMode?"ON \u26A1":"OFF"}`),loadSmilesCache().then(t=>{log.info(`\u{1F4E6} SMILES cache ready: ${Object.keys(t).length} cached compounds`)}),settings.enabled?(log.info("\u{1F680} Extension enabled, initializing renderer..."),initializeRenderer(),settings.sdAverageSize=e.sdAverageSize||100,console.log("[Content] Loaded sdAverageSize from storage:",settings.sdAverageSize),settings.sdAverageSize!==100&&(setTimeout(()=>{applyAverageSizeScaling(settings.sdAverageSize),console.log("[Content] Applied saved size scaling (1st pass):",settings.sdAverageSize+"%")},2e3),setTimeout(()=>{applyAverageSizeScaling(settings.sdAverageSize),console.log("[Content] Applied saved size scaling (2nd pass):",settings.sdAverageSize+"%")},5e3))):log.info("\u23F8\uFE0F  Extension disabled in settings")}),chrome.storage.onChanged.addListener(e=>{e.enabled&&(log.info("\u2699\uFE0F  Settings changed, reloading...",e),e.enabled.newValue&&location.reload()),e.viewer3DSource&&(log.info("\u{1F504} 3D Viewer source changed, updating...",e.viewer3DSource),settings.viewer3DSource=e.viewer3DSource.newValue,log.success(`\u2705 Switched to ${e.viewer3DSource.newValue} 3D viewer`))}),chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.action==="renderPreview"){try{const n=wrapChemicalFormulas(e.code);o({html:n})}catch(n){console.error("Error rendering preview:",n),o({html:`<span style="color: red;">Error: ${n.message}</span>`})}return!0}if(e.type==="SETTINGS_CHANGED"){console.log("%c\u2699\uFE0F [Content] Settings changed from popup:","background: #2196F3; color: white; font-weight: bold; padding: 4px;",e.settings),Object.assign(settings,e.settings);const n=["sdShowCarbons","sdAromaticRings","sdShowMethyls","sdAtomNumbers","sdShowExplicitHydrogens","sdShowImplicitHydrogens","sdCompactDrawing","sdFlipHorizontal","sdFlipVertical","sdTheme","sdAutoAdapt","sdRotate","sdAverageSize","sdGradientColors","sdScaleByWeight","useStereochemistry"],r=Object.keys(e.settings).filter(i=>n.includes(i));return r.length>0?console.log("%c\u{1F3A8} [Content] 2D settings changed - will re-render visible molecules:","color: #4CAF50; font-weight: bold;",r):console.log("%c\u{1F527} [Content] 3D/other settings changed - no 2D re-render needed","color: #9C27B0;",Object.keys(e.settings)),o({success:!0}),!0}});function initializeRenderer(){log.inject("\u{1F527} Initialize renderer - Starting chemical formula processing"),injectStyles(),settings.performanceMode?log.inject("\u26A1 Performance mode ENABLED - Setting up lazy-loading for SVGs"):log.inject("\u26A1 Performance mode disabled - will load images immediately"),setupLazyLoading(),log.inject("\u{1F680} Starting initial page scan..."),scanAndRender(),log.inject("\u{1F504} Setting up dynamic content observer..."),observePageChanges(),log.success("\u2705 Renderer initialized - formulas will be processed as they appear")}function injectStyles(){const e='.molecule-diagram{display:inline-block!important;position:static!important;max-width:100%;max-height:400px;margin:0 12px 8px 0!important;vertical-align:middle;padding:0!important;border:none!important;border-radius:4px;background-color:transparent!important;transition:opacity .3s ease;cursor:pointer;opacity:1}.molecule-diagram[data-loaded="error"]{background-color:transparent!important;border:1px solid rgba(239,83,80,0.3)!important}.molecule-loading{opacity:.1;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 2s infinite}@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}.molecule-fadein{animation:fadeIn .4s ease-in-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.molecule-container{display:inline-flex;flex-wrap:wrap;gap:12px;align-items:center;margin:8px 0}.molecule-container .molecule-diagram{margin:0}.molecule-container.vertical{display:flex;flex-direction:column;align-items:flex-start;gap:16px;margin:12px 0}.molecule-container.vertical .molecule-diagram{margin:0;display:block}.molecule-rotate-0{transform:rotate(0deg)}.molecule-rotate-90{transform:rotate(90deg);max-width:200px;max-height:300px}.molecule-rotate-180{transform:rotate(180deg)}.molecule-rotate-270{transform:rotate(270deg);max-width:200px;max-height:300px}.molecule-diagram:hover{background-color:rgba(100,150,255,.1)!important;box-shadow:0 0 8px rgba(100,150,255,.2)!important}.molecule-viewer-container{display:inline-block!important;margin:8px 12px 8px 0!important;vertical-align:middle;padding:0!important;background:transparent!important;border:none!important;box-shadow:none!important}.molecule-viewer-container:hover{background:transparent!important;border:none!important;box-shadow:none!important}.molecule-viewer-container .molecule-diagram{display:block;max-width:300px;max-height:200px;margin-bottom:6px;cursor:pointer;border-radius:4px}.molecule-viewer-container .molecule-diagram:hover{background-color:rgba(100,150,255,.15)!important;box-shadow:0 0 8px rgba(100,150,255,.3)!important}.molecule-download-btn:hover{background:#45a049!important;transform:scale(1.02)}.molecule-download-btn:active{transform:scale(.98)}@media(max-width:768px){.molecule-diagram{max-width:250px;max-height:150px}.molecule-container{flex-direction:column;gap:8px}.molecule-viewer-container{margin:8px 0!important}}',t=document.createElement("style");t.textContent=e,t.id="chem-renderer-styles",(document.head||document.documentElement).appendChild(t)}function parseChemFlags(e,t=!0){const o={useDefaults:!1,flagsLocked:!1,showCarbons:void 0,aromaticCircles:void 0,showMethyls:void 0,atomNumbers:void 0,flipHorizontal:void 0,flipVertical:void 0,addHydrogens:void 0,showImplicitHydrogens:void 0,size:void 0,rotation:void 0,isCompound:!1,compoundType:void 0,isDirectSmiles:!1,moleculeName:null,isDirectID:!1,idType:void 0,idValue:void 0,smilesValue:void 0,displayName:void 0,isIUPAC:!1};if(!e)return o;const n=e.match(/chem:(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid)=([^:]+):/i),r=n?null:e.match(/chem:([a-zA-Z0-9][a-zA-Z0-9\-,\s\(\)]{0,}?)(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid)=([^:]+):/i);if(n){const i=n[1].toLowerCase(),l=n[2];switch(i){case"smiles":o.compoundType="smiles",o.isDirectSmiles=!0;break;case"mol":o.compoundType="compound",o.isCompound=!0;break;case"biomol":o.compoundType="biomolecule";break;case"mineral":o.compoundType="mineral",o.isMineral=!0;break;case"iupac":o.compoundType="compound",o.isIUPAC=!0,o.isCompound=!0;break;case"pbdid":o.compoundType="biomolecule",o.isDirectID=!0,o.idType="pdbid";break;case"cid":o.compoundType="compound",o.isDirectID=!0,o.idType="cid",o.isCompound=!0;break;case"codid":o.compoundType="mineral",o.isDirectID=!0,o.idType="codid";break}let s=l;const c=i==="pbdid"?null:l.match(/^(.+?)([+\-][a-zA-Z](?:[+\-][a-zA-Z])*)$/);c&&(s=c[1],o.flagsLocked=!0),o.moleculeName=s.trim(),i==="smiles"&&(o.smilesValue=s.trim()),(i==="pbdid"||i==="cid"||i==="codid")&&(o.idValue=s.trim());const f=c?c[2]:"";if(!t)return console.log("%c\u{1F6AB} AI Flag Control DISABLED - ignoring flags in text","color: #FF9800; font-weight: bold;"),o;f.includes("+d")&&(o.useDefaults=!0);const g=f.match(/\+([a-zA-Z0-9]+)/g);g&&g.forEach(w=>{const d=w.substring(1).toLowerCase();if(d==="c"&&(o.showCarbons=!0),d==="o"&&(o.aromaticCircles=!0),d==="m"&&(o.showMethyls=!0),d==="n"&&(o.atomNumbers=!0),d==="h"&&(o.addHydrogens=!0),d==="i"&&(o.showImplicitHydrogens=!0),d==="p"&&(o.flipHorizontal=!0),d==="q"&&(o.flipVertical=!0),d==="d"&&(o.useDefaults=!0),d.startsWith("s")&&d.length>1){const m=parseInt(d.substring(1));isNaN(m)||(o.size=m/100)}});const y=f.match(/-([a-zA-Z])/g);return y&&y.forEach(w=>{const d=w.substring(1).toLowerCase();d==="c"&&(o.showCarbons=!1),d==="o"&&(o.aromaticCircles=!1),d==="m"&&(o.showMethyls=!1),d==="n"&&(o.atomNumbers=!1),d==="h"&&(o.addHydrogens=!1),d==="i"&&(o.showImplicitHydrogens=!1),d==="p"&&(o.flipHorizontal=!1),d==="q"&&(o.flipVertical=!1)}),console.log("%c\u{1F4E6} Standard syntax parsed:","color: #2196F3;",{type:i,value:l,result:o}),o}if(r){const i=r[1].trim(),l=r[2].toLowerCase(),s=r[3];switch(l){case"smiles":o.compoundType="smiles",o.isDirectSmiles=!0;break;case"mol":o.compoundType="compound",o.isCompound=!0;break;case"biomol":o.compoundType="biomolecule";break;case"mineral":o.compoundType="mineral",o.isMineral=!0;break;case"iupac":o.compoundType="compound",o.isIUPAC=!0,o.isCompound=!0;break;case"pbdid":o.compoundType="biomolecule",o.isDirectID=!0,o.idType="pdbid";break;case"cid":o.compoundType="compound",o.isDirectID=!0,o.idType="cid",o.isCompound=!0;break;case"codid":o.compoundType="mineral",o.isDirectID=!0,o.idType="codid",o.isMineral=!0;break}o.moleculeName=i;const u=l==="pbdid";let c=-1;if(!u){const d=/[+-](c|o|m|n|h|i|p|q|d|s)(?=[+-]|$)/gi;s.match(d)&&(c=s.search(d))}const f=c!==-1?s.substring(0,c).trim():s.trim();l==="smiles"?o.smilesValue=f:l==="iupac"?o.iupacValue=f:l==="mineral"?o.mineralValue=f:l==="biomol"?o.biomolValue=f:l==="mol"?o.molValue=f:(l==="pbdid"||l==="cid"||l==="codid")&&(o.idValue=f),c!==-1&&(o.flagsLocked=!0),o.displayName=i;const g=c!==-1?s.substring(c):"";if(!t)return console.log("%c\u{1F6AB} AI Flag Control DISABLED - ignoring flags in text","color: #FF9800; font-weight: bold;"),o;g.includes("+d")&&(o.useDefaults=!0);const y=g.match(/\+([a-zA-Z0-9]+)/g);y&&y.forEach(d=>{const m=d.substring(1).toLowerCase();if(m==="c"&&(o.showCarbons=!0),m==="o"&&(o.aromaticCircles=!0),m==="m"&&(o.showMethyls=!0),m==="n"&&(o.atomNumbers=!0),m==="h"&&(o.addHydrogens=!0),m==="i"&&(o.showImplicitHydrogens=!0),m==="p"&&(o.flipHorizontal=!0),m==="q"&&(o.flipVertical=!0),m==="d"&&(o.useDefaults=!0),m.startsWith("s")&&m.length>1){const I=parseInt(m.substring(1));isNaN(I)||(o.size=I/100)}if(m.startsWith("r")&&m.length>1){const I=parseInt(m.substring(1));isNaN(I)||(o.rotation=I)}});const w=g.match(/-([a-zA-Z])/g);return w&&w.forEach(d=>{const m=d.substring(1).toLowerCase();m==="c"&&(o.showCarbons=!1),m==="o"&&(o.aromaticCircles=!1),m==="m"&&(o.showMethyls=!1),m==="n"&&(o.atomNumbers=!1),m==="h"&&(o.addHydrogens=!1),m==="i"&&(o.showImplicitHydrogens=!1),m==="p"&&(o.flipHorizontal=!1),m==="q"&&(o.flipVertical=!1)}),console.log("%c\u{1F3F7}\uFE0F Named syntax parsed:","color: #9C27B0;",{displayName:i,type:l,value:s,smilesValue:o.smilesValue,result:o}),o}if(e.includes("/")){const i=e.split("/");if(i.length>1){const l=i[1];if(l.includes(":")){const s=l.split(":")[0].toLowerCase();if(s.includes("d")){o.useDefaults=!0;const u=s.replace("d","");u.includes("-c")&&(o.showCarbons=!1),u.includes("-o")&&(o.aromaticCircles=!1),u.includes("-m")&&(o.showMethyls=!1),u.includes("-n")&&(o.atomNumbers=!1),u.includes("-p")&&(o.flipHorizontal=!0),u.includes("-q")&&(o.flipVertical=!0)}}}}if(e.includes("+")){o.flagsLocked=!0;const i=e.match(/\+([a-zA-Z0-9]+)/g);i&&i.forEach(l=>{const s=l.substring(1).toLowerCase();if(s==="c"&&(o.showCarbons=!0),s==="o"&&(o.aromaticCircles=!0),s==="m"&&(o.showMethyls=!0),s==="n"&&(o.atomNumbers=!0),s==="h"&&(o.addHydrogens=!0),s==="i"&&(o.showImplicitHydrogens=!0),s==="p"&&(o.flipHorizontal=!0),s==="q"&&(o.flipVertical=!0),s==="d"&&(o.useDefaults=!0),s==="compound"&&(o.isCompound=!0),s==="compound"&&(o.compoundType="compound"),(s==="biomolecule"||s==="bio"||s==="protein")&&(o.compoundType="biomolecule"),(s==="mineral"||s==="crystal")&&(o.compoundType="mineral"),(s==="smiles"||s==="smi")&&(o.isDirectSmiles=!0),s.startsWith("s")&&s.length>1){const u=parseInt(s.substring(1));isNaN(u)||(o.size=u/100)}if(s.startsWith("r")&&s.length>1){const u=parseInt(s.substring(1));isNaN(u)||(o.rotation=u)}})}return o}function stripFlagsFromName(e){if(!e)return e;const t=e.indexOf("/");return t!==-1?e.substring(0,t):e}function applyFlagOverrides(e,t){try{const o={...e};return(t==null?void 0:t.showCarbons)!==void 0&&(o.m2cfShowCarbons=t.showCarbons),(t==null?void 0:t.aromaticCircles)!==void 0&&(o.m2cfAromaticCircles=t.aromaticCircles),(t==null?void 0:t.showMethyls)!==void 0&&(o.m2cfShowMethyls=t.showMethyls),(t==null?void 0:t.atomNumbers)!==void 0&&(o.m2cfAtomNumbers=t.atomNumbers),(t==null?void 0:t.addHydrogens)!==void 0&&(o.m2cfAddH2=t.addHydrogens),(t==null?void 0:t.flipHorizontal)!==void 0&&(o.m2cfFlipHorizontal=t.flipHorizontal,o.flipHorizontal=t.flipHorizontal),(t==null?void 0:t.flipVertical)!==void 0&&(o.m2cfFlipVertical=t.flipVertical,o.flipVertical=t.flipVertical),(t==null?void 0:t.rotation)!==void 0&&(o.m2cfRotate=t.rotation,o.mvRotate=t.rotation),o}catch(o){return console.error("Error applying flag overrides:",o),e}}function wrapImageWithRotationContainer(e,t,o,n){const r=document.createElement("div");return r.className="molecule-container",r.style.cssText=`
    display: inline-block;
    position: relative;
    vertical-align: middle;
    margin: 0 12px 8px 0;
    background: none;
    background-color: transparent;
    border: none;
    box-shadow: none;
  `,r._moleculeName=o,r._moleculeData=n,r.appendChild(e),r}function addHoverControls(e,t,o){if(e.querySelector(".molecule-name-overlay"))return;const n=document.createElement("div");n.className="molecule-name-overlay",n.textContent=t||"Unknown",n.style.cssText=`
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-family: sans-serif;
    opacity: 0.7;
    transition: opacity 0.2s;
    pointer-events: none;
    z-index: 10;
    white-space: nowrap;
    line-height: 1.4;
  `;const r=o.compoundType==="biomolecule"||o.pdbid||o.flags&&o.flags.compoundType==="biomolecule",i=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" style="display:block;">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
    <line x1="12" y1="22.08" x2="12" y2="12"/>
  </svg>`,l=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="16" height="16" style="display:block;">
    <path d="M12 2v20"/>
    <path d="M2.5 7l19 10"/>
    <path d="M2.5 17l19-10"/>
  </svg>`,s=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16" style="display:block;">
    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(45 12 12)"/>
    <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-45 12 12)"/>
    <ellipse cx="12" cy="12" rx="10" ry="4"/>
    <circle cx="12" cy="12" r="2" fill="currentColor"/>
  </svg>`,u=document.createElement("div");u.className="molecule-3d-button-group",u.style.cssText=`
    position: absolute;
    top: 4px;
    right: 4px;
    display: flex;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
    border-radius: 4px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.85);
  `;let c=null,f=settings.molviewBioAssembly===!0;r&&(c=document.createElement("button"),c.className="molecule-bio-toggle",c.innerHTML=f?l:s,c.title=f?"Mol* viewer (click to switch to MolView)":"MolView (click to switch to Mol*)",c.style.cssText=`
      background: transparent;
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      border-right: 1px solid rgba(255,255,255,0.3);
      box-sizing: border-box;
    `,c.addEventListener("mouseenter",()=>{c.style.background="rgba(255,255,255,0.15)"}),c.addEventListener("mouseleave",()=>{c.style.background="transparent"}),c.addEventListener("click",async T=>{T.stopPropagation(),f=!f,f?(c.innerHTML=l,c.title="Mol* viewer (click to switch to MolView)"):(c.innerHTML=s,c.title="MolView (click to switch to Mol*)"),console.log("\u{1F504} Bio viewer toggle:",f?"Mol*":"MolView"),o.preferMolstar=f;let k=e.closest(".molecule-3d-viewer");if(k||(k=e.querySelector(".molecule-3d-viewer")),!k&&e.classList.contains("molecule-3d-viewer")&&(k=e),k&&f?k.setAttribute("data-viewer-type","molstar"):k&&k.setAttribute("data-viewer-type","molview"),console.log("\u{1F50D} Looking for 3D viewer:",{element:e.className,found:!!k,pdbid:o.pdbid}),k){const a=k.querySelector("iframe");if(console.log("\u{1F50D} Found iframe:",!!a),a&&o.pdbid){const h=o.pdbid.toLowerCase();let p;f?(p=`https://molstar.org/viewer/?pdb=${h}&hide-controls=1`,console.log("%c\u{1F504} Switching to Mol*:","color: #E91E63; font-weight: bold;",p)):(p=buildMolViewEmbedUrl(h,"pdbid","biomolecule"),console.log("%c\u{1F504} Switching to MolView:","color: #9C27B0; font-weight: bold;",p));const x=document.createElement("iframe");x.src=p,x.style.cssText=a.style.cssText,x.setAttribute("allow",a.getAttribute("allow")||"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking"),x.setAttribute("allowfullscreen","true"),x.setAttribute("frameborder","0"),x.title=f?`Mol* Viewer: ${h}`:`MolView: ${h}`,a.parentNode&&(a.parentNode.replaceChild(x,a),console.log("%c\u2705 Created new iframe!","color: green; font-weight: bold;"))}else console.log("%c\u26A0\uFE0F Could not switch - missing iframe or pdbid","color: orange;")}else console.log("\u{1F4DD} Preference saved for next 3D view")}));const g=document.createElement("button");g.className="molecule-3d-cube-btn",g.innerHTML=i,g.title="View in 3D",g.style.cssText=`
    background: transparent;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    padding: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    box-sizing: border-box;
  `,g.addEventListener("mouseenter",()=>{g.style.background="rgba(255,255,255,0.15)"}),g.addEventListener("mouseleave",()=>{g.style.background="transparent"}),g.addEventListener("click",async T=>{T.stopPropagation(),console.log("\u{1F52E} 3D cube button clicked!",{moleculeData:o,element:e,useMolstar:f}),r&&(o.preferMolstar=f);try{await show3DViewerInline(o,e)}catch(k){console.error("\u274C Error showing 3D viewer:",k),alert("Failed to load 3D viewer: "+k.message)}}),c&&u.appendChild(c),u.appendChild(g);const y=u,w=null,d=document.createElement("div");d.className="chem-size-controls",d.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 1000;
  `,e.style.position!=="relative"&&e.style.position!=="absolute"&&(e.style.position="relative"),e.offsetWidth;const m=document.createElement("button");m.className="chem-size-btn chem-size-up",m.innerHTML="\u25B2",m.title="Increase size",m.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  `;const I=document.createElement("button");I.className="chem-size-btn chem-size-down",I.innerHTML="\u25BC",I.title="Decrease size",I.style.cssText=m.style.cssText;function A(T,k=100,a=80){const h=e.querySelector("img")||e.querySelector("iframe");if(!h)return;const p=h.offsetWidth||h.width||h.naturalWidth||300,x=h.offsetHeight||h.height||h.naturalHeight||200,S=Math.max(k,Math.round(p*T)),E=Math.max(a,Math.round(x*T));(v=>{v.style.setProperty("width",`${S}px`,"important"),v.style.setProperty("height",`${E}px`,"important"),v.style.setProperty("max-width","none","important"),v.style.setProperty("max-height","none","important")})(h),e.style.setProperty("width",`${S}px`,"important"),e.style.setProperty("height",`${E}px`,"important")}m.addEventListener("click",T=>{T.stopPropagation(),A(1.2)}),I.addEventListener("click",T=>{T.stopPropagation(),A(.8333)}),d.appendChild(m),d.appendChild(I),e.addEventListener("mouseenter",()=>{n.style.opacity="1",y.style.opacity="1",d.style.opacity="1",w&&(w.style.opacity="1")}),e.addEventListener("mouseleave",()=>{n.style.opacity="0.7",y.style.opacity="0",d.style.opacity="0",w&&(w.style.opacity="0")}),getComputedStyle(e).position==="static"&&(e.style.position="relative"),e.style.background="none",e.style.backgroundColor="transparent",e.style.border="none",e.style.boxShadow="none",e.appendChild(n),e.appendChild(y),w&&e.appendChild(w),e.appendChild(d)}function buildBioImageUrl(e){const t=e.toLowerCase(),o=settings.molviewBioAssembly?"assembly-1":"model-1";return`https://cdn.rcsb.org/images/structures/${t}_${o}.jpeg`}function buildMolViewEmbedUrl(e,t,o="compound"){const n="https://embed.molview.org/v1/",r=new URLSearchParams;if(r.set(t,e),o==="biomolecule"&&(settings.molviewChainType&&r.set("chainType",settings.molviewChainType),settings.molviewChainBonds&&r.set("chainBonds","true"),settings.molviewChainColor&&r.set("chainColor",settings.molviewChainColor),settings.proteinMolviewBgColor&&r.set("bg",settings.proteinMolviewBgColor)),o==="mineral"){if(settings.mineralRepresentation){const i={ballAndStick:"balls",stick:"stick",vdwSpheres:"vdw",wireframe:"wireframe",line:"line"};r.set("mode",i[settings.mineralRepresentation]||"balls")}settings.mineralMolviewBgColor&&r.set("bg",settings.mineralMolviewBgColor)}if(t==="smiles"||t==="cid"||o==="compound"){if(settings.molviewRepresentation){const i={ballAndStick:"balls",stick:"stick",vdwSpheres:"vdw",wireframe:"wireframe",line:"line"};r.set("mode",i[settings.molviewRepresentation]||"balls")}else r.has("mode")||r.set("mode","balls");settings.compoundMolviewBgColor&&r.set("bg",settings.compoundMolviewBgColor)}return n+"?"+r.toString()}window.parseChemFlags=parseChemFlags,window.stripFlagsFromName=stripFlagsFromName,window.applyFlagOverrides=applyFlagOverrides,window.buildMolViewEmbedUrl=buildMolViewEmbedUrl;function setupLazyLoading(){if(window._lazyLoadObserver){try{window._lazyLoadObserver.disconnect()}catch{}window._lazyLoadObserver=null}log.inject("\u{1F680} Setting up Intersection Observer for lazy-loading with performance optimization");let e=0;const t=3;function o(){e--,typeof g=="function"&&setTimeout(g,50)}const n=new IntersectionObserver(a=>{a.forEach(h=>{if(h.isIntersecting){const p=h.target;p.dataset.loaded==="false"&&p.dataset.src&&e<t&&(window.requestIdleCallback?requestIdleCallback(()=>{e<t&&r(p)},{timeout:1e3}):setTimeout(()=>{e<t&&r(p)},50))}})},{rootMargin:"300px"});function r(a){e++,log.debug(`\u{1F5BC}\uFE0F  Loading SVG (#${e}): ${a.dataset.src.substring(0,60)}...`),a.classList.add("molecule-fadein"),a.classList.remove("molecule-loading");const h=new Image;h.onload=()=>{a.src=a.dataset.src,a.dataset.loaded="true",n.unobserve(a),o(),log.debug(`\u2705 SVG loaded (${e} active loads remaining)`)},h.onerror=()=>{o(),log.debug(`\u274C SVG failed to load (${e} active loads remaining)`)},h.src=a.dataset.src}async function i(a,h){console.log("%c\u{1F9EC} RENDERBIOMOLECULE2D CALLED","background: #E91E63; color: white; font-weight: bold; padding: 4px;");try{const p=document.createElement("img");p.src=a.imageUrl,p.alt=a.nomenclature||"Biomolecule",p.className="molecule-diagram molecule-biomolecule",p.crossOrigin="anonymous";const x=settings.viewer3DSize||"normal",S={small:{width:200,height:150},medium:{width:300,height:250},normal:{width:400,height:350},large:{width:600,height:450},xlarge:{width:800,height:600}},E=S[x]||S.normal;if(p.style.cssText=`
        width: ${E.width}px;
        height: ${E.height}px;
        max-width: ${E.width}px;
        max-height: ${E.height}px;
        object-fit: contain;
        display: block;
        margin: 0;
        vertical-align: middle;
        cursor: pointer;
        border-radius: 8px;
      `,p.dataset.fixedSize="true",settings.proteinRemoveWhiteBg)try{const b=await backgroundFetchBlob(a.imageUrl);if(b&&b.base64){const v=new Image;v.onload=()=>{try{const F=document.createElement("canvas"),_=F.getContext("2d");F.width=v.naturalWidth,F.height=v.naturalHeight,_.drawImage(v,0,0);const R=_.getImageData(0,0,F.width,F.height),N=R.data;for(let M=0;M<N.length;M+=4){const V=N[M],j=N[M+1],L=N[M+2],D=Math.sqrt(Math.pow(255-V,2)+Math.pow(255-j,2)+Math.pow(255-L,2));D<15?N[M+3]=0:D<150&&(N[M+3]=Math.floor(255*(D-15)/135))}_.putImageData(R,0,0),p.src=F.toDataURL("image/png"),console.log("%c\u2705 White background removed successfully","color: #4CAF50; font-weight: bold;")}catch(F){console.warn("Canvas processing failed:",F.message)}},v.src=`data:${b.type||"image/jpeg"};base64,${b.base64}`}}catch(b){console.warn("Background removal failed:",b.message)}h.dataset.loaded="true",chrome.storage.sync.get({saveSizePerImage:!1,saveSizeBySMILES:!0},async b=>{await wrapImageWithSizeControls(p,h,a,b)})}catch(p){console.error("renderBiomolecule2D error:",p),h.alt="Failed to load biomolecule image",h.dataset.loaded="error"}}async function l(a,h){e++,console.log("%c\u{1F3A8} RENDER - Client-side (no server!)","background: #222; color: #00FF00; font-size: 16px; padding: 5px;"),console.log("Molecule data:",a);try{!a&&h.dataset.moleculeViewer&&(a=JSON.parse(atob(h.dataset.moleculeViewer)));const p=a.flags||{},x=p.displayName||a.nomenclature||a.name||"molecule";let S="mol",E=x,b=null;if(p.isDirectSmiles||a.smiles?(S="smiles",b=p.smilesValue||a.smiles||x,E=b):p.compoundType==="biomolecule"||p.isBiomolecule?(S="biomol",E=p.biomolValue||a.nomenclature||x):p.compoundType==="mineral"||p.isMineral?(S="mineral",E=p.mineralValue||a.nomenclature||x):p.isIUPAC?(S="iupac",E=p.iupacValue||a.nomenclature||x,console.log("%c\u{1F52C} IUPAC lookup:","color: #FF5722; font-weight: bold;",{iupacValue:p.iupacValue,lookupValue:E})):E=p.molValue||a.nomenclature||x,console.log(`%c\u{1F4CD} Client-side lookup: ${S}=`,"color: #2196F3; font-weight: bold;",E),S==="biomol"){try{const C=await queryRCSB(E);if(C&&C.pdbid){console.log(`%c\u{1F9EC} Got pdbid from RCSB: ${C.pdbid}`,"color: #E91E63; font-weight: bold;");const B={nomenclature:x,compoundType:"biomolecule",embedUrl:buildMolViewEmbedUrl(C.pdbid,"pdbid","biomolecule"),imageUrl:C.imageUrl||buildBioImageUrl(C.pdbid),pdbid:C.pdbid,is3D:a.is3D||a.show3D||p.is3D};B.is3D?await s(B,h):await i(B,h),o();return}}catch(C){console.error("Biomolecule lookup failed:",C.message)}h.alt=`Biomolecule not found: ${E}`,o();return}if(S==="mineral")try{let C=await queryCOD(E);if(C||(C=await queryMineralNamesFallback(E)),C&&C.codid)if(console.log(`%c\u{1F48E} Got CODID: ${C.codid}`,"color: #00BCD4; font-weight: bold;"),C.smiles&&!p.is3D)b=C.smiles,a.codid=C.codid;else{const B={nomenclature:x,compoundType:"mineral",embedUrl:`https://embed.molview.org/v1/?codid=${C.codid}`,codid:C.codid,formula:C.formula,is3D:!0};await s(B,h),o();return}else{console.warn("%c\u26A0\uFE0F Mineral not found:","color: #FF9800;",E),h.alt=`Mineral not found: ${E}`,o();return}}catch(C){console.error("Mineral lookup failed:",C.message),h.alt=`Mineral lookup failed: ${E}`,o();return}if(S==="iupac"&&!b)try{if(b=await queryOPSIN(E),!b){console.warn("%c\u26A0\uFE0F OPSIN could not parse IUPAC name:","color: #FF9800;",E);const C=await queryPubChemByName(E);C&&(b=settings.m2cfUse3DSmiles?C.isomericSmiles||C.canonicalSmiles:C.canonicalSmiles||C.isomericSmiles,a.cid=C.cid)}}catch(C){console.error("IUPAC lookup failed:",C.message)}if(S==="mol"&&!b)try{const C=await queryPubChemByName(E);if(C)b=settings.m2cfUse3DSmiles?C.isomericSmiles||C.canonicalSmiles:C.canonicalSmiles||C.isomericSmiles,a.cid=C.cid,console.log(`%c\u{1F9EA} Got SMILES from PubChem: ${b==null?void 0:b.substring(0,30)}...`,"color: #4CAF50; font-weight: bold;");else{const B=await queryPubChemAutocomplete(E);if(B.length>0){const U=B[0],O=await queryPubChemByName(U);O&&(b=settings.m2cfUse3DSmiles?O.isomericSmiles||O.canonicalSmiles:O.canonicalSmiles||O.isomericSmiles,a.cid=O.cid,console.log(`%c\u{1F9EA} Got SMILES via autocomplete match "${U}": ${b==null?void 0:b.substring(0,30)}...`,"color: #4CAF50;"))}}}catch(C){console.error("PubChem lookup failed:",C.message)}if(a.is3D||a.show3D||p.is3D){await s(a,h),o();return}if(!b){console.error("%c\u274C Could not find SMILES for:","color: red;",E),h.alt=`Could not find SMILES for: ${E}`,o();return}console.log("%c\u{1F3A8} Rendering with SmilesDrawer:","background: #4CAF50; color: white; font-weight: bold; padding: 4px;",b.substring(0,50));const v=settings.enableAIFlagControl===!0;let F=settings.m2cfShowCarbons===!0,_=settings.m2cfAromaticCircles===!0,R=settings.m2cfShowMethyls===!0,N=settings.m2cfAtomNumbers===!0,M=settings.m2cfFlipVertical===!0,V=settings.m2cfFlipHorizontal===!0,j=settings.m2cfAddH2===!0,L=settings.m2cfShowImplicitH!==!1,D=settings.m2cfCompactDrawing===!0;v&&p.flagsLocked&&(p.showCarbons!==void 0&&(F=p.showCarbons),p.aromaticCircles!==void 0&&(_=p.aromaticCircles),p.showMethyls!==void 0&&(R=p.showMethyls),p.atomNumbers!==void 0&&(N=p.atomNumbers),p.addHydrogens!==void 0&&(j=p.addHydrogens),p.showImplicitH!==void 0&&(L=p.showImplicitH),p.flipHorizontal!==void 0&&(V=p.flipHorizontal),p.flipVertical!==void 0&&(M=p.flipVertical));const H=settings.sdTheme||"light",G=settings.sdGradientColors===!0,P=settings.sdBondThickness||1,$=300,z=240;let Y=$,Z=z;if(settings.sdScaleByWeight&&b){const B=b.replace(/[@\/\\]/g,"").replace(/\[[^\]]+\]/g,"X").match(/[A-Z]/g),U=B?B.length:20,O=Math.max(.7,Math.min(4,Math.sqrt(U)/Math.sqrt(20)));Y=Math.round($*O),Z=Math.round(z*O),console.log(`\u{1F4D0} Intelligent sizing: ${U} atoms \u2192 ${O.toFixed(2)}x scale`)}const ee={width:Y,height:Z,bondThickness:2*P,bondLength:25,shortBondLength:.85,bondSpacing:6,atomVisualization:"default",isomeric:!0,debug:!1,showCarbons:F,terminalCarbons:R,explicitHydrogens:j,showHydrogens:j,showImplicitHydrogens:L,showAromaticRings:_,atomNumbering:N,solidBondColors:!G,compactDrawing:D,overlapSensitivity:.42,overlapResolutionIterations:1,fontSizeLarge:11,fontSizeSmall:3,padding:10,experimentalSSSR:!1,themes:{dark:{C:"#ffffff",O:"#ff6b6b",N:"#4dabf7",F:"#51cf66",CL:"#20c997",BR:"#fd7e14",I:"#be4bdb",P:"#fd7e14",S:"#fcc419",B:"#f59f00",SI:"#f59f00",H:"#aaaaaa",ATOM_NUMBER:"#ffd700",BACKGROUND:"transparent"},light:{C:"#222222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",H:"#666666",ATOM_NUMBER:"#2196F3",BACKGROUND:"transparent"}}};queueSmilesDrawerParse(b,C=>{let B=null;try{const U=`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;B=document.createElement("div"),B.style.cssText="position:absolute;left:-9999px;top:-9999px;visibility:hidden;",B.innerHTML=`<svg id="${U}"></svg>`,document.body.appendChild(B),getOrCreateSvgDrawer(ee).draw(C,U,H);const J=document.getElementById(U);if(J){try{const q=J.getBBox(),X=10;J.setAttribute("width",Math.ceil(q.width+X*2)),J.setAttribute("height",Math.ceil(q.height+X*2)),J.setAttribute("viewBox",`${q.x-X} ${q.y-X} ${q.width+X*2} ${q.height+X*2}`)}catch(q){console.warn("Could not get bbox:",q)}const oe=new XMLSerializer().serializeToString(J),te="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(oe),W=document.createElement("img");W.src=te,W.alt=x,W.className="molecule-diagram",W.dataset.moleculeViewer="true",W.dataset.smiles=b,W.dataset.nomenclature=x,W.dataset.compoundType=S,W.style.cssText="display: block; margin: 0; padding: 0; border: none;";let K=[];M&&K.push("scaleY(-1)"),V&&K.push("scaleX(-1)"),p.rotation&&K.push(`rotate(${p.rotation}deg)`),K.length>0&&(W.style.transform=K.join(" "));const Q=wrapImageWithRotationContainer(W,p.rotation,x,a);h.parentNode&&(h.parentNode.replaceChild(Q,h),addHoverControls(Q,x,a),console.log("%c\u2705 SmilesDrawer rendered successfully","color: green; font-weight: bold;"))}}catch(U){console.error("%c\u274C SmilesDrawer render error:","color: red;",U)}finally{B&&B.parentNode&&B.parentNode.removeChild(B)}},C=>{console.error("%c\u274C SmilesDrawer parse error:","color: red;",C),h.alt=`Error parsing SMILES: ${C.message}`}),o()}catch(p){console.error("%c\u274C Rendering error:","color: red; font-weight: bold;",p),h.alt=`Error: ${p.message}`,o()}}async function s(a,h){var E,b;const p=((E=a.flags)==null?void 0:E.displayName)||a.nomenclature||a.smiles||"";let x=h;if(x.classList&&x.classList.contains("molecule-3d-viewer")){console.log("\u{1F504} Toggling back to 2D view");const v=x._original2DElement;v&&x.parentNode&&(x.parentNode.replaceChild(v,x),console.log("\u2705 Restored original 2D view"));return}let S=h;if(h.tagName!=="IMG"){if(S=h.querySelector("img"),!S){const v=h.querySelector(".molecule-size-wrapper");v&&(S=v.querySelector("img"),x=v)}S||h.classList&&(h.classList.contains("chem-3d-placeholder")||h.classList.contains("chem-2d-viewer-container")||h.classList.contains("molecule-viewer-container"))&&(console.log("%c\u{1F504} Using container as target (no img element)","color: #ff9800;"),S=null,x=h)}if(!S&&!x)throw console.error("\u274C Could not find img element or valid container in:",h),new Error("Could not find image element");try{const v=a.compoundType||((b=a.flags)==null?void 0:b.compoundType)||"compound",F=v==="biomolecule";let _;if(F){const L=settings.viewer3DSize||"normal",D={small:{width:200,height:150},medium:{width:300,height:250},normal:{width:400,height:350},large:{width:600,height:450},xlarge:{width:800,height:600}};_=D[L]||D.normal,console.log("%c\u{1F9EC} Biomolecule 3D Viewer Size (fixed):","color: #E91E63; font-weight: bold;",L,_)}else{const L=S&&(S.offsetWidth||S.naturalWidth)||300,D=S&&(S.offsetHeight||S.naturalHeight)||200,H=L/D,G=(v==="mineral"?settings.mineral3DSize||100:settings.compound3DSize||100)/100,$=Math.round(300*G),z=Math.round($/H);_={width:$,height:z},console.log("%c\u{1F9EA} Compound/Mineral 3D Viewer Size (aspect ratio preserved):","color: #4CAF50; font-weight: bold;",{type:v,scaleFactor:G,aspectRatio:H.toFixed(2),dimensions:_})}const R=document.createElement("div");R.className="molecule-viewer-container molecule-3d-viewer",R.style.cssText=`
        display: inline-block;
        width: ${_.width}px;
        height: ${_.height}px;
        margin: 0;
        padding: 0;
        vertical-align: middle;
        position: relative;
        border: none;
        outline: none;
        border-radius: 8px;
        overflow: hidden;
        background: transparent;
        box-shadow: none;
        max-width: 100%;
        box-sizing: border-box;
      `;const N=document.createElement("iframe");let M;if(a.embedUrl||a.pdbid||a.codid){const L=a.compoundType||"compound";if(a.pdbid){const D=a.pdbid.toLowerCase();if(a.preferMolstar===!0||settings.molviewBioAssembly===!0){const G=settings.bioAssemblyGraphics||"balanced",P=settings.bioAssemblyPdbProvider||"rcsb";settings.molviewBioAssembly?"molstar"==="molstar-me"?(M=`https://molstar.org/me/viewer/?pdb=${D}&hide-controls=1&graphics-mode=${G}&pdb-provider=${P}`,console.log("%c\u{1F9EC} Using Mol* Mesoscale Explorer:","color: #FF5722; font-weight: bold;",M)):(M=`https://molstar.org/viewer/?pdb=${D}&assembly-id=1&hide-controls=1`,console.log("%c\u{1F9EC} Using Mol* Standard Viewer:","color: #E91E63; font-weight: bold;",M)):(M=`https://molstar.org/viewer/?pdb=${D}&hide-controls=1`,console.log("%c\u{1F9EC} Using Mol* (user selected):","color: #E91E63; font-weight: bold;",M))}else M=buildMolViewEmbedUrl(a.pdbid,"pdbid","biomolecule"),console.log("%c\u{1F9EC} Using MolView (default):","color: #9C27B0; font-weight: bold;",M)}else a.codid?(M=buildMolViewEmbedUrl(a.codid,"codid","mineral"),console.log("%c\u{1F48E} Built MolView URL for mineral with settings:","color: #00BCD4; font-weight: bold;",M)):(console.log("%c\u{1F52E} Using stored embed URL:","color: #9C27B0; font-weight: bold;",a.embedUrl),M=a.embedUrl);N.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking")}else{if(console.log("%c\u{1F9EA} COMPOUND 3D VIEWER PATH","background: #4CAF50; color: white; font-weight: bold; padding: 4px;"),console.log("moleculeData:",a),console.log("compoundName:",p),a.cid)M=buildMolViewEmbedUrl(a.cid,"cid","compound"),console.log("%c\u{1F4CD} MolView URL (CID):","color: #4CAF50; font-weight: bold;",M);else if(a.smiles)M=buildMolViewEmbedUrl(a.smiles,"smiles","compound"),console.log("%c\u{1F4CD} MolView URL (SMILES):","color: #0066cc; font-weight: bold;",M);else if(p)try{const L=await fetchFromChemistryLaTeXServer("mol",p);if(L&&L.cid)M=buildMolViewEmbedUrl(L.cid,"cid","compound"),console.log("%c\u{1F4CD} MolView URL (fetched CID):","color: #4CAF50; font-weight: bold;",M);else if(L&&L.smiles)M=buildMolViewEmbedUrl(L.smiles,"smiles","compound"),console.log("%c\u{1F4CD} MolView URL (fetched SMILES):","color: #0066cc; font-weight: bold;",M);else throw new Error("No CID or SMILES found")}catch(L){console.error("%c\u274C Could not fetch CID for 3D view:","color: red;",L.message),M="about:blank"}else console.error("%c\u274C No identifier for 3D view","color: red;"),M="about:blank";N.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking"),console.log("%c\u{1F3AF} Final viewerUrl:","background: blue; color: white; font-weight: bold;",M)}M||(console.error("%c\u274C viewerUrl is undefined - preventing iframe from loading current page","color: red; font-weight: bold;"),M="about:blank"),N.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; xr-spatial-tracking"),N.setAttribute("allowfullscreen","true"),N.setAttribute("frameborder","0"),N.style.cssText=`
        width: 100%;
        height: 100%;
        border: none !important;
        outline: none !important;
        margin: 0;
        padding: 0;
        display: block;
        background: transparent;
        box-shadow: none;
      `,N.title=`3D Viewer: ${p}`,R._original2DElement=x,R.appendChild(N);const V=document.createElement("div");V.className="chem-size-controls",V.style.cssText=`
        position: absolute;
        bottom: 4px;
        left: 4px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s;
      `,R.style.position!=="relative"&&R.style.position!=="absolute"&&(R.style.position="relative"),R.onmouseenter=()=>V.style.opacity="1",R.onmouseleave=()=>V.style.opacity="0";const j=(L,D)=>{const H=document.createElement("button");return H.innerHTML=L,H.style.cssText=`
          width: 24px;
          height: 24px;
          border: none;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background 0.2s;
        `,H.onmouseenter=()=>H.style.background="rgba(0, 0, 0, 0.9)",H.onmouseleave=()=>H.style.background="rgba(0, 0, 0, 0.7)",H.onclick=G=>{G.stopPropagation();const P=parseInt(R.style.width),$=parseInt(R.style.height);if(D<0&&P<200)return;const z=1+D/100;R.style.width=`${Math.round(P*z)}px`,R.style.height=`${Math.round($*z)}px`},H};if(R.style.position!=="relative"&&R.style.position!=="absolute"&&(R.style.position="relative"),R.offsetWidth,V.appendChild(j("\u25B2",10)),V.appendChild(j("\u25BC",-10)),R.appendChild(V),N.src=M,console.log("%c\u{1F680} 3D Viewer Loaded directly","color: #00FF00; font-weight: bold"),a.pdbid&&M.includes("embed.molview.org")){const L=a.pdbid.toUpperCase();let D=!1;const H=`https://molstar.org/viewer/?pdb=${L.toLowerCase()}&hide-controls=1`,G=()=>{if(D)return;D=!0,console.log("%c\u26A0\uFE0F MolView failed - switching to Mol* viewer","color: orange; font-weight: bold;");const $=document.createElement("iframe");$.src=H,$.style.cssText=N.style.cssText,$.setAttribute("allow",N.getAttribute("allow")||""),$.setAttribute("allowfullscreen","true"),$.setAttribute("frameborder","0"),$.title=`Mol* Viewer: ${L}`,N.parentNode&&(N.parentNode.replaceChild($,N),console.log("%c\u{1F504} Switched to Mol* viewer:","color: #4CAF50; font-weight: bold;",H))},P=$=>{if($.origin==="https://embed.molview.org"&&!D){const z=$.data;z&&(z.error||z.type==="error"||typeof z=="string"&&z.toLowerCase().includes("error")||typeof z=="string"&&z.toLowerCase().includes("failed")||typeof z=="string"&&z.toLowerCase().includes("404")||typeof z=="string"&&z.toLowerCase().includes("not found"))&&(console.log("%c\u274C MolView error message detected - switching to Mol*","color: red; font-weight: bold;",z),G(),window.removeEventListener("message",P))}};window.addEventListener("message",P),setTimeout(()=>{window.removeEventListener("message",P)},6e4)}x.parentNode?(x.parentNode.replaceChild(R,x),addHoverControls(R,p,a),console.log("%c\u2705 3D viewer embedded inline","color: green; font-weight: bold;")):(console.error("%c\u274C Cannot replace image - no parent node","color: red; font-weight: bold;"),S.nextSibling?S.parentElement.insertBefore(R,S.nextSibling):S.parentElement.appendChild(R),S.style.display="none"),o()}catch(v){console.error("%c\u274C Error showing 3D viewer inline:","color: red; font-weight: bold;",v);const F=buildServerSvgUrl("mol",p,{showCarbons:settings.m2cfShowCarbons,aromaticCircles:settings.m2cfAromaticCircles,renderingEngine:settings.renderingEngine});S.src=F,S.classList.add("molecule-fadein"),S.classList.remove("molecule-loading"),o()}}function u(a){console.log("%c\u{1F3A8} [loadMoleculeImage] Rendering molecule","background: #9C27B0; color: white; font-weight: bold; padding: 4px;");try{const h=JSON.parse(atob(a.dataset.moleculeViewer||a.dataset.mol2chemfig));console.log("%c\u{1F4E6} Decoded molecule data:","color: #9C27B0;",h),l(h,a)}catch(h){console.error("%c\u274C [loadMoleculeImage] Failed to parse molecule data:","color: red;",h.message),a.alt="\u26A0\uFE0F Failed to render molecule",a.style.minWidth="100px",a.style.minHeight="50px",a.style.backgroundColor="#ffebee",a.style.border="1px solid #ef5350",a.style.borderRadius="4px",a.style.padding="10px",a.dataset.loaded="error"}}const c=[];let f=!1;function g(){if(!(f||c.length===0)){for(f=!0;c.length>0&&e<t;){const a=c.shift();a.dataset.loaded!=="true"&&a.dataset.loaded!=="loading"&&(a.dataset.loaded="loading",u(a))}f=!1,c.length>0&&setTimeout(g,200)}}const y=n,w=new IntersectionObserver(a=>{a.forEach(h=>{const p=h.target;h.isIntersecting&&p.dataset.loaded!=="true"&&p.dataset.loaded!=="loading"&&(p.classList.contains("molecule-viewer")||p.classList.contains("molecule-compound")||p.classList.contains("molecule-legacy")?(console.log(`%c\u{1F9EA} Molecule image entered viewport: ${p.alt||"unknown"}`,"background: #0088FF; color: #FFF; padding: 4px;"),w.unobserve(p),e<t?(p.dataset.loaded="loading",u(p)):(console.log(`%c\u23F3 Queuing molecule (${e}/${t} active): ${p.alt||"unknown"}`,"background: #FFA500; color: white; padding: 2px;"),c.push(p),setTimeout(g,100))):e<t?r(p):typeof requestIdleCallback<"u"?requestIdleCallback(()=>{e<t&&r(p)}):setTimeout(()=>{e<t&&r(p)},50))})},{rootMargin:"300px"});window._lazyLoadObserver=w,window._loadMoleculeImage=u,window._queueMoleculeLoad=function(a){a.dataset.loaded==="true"||a.dataset.loaded==="loading"||(e<t?(a.dataset.loaded="loading",u(a)):(console.log(`%c\u23F3 Queuing molecule: ${a.alt||"unknown"}`,"background: #FFA500; color: white; padding: 2px;"),c.push(a),setTimeout(g,100)))},window.show3DViewerInline=s;const d=10,m=1500;let I=0;const A=500;function T(){const a=Date.now();if(a-I<A)return;I=a;const h=document.querySelectorAll('img.molecule-diagram[data-loaded="false"], img.molecule-diagram:not([data-loaded])');if(h.length===0)return;const p=window.scrollY-m,x=window.scrollY+window.innerHeight+m,S=[];if(h.forEach(b=>{const v=b.getBoundingClientRect(),F=window.scrollY+v.top;F>=p&&F<=x&&S.push({img:b,distance:Math.abs(F-(window.scrollY+window.innerHeight/2))})}),S.length===0)return;S.sort((b,v)=>b.distance-v.distance);const E=S.slice(0,d);console.log(`%c\u{1F4E6} Preloading chunk of ${E.length} molecules (${S.length} nearby, ${h.length} total unloaded)`,"background: #9C27B0; color: white; padding: 2px;"),E.forEach(({img:b})=>{window._queueMoleculeLoad&&window._queueMoleculeLoad(b)})}let k=null;window.addEventListener("scroll",()=>{k&&clearTimeout(k),k=setTimeout(T,150)},{passive:!0}),setTimeout(T,1e3),log.success("\u2705 Lazy-loading observer initialized (max 3 concurrent loads)")}let scanAndRenderTimeout=null,lastScanTime=0;const MIN_SCAN_INTERVAL=1e3;function scanAndRender(){scanAndRenderTimeout&&clearTimeout(scanAndRenderTimeout);const t=Date.now()-lastScanTime;if(t<MIN_SCAN_INTERVAL){const o=MIN_SCAN_INTERVAL-t;scanAndRenderTimeout=setTimeout(()=>{scanAndRenderImmediate()},o),console.log(`[ChemRenderer] Debouncing scan, will run in ${o}ms`);return}scanAndRenderImmediate()}function scanAndRenderImmediate(){if(lastScanTime=Date.now(),!settings.enabled){log.debug("scanAndRender() called but extension is disabled");return}log.inject("\u{1F50D} STARTING PAGE SCAN for chemical formulas");const e=document.getElementsByTagName("*");let t=0,o=0,n=0,r=[];const i=1e4;log.debug(`Total elements in DOM: ${e.length}`);for(let l=0;l<e.length&&o<i;l++){const s=e[l];if(o++,s.tagName==="SCRIPT"||s.tagName==="STYLE"||s.tagName==="NOSCRIPT"||s.classList.contains("MathJax")||s.hasAttribute("data-chem-processed"))continue;const u=[];let c="";const f=document.createTreeWalker(s,NodeFilter.SHOW_TEXT,{acceptNode:y=>y.parentNode===s?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP});let g;for(;g=f.nextNode();)u.push(g),c+=g.nodeValue;if(!(u.length===0||!c)&&(c.includes("chem:")||c.includes("\\ce{")||c.includes("ce{"))){n++,r.push(c.substring(0,100)),log.debug(`\u{1F52C} Found potential chemistry text: "${c.substring(0,80)}..."`);const y=wrapChemicalFormulas(c);if(y!==c){log.debug(`\u2728 Found formula in text: "${c.substring(0,50)}..."`),log.debug(`Wrapped result: "${y.substring(0,50)}..."`);const w=document.createElement("span");w.innerHTML=y,w.setAttribute("data-chem-processed","true"),s.replaceChild(w,u[0]);for(let m=1;m<u.length;m++)u[m].parentNode&&u[m].parentNode.removeChild(u[m]);const d=w.querySelectorAll('img.molecule-diagram[data-loaded="false"]');if(console.log("%c[ChemRenderer] Found images to load:","color: #FF00FF; font-weight: bold;",d.length),d.length>0)if(console.log("%c[ChemRenderer] Performance mode:","color: #FF00FF;",settings.performanceMode),console.log("%c[ChemRenderer] _lazyLoadObserver exists:","color: #FF00FF;",!!window._lazyLoadObserver),console.log("%c[ChemRenderer] _loadMoleculeImage exists:","color: #FF00FF;",!!window._loadMoleculeImage),settings.performanceMode&&window._lazyLoadObserver)d.forEach(m=>{console.log("%c[ChemRenderer] Observing image for lazy load:","color: #FF00FF;",m.className),window._lazyLoadObserver.observe(m)}),log.debug(`\u{1F4CA} Setup lazy-loading for ${d.length} SVGs`);else if(window._loadMoleculeImage&&window._queueMoleculeLoad){console.log(`%c[ChemRenderer] \u{1F680} Chunk-loading ${d.length} images (lazy loading disabled)`,"color: #00FF00; font-weight: bold;");const m=window.scrollY+window.innerHeight/2,I=Array.from(d).map(A=>{const T=A.getBoundingClientRect(),k=window.scrollY+T.top+T.height/2,a=Math.abs(k-m);return{img:A,distance:a}});I.sort((A,T)=>A.distance-T.distance),I.forEach(({img:A},T)=>{window._queueMoleculeLoad(A)}),log.debug(`\u{1F4CA} Queued ${d.length} SVGs for chunk-based loading`)}else window._loadMoleculeImage?(console.log(`%c[ChemRenderer] \u{1F680} Fallback loading ${d.length} images`,"color: #FFAA00; font-weight: bold;"),d.forEach((m,I)=>{m.dataset.loaded="pending",setTimeout(()=>{m.dataset.loaded==="pending"&&(m.dataset.loaded="loading",window._loadMoleculeImage(m))},I*300)}),log.debug(`\u{1F4CA} Triggered fallback loading for ${d.length} SVGs`)):console.error("%c[ChemRenderer] ERROR: No loader available!","color: #FF0000; font-weight: bold;");t++}}}log.inject("\u{1F4CA} Scan results:"),log.inject(`  - Elements scanned: ${o}`),log.inject(`  - Text nodes found: ${n}`),log.inject(`  - Formulas wrapped: ${t}`),r.length>0&&(log.inject(`  - Chemistry text samples: ${r.length} found`),r.forEach((l,s)=>{log.debug(`    Sample ${s+1}: ${l}`)})),t>0?(log.inject(`\u{1F3A8} ${t} formula(s) found and processed!`),window.MathJax&&window.MathJax.typesetPromise?(log.inject("Calling MathJax.typesetPromise() for final rendering"),MathJax.typesetPromise().then(()=>{log.success("\u2728 RENDERING COMPLETE! Formulas rendered with MathJax")}).catch(l=>{log.debug("MathJax rendering skipped (not available), using fallback")})):log.success("\u2728 Formulas processed - CodeCogs and Unicode rendering active")):log.debug("No formulas found in this scan - page may not contain chemistry notation"),window._chemRendererObserver||(log.inject("Setting up dynamic content observer"),observePageChanges())}function wrapChemicalFormulas(e){if(!e||e.trim().length===0)return e;if(e.length>5e4)return console.warn("[ChemRenderer] Text too long for processing, skipping"),e;let t=e,o=[];if(log.debug("\u{1F9EA} Applying Pattern 0b: chem:text: \u2192 Using selected renderer engine"),t.length>0){const i=t.substring(0,200);console.log("[ChemRenderer] \u{1F50D} DEBUG: Scanning text sample:",i),console.log("[ChemRenderer] \u{1F50D} DEBUG: Text length:",t.length),console.log("[ChemRenderer] \u{1F50D} DEBUG: Looking for pattern: /\\bchem:([^:]+):/g")}const n=/\bchem:([^=]*?)(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid)=([^:]+):/gi,r=t.match(n);return console.log("[ChemRenderer] \u{1F50D} DEBUG: chemMatches result:",r),r&&(r.length>100&&(console.warn("[ChemRenderer] Too many chem: patterns detected, limiting to first 100"),r.length=100),log.debug(`  Found ${r.length} chem:type=value: patterns`),console.log("[ChemRenderer] \u2705 Found patterns:",r),log.debug(`  Renderer engine: ${settings.rendererEngine}, 3D Viewer enabled: ${settings.enable3DViewer}`),t=t.replace(/\bchem:([^=]*?)(smiles|mol|biomol|mineral|iupac|pbdid|cid|codid)=([^:]+):/gi,(i,l,s,u)=>{try{const c=u.trim(),f=l?l.trim():"";if(!c||c.length>500)return i;if(/\s+[a-zA-Z]{2,}/.test(c))return console.warn("[ChemRenderer] Skipping invalid content (looks like sentence):",c),i;if(/\b(should|only|with|that|this|the|and|for|not|use|when|from|have|are|was|were)\b/i.test(c))return console.warn("[ChemRenderer] Skipping invalid content (contains English words):",c),i;const y=f?f+s.toLowerCase()+"="+c:s.toLowerCase()+"="+c;log.debug(`  Converting molecule: ${y} (displayName: "${f}")`),window.chemRendererPerformance.recordStructure();let w=f||c,d={useDefaults:!1},m=settings;if(!0)try{const b=settings.enableAIFlagControl===!0;console.log("%c\u{1F527} AI Flag Control setting:","color: #FF6B00; font-weight: bold;",b,"raw value:",settings.enableAIFlagControl),d=window.parseChemFlags("chem:"+y+":",b),console.log("%c\u{1F3F4} Parsed flags:","color: #FF6B00; font-weight: bold;",d),d.moleculeName&&!f&&(w=d.moleculeName);let v;d.useDefaults?v=settings:d.flagsLocked?v={...settings,m2cfShowCarbons:!1,m2cfAromaticCircles:!1,m2cfShowMethyls:!1,m2cfAtomNumbers:!1,m2cfAddH2:!1,m2cfFlipHorizontal:!1,m2cfFlipVertical:!1,m2cfInvert:!1}:v=settings,m=window.applyFlagOverrides(v,d),console.log("%c\u2699\uFE0F Applied settings:","color: #9C27B0; font-weight: bold;",{useDefaults:d.useDefaults,flagsLocked:d.flagsLocked,showCarbons:m.m2cfShowCarbons,aromaticCircles:m.m2cfAromaticCircles,showMethyls:m.m2cfShowMethyls,atomNumbers:m.m2cfAtomNumbers,addH2:m.m2cfAddH2,flipHorizontal:m.m2cfFlipHorizontal,flipVertical:m.m2cfFlipVertical,invert:m.m2cfInvert,compoundType:d.compoundType,isDirectSmiles:d.isDirectSmiles}),d.moleculeName||(y.includes("/")?w=y.split("/")[0].trim():y.includes("+")?w=y.split("+")[0].trim():y.includes("-")&&(w=y.split("-")[0].trim()))}catch(b){console.error("Error processing flags, using default behavior:",b),w=y,m=settings}const A=d.isDirectSmiles,T=d.compoundType;console.log(`%c\u{1F4E6} Type detection: isDirectSmiles=${A}, specifiedType=${T}, compoundName=${w}`,"color: #2196F3; font-weight: bold;");const k={...d,compoundType:T==="smiles"?"compound":T,isDirectSmiles:A,smilesValue:d.smilesValue,displayName:d.moleculeName},a=d.smilesValue||(A?w:null);if(d.isDirectID&&d.idValue){const b=d.idValue,v=d.moleculeName||b;if(d.idType==="pdbid"){console.log("%c\u{1F9EC} DIRECT PDB ID LOOKUP:","background: #E91E63; color: white; font-weight: bold; padding: 4px;",b);const R=`<img src="" alt="chem" class="molecule-diagram molecule-biomolecule" data-molecule-viewer="${btoa(JSON.stringify({pdbid:b,name:v,type:"pdbid",compoundType:"biomolecule",flags:k}))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending PDB ID to biomolecule viewer: ${b}`),R}else if(d.idType==="cid"){console.log("%c\u{1F9EA} DIRECT CID LOOKUP:","background: #4CAF50; color: white; font-weight: bold; padding: 4px;",b);const F={cid:b,name:v,type:"cid",isCompound:!0,directLookup:!0,flags:{...k,compoundType:"compound",skipIntegratedSearch:!0}},R=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(F))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending CID to server: ${b}`),R}else if(d.idType==="codid"){console.log("%c\u{1F48E} DIRECT COD ID LOOKUP:","background: #9C27B0; color: white; font-weight: bold; padding: 4px;",b);const R=`<img src="" alt="chem" class="molecule-diagram molecule-mineral" data-molecule-viewer="${btoa(JSON.stringify({codid:b,name:v,type:"codid",compoundType:"mineral",flags:k}))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending COD ID to mineral viewer: ${b}`),R}}if(d.is3D){const b={...a?{smiles:a}:{nomenclature:w},name:w,type:a?"smiles":"nomenclature",isCompound:!0,show3D:!0,auto3D:!0,flags:k},F=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(b))}" data-loaded="false" data-show-3d="true" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending ${a?"SMILES":"nomenclature"} to 3D viewer: ${w}`),F}if(d.isCompound||T==="compound"){console.log("%c\u{1F9EA} DIRECT COMPOUND PATH (mol= syntax)","background: #4CAF50; color: white; font-weight: bold; padding: 4px;");const b={...a?{smiles:a}:{nomenclature:w},name:w,type:a?"smiles":"nomenclature",isCompound:!0,directLookup:!0,flags:{...k,compoundType:"compound",skipIntegratedSearch:!0}},F=`<img src="" alt="chem" class="molecule-diagram molecule-compound" data-molecule-viewer="${btoa(JSON.stringify(b))}" data-loaded="false" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending ${a?"SMILES":"nomenclature"} DIRECTLY to server (mol= syntax): ${w}`),F}const h=m.m2cfRotate||m.mvRotate||0,p=d.size||1,x={...a?{smiles:a}:{nomenclature:w},type:a?"smiles":"nomenclature",options:{width:Math.round(300*p),height:Math.round(200*p),aromaticCircles:m.m2cfAromaticCircles,fancyBonds:m.m2cfFancyBonds,showCarbons:m.m2cfShowCarbons,showMethyls:m.m2cfShowMethyls,atomNumbers:m.m2cfAtomNumbers,hydrogensMode:m.m2cfHydrogensMode,addH2:m.m2cfAddH2,flipHorizontal:m.m2cfFlipHorizontal,flipVertical:m.m2cfFlipVertical,scale:p,rotation:d.rotation||h},isMoleculeViewer:!0,flags:k},E=`<img src="" alt="chem" class="molecule-diagram molecule-viewer" data-molecule-viewer="${btoa(JSON.stringify(x))}" data-loaded="false" data-rotation="${h}" style="display: inline-block; height: auto; margin: 0 12px 8px 0; vertical-align: middle; padding: 4px; border-radius: 4px; background-color: transparent;">`;return log.debug(`  \u{1F4E4} Sending ${A?"SMILES":"nomenclature"} to MoleculeViewer: ${w} (type: ${T||"auto-detect"})`),E}catch(c){return console.error("[ChemRenderer] \u274C Error processing molecule:",{error:c.message,stack:c.stack,content:content_trimmed,match:i}),i}})),o.length>0&&log.debug(`\u2705 Total patterns found & converted: ${o.length}`),t}function observePageChanges(){if(window._chemRendererObserver){try{window._chemRendererObserver.disconnect(),clearTimeout(window._chemRendererObserver.timer)}catch{}window._chemRendererObserver=null}log.inject("\u{1F504} Setting up mutation observer for dynamic content detection");let e=0,t=!1,o=0,n=!1,r=0;const i=1e3,l=2e3,s=new MutationObserver(u=>{if(t)return;const c=Math.min(u.length,5);for(let f=0;f<c;f++){const g=u[f].target;if(g&&(g.classList&&(g.classList.contains("molecule-diagram")||g.classList.contains("molecule-container")||g.classList.contains("molecule-viewer")||g.classList.contains("chem-size-controls")||g.classList.contains("chemistrylatex-image-loading-indicator"))||g.closest&&g.closest(".molecule-container, .chem-image-container, .molecule-viewer-container")))return}if(o+=u.length,e++,o>i){const f=Date.now();(!n||f-r>l)&&(log.warn(`\u26A0\uFE0F High mutation rate detected (${o}), throttling to prevent crashes...`),n=!0,r=f),o=0,clearTimeout(s.timer),s.timer=setTimeout(()=>{if(n=!1,o=0,settings.enabled&&!t&&!isUpdatingImages){t=!0;try{log.inject("\u26A1 Delayed re-scan after high mutation period"),scanAndRender()}catch(g){log.error("Error during page scan:",g)}finally{setTimeout(()=>{t=!1},200)}}},1500);return}e%100===0&&log.debug(`Detected ${e} total mutations`),clearTimeout(s.timer),s.timer=setTimeout(()=>{if(o=0,isUpdatingImages){log.debug("\u23ED\uFE0F Skipping re-scan - currently updating images");return}if(settings.enabled){t=!0;try{log.inject("\u26A1 Re-scanning page after dynamic content detected"),scanAndRender()}catch(f){log.error("Error during page scan:",f)}finally{setTimeout(()=>{t=!1},100)}}},500)});s.observe(document.documentElement,{childList:!0,subtree:!0,characterData:!1}),window._chemRendererObserver=s,log.success("\u2705 Dynamic content observer initialized")}function cleanupObservers(){try{window._chemRendererObserver&&(window._chemRendererObserver.disconnect(),clearTimeout(window._chemRendererObserver.timer),window._chemRendererObserver=null),window._lazyLoadObserver&&(window._lazyLoadObserver.disconnect(),window._lazyLoadObserver=null),lazyReRenderObserver&&(lazyReRenderObserver.disconnect(),lazyReRenderObserver=null),renderedImageCache.clear(),pendingSearches.clear(),imagesBeingRendered.clear(),log.info("\u{1F9F9} Cleaned up all observers and caches")}catch{}}if(window.addEventListener("beforeunload",cleanupObservers),window.addEventListener("pagehide",cleanupObservers),window.matchMedia){let t=function(o){console.log(`%c\u{1F313} Dark mode ${o?"enabled":"disabled"} - updating molecule colors`,"color: #00AAFF; font-weight: bold;"),document.querySelectorAll("img.molecule-diagram").forEach(i=>{const l=i.src;if(l&&l.startsWith("data:image/svg+xml;base64,"))try{const s=l.replace("data:image/svg+xml;base64,",""),u=atob(s);let c=u;if(o?c=c.replace(/#000000/gi,"#FFFFFF").replace(/#000\b/gi,"#FFF").replace(/rgb\(0,\s*0,\s*0\)/gi,"rgb(255, 255, 255)").replace(/stroke="black"/gi,'stroke="white"').replace(/fill="black"/gi,'fill="white"'):c=u.replace(/#FFFFFF/gi,"#000000").replace(/#FFF\b/gi,"#000").replace(/rgb\(255,\s*255,\s*255\)/gi,"rgb(0, 0, 0)").replace(/stroke="white"/gi,'stroke="black"').replace(/fill="white"/gi,'fill="black"'),i.dataset.originalSrc||(i.dataset.originalSrc=l),!o&&i.dataset.originalSrc){i.src=i.dataset.originalSrc;return}i.src="data:image/svg+xml;base64,"+btoa(c)}catch(s){console.error("Error updating molecule colors:",s)}}),document.querySelectorAll("img.compound-diagram").forEach(i=>{console.log(`\u{1F313} Dark mode ${o?"enabled":"disabled"} - consider reprocessing compound image:`,i.src)})};var updateMoleculeColors=t;window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>{t(o.matches)}),log.success("\u2705 Dark mode listener initialized")}log.success("\u{1F389} ChemRenderer loaded");function renderSelectionAsMolecule(e,t){const o=window.getSelection();if(!o.rangeCount)return;const n=o.getRangeAt(0),r=document.createElement("img");r.className="molecule-diagram molecule-viewer",r.alt=e,r.title=t.title,r.src="";const i={nomenclature:t.nomenclature||e,type:t.type||"nomenclature",options:{width:400,height:300,scale:1,rotation:0},isMoleculeViewer:!0,flags:t.flags};t.smiles&&(i.smiles=t.smiles),r.dataset.moleculeViewer=btoa(JSON.stringify(i)),r.dataset.loaded="false",r.dataset.rotation="0",r.dataset.compoundType=t.flags.compoundType,t.smiles&&(r.dataset.smiles=t.smiles),r.style.cssText="display:inline-block;vertical-align:middle;margin:0 4px;min-width:100px;min-height:80px;background:rgba(128,128,128,0.1);border-radius:4px;padding:4px",n.deleteContents(),n.insertNode(r),o.removeAllRanges(),window._loadMoleculeImage?window._loadMoleculeImage(r):r.alt="Error: Renderer not ready"}chrome.runtime.onMessage.addListener((e,t,o)=>{var r,i,l;const n=(r=e.text)==null?void 0:r.trim();switch(e.type){case"INSPECT_MOLECULE":if(!n)return;renderSelectionAsMolecule(n,{title:`Searching compound database: ${n}`,flags:{compoundType:"compound",isDirectSmiles:!1}});break;case"RENDER_SMILES":if(!n)return;renderSelectionAsMolecule(n,{title:`SMILES: ${n}`,type:"smiles",smiles:n,flags:{compoundType:"compound",isDirectSmiles:!0}});break;case"RENDER_BIOMOLECULE":if(!n)return;renderSelectionAsMolecule(n,{title:`Searching protein database: ${n}`,flags:{compoundType:"biomolecule",isDirectSmiles:!1}});break;case"RENDER_MINERAL":if(!n)return;renderSelectionAsMolecule(n,{title:`Searching mineral database: ${n}`,flags:{compoundType:"mineral",isDirectSmiles:!1}});break;case"RENDER_IUPAC":if(!n)return;renderSelectionAsMolecule(n,{title:`Converting IUPAC Name: ${n}`,isIUPAC:!0,flags:{compoundType:"compound",isDirectSmiles:!1,isIUPAC:!0}});break}if(e.type==="RERENDER_IMAGE"){const s=e.srcUrl,u=e.renderAs;console.log("%c\u{1F504} Re-rendering image as:","color: #FF5722; font-weight: bold;",u),console.log("Looking for image with src:",(s==null?void 0:s.substring(0,100))+"...");const c=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let f=null;for(const d of c)if(d.src===s){f=d;break}if(!f){console.warn("\u274C Could not find molecule image with the given src");return}console.log("%c\u2705 Found target image:","color: #4CAF50;",f);let g=f.dataset.nomenclature||f.dataset.smiles||((i=f.alt)==null?void 0:i.replace(/^(SMILES|Biomolecule|Mineral):\s*/,""))||((l=f.title)==null?void 0:l.replace(/^(Searching|Rendering|PDB|COD).*?:\s*/,""));if(!g&&f.dataset.moleculeViewer)try{const d=JSON.parse(atob(f.dataset.moleculeViewer));g=d.smiles||d.nomenclature||d.name}catch(d){console.warn("Could not decode moleculeViewer data:",d)}if(!g){console.warn("\u274C Could not extract original text from image"),alert("Could not determine the original molecule name/SMILES from this image.");return}g=g.trim(),console.log("%c\u{1F4DD} Original text:","color: #2196F3;",g);let y,w;switch(u){case"molecule":w={compoundType:"compound",isDirectSmiles:!1},y={nomenclature:g,type:"nomenclature",flags:w};break;case"smiles":w={compoundType:"compound",isDirectSmiles:!0},y={smiles:g,nomenclature:`SMILES: ${g}`,type:"smiles",flags:w},f.dataset.smiles=g;break;case"biomolecule":w={compoundType:"biomolecule",isDirectSmiles:!1},y={nomenclature:g,type:"nomenclature",flags:w};break;case"mineral":w={compoundType:"mineral",isDirectSmiles:!1},y={nomenclature:g,type:"nomenclature",flags:w};break;default:console.warn("Unknown render type:",u);return}y.options={width:400,height:300,scale:1,rotation:0},y.isMoleculeViewer=!0,f.dataset.moleculeViewer=btoa(JSON.stringify(y)),f.dataset.loaded="false",f.dataset.compoundType=w.compoundType||"auto",f.alt=g,f.title=`Re-rendering as ${u}: ${g}`,f.src="",console.log("%c\u{1F504} Triggering re-render via _loadMoleculeImage...","color: #FF5722;"),window._loadMoleculeImage?window._loadMoleculeImage(f):(console.error("\u274C _loadMoleculeImage not found on window object"),f.alt="Error: Renderer not ready")}if(e.type==="EDIT_FLAGS"){const s=e.srcUrl;console.log("%c\u{1F39B}\uFE0F Opening flag editor dialog","color: #9C27B0; font-weight: bold;");const u=document.querySelectorAll("img.molecule-diagram, img.molecule-viewer, img[data-molecule-viewer]");let c=null;for(const d of u)if(d.src===s){c=d;break}if(!c){console.warn("\u274C Could not find molecule image with the given src");return}let f={},g=c.alt||c.title||"Unknown";if(c.dataset.moleculeViewer)try{const d=JSON.parse(atob(c.dataset.moleculeViewer));f=d.flags||{},g=d.nomenclature||d.smiles||g}catch(d){console.warn("Could not decode moleculeViewer data:",d)}const y=document.getElementById("chemistrylatex-flag-editor");y&&y.remove();const w=document.createElement("div");w.id="chemistrylatex-flag-editor",w.innerHTML=`
      <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999999; display: flex; align-items: center; justify-content: center;">
        <div style="background: #fff; border-radius: 12px; padding: 24px; min-width: 350px; max-width: 450px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
          <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">\u{1F39B}\uFE0F ChemistryLaTeX Flag Editor</h3>
          <p style="margin: 0 0 16px 0; font-size: 13px; color: #666; word-break: break-all;">${g}</p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-c" ${f.showCarbons?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Carbons (c)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-n" ${f.atomNumbers?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Atom Numbers (n)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-o" ${f.aromaticCircles?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Aromatic Rings (o)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-h" ${f.addHydrogens?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Hydrogens (h)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-m" ${f.showMethyls?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show Methyls (m)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-i" ${f.showImplicitHydrogens?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Implicit H (i)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-p" ${f.flipHorizontal?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Flip Horizontal (p)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="flag-q" ${f.flipVertical?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Flip Vertical (q)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; grid-column: span 2;">
              <input type="checkbox" id="flag-3d" ${f.is3D?"checked":""} style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">Show 3D Model First (3d)</span>
            </label>
          </div>
          
          <p style="margin: 0 0 16px 0; font-size: 11px; color: #999;">\u26A0\uFE0F Changes are temporary and will be reset when you change global settings in the popup.</p>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="flag-cancel" style="padding: 10px 20px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button id="flag-apply" style="padding: 10px 20px; border: none; background: #4CAF50; color: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Apply</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(w),document.getElementById("flag-cancel").addEventListener("click",()=>{w.remove()}),document.getElementById("flag-apply").addEventListener("click",()=>{const d={showCarbons:document.getElementById("flag-c").checked,atomNumbers:document.getElementById("flag-n").checked,aromaticCircles:document.getElementById("flag-o").checked,addHydrogens:document.getElementById("flag-h").checked,showMethyls:document.getElementById("flag-m").checked,showImplicitHydrogens:document.getElementById("flag-i").checked,flipHorizontal:document.getElementById("flag-p").checked,flipVertical:document.getElementById("flag-q").checked,is3D:document.getElementById("flag-3d").checked,flagsLocked:!0,...f};console.log("%c\u{1F39B}\uFE0F Applying new flags:","color: #9C27B0;",d);let m={};if(c.dataset.moleculeViewer)try{m=JSON.parse(atob(c.dataset.moleculeViewer))}catch{}m.flags=d,m.isMoleculeViewer=!0,c.dataset.moleculeViewer=btoa(JSON.stringify(m)),c.dataset.loaded="false",c.src="",window._loadMoleculeImage&&window._loadMoleculeImage(c),w.remove()}),w.querySelector("div").addEventListener("click",d=>{d.target===w.querySelector("div")&&w.remove()})}});
