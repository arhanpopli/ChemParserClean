/**
 * ChemistryLaTeX - Independent Client-Side Edition
 * Copyright (c) 2026 Arhan Popli. All rights reserved.
 * Unauthorized copying, modification, or distribution of this software is prohibited.
 */
const SIZE_STEP=20,MIN_SIZE=100,BASE_SIZE=300,DEFAULT_WIDTH=300,DEFAULT_HEIGHT=Math.round(240);function calculateDefaultSize(e){return{width:300,height:DEFAULT_HEIGHT}}function getImageKey(e){return e?e.smiles?`smiles:${e.smiles}`:e.nomenclature?`nomenclature:${e.nomenclature}`:null:null}function getPageImageKey(e,r){const i=getImageKey(e);return i?`page:${r}:${i}`:null}async function loadImageSize(e,r,i){try{const a=getImageKey(e),t=calculateDefaultSize(e);if(!a||!i.saveSizePerImage&&!i.saveSizeBySMILES)return t;let n;return i.saveSizePerImage&&!i.saveSizeBySMILES?n=getPageImageKey(e,r):n=a,n?new Promise(o=>{chrome.storage.local.get([n],s=>{s[n]?o(s[n]):o(t)})}):t}catch(a){return console.error("Error loading image size:",a),calculateDefaultSize(e)}}async function saveImageSize(e,r,i,a){try{const t=getImageKey(e);if(!t||!a.saveSizePerImage&&!a.saveSizeBySMILES)return;let n;if(a.saveSizePerImage&&!a.saveSizeBySMILES?n=getPageImageKey(e,r):n=t,!n)return;const o={};o[n]=i,chrome.storage.local.set(o,()=>{console.log(`Saved size for ${n}:`,i)})}catch(t){console.error("Error saving image size:",t)}}function createSizeControls(e,r,i,a){const t=document.createElement("div");t.className="chem-size-controls",t.style.cssText=`
    position: absolute;
    bottom: 4px;
    left: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
  `;const n=document.createElement("button");n.className="chem-size-btn chem-size-up",n.innerHTML="\u25B2",n.title="Increase size",n.style.cssText=`
    width: 24px;
    height: 24px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  `;const o=document.createElement("button");return o.className="chem-size-btn chem-size-down",o.innerHTML="\u25BC",o.title="Decrease size",o.style.cssText=n.style.cssText,[n,o].forEach(s=>{s.addEventListener("mouseenter",()=>{s.style.background="rgba(0, 0, 0, 0.9)"}),s.addEventListener("mouseleave",()=>{s.style.background="rgba(0, 0, 0, 0.7)"})}),n.addEventListener("click",s=>{s.stopPropagation(),adjustImageSize(e,r,i,20,a)}),o.addEventListener("click",s=>{s.stopPropagation(),adjustImageSize(e,r,i,-20,a)}),t.appendChild(n),t.appendChild(o),e.addEventListener("mouseenter",()=>{t.style.opacity="1"}),e.addEventListener("mouseleave",()=>{t.style.opacity="0"}),t}function adjustImageSize(e,r,i,a,t){const n=parseInt(r.style.width)||r.offsetWidth||300,o=parseInt(r.style.height)||r.offsetHeight||DEFAULT_HEIGHT;let s=n+a,c=o+Math.round(a*(o/n));s=Math.max(100,s),c=Math.max(100,c),r.style.width=`${s}px`,r.style.height=`${c}px`;const l=window.location.href;saveImageSize(i,l,{width:s,height:c},t),console.log(`Adjusted size: ${s}x${c}`)}async function wrapImageWithSizeControls(e,r,i,a){try{const t=document.createElement("div");t.className="chem-image-container",t.style.cssText=`
      position: relative;
      display: inline-block;
      margin: 0 12px 8px 0;
      vertical-align: middle;
    `;const n=window.location.href,o=await loadImageSize(i,n,a);e.style.width=`${o.width}px`,e.style.height=`${o.height}px`,i&&(e.dataset.moleculeData=JSON.stringify(i));const s=createSizeControls(t,e,i,a);return r.parentNode.insertBefore(t,r),t.appendChild(e),t.appendChild(s),r.remove(),t}catch(t){return console.error("Error wrapping image with size controls:",t),r.parentNode.replaceChild(e,r),e}}
