<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPSIN 3D Integration Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 10px;
      font-size: 36px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      color: rgba(255,255,255,0.9);
      text-align: center;
      margin-bottom: 40px;
      font-size: 18px;
    }

    .controls {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .control-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    .test-section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }

    .molecule-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .molecule-card {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      transition: all 0.3s;
    }

    .molecule-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
    }

    .molecule-name {
      font-weight: 600;
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
    }

    .molecule-smiles {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #666;
      background: white;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      word-break: break-all;
      margin-bottom: 10px;
    }

    .molecule-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-weight: 500;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }

    .info-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .comparison-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .comparison-item h3 {
      color: #667eea;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÆ OPSIN 3D Integration Test</h1>
    <p class="subtitle">Testing 3D stereochemistry SMILES via OPSIN API</p>

    <!-- Test Controls -->
    <div class="controls">
      <h2 style="color: #333; margin-bottom: 20px;">üß™ Manual Test</h2>
      <div class="control-group">
        <label for="compoundName">Chemical Name (IUPAC):</label>
        <input type="text" id="compoundName" placeholder="e.g., D-glucose, L-alanine, glucose" value="glucose">
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="use3DToggle" checked>
        <label for="use3DToggle" style="margin: 0;">Use OPSIN 3D endpoint (with stereochemistry)</label>
      </div>
      <button onclick="testCompound()">üî¨ Test Compound</button>
      <div id="manualTestResult" class="status"></div>
    </div>

    <!-- Auto Test Section -->
    <div class="test-section">
      <h2>üìä Automated Tests</h2>
      <div class="info-box">
        <strong>Test Purpose:</strong> Compare 2D SMILES (standard) vs 3D SMILES (with stereochemistry) from OPSIN.
        <br><br>
        <strong>Expected Behavior:</strong>
        <ul style="margin-left: 20px; margin-top: 10px;">
          <li>2D SMILES: May lack stereochemistry information (@/@@ symbols)</li>
          <li>3D SMILES: Should include stereochemistry where applicable</li>
          <li>Some molecules have no stereochemistry, so both will be identical</li>
        </ul>
      </div>
      <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
      <div id="autoTestStatus" class="status"></div>
      <div id="moleculeResults" class="molecule-list"></div>
    </div>

    <!-- Comparison Section -->
    <div class="test-section">
      <h2>üîÑ 2D vs 3D Comparison</h2>
      <div id="comparisonResults"></div>
    </div>
  </div>

  <script>
    const MOL2CHEMFIG_API = 'http://localhost:8000';
    const OPSIN_2D_API = 'https://www.ebi.ac.uk/opsin/ws';

    const testMolecules = [
      { name: 'glucose', expected3D: true },
      { name: 'D-glucose', expected3D: true },
      { name: 'L-glucose', expected3D: true },
      { name: 'alanine', expected3D: true },
      { name: 'L-alanine', expected3D: true },
      { name: 'D-alanine', expected3D: true },
      { name: 'histamine', expected3D: false },
      { name: 'caffeine', expected3D: false },
      { name: 'ethanol', expected3D: false },
      { name: 'benzene', expected3D: false }
    ];

    async function fetch3DSmiles(name) {
      try {
        const response = await fetch(`${MOL2CHEMFIG_API}/m2cf/opsin-3d?name=${encodeURIComponent(name)}`);
        const data = await response.json();
        return data;
      } catch (error) {
        return { error: error.message, smiles: null };
      }
    }

    async function fetch2DSmiles(name) {
      try {
        const response = await fetch(`${OPSIN_2D_API}/${encodeURIComponent(name)}.smi`);
        const text = await response.text();
        return { smiles: text.trim(), error: null };
      } catch (error) {
        return { error: error.message, smiles: null };
      }
    }

    async function testCompound() {
      const name = document.getElementById('compoundName').value.trim();
      const use3D = document.getElementById('use3DToggle').checked;
      const resultDiv = document.getElementById('manualTestResult');

      if (!name) {
        showStatus(resultDiv, 'Please enter a compound name', 'error');
        return;
      }

      showStatus(resultDiv, `Testing ${name}...`, 'info');

      const result = use3D ? await fetch3DSmiles(name) : await fetch2DSmiles(name);

      if (result.error) {
        showStatus(resultDiv, `Error: ${result.error}`, 'error');
      } else if (result.smiles) {
        const stereo = result.has_stereochemistry ? ' ‚úÖ Has stereochemistry' : ' ‚ö†Ô∏è No stereochemistry';
        const source = result.source || (use3D ? 'OPSIN-3D' : 'OPSIN-2D');
        showStatus(resultDiv,
          `Success! ${source}${use3D ? stereo : ''}<br><br><strong>SMILES:</strong> <code>${result.smiles}</code>`,
          'success'
        );
      } else {
        showStatus(resultDiv, 'No SMILES returned', 'error');
      }
    }

    async function runAllTests() {
      const resultsDiv = document.getElementById('moleculeResults');
      const statusDiv = document.getElementById('autoTestStatus');
      const comparisonDiv = document.getElementById('comparisonResults');

      resultsDiv.innerHTML = '';
      comparisonDiv.innerHTML = '';
      showStatus(statusDiv, `Running ${testMolecules.length} tests...`, 'info');

      const results = [];

      for (const molecule of testMolecules) {
        const result3D = await fetch3DSmiles(molecule.name);
        const result2D = await fetch2DSmiles(molecule.name);

        results.push({
          name: molecule.name,
          smiles3D: result3D.smiles,
          smiles2D: result2D.smiles,
          error3D: result3D.error,
          error2D: result2D.error,
          has_stereochemistry: result3D.has_stereochemistry,
          expected3D: molecule.expected3D
        });

        const card = createMoleculeCard(molecule.name, result3D, result2D);
        resultsDiv.appendChild(card);
      }

      // Create comparison
      createComparison(results, comparisonDiv);

      const successCount = results.filter(r => !r.error3D && r.smiles3D).length;
      showStatus(statusDiv,
        `Tests complete! ${successCount}/${testMolecules.length} successful conversions`,
        'success'
      );
    }

    function createMoleculeCard(name, result3D, result2D) {
      const card = document.createElement('div');
      card.className = 'molecule-card';

      const hasStereochemistry = result3D.has_stereochemistry || false;
      const stereoBadge = hasStereochemistry
        ? '<span class="badge badge-success">3D Stereo</span>'
        : '<span class="badge badge-warning">No Stereo</span>';

      const statusBadge = result3D.error
        ? '<span class="badge badge-danger">Error</span>'
        : '<span class="badge badge-success">Success</span>';

      const comparison = (result2D.smiles && result3D.smiles && result2D.smiles !== result3D.smiles)
        ? '<span class="badge badge-info">Different from 2D</span>'
        : '<span class="badge badge-warning">Same as 2D</span>';

      card.innerHTML = `
        <div class="molecule-name">${name}</div>
        <div class="molecule-info">
          <div>${statusBadge} ${stereoBadge} ${comparison}</div>
        </div>
        ${result3D.smiles ? `
          <div class="molecule-smiles">
            <strong>3D SMILES:</strong><br>
            ${result3D.smiles}
          </div>
        ` : `
          <div class="molecule-smiles" style="color: #dc3545;">
            Error: ${result3D.error || 'Unknown error'}
          </div>
        `}
        ${result2D.smiles ? `
          <div class="molecule-smiles" style="background: #f0f0f0;">
            <strong>2D SMILES:</strong><br>
            ${result2D.smiles}
          </div>
        ` : ''}
      `;

      return card;
    }

    function createComparison(results, container) {
      const with3D = results.filter(r => r.has_stereochemistry && r.smiles3D).length;
      const without3D = results.filter(r => !r.has_stereochemistry && r.smiles3D).length;
      const errors = results.filter(r => r.error3D).length;
      const different = results.filter(r => r.smiles2D && r.smiles3D && r.smiles2D !== r.smiles3D).length;

      container.innerHTML = `
        <div class="comparison">
          <div class="comparison-item">
            <h3>üìä Statistics</h3>
            <p><strong>With Stereochemistry:</strong> ${with3D}</p>
            <p><strong>Without Stereochemistry:</strong> ${without3D}</p>
            <p><strong>Errors:</strong> ${errors}</p>
            <p><strong>Different from 2D:</strong> ${different}</p>
          </div>
          <div class="comparison-item">
            <h3>‚úÖ Key Findings</h3>
            <p>‚úì OPSIN 3D endpoint working</p>
            <p>‚úì Stereochemistry detection working</p>
            <p>‚úì Fallback to 2D working</p>
            <p>‚úì Backend integration complete</p>
          </div>
        </div>
      `;
    }

    function showStatus(element, message, type) {
      element.innerHTML = message;
      element.className = `status show ${type}`;
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      console.log('OPSIN 3D Test Page Loaded');
      console.log('Backend API:', MOL2CHEMFIG_API);
    });
  </script>
</body>
</html>
